<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>أكاديمية ANS — نظام حسابات التخدير</title>

<style>
  :root{
    --bg:#0a1124;--panel:#0f1830;--line:#1c2a4f;--text:#e8f0ff;--muted:#99a9d3;
    --pri:#3aa6ff;--pri-ink:#00122b;--danger:#ff5470;--danger-ink:#2b0010;--ghost:#162448;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Tahoma",system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text)}
  .hidden{display:none!important}
  .btn{cursor:pointer;padding:10px 14px;border-radius:12px;border:0;font-weight:700;transition:transform .05s}
  .btn:active{transform:scale(.98)}
  .btn-primary{background:var(--pri);color:var(--pri-ink)}
  .btn-danger{background:var(--danger);color:var(--danger-ink)}
  .btn-ghost{background:#132044;color:#dbe7ff;border:1px solid var(--line)}
  .btn-chip{background:var(--ghost);color:#cfe1ff;padding:6px 10px;border-radius:999px;border:1px solid var(--line)}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  input,select,textarea{background:#0b1633;color:var(--text);border:1px solid var(--line);border-radius:12px;padding:10px;width:100%;margin:6px 0}
  label{font-size:13px;color:var(--muted)}
  .title{font-size:20px;margin:0 0 8px}
  .tabs{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
  .tab{padding:10px 14px;border-radius:12px;background:#0d1a36;color:#cde1ff;cursor:pointer;border:1px solid var(--line)}
  .tab.active{background:#173069}
  #chatBox{height:260px;overflow-y:auto;background:#0b1634;padding:10px;border-radius:12px;border:1px solid var(--line)}
  .msg{margin:6px 0;padding:8px;background:#152c58;border-radius:10px}
  .chip{background:#162448;padding:6px 10px;border-radius:999px;font-size:12px;margin:2px;display:inline-block;border:1px solid var(--line)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 220px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .divider{height:1px;background:var(--line);margin:8px 0}
  .k{color:#9cc0ff}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#07112a;z-index:9999">
  <div class="card" style="max-width:360px;text-align:center">
    <div style="font-size:28px;margin-bottom:6px">ANS</div>
    <div class="muted">جاري التحميل...</div>
  </div>
</div>

<!-- Login -->
<div id="loginScreen" class="hidden" style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:16px">
  <div class="card" style="max-width:380px;width:100%">
    <h3 class="title">تسجيل الدخول</h3>
    <label>البريد</label><input id="emailInput" type="email" placeholder="you@example.com" />
    <label>كلمة المرور</label><input id="passInput" type="password" placeholder="••••••••" />
    <button class="btn btn-primary" id="loginBtn" style="width:100%;margin-top:8px">دخول</button>
    <div class="divider"></div>
    <button class="btn btn-ghost" id="googleBtn" style="width:100%">دخول بواسطة Google</button>
    <div class="muted" style="margin-top:8px">المالك: <b class="k">bama47686@gmail.com</b> (role=owner)</div>
  </div>
</div>

<!-- App -->
<div id="app" class="hidden" style="padding:16px;max-width:1200px;margin:auto">
  <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <div>
      <div style="font-size:18px">نظام حسابات التخدير — ANS</div>
      <div id="userInfo" class="muted"></div>
    </div>
    <div class="toolbar">
      <button id="btnGoHistory" class="btn btn-chip">📂 السجل</button>
      <button id="logoutBtn" class="btn btn-danger">تسجيل الخروج</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-target="panelDose">⚖️ الجرعات</div>
    <div class="tab" data-target="panelFluids">💧 السوائل</div>
    <div class="tab" data-target="panelASA">📊 ASA</div>
    <div class="tab" data-target="panelChat">💬 الشات</div>
    <div class="tab hidden" id="tabAdmin" data-target="panelAdmin">⚙️ المالك</div>
    <div class="tab" data-target="panelHistory">🗂️ السجل</div>
  </div>

  <!-- Dose -->
  <div id="panelDose" class="card">
    <h3 class="title">⚖️ حساب الجرعات</h3>
    <div class="row">
      <div class="col"><label>اسم المريض</label><input id="doseName" /></div>
      <div class="col"><label>الوزن (كغ)</label><input id="doseWeight" type="number" /></div>
      <div class="col"><label>ملاحظات</label><input id="doseNotes" placeholder="حساسية، أدوية ثابتة..." /></div>
    </div>
    <div class="row">
      <div class="col"><label>الأعراض</label><textarea id="doseSymptoms" rows="2" placeholder="أعراض المريض الحالية"></textarea></div>
      <div class="col"><label>طرق التخفيف</label><textarea id="doseRelief" rows="2" placeholder="خطط/تعليمات التخفيف"></textarea></div>
    </div>
    <div class="toolbar">
      <button class="btn btn-primary" onclick="calcDose()">احسب</button>
      <div id="doseResult" class="row"></div>
    </div>
  </div>

  <!-- Fluids -->
  <div id="panelFluids" class="card hidden">
    <h3 class="title">💧 حساب السوائل</h3>
    <div class="row">
      <div class="col"><label>اسم المريض</label><input id="fluidName" /></div>
      <div class="col"><label>الوزن (كغ)</label><input id="fluidWeight" type="number" /></div>
    </div>
    <div class="row">
      <div class="col"><label>الأعراض</label><textarea id="fluidSymptoms" rows="2"></textarea></div>
      <div class="col"><label>طرق التخفيف</label><textarea id="fluidRelief" rows="2"></textarea></div>
    </div>
    <div class="toolbar">
      <button class="btn btn-primary" onclick="calcFluids()">احسب</button>
      <div id="fluidResult" class="row"></div>
    </div>
  </div>

  <!-- ASA -->
  <div id="panelASA" class="card hidden">
    <h3 class="title">📊 تقييم ASA</h3>
    <div class="row">
      <div class="col"><label>اسم المريض</label><input id="asaName" /></div>
      <div class="col"><label>العمر</label><input id="asaAge" type="number" /></div>
      <div class="col">
        <label>مرافق</label>
        <select id="asaCom" multiple style="min-height:104px">
          <option>لا يوجد</option>
          <option>سكري غير مضبوط</option>
          <option>ضغط شديد</option>
          <option>فشل قلبي</option>
          <option>قصور كبدي/كلوي</option>
          <option>حالة إسعافية</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="col"><label>الأعراض</label><textarea id="asaSymptoms" rows="2"></textarea></div>
      <div class="col"><label>طرق التخفيف</label><textarea id="asaRelief" rows="2"></textarea></div>
    </div>
    <div class="toolbar">
      <button class="btn btn-primary" onclick="calcASA()">تقييم</button>
      <div id="asaResult" class="row"></div>
    </div>
  </div>

  <!-- Chat -->
  <div id="panelChat" class="card hidden">
    <h3 class="title">💬 الشات</h3>
    <div id="chatBox"></div>
    <div class="row">
      <div class="col"><input id="chatInput" placeholder="رسالتك..." /></div>
      <div><button id="chatSend" class="btn btn-primary">إرسال</button></div>
    </div>
  </div>

  <!-- History -->
  <div id="panelHistory" class="card hidden">
    <h3 class="title">🗂️ السجل</h3>
    <div class="toolbar" id="historyToolbar">
      <button class="btn btn-chip" id="btnMyHistory">سجلي</button>
      <button class="btn btn-chip hidden" id="btnAllHistory">كل السجلات (مالك)</button>
      <input id="historySearch" placeholder="بحث بالاسم/الإيميل/الدواء..." style="min-width:220px" />
    </div>
    <div id="historyList" class="grid"></div>
  </div>

  <!-- Admin -->
  <div id="panelAdmin" class="card hidden">
    <h3 class="title">⚙️ لوحة المالك</h3>
    <div class="muted" style="margin-bottom:6px">عرض جميع المستخدمين مع إمكانية الحظر/إلغاء الحظر (حسب UID)</div>
    <div id="usersList" class="grid"></div>
  </div>
</div>

<script type="module">
  /*************** Firebase (Modules) ***************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { 
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, 
    GoogleAuthProvider, signInWithPopup, signOut 
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { 
    getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, addDoc, 
    serverTimestamp, query, orderBy, where, onSnapshot, limit 
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
    authDomain: "anesthesia-dose-262e3.firebaseapp.com",
    projectId: "anesthesia-dose-262e3",
    storageBucket: "anesthesia-dose-262e3.firebasestorage.app",
    messagingSenderId: "602244448093",
    appId: "1:602244448093:web:0a8d9905849126086ff2b4",
    measurementId: "G-SCHMQFCK3J"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /*************** UI helpers ***************/
  const splash       = document.getElementById("splash");
  const loginScreen  = document.getElementById("loginScreen");
  const appEl        = document.getElementById("app");
  const userInfo     = document.getElementById("userInfo");
  const tabAdmin     = document.getElementById("tabAdmin");
  const historyList  = document.getElementById("historyList");
  const btnAllHistory= document.getElementById("btnAllHistory");
  const btnMyHistory = document.getElementById("btnMyHistory");
  const historySearch= document.getElementById("historySearch");
  let currentUser=null, currentRole="user", showingAll=false, allHistoryCache=[], myHistoryCache=[];

  setTimeout(()=>splash.classList.add("hidden"),1000);

  // Tabs
  document.querySelectorAll(".tab").forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      ["panelDose","panelFluids","panelASA","panelChat","panelHistory","panelAdmin"]
        .forEach(id=>document.getElementById(id).classList.add("hidden"));
      document.getElementById(t.dataset.target).classList.remove("hidden");
    };
  });
  document.getElementById("btnGoHistory").onclick=()=>{
    document.querySelector('[data-target="panelHistory"]').click();
  };

  /*************** Auth ***************/
  document.getElementById("loginBtn").onclick=()=>signInWithEmailAndPassword(auth,emailInput.value,passInput.value).catch(e=>alert(e.message));
  document.getElementById("googleBtn").onclick=()=>signInWithPopup(auth,new GoogleAuthProvider());
  document.getElementById("logoutBtn").onclick=()=>signOut(auth);

  onAuthStateChanged(auth, async (u)=>{
    if(u){
      currentUser=u;
      const role = (u.email==="bama47686@gmail.com") ? "owner" : "user";
      await setDoc(doc(db,"users",u.uid),{uid:u.uid,email:u.email,role,banned:false},{merge:true});
      const us = (await getDoc(doc(db,"users",u.uid))).data();
      if(us?.banned){ alert("تم حظرك من الوصول للتطبيق."); await signOut(auth); return; }
      currentRole=role;
      userInfo.textContent=`${u.email} — Role: ${role}`;
      tabAdmin.classList.toggle("hidden", role!=="owner");
      btnAllHistory.classList.toggle("hidden", role!=="owner");
      loginScreen.classList.add("hidden");
      appEl.classList.remove("hidden");

      initChat();
      await loadMyHistory();
      if(role==="owner"){ loadUsers(); await loadAllHistory(); }
    }else{
      appEl.classList.add("hidden");
      loginScreen.classList.remove("hidden");
    }
  });

  /*************** History Save/Load ***************/
  async function saveHistory(obj){
    if(!currentUser) return;
    await addDoc(collection(db,"history"),{
      ...obj,
      uid:currentUser.uid,
      email:currentUser.email,
      createdAt: serverTimestamp()
    });
    // Refresh caches
    await loadMyHistory();
    if(currentRole==="owner" && showingAll) await loadAllHistory();
  }

  function fmtDate(ts){
    if(!ts) return "";
    const d = ts.toDate? ts.toDate(): new Date(ts);
    return d.toLocaleString("ar-IQ");
  }

  function renderHistory(cards){
    const q = (historySearch.value||"").trim().toLowerCase();
    historyList.innerHTML="";
    cards.filter(h=>{
      if(!q) return true;
      const hay = JSON.stringify(h).toLowerCase();
      return hay.includes(q);
    }).forEach(h=>{
      const wrap=document.createElement("div");
      wrap.className="card";
      const inputs = h.inputs ? JSON.stringify(h.inputs).replaceAll('"','').replaceAll('{','').replaceAll('}','') : "—";
      const result = h.result ? JSON.stringify(h.result).replaceAll('"','').replaceAll('{','').replaceAll('}','') : "—";
      wrap.innerHTML = `
        <div class="row" style="align-items:center;justify-content:space-between">
          <div><b>🧑‍⚕️ ${h.patientName || "—"}</b></div>
          <div>${h.type? `<span class="chip">${h.type}</span>`:""}</div>
        </div>
        <div class="muted">${fmtDate(h.createdAt)} — ${h.email||""}</div>
        <div class="divider"></div>
        <div>📏 <span class="k">${inputs}</span></div>
        <div>💊 <span class="k">${result}</span></div>
        ${h.symptoms? `<div>⚠️ <span class="k">${h.symptoms}</span></div>`:""}
        ${h.relief?   `<div>💡 <span class="k">${h.relief}</span></div>`:""}
      `;
      historyList.appendChild(wrap);
    });
    if(!historyList.children.length){
      historyList.innerHTML = `<div class="muted">لا توجد سجلات مطابقة.</div>`;
    }
  }

  async function loadMyHistory(){
    if(!currentUser) return;
    const qy = query(
      collection(db,"history"),
      where("uid","==",currentUser.uid),
      orderBy("createdAt","desc")
    );
    const snap = await getDocs(qy);
    myHistoryCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
    if(!showingAll) renderHistory(myHistoryCache);
  }

  async function loadAllHistory(){
    const qy = query(collection(db,"history"), orderBy("createdAt","desc"), limit(400));
    const snap = await getDocs(qy);
    allHistoryCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
    if(showingAll) renderHistory(allHistoryCache);
  }

  btnMyHistory.onclick = ()=>{ showingAll=false; renderHistory(myHistoryCache); };
  btnAllHistory.onclick = async ()=>{ if(currentRole!=="owner") return; showingAll=true; if(!allHistoryCache.length) await loadAllHistory(); renderHistory(allHistoryCache); };
  historySearch.oninput = ()=>{ renderHistory(showingAll? allHistoryCache : myHistoryCache); };

  /*************** Users (Owner) ***************/
  async function loadUsers(){
    const snap = await getDocs(collection(db,"users"));
    const box  = document.getElementById("usersList");
    box.innerHTML="";
    snap.forEach(d=>{
      const u = d.data();
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div><b>${u.email||""}</b></div>
        <div class="muted">UID: ${u.uid}</div>
        <div class="muted">Role: ${u.role}</div>
        <div class="toolbar" style="margin-top:6px">
          <button class="btn ${u.banned? "btn-primary":"btn-danger"}" onclick="toggleBan('${u.uid}', ${!!u.banned})">
            ${u.banned? "إلغاء الحظر":"حظر"}
          </button>
        </div>
      `;
      box.appendChild(card);
    });
  }
  window.toggleBan = async (uid,cur)=>{
    await updateDoc(doc(db,"users",uid),{banned:!cur});
    loadUsers();
  };

  /*************** Calculators ***************/
  // جرعات
  window.calcDose = async ()=>{
    const w = +document.getElementById("doseWeight").value;
    const name = document.getElementById("doseName").value.trim();
    const notes= document.getElementById("doseNotes").value.trim();
    const sym  = document.getElementById("doseSymptoms").value.trim();
    const rel  = document.getElementById("doseRelief").value.trim();
    if(!w || !name){ alert("الرجاء إدخال اسم المريض والوزن."); return; }

    // أمثلة مبسطة، عدل حسب بروتوكولك
    const result = {
      Propofol: `${(2*w).toFixed(0)}–${(3*w).toFixed(0)} mg`,
      Fentanyl:`${(1*w).toFixed(0)} mcg`,
      Midazolam:`${(0.1*w).toFixed(1)} mg`
    };
    document.getElementById("doseResult").innerHTML =
      Object.entries(result).map(([k,v])=>`<span class="chip">${k}: ${v}</span>`).join(" ");

    await saveHistory({
      type:"dose",
      patientName:name,
      inputs:{weight:w,notes},
      result,
      symptoms:sym,
      relief:rel
    });
  };

  // سوائل
  window.calcFluids = async ()=>{
    const w = +document.getElementById("fluidWeight").value;
    const name = document.getElementById("fluidName").value.trim();
    const sym  = document.getElementById("fluidSymptoms").value.trim();
    const rel  = document.getElementById("fluidRelief").value.trim();
    if(!w || !name){ alert("الرجاء إدخال اسم المريض والوزن."); return; }

    // تقدير بسيط: 30 ml/kg/day
    const fluids = `${(w*30).toFixed(0)} ml/day`;
    document.getElementById("fluidResult").innerHTML = `<span class="chip">${fluids}</span>`;

    await saveHistory({
      type:"fluids",
      patientName:name,
      inputs:{weight:w},
      result:{fluids},
      symptoms:sym,
      relief:rel
    });
  };

  // ASA
  window.calcASA = async ()=>{
    const age = +document.getElementById("asaAge").value;
    const name= document.getElementById("asaName").value.trim();
    const sel = [...document.getElementById("asaCom").selectedOptions].map(o=>o.value);
    const sym = document.getElementById("asaSymptoms").value.trim();
    const rel = document.getElementById("asaRelief").value.trim();
    if(!name || !age){ alert("الرجاء إدخال اسم المريض والعمر."); return; }

    let score="ASA I";
    if(sel.includes("فشل قلبي")||sel.includes("قصور كبدي/كلوي")) score="ASA IV";
    else if(sel.includes("سكري غير مضبوط")||sel.includes("ضغط شديد")) score="ASA III";
    else if(sel.includes("لا يوجد")||sel.length===0) score="ASA I";
    else score="ASA II";
    if(sel.includes("حالة إسعافية")) score += " (E)";

    document.getElementById("asaResult").innerHTML = `<span class="chip">${score}</span>`;

    await saveHistory({
      type:"asa",
      patientName:name,
      inputs:{age,comorbidities:sel},
      result:{score},
      symptoms:sym,
      relief:rel
    });
  };

  /*************** Chat ***************/
  function initChat(){
    const qy = query(collection(db,"chat"), orderBy("time"));
    onSnapshot(qy, snap=>{
      const box=document.getElementById("chatBox");
      box.innerHTML="";
      snap.forEach(m=>{
        const d=m.data();
        const div=document.createElement("div");
        div.className="msg";
        div.innerHTML = `<b>${d.email||"مستخدم"}:</b> ${d.text||""}`;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    });
  }
  document.getElementById("chatSend").onclick = async ()=>{
    const inp=document.getElementById("chatInput");
    const text=(inp.value||"").trim();
    if(!text || !currentUser) return;
    await addDoc(collection(db,"chat"),{
      uid:currentUser.uid,
      email:currentUser.email,
      text,
      time:serverTimestamp()
    });
    inp.value="";
  };

</script>
</body>
</html>
