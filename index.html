 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø£ÙƒØ§Ø¯ÙŠÙ…Ø© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</title>

<!-- ********** Ø³ØªØ§ÙŠÙ„ Ù…ØªÙƒØ§Ù…Ù„ (Dark/Light ready) ********** -->
<style>
  :root{
    --bg-dark:#071223; --bg-dark-2:#0b3045; --card:#0f2333;
    --accent:#0a9bd6; --accent-2:#11cdef; --glass: rgba(255,255,255,0.04);
    --success:#16a34a; --danger:#ff5252;
    --text:#e6f6ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg-dark),var(--bg-dark-2));color:var(--text);min-height:100vh;overflow-x:hidden;transition:background .35s,color .35s}
  .light body,.light :root{ /* not used directly but can flip classes if needed */ }
  header{padding:8px 18px;text-align:center;font-weight:700;background:linear-gradient(90deg,#072a40,#0a5f86);box-shadow:0 6px 20px rgba(2,6,23,.45)}
  header h1{margin:0;padding:6px 0;font-size:1.1rem}
  /* splash */
  #splash{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;background:linear-gradient(135deg,#071024 0%, #06293a 70%);overflow:hidden}
  .splash-top{width:92%;max-width:900px;display:flex;flex-direction:column;gap:12px;align-items:stretch;transform-origin:center}
  .splash-bar{
    background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    padding:18px;border-radius:12px;color:#eaf6ff;display:flex;flex-direction:column;gap:6px;
    box-shadow:0 10px 40px rgba(0,0,0,0.6);
  }
  .splash-bar .role{opacity:.9;font-size:13px;color:#cfefff}
  .splash-bar.dev{animation:barOutDev 5s cubic-bezier(.2,.9,.3,1) forwards}
  .splash-bar.mid{animation:barOutMid 5s cubic-bezier(.2,.9,.3,1) forwards}
  .splash-bar.top{animation:barOutTop 5s cubic-bezier(.2,.9,.3,1) forwards}
  @keyframes barOutTop{0%{transform:translateX(0);opacity:1}60%{opacity:1}100%{transform:translateX(-150%);opacity:0}}
  @keyframes barOutMid{0%{transform:translateX(0);opacity:1}60%{opacity:1}100%{transform:translateY(-120%);opacity:0}}
  @keyframes barOutDev{0%{transform:translateX(0);opacity:1}60%{opacity:1}100%{transform:translateX(150%);opacity:0}}
  .splash-note{color:#cfefff;opacity:.95}
  /* decorations */
  .decoration{position:fixed;inset:0;pointer-events:none;z-index:5}
  .bubble{position:absolute;border-radius:50%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.08), rgba(255,255,255,0.01));filter:blur(8px);opacity:.5;animation:float 9s ease-in-out infinite}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-50px)}100%{transform:translateY(0)}}
  .glow{position:absolute;border-radius:50%;filter:blur(40px);opacity:.7}
  /* app container */
  .app-wrap{position:relative;z-index:10;max-width:1200px;margin:34px auto;padding:20px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,0.6)}
  .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .btn{padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#042a3a;cursor:pointer;font-weight:700;min-width:140px}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .panel{display:none;margin-top:14px}
  label{display:block;margin:8px 0;text-align:right}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px}
  .result-box{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.2));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .pill{display:inline-block;padding:6px 10px;background:rgba(255,255,255,0.03);border-radius:999px;margin:6px 6px 0 0;color:#dff6ff}
  .sideEffect{background:rgba(255,60,60,0.06);border-left:4px solid rgba(255,80,80,0.9);padding:10px;margin:8px 0;border-radius:6px}
  .muted{color:#bcdcec;font-size:13px}
  footer{margin-top:18px;text-align:center;color:#93c1d8;font-size:13px}
  .chatBox{height:140px;overflow:auto;padding:10px;background:rgba(255,255,255,0.012);border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .controls-row{display:flex;gap:8px;align-items:center}
  .small-muted{font-size:12px;color:#a9d7ee}
  /* responsive tweaks */
  @media (max-width:720px){
    .grid{grid-template-columns:1fr}
    .top-actions{flex-direction:column}
  }
  /* light mode (toggle) */
  body.light{background:linear-gradient(180deg,#f5f8fb,#ffffff);color:#052036}
  body.light .card{background:#fff;box-shadow:0 12px 30px rgba(2,6,23,0.06)}
  body.light input,body.light select,body.light textarea{background:#fff;color:#052036;border:1px solid #e6eef6}
  body.light .splash-bar{color:#072a40}
</style>
</head>
<body>

<!-- SPLASH / HIERARCHICAL BARS -->
<div id="splash">
  <div class="splash-top" style="width:86%">
    <!-- hierarchical: top -> middle -> dev (dev is last to disappear as requested) -->
    <div class="splash-bar top">
      <strong>Ø´Ø±ÙŠØ· 1 â€” Ø£ÙƒØ§Ø¯Ù…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ©</strong>
      <div class="role">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</div>
    </div>

    <div class="splash-bar mid">
      <strong>Ø´Ø±ÙŠØ· 2 â€” Ù…Ù†Ø¸Ù‘Ù…</strong>
      <div class="role">Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ± â€” @871c</div>
    </div>

    <div class="splash-bar dev">
      <strong>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</strong>
      <div class="role">Ù…Ù†Ø¸Ù… Ùˆ Ù…Ø·ÙˆØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” @ku56t</div>
    </div>
  </div>

  <div class="splash-note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙØªØ­ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ø·ÙŠØ¦Ø© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª)</div>

  <!-- decorative sparkles -->
  <div style="position:absolute;inset:0;pointer-events:none">
    <div style="position:absolute;left:6%;top:20%;width:14px;height:14px;background:rgba(255,255,255,0.12);border-radius:50%;filter:blur(6px);animation:float 7s infinite;"></div>
    <div style="position:absolute;right:12%;top:36%;width:18px;height:18px;background:rgba(255,255,255,0.08);border-radius:50%;filter:blur(9px);animation:float 9s infinite;"></div>
  </div>
</div>

<!-- decoration bubbles -->
<div class="decoration" aria-hidden="true">
  <div class="bubble" style="left:3%;top:10%;width:140px;height:140px;animation-duration:10s"></div>
  <div class="bubble" style="left:82%;top:18%;width:100px;height:100px;animation-duration:12s"></div>
  <div class="bubble" style="left:22%;top:75%;width:90px;height:90px;animation-duration:8s"></div>
  <div class="bubble" style="left:68%;top:82%;width:120px;height:120px;animation-duration:11s"></div>
  <div class="glow" style="left:2%;top:72%;width:300px;height:300px;background:radial-gradient(circle,#11cdef44,transparent);"></div>
  <div class="glow" style="right:2%;top:60%;width:260px;height:260px;background:radial-gradient(circle,#0a9bd644,transparent);"></div>
</div>

<!-- APP MAIN -->
<div class="app-wrap" id="app" style="display:none">
  <div class="card">
    <header><h1>Ø£ÙƒØ§Ø¯Ù…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â˜† â€” Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆÙ‘Ø±</h1></header>

    <div class="top-actions" style="margin-top:12px">
      <button class="btn" id="showDose">ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</button>
      <button class="btn" id="showFluids">ğŸ’§ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</button>
      <button class="btn" id="showAirway">ğŸ« Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ / ETT</button>
      <button class="btn" id="showAdmin">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      <button class="btn ghost" id="showAbout">â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
      <button class="btn ghost" id="toggleTheme">ğŸŒ™ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
      <div style="flex:1"></div>
      <div id="userInfo" class="muted" style="align-self:center"></div>
      <button class="btn ghost" id="btnLogout" style="min-width:110px">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <!-- Panels -->
    <!-- Dose panel -->
    <section id="panelDose" class="panel">
      <h2>ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ±</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
            <input id="patientNameDose" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
          </label>

          <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº)
            <input id="weightDose" type="number" placeholder="Ù…Ø«Ø§Ù„: 70">
          </label>

          <label>Ø§Ù„Ø¹Ù…Ø±
            <div style="display:flex;gap:8px">
              <input id="ageDose" type="number" placeholder="Ù…Ø«Ø§Ù„: 40" style="flex:1">
              <select id="ageUnitDose" style="width:120px">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>ØªØµÙ†ÙŠÙ ASA
            <select id="asaSelect">
              <option value="I">ASA I</option>
              <option value="II">ASA II</option>
              <option value="III">ASA III</option>
              <option value="IV">ASA IV</option>
              <option value="V">ASA V</option>
            </select>
          </label>

          <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
            <select id="patientHealth">
              <option value="healthy">ØµØ­ÙŠ</option>
              <option value="unhealthy">Ù…Ø±ÙŠØ¶</option>
            </select>
          </label>

          <div id="diseaseDiv" style="display:none;margin-top:6px">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ (Ù…ØªØ¹Ø¯Ø¯)
              <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">
                <label><input type="checkbox" class="diseaseChk" value="diabetes"> Ø³ÙƒØ±ÙŠ</label>
                <label><input type="checkbox" class="diseaseChk" value="heart"> Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨ÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="lung"> Ø£Ù…Ø±Ø§Ø¶ Ø±Ø¦ÙˆÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="liver"> Ø£Ù…Ø±Ø§Ø¶ ÙƒØ¨Ø¯ÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="kidney"> Ø£Ù…Ø±Ø§Ø¶ ÙƒÙ„ÙˆÙŠÙ‘Ø©</label>
                <label><input type="checkbox" class="diseaseChk" value="allergy"> Ø­Ø³Ø§Ø³ÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="obesity"> Ø³Ù…Ù†Ø© Ù…ÙØ±Ø·Ø©</label>
              </div>
            </label>
          </div>

          <label>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡
            <select id="drugDose"></select>
          </label>

          <div class="controls-row" style="margin-top:8px">
            <button class="btn" id="calcDose">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
            <button class="btn ghost" id="scanBagBtn" title="ÙØªØ­ ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ">ğŸ“· Ù…Ø³Ø­ ÙƒÙŠØ³ Ø§Ù„Ù…Ø±ÙŠØ¶</button>
            <div style="flex:1"></div>
          </div>

          <div style="margin-top:6px" class="small-muted">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ‚Ø±ÙŠØ¨ÙŠØ© â€” Ø±Ø§Ø¬Ø¹ Ø³Ø±ÙŠØ±ÙŠØ§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹.</div>
        </div>

        <div>
          <div id="doseResult" class="result-box"><b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</b></div>
          <div id="doseEffects" style="margin-top:12px"></div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

      <h3>Ø´Ø§Øª/Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
      <div class="chatBox" id="doseChat"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="doseChatInput" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ùˆ Ø³Ø¤Ø§Ù„">
        <button class="btn ghost" id="doseChatSend">Ø£Ø±Ø³Ù„</button>
      </div>
    </section>

    <!-- Fluids -->
    <section id="panelFluids" class="panel">
      <h2>ğŸ’§ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
            <input id="patientNameFluid" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
          </label>

          <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº)
            <input id="weightFluid" type="number" placeholder="Ù…Ø«Ø§Ù„: 70">
          </label>

          <label>Ø§Ù„Ø¹Ù…Ø±
            <div style="display:flex;gap:8px">
              <input id="ageFluid" type="number" placeholder="Ù…Ø«Ø§Ù„: 40" style="flex:1">
              <select id="ageUnitFluid" style="width:120px">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¦Ù„
            <select id="fluidType">
              <option value="NS">Normal Saline (0.9% NaCl)</option>
              <option value="RL">Ringer Lactate</option>
              <option value="D5W">Dextrose 5% (D5W)</option>
              <option value="PRBC">PRBC - Ù†Ù‚Ù„ Ø¯Ù… (1 ÙˆØ­Ø¯Ø©)</option>
            </select>
          </label>

          <div style="margin-top:8px" class="controls-row">
            <button class="btn" id="calcFluids">Ø§Ø­Ø³Ø¨</button>
            <div style="flex:1"></div>
          </div>
        </div>

        <div>
          <div id="fluidResult" class="result-box"><b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</b></div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

      <h3>Ø´Ø§Øª/Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³ÙˆØ§Ø¦Ù„</h3>
      <div class="chatBox" id="fluidChat"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="fluidChatInput" placeholder="Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø³ÙˆØ§Ø¦Ù„/Ù†Ù‚Ù„ Ø¯Ù…">
        <button class="btn ghost" id="fluidChatSend">Ø£Ø±Ø³Ù„</button>
      </div>
    </section>

    <!-- Airway -->
    <section id="panelAirway" class="panel">
      <h2>ğŸ« Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ Ùˆ ETT</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
            <input id="patientNameAirway" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
          </label>

          <label>Ø§Ù„Ø¹Ù…Ø±
            <div style="display:flex;gap:8px">
              <input id="ageAirway" type="number" placeholder="Ù…Ø«Ø§Ù„: 3" style="flex:1">
              <select id="ageUnitAirway" style="width:120px">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>Ø§Ù„ÙˆØ²Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            <input id="weightAirway" type="number" placeholder="ÙƒØº">
          </label>

          <div style="margin-top:8px" class="controls-row">
            <button class="btn" id="calcAirway">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­</button>
            <button class="btn ghost" id="showScanner">ğŸ” ÙƒØ§Ù…ÙŠØ±Ø§ (Ù…Ø³Ø­ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¶ÙˆØ¡)</button>
          </div>
        </div>

        <div>
          <div id="airwayResult" class="result-box">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

      <h3>Ø´Ø§Øª/Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
      <div class="chatBox" id="airwayChat"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="airwayChatInput" placeholder="Ø³Ø¤Ø§Ù„ Ø¹Ù† Airway/ETT">
        <button class="btn ghost" id="airwayChatSend">Ø£Ø±Ø³Ù„</button>
      </div>
    </section>

    <!-- Admin panel -->
    <section id="panelAdmin" class="panel">
      <h2>âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</h2>
      <div id="adminContent"></div>
      <div id="ownerControls" style="display:none;margin-top:10px">
        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
        <div>
          <button class="btn" id="btnRefreshUsers">ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
          <div id="usersList" style="margin-top:8px"></div>
        </div>

        <h3 style="margin-top:12px">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (History)</h3>
        <div>
          <input id="searchHistory" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/Ø§Ù„Ø¯ÙˆØ§Ø¡">
          <button class="btn ghost" id="btnSearchHistory">Ø¨Ø­Ø«</button>
          <div id="historyList" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- About -->
    <section id="panelAbout" class="panel">
      <h2>â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
      <div class="result-box">
        <p>Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ± â€” Ù…ÙˆÙ‚Ø¹ ØªØ¹Ù„ÙŠÙ…ÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± ÙˆØ§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØªÙˆØµÙŠØ§Øª airway. Ø§Ù„ÙÙƒØ±Ø© Ù…Ù‚ØªØ±Ø­Ø© Ù…Ù† Ø·Ù„Ø§Ø¨ Ù‚Ø³Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„ÙƒÙˆØª (Ø§Ù„Ù…Ø±Ø­Ù„ØªØ§Ù† Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø±Ø§Ø¨Ø¹Ø©) Ø³Ù†Ø© 2026.</p>
        <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ÙˆØªØ·ÙˆÙŠØ±Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø©: <strong>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</strong> (@ku56t) â€” Ù…Ø·ÙˆØ± ÙˆÙ…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹. Ù…Ù†Ø¸Ù‘Ù…ÙˆÙ†: <strong>Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ±</strong> (@871c) Ùˆ <strong>Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰</strong> (@ans_mz1092).</p>
        <p>ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙÙ‚Ø·. Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ‚Ø±ÙŠØ¨ÙŠØ© â€” Ù„Ø§ ØªØ¹ÙˆÙ‘Ù„ Ø¹Ù„ÙŠÙ‡Ø§ Ø³Ø±ÙŠØ±ÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ø¨ÙŠØ¨ Ù…Ø®ØªØµ.</p>
      </div>
    </section>

    <footer>Â© Ø£ÙƒØ§Ø¯Ù…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ø±Ø§Ø¬Ø¹ Ø¯ÙˆÙ…Ø§Ù‹ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ±ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙŠ Ø¬Ø±Ø¹Ø©</footer>
  </div>
</div>

<!-- Camera modal / scanner (simple) -->
<div id="scannerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;align-items:center;justify-content:center">
  <div style="background:#021827;padding:12px;border-radius:12px;max-width:900px;width:90%;">
    <h3 style="margin:0 0 8px">ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ (Ù…Ø­Ø§ÙƒØ§Ø©)</h3>
    <p style="margin:0 0 8px;color:#cfe8ff">Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù„ÙƒÙŠØ³ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø£Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯ â€” Ù‡Ø°Ù‡ Ø®Ø§ØµÙŠØ© Ù…Ø­Ø§ÙƒØ§Ø©. Ù„ØªÙ…ÙƒÙŠÙ† OCR Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ù…Ø¬ Tesseract.js Ø£Ùˆ Ø®Ø¯Ù…Ø© Cloud Vision.</p>
    <video id="scannerVideo" autoplay style="width:100%;border-radius:8px;background:#000"></video>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="captureBtn" class="btn">Ø§Ù„ØªÙ‚Ø§Ø·</button>
      <button id="closeScanner" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="scanResult" style="margin-top:12px" class="result-box"></div>
  </div>
</div>


/* Panels */
const panels = { showDose:'panelDose', showFluids:'panelFluids', showAirway:'panelAirway', showAdmin:'panelAdmin', showAbout:'panelAbout' };
Object.keys(panels).forEach(btnId=>{
  const el = document.getElementById(btnId);
  if(!el) return;
  el.addEventListener('click', ()=> showPanel(panels[btnId]));
});
function showPanel(id){ Object.values(panels).forEach(pid=>document.getElementById(pid).style.display='none'); document.getElementById(id).style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }

/* Splash hide after 5s (bars animations) */
/* Splash hide after 5s (bars animations) â€” allow skip & immediate show on login */
let splashTimeout = setTimeout(hideSplash, 5000);
function hideSplash(){
  if(!splash || splash.style.display === 'none') return;
  splash.style.transition='opacity .25s, transform .25s';
  splash.style.opacity='0';
  splash.style.transform='translateY(-20px)';
  setTimeout(()=>{ splash.style.display='none'; appWrap.style.display='block'; },300);
}
// allow user to skip splash by click or Escape key
splash.addEventListener('click', ()=>{ clearTimeout(splashTimeout); hideSplash(); });
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ clearTimeout(splashTimeout); hideSplash(); } });


/* Toggle theme */
document.getElementById('toggleTheme').addEventListener('click', ()=>{
  document.body.classList.toggle('light');
});

/* ========== Drug database with side effects + reduction methods ==========
   You can extend this object: add drugs with dose (per age category mg/kg or Âµg/kg), max, side_effects[], management[], reduce (text)
*/
const drugData = {
  "Propofol":{
    dose:{ infant:[2.5,3.0], child:[2.0,2.5], adult:2.5 },
    max:{value:300,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù…","ØªÙˆÙ‚Ù ØªÙ†ÙÙ‘Ø³ Ù…Ø¤Ù‚Øª","Ø£Ù„Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ù‚Ù†","Propofol infusion syndrome Ø¹Ù†Ø¯ ØªØ³Ø±ÙŠØ¨ Ø·ÙˆÙŠÙ„"],
    management:["Ø³ÙˆØ§Ø¦Ù„ Ùˆ/Ø£Ùˆ Vasopressors","Ø¯Ø¹Ù… Ø§Ù„ØªÙ†ÙÙ‘Ø³ ÙˆØªÙ‡ÙˆÙŠØ©","Lidocaine Ù‚Ø¨Ù„ Ø§Ù„Ø­Ù‚Ù†","Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø±ÙŠØ¨ ÙˆØ¯Ø¹Ù… Ù‚Ù„Ø¨ÙŠ/ØªÙ†ÙØ³ÙŠ"],
    reduce:"Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø±Ø¹Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù†Ø®ÙØ¶Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… ØªØ³Ø±ÙŠØ¨ Ù…Ø³ØªÙ…Ø± Ø¨Ø·ÙŠØ¡ØŒ Ù‚Ù„Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆÙ…Ø±Ø¶Ù‰ Ø§Ù„Ù‚Ù„Ø¨."
  },
  "Midazolam":{
    dose:{ infant:[0.05,0.1], child:[0.05,0.2], adult:0.15 },
    max:{value:10,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["ØªÙ‡Ø¯Ø¦Ø© Ù…ÙØ±Ø·Ø©","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·","Ø±Ø¯ÙˆØ¯ Ø¹ÙƒØ³ÙŠØ© Ù†Ø§Ø¯Ø±Ø©"],
    management:["Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¹Ù†Ø§ÙŠØ© ØªÙ†ÙÙ‘Ø³ÙŠØ©","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø£Ùˆ Flumazenil (Ù…Ø¶Ø§Ø¯)"],
    reduce:"Ù‚Ù„Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆØ£ÙŠØ¶Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù†Ø®ÙØ§Ø¶ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙƒØ¨Ø¯."
  },
  "Fentanyl":{
    dose:{ infant:[1,2], child:[2,3], adult:2 }, // Âµg/kg
    max:{value:300,unit:'Âµg'}, unitPerKg:'Âµg/kg',
    side_effects:["ØªØ«Ø¨ÙŠØ· ØªÙ†ÙØ³ÙŠ","ØªØ¨Ø§Ø·Ø¤ Ù†Ø¨Ø¶ Ø§Ù„Ù‚Ù„Ø¨","ØºØ«ÙŠØ§Ù†/Ù‚ÙŠØ¡"],
    management:["Ø¯Ø¹Ù… ØªÙ†ÙØ³ÙŠØŒ Naloxone Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©","Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ù„Ø¨ÙŠØ©","Ø£Ø¯ÙˆÙŠØ© Ù…Ø¶Ø§Ø¯Ø© Ù„Ù„ØºØ«ÙŠØ§Ù†"],
    reduce:"Ø§Ø³ØªØ®Ø¯Ù… Ø¬Ø±Ø¹Ø§Øª Ù…Ù‚Ø³Ù…Ø© (titrate) ÙˆØ§Ø¨ØªØ¹Ø¯ Ø¹Ù† Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„ØªØ±ÙƒÙŠØ² ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆØ§Ù„Ù…ØµØ§Ø¨ÙŠÙ† Ø¨Ø£Ù…Ø±Ø§Ø¶ Ø±Ø¦ÙˆÙŠØ©."
  },
  "Ketamine":{
    dose:{ infant:[2,3], child:[4,5], adult:1.5 }, // mg/kg
    max:{value:300,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["Ø²ÙŠØ§Ø¯Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…","ØªÙŠØ¨Ù‘Ø³ Ø¹Ø¶Ù„ÙŠ","Ù‡Ù„ÙˆØ³Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙØ§Ù‚Ø©"],
    management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· ÙˆÙ†Ø¨Ø¶","Midazolam ÙƒÙ…Ù‡Ø¯Ø¦ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©","Ø¨ÙŠØ¦Ø© Ù‡Ø§Ø¯Ø¦Ø© Ù„Ù„Ù…Ø±Ø¶Ù‰"],
    reduce:"Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ø±Ø¹Ø§Øª Ø£ØµØºØ± Ø¹Ù†Ø¯ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆØ®Ù„Ø·Ù‡Ø§ Ù…Ø¹ Ù…Ø³ÙƒÙ†Ø§Øª Ø£Ùˆ Ø¨Ù†Ø²ÙˆØ¯ÙŠØ§Ø²ÙŠØ¨ÙŠÙ† Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡Ù„ÙˆØ³Ø©."
  },
  "Thiopental":{
    dose:{ infant:[10,15], child:[10,12.5], adult:12.5 },
    max:{value:400,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["ÙƒØ¨Øª ØªÙ†ÙØ³ÙŠ","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"],
    management:["ØªÙ‡ÙˆÙŠØ©/Ø£ÙƒØ³Ø¬ÙŠÙ†","Ø¯Ø¹Ù… Ø¶ØºØ· Ø§Ù„Ø¯Ù…"],
    reduce:"ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆÙ…Ø±Ø¶Ù‰ Ø§Ù„Ù‚Ù„Ø¨."
  },
  "Etomidate":{
    dose:{ infant:[0.15,0.3], child:[0.2,0.3], adult:0.3 },
    max:{value:40,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["Myoclonus","Ù‚Ù…Ø¹ Ù…Ø­ÙˆØ± Ø§Ù„ØºØ¯Ø¯ Ø§Ù„ÙƒØ¸Ø±ÙŠØ© (transient)"],
    management:["Benzodiazepine Ù„Ù„ØªÙ‚Ù„ÙŠÙ„","Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ØµÙŠØ± Ø§Ù„Ù…Ø¯Ù‰"],
    reduce:"Ù„Ø§ ÙŠÙØ¶Ù„ Ø§Ù„ØªØ³Ø±ÙŠØ¨ Ø§Ù„Ù…Ø³ØªÙ…Ø±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù‚Ù„ Ø¬Ø±Ø¹Ø© ÙØ¹Ù‘Ø§Ù„Ø©."
  },
  "Dexmedetomidine":{
    dose:{ infant:[0.5,1.0], child:[1.0,2.0], adult:1.0 }, // Âµg/kg
    max:{value:200,unit:'Âµg'}, unitPerKg:'Âµg/kg',
    side_effects:["Ø¨Ø·Ø¡ Ù‚Ù„Ø¨","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"],
    management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ù„Ø¨ÙŠØ©","Ø¹Ù„Ø§Ø¬ Ø¯Ø§Ø¹Ù… Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©"],
    reduce:"Ø®ÙØ¶ Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªØºÙ†Ø§Ø¡ Ø¹Ù†Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø¶Ø¹ÙØ§Ø¡."
  },
  "Isoflurane":{
    dose:{ infant:[1.3,1.6], child:[1.3,1.6], adult:1.45 },
    max:{value:100,unit:'%MAC'}, unitPerKg:'%MAC',
    side_effects:["Ù‡Ø¨ÙˆØ· Ø¶ØºØ·","ÙƒØ¨Øª ØªÙ†ÙØ³ÙŠ"],
    management:["ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ¯Ø¹Ù… ØªÙ†ÙØ³ÙŠ"],
    reduce:"Ø§Ø¨Ø¯Ø£ Ø¨MAC Ù…Ù†Ø®ÙØ¶ ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆÙ‚Ù„Ù„ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹."
  },
  "Succinylcholine":{
    dose:{ infant:[1,2], child:[1,2], adult:1.5 },
    max:{value:200,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["Hyperkalemia","Malignant Hyperthermia (Ù†Ø§Ø¯Ø±)"],
    management:["ØªÙ‡ÙˆÙŠØ© Ø§ØµØ·Ù†Ø§Ø¹ÙŠØ©","Dantrolene Ø¹Ù†Ø¯ MH"],
    reduce:"ØªØ¬Ù†Ù‘Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…Ø¹Ø±Ø¶ÙŠÙ† Ù„Ø®Ø·Ø± Hyperkalemia."
  },
  "Lidocaine":{
    dose:{ infant:[1,2], child:[2,3], adult:3 },
    max:{value:300,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["ØªØ´Ù†Ø¬Ø§Øª","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"],
    management:["Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø±ÙŠØ¨ØŒ Benzodiazepine Ù„Ù„ØªØ´Ù†Ø¬Ø§Øª"],
    reduce:"Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ mg Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø¬Ø±Ø¹Ø§Øª Ù…ÙˆØ¶Ø¹ÙŠØ©/Ù…Ø±ÙƒØ²Ø© ÙˆØªØ®ÙÙŠØ¶ Ø¹Ù†Ø¯ Ø¶Ø¹Ù Ø§Ù„ÙƒØ¨Ø¯."
  },
  "Bupivacaine":{
    dose:{ infant:[1,2], child:[2,2], adult:2 },
    max:{value:200,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["Ø³Ù…ÙŠØ© Ù‚Ù„Ø¨ÙŠØ©","ØªØ´Ù†Ø¬Ø§Øª"],
    management:["Intralipid 20%ØŒ Ø¯Ø¹Ù… Ù‚Ù„Ø¨/ØªÙ†ÙØ³"],
    reduce:"Ø§Ø³ØªØ¹Ù…Ù„ Ø£Ù‚Ù„ ØªØ±ÙƒÙŠØ² ÙˆÙƒÙ…ÙŠØ© ÙƒØ§ÙÙŠØ© ÙˆØªØ¬Ù†Ù‘Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©."
  }
};

/* populate drug select */
const drugSelect = document.getElementById('drugDose');
Object.keys(drugData).forEach(name=>{
  const opt = document.createElement('option'); opt.value = name; opt.textContent = name; drugSelect.appendChild(opt);
});

/* UI toggles for diseaseDiv */
document.getElementById('patientHealth').addEventListener('change',(e)=>{
  document.getElementById('diseaseDiv').style.display = e.target.value === 'unhealthy' ? 'block' : 'none';
  if(e.target.value === 'healthy') document.querySelectorAll('.diseaseChk').forEach(c=>c.checked=false);
});

/* ========== Utility functions ========= */
function toYears(val, unit){
  const v = parseFloat(val);
  if(isNaN(v) || v < 0) return NaN;
  if(unit === 'years') return v;
  if(unit === 'months') return v/12;
  if(unit === 'days') return v/365;
  return v;
}
function ageCategory(years){
  if(years < 1) return 'infant';
  if(years < 12) return 'child';
  return 'adult';
}
function avgDose(dv){ return Array.isArray(dv) ? (dv[0]+dv[1])/2 : dv; }

/* ASA & disease factors (conservative) */
const asaFactors = { I:1.00, II:0.95, III:0.85, IV:0.75, V:0.65 };
const diseaseFactors = { diabetes:0.95, heart:0.8, lung:0.85, liver:0.7, kidney:0.75, allergy:0.9, obesity:1.05 };

/* ========== Calculation core ========== */
function calculateTotalDose(drugName, weightKg, ageYears, asaClass, diseases){
  const doc = drugData[drugName];
  if(!doc) return null;
  const cat = ageCategory(ageYears);
  const perKg = avgDose(doc.dose[cat]);
  if(doc.unitPerKg === '%MAC'){
    let factor = asaFactors[asaClass] || 1.0;
    diseases.forEach(d => { if(diseaseFactors[d]) factor *= diseaseFactors[d]; });
    return { value: (perKg * factor).toFixed(2), unit: '% MAC', note: 'ØªØ±ÙƒÙŠØ² ØºØ§Ø²ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ' };
  }
  let total = perKg * weightKg;
  total *= (asaFactors[asaClass] || 1.0);
  diseases.forEach(d => { if(diseaseFactors[d]) total *= diseaseFactors[d]; });
  if(doc.max && typeof doc.max.value === 'number' && total > doc.max.value) total = doc.max.value;
  return { value: total, unitPerKg: doc.unitPerKg, unitTotal: (doc.max && doc.max.unit) ? doc.max.unit : (doc.unitPerKg.includes('Âµg') ? 'Âµg' : 'mg') };
}

function formatDose(calc){
  if(!calc) return 'Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨';
  if(calc.unit === '% MAC') return `${calc.value} ${calc.unit}`;
  let v = parseFloat(calc.value);
  if(isNaN(v)) return 'Ø®Ø·Ø£';
  const unit = calc.unitTotal || (calc.unitPerKg && calc.unitPerKg.includes('Âµg') ? 'Âµg' : 'mg');
  if(unit === 'Âµg') v = Math.round(v);
  else if(v < 10) v = v.toFixed(2);
  else v = v.toFixed(1);
  return `${v} ${unit}`;
}

/* ========== Save history to Firestore ========== */
async function saveHistory(entry){
  try{
    const col = collection(db,'history');
    await addDoc(col, { ...entry, createdAt: serverTimestamp() });
  }catch(err){
    console.error('saveHistory err',err);
  }
}

/* ========== Button handlers: Dose calculation ========== */
document.getElementById('calcDose').addEventListener('click', async ()=>{
  // inputs
  const pname = document.getElementById('patientNameDose').value.trim();
  const weight = parseFloat(document.getElementById('weightDose').value);
  const ageVal = parseFloat(document.getElementById('ageDose').value);
  const ageUnit = document.getElementById('ageUnitDose').value;
  const asa = document.getElementById('asaSelect').value;
  const drug = drugSelect.value;
  if(!weight || !ageVal || !drug){
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… (Ù…ÙØ¶Ù„)ØŒ Ø§Ù„ÙˆØ²Ù†ØŒ Ø§Ù„Ø¹Ù…Ø±ØŒ ÙˆØ§Ù„Ø¯ÙˆØ§Ø¡');
    return;
  }
  const ageYears = toYears(ageVal, ageUnit);
  const diseases = [];
  if(document.getElementById('patientHealth').value === 'unhealthy'){
    document.querySelectorAll('.diseaseChk:checked').forEach(ch=>diseases.push(ch.value));
  }
  const calc = calculateTotalDose(drug, weight, ageYears, asa, diseases);
  const display = formatDose(calc);

  // show
  const rEl = document.getElementById('doseResult');
  rEl.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap">
    <span class="pill">${drug}</span><span class="pill">ÙˆØ²Ù†: ${weight} ÙƒØº</span><span class="pill">Ø¹Ù…Ø±: ${ageVal} ${ageUnit}</span><span class="pill">ASA: ${asa}</span>
    </div>
    <div style="margin-top:10px;font-weight:700;font-size:1.1rem;color:var(--accent)">Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©: ${display}</div>
    <div style="margin-top:6px;color:#bfe8ff">Ø·Ø±ÙŠÙ‚Ø© ØªØ®ÙÙŠÙ/Ù…Ù„Ø§Ø­Ø¸Ø©: ${drugData[drug].reduce || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø©'}</div>`;

  // side effects & management
  const ddata = drugData[drug];
  let effHTML = '';
  ddata.side_effects.forEach((se,i)=> effHTML += `<div class="sideEffect"><b>Ø¹Ø±Ø¶ Ø¬Ø§Ù†Ø¨ÙŠ:</b> ${se}<br><b>Ø§Ù„ØªØ¹Ø§Ù…Ù„:</b> ${ddata.management[i] || 'ØªØ¯Ø¨ÙŠØ± Ø¯Ø§Ø¹Ù…'}</div>`);
  document.getElementById('doseEffects').innerHTML = effHTML;

  // Save history (if logged in)
  const user = auth.currentUser;
  if(user){
    await saveHistory({
      type: 'dose',
      patientName: pname || null,
      inputs: { weight, ageVal, ageUnit, asa, diseases, drug },
      result: display,
      uid: user.uid,
      userEmail: user.email
    });
  }
});

/* ========== Fluids calculation ========== */
document.getElementById('calcFluids').addEventListener('click', async ()=>{
  const pname = document.getElementById('patientNameFluid').value.trim();
  const w = parseFloat(document.getElementById('weightFluid').value);
  const ageVal = parseFloat(document.getElementById('ageFluid').value) || 30;
  const ageUnit = document.getElementById('ageUnitFluid').value;
  const ftype = document.getElementById('fluidType').value;
  if(!w){ alert('Ø£Ø¯Ø®Ù„ ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶'); return; }
  const ageYears = toYears(ageVal, ageUnit);
  // simplified maintenance
  let maintenance;
  if(ageYears < 1) maintenance = 100 * w;
  else if(ageYears < 10) maintenance = 50 * w;
  else maintenance = 30 * w;
  // fluid adjustments by type (very simplified)
  let factor = 1.0;
  let note = '';
  if(ftype === 'RL'){ factor = 1.02; note = 'Ringer Lactate slightly different electrolyte composition.'; }
  if(ftype === 'D5W'){ factor = 0.9; note = 'D5W not ideal for replacement; only free water.'; }
  if(ftype === 'PRBC'){ factor = 1.0; note = 'PRBC ÙˆØ§Ø­Ø¯ = ~300ml (ØªÙ‚Ø¯ÙŠØ±ÙŠ)'; }
  const maintenanceAdj = Math.round(maintenance * factor);
  const bloodVol = Math.round((ageYears < 1 ? 85 : (ageYears < 10 ? 80 : 70)) * w);
  document.getElementById('fluidResult').innerHTML = `<div><b>ØµÙŠØ§Ù†Ø© (24h) - ${ftype}:</b> ${maintenanceAdj} ml</div>
    <div style="margin-top:6px"><b>Ø­Ø¬Ù… Ø¯Ù… ØªÙ‚Ø±ÙŠØ¨ÙŠ:</b> ${bloodVol} ml</div><div class="muted">${note}</div>`;

  // save history
  const user = auth.currentUser;
  if(user){
    await saveHistory({
      type:'fluids',
      patientName: pname || null,
      inputs:{ weight:w, ageVal, ageUnit, fluidType: ftype },
      result: {maintenance:maintenanceAdj, bloodVol},
      uid:user.uid, userEmail:user.email
    });
  }
});

/* ========== Airway calculation ========== */
document.getElementById('calcAirway').addEventListener('click', async ()=>{
  const pname = document.getElementById('patientNameAirway').value.trim();
  const ageVal = parseFloat(document.getElementById('ageAirway').value);
  const ageUnit = document.getElementById('ageUnitAirway').value;
  const weight = parseFloat(document.getElementById('weightAirway').value) || null;
  if(!ageVal){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø±'); return; }
  const ageYears = toYears(ageVal, ageUnit);
  let blade = '', ett = '';
  if(ageYears < 1){ blade='Blade 0-1 (Neonate/Infant)'; ett='3.0 - 3.5 mm'; }
  else if(ageYears < 5){ blade='Blade 1-2 (Pediatric)'; ett='4.0 - 4.5 mm'; }
  else if(ageYears < 10){ blade='Blade 2 (Pediatric)'; ett='5.0 - 5.5 mm'; }
  else { blade='Adult blade (3-4)'; ett='6.0 - 8.0 mm'; }
  let ettByAge = '';
  if(ageYears>=1 && ageYears < 12){ const e = Math.floor(ageYears/4 + 4); ettByAge=`Ø·Ø±ÙŠÙ‚Ø© Ø³Ø±ÙŠØ¹Ø© ETT (uncuffed): ${e}.0 mm`; }
  document.getElementById('airwayResult').innerHTML = `<div><b>Ø´ÙØ±Ø© Ù…Ù‚ØªØ±Ø­Ø©:</b> ${blade}</div>
    <div style="margin-top:6px"><b>ETT Ù…Ù‚ØªØ±Ø­:</b> ${ett} ${ettByAge}</div>
    <div style="margin-top:8px;color:#bfe8ff">ØªØ°ÙƒÙ‘Ø± ØªØ¬Ù‡ÙŠØ² Ù…Ù‚Ø§Ø³Ø§Øª Ø£ÙƒØ¨Ø±/Ø£ØµØºØ± ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ø³Ø±ÙŠØ±ÙŠØ§Ù‹.</div>`;

  // save history
  const user = auth.currentUser;
  if(user){
    await saveHistory({
      type:'airway',
      patientName: pname || null,
      inputs:{ ageVal, ageUnit, weight },
      result:{ blade, ett },
      uid:user.uid, userEmail:user.email
    });
  }
});

/* ========== CHAT placeholders (local) ========== */
function setupChat(btnId, chatId, inputId){
  document.getElementById(btnId).addEventListener('click', ()=>{
    const txt = document.getElementById(inputId).value.trim();
    if(!txt) return;
    const cb = document.getElementById(chatId);
    cb.innerHTML += `<div style="margin-bottom:6px"><b>Ø£Ù†Øª:</b> ${txt}</div>`;
    document.getElementById(inputId).value='';
    cb.innerHTML += `<div style="margin-bottom:6px;color:#bfe9ff"><b>Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø±Ø¯ ØªØ¬Ø±ÙŠØ¨ÙŠ):</b> ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© Ø³Ø±ÙŠØ±ÙŠÙ‹Ø§. Ø§Ù„Ø®Ø§ØµÙŠØ© ØºÙŠØ± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€OpenAI ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©.</div>`;
    cb.scrollTop = cb.scrollHeight;
  });
}
setupChat('doseChatSend','doseChat','doseChatInput');
setupChat('fluidChatSend','fluidChat','fluidChatInput');
setupChat('airwayChatSend','airwayChat','airwayChatInput');

/* ========== Scanner (camera) â€” Ù…Ø­Ø§ÙƒØ§Ø© + ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ø±Ø¨Ø· OCR Ø­Ù‚ÙŠÙ‚ÙŠ ) ========== */
const scannerModal = document.getElementById('scannerModal');
const scannerVideo = document.getElementById('scannerVideo');
const captureBtn = document.getElementById('captureBtn');
const closeScanner = document.getElementById('closeScanner');
const scanResult = document.getElementById('scanResult');
let streamRef = null;

document.getElementById('scanBagBtn').addEventListener('click', async ()=>{
  openScanner();
});
document.getElementById('showScanner').addEventListener('click', async ()=> openScanner());

async function openScanner(){
  try{
    scannerModal.style.display='flex';
    // request camera
    streamRef = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
    scannerVideo.srcObject = streamRef;
  }catch(err){
    alert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err.message);
    scannerModal.style.display='none';
  }
}
captureBtn.addEventListener('click', ()=>{
  // take snapshot and perform mock analysis
  const v = scannerVideo;
  const canvas = document.createElement('canvas');
  canvas.width = v.videoWidth; canvas.height = v.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(v,0,0,canvas.width,canvas.height);
  const dataURL = canvas.toDataURL('image/png');
  // For true OCR: integrate Tesseract.js (client-side) or call a cloud OCR API with the dataURL.
  // Here: we'll simulate extraction and present a safe recommendation.
  scanResult.innerHTML = `<div><b>ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© â€” ØªØ­Ù„ÙŠÙ„ (Ù…Ø­Ø§ÙƒØ§Ø©)</b></div>
    <div style="margin-top:8px">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ù†Øµ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© (Ù…Ø­Ø§ÙƒØ§Ø©). Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„ÙŠØ³Øª ØªØ´Ø®ÙŠØµÙ‹Ø§. Ø£Ù†ØµØ­ Ø¨Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„ØµÙ‚ Ø§Ù„ÙƒÙŠØ³ ÙŠØ¯ÙˆÙŠØ§Ù‹.</div>
    <div style="margin-top:8px;font-weight:700">Ø§Ù‚ØªØ±Ø§Ø­ Ø£Ù…Ù†ÙŠ:</div>
    <ul style="margin-top:6px">
      <li>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©ØŒ Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©.</li>
      <li>ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø§ÙŠÙ† Ø£Ùˆ Ø§Ù„Ø´Ùƒ â€” Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…ÙˆØ±Ø¯ ÙˆØ±Ø§Ø¬Ø¹ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©.</li>
    </ul>
    <div style="margin-top:8px"><img src="${dataURL}" style="width:120px;border-radius:6px"/></div>`;
});

closeScanner.addEventListener('click', ()=>{
  stopScanner();
});
function stopScanner(){
  scannerModal.style.display='none';
  if(streamRef){ streamRef.getTracks().forEach(t=>t.stop()); streamRef=null; scannerVideo.srcObject=null; scanResult.innerHTML=''; }
}

/* ========== AUTH: mandatory login flow ========== */


/* ========== Owner: manage users and ban/unban ========= */
async function populateUsersList(){
  const ul = document.getElementById('usersList');
  ul.innerHTML = '<div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  // get users from Firestore users collection
  const q = query(collection(db,'users'), orderBy('email','asc'));
  const snaps = await getDocs(q);
  ul.innerHTML = '';
  for(const s of snaps.docs){
    const data = s.data();
    const row = document.createElement('div');
    row.style.padding='8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    row.innerHTML = `<div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
      <div><strong>${data.email}</strong><div class="muted">UID: ${data.uid} â€” Role: ${data.role || 'user'}</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" onclick="toggleBan('${data.uid}','${data.email}')">Ø­Ø¸Ø±/Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn ghost" onclick="setRole('${data.uid}','user')">Ø§Ø¬Ø¹Ù„ Ù…Ø³ØªØ®Ø¯Ù…</button>
        <button class="btn ghost" onclick="setRole('${data.uid}','owner')">Ø§Ø¬Ø¹Ù„ Ù…Ø§Ù„Ùƒ</button>
      </div>
    </div>`;
    ul.appendChild(row);
  }
}
window.populateUsersList = populateUsersList;

async function toggleBan(uid,email){
  const bannedRef = doc(db,'banned',uid);
  const bb = await getDoc(bannedRef);
  if(bb.exists()){
    // unban
    await setDoc(bannedRef, { banned:false, uid }, { merge:true });
    alert(`${email} ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±`);
  } else {
    await setDoc(bannedRef, { banned:true, uid, by: auth.currentUser ? auth.currentUser.email : null, createdAt: serverTimestamp() });
    alert(`${email} ØªÙ… Ø­Ø¸Ø±Ù‡`);
  }
  populateUsersList();
}

async function setRole(uid,role){
  await setDoc(doc(db,'users',uid), { role }, { merge:true });
  alert('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
  populateUsersList();
}

/* ========== History (owner panel) - simple search ========= */
async function populateHistory(qStr=''){
  const container = document.getElementById('historyList');
  container.innerHTML = '<div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  let q;
  if(qStr && qStr.trim().length){
    // naive: fetch last 200 and filter client-side
    const snaps = await getDocs(query(collection(db,'history'), orderBy('createdAt','desc'), limit(200)));
    const list = snaps.docs.map(d=>({id:d.id, ...d.data()})).filter(item => {
      const s = JSON.stringify(item).toLowerCase();
      return s.includes(qStr.toLowerCase());
    });
    renderHistoryList(list);
    return;
  } else {
    const snaps = await getDocs(query(collection(db,'history'), orderBy('createdAt','desc'), limit(100)));
    const list = snaps.docs.map(d=>({id:d.id, ...d.data()}));
    renderHistoryList(list);
  }
}
function renderHistoryList(list){
  const container = document.getElementById('historyList');
  container.innerHTML = '';
  if(!list || !list.length) { container.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</div>'; return; }
  list.forEach(item=>{
    const el = document.createElement('div');
    el.style.padding='8px'; el.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    el.innerHTML = `<div style="display:flex;gap:12px;justify-content:space-between">
      <div><strong>${item.type.toUpperCase()} â€” ${item.patientName||'â€”'}</strong>
        <div class="muted">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${item.userEmail||'â€”'} â€” ${item.createdAt ? new Date(item.createdAt.seconds*1000).toLocaleString() : ''}</div>
        <div class="muted">Ù…Ø¯Ø®Ù„Ø§Øª: ${JSON.stringify(item.inputs)}</div>
      </div>
      <div style="text-align:left"><b>Ù†ØªÙŠØ¬Ø©:</b><div>${JSON.stringify(item.result)}</div></div>
    </div>`;
    container.appendChild(el);
  });
}

/* wire history search */
document.getElementById('btnSearchHistory').addEventListener('click', ()=> populateHistory(document.getElementById('searchHistory').value.trim()));
document.getElementById('btnRefreshUsers').addEventListener('click', ()=> populateUsersList());

/* show default panel */
showPanel('panelDose');

/* ========== Simple UI: Auto create owner account (OPTIONAL helper) =========
   If you want to ensure an owner account exists with given credentials, you can run below.
   WARNING: This will attempt to create an account with the known owner password if not exists.
   For security, disable in production or require manual creation.
*/
async function ensureOwnerExists(){
  try{
    const methods = await fetchSignInMethodsForEmail(auth, OWNER_EMAIL);
    if(!methods || !methods.length){
      // create user with provided password (careful)
      await createUserWithEmailAndPassword(auth, OWNER_EMAIL, OWNER_DEFAULT_PASS);
      alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ). Ø§Ù„Ø¢Ù† Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
    }
  }catch(err){
    console.warn('ensureOwnerExists err',err);
  }
}
// Uncomment if you want auto-create owner during dev
// ensureOwnerExists();

/* ========== Simple populate initial UI when auth ready ========= */
onAuthStateChanged(auth, user => {
  if(user){
    document.getElementById('userInfo').textContent = `${user.email}`;
    // populate owner controls if role owner
    (async ()=>{
      const udoc = await getDoc(doc(db,'users',user.uid));
      const role = udoc.exists() ? udoc.data().role : (user.email === OWNER_EMAIL ? 'owner' : 'user');
      if(role === 'owner') { document.getElementById('ownerControls').style.display='block'; populateUsersList(); populateHistory(); }
      else document.getElementById('ownerControls').style.display='none';
    })();
  }
});

/* ========== Simple page-ready message ========== */
console.log('ANS Anesthesia app loaded.');

/* ================== End of module ================ */

// Functions for Admin Panel
function loadUsers(){
  const usersList = document.getElementById("usersList");
  usersList.innerHTML = "<p>Ù…ÙŠØ²Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªØªØ·Ù„Ø¨ Firebase Admin SDK (ÙŠØ´ØªØºÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙ‚Ø·).</p>";
}

function addDrug(){
  const name = document.getElementById("drugName").value;
  const dose = document.getElementById("drugDose").value;
  const side = document.getElementById("drugSide").value;
  const treatment = document.getElementById("drugTreatment").value;
  if(name && dose){
    const div = document.createElement("div");
    div.style.border = "1px solid #ddd";
    div.style.padding = "5px";
    div.style.marginTop = "5px";
    div.innerHTML = "<b>"+name+"</b> | Ø¬Ø±Ø¹Ø©: "+dose+" | Ø£Ø¹Ø±Ø§Ø¶: "+side+" | Ø¹Ù„Ø§Ø¬: "+treatment;
    document.getElementById("drugsList").appendChild(div);
  }
}

</script>
<script type="module">
// OpenAI API Key
const OPENAI_API_KEY = "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";

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ AI
async function callAI(message) {
  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [{ role: "user", content: message }]
    })
  });
  const data = await res.json();
  return data.choices[0].message.content;
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø´Ø§Øª Ù„ÙƒÙ„ Ù‚Ø³Ù…
function setupChat(btnId, chatId, inputId, section) {
  document.getElementById(btnId).addEventListener('click', async ()=>{
    const msg = document.getElementById(inputId).value.trim();
    if(!msg) return;
    const cb = document.getElementById(chatId);
    cb.innerHTML += `<div><b>Ø£Ù†Øª:</b> ${msg}</div>`;
    document.getElementById(inputId).value = '';
    cb.scrollTop = cb.scrollHeight;

    cb.innerHTML += `<div style="color:#aaa">â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø¯...</div>`;
    try {
      const reply = await callAI(`[${section}] ${msg}`);
      cb.innerHTML += `<div style="color:#bfe9ff"><b>AI:</b> ${reply}</div>`;
    } catch(e){
      cb.innerHTML += `<div style="color:red">âŒ Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>`;
    }
    cb.scrollTop = cb.scrollHeight;
  });
}

// Ø±Ø¨Ø· Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø£Ù‚Ø³Ø§Ù…
setupChat('doseChatSend','doseChat','doseChatInput','Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª');
setupChat('fluidChatSend','fluidChat','fluidChatInput','Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…');
setupChat('airwayChatSend','airwayChat','airwayChatInput','Ø§Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ & ETT');
</script>
  

<!-- Admin Panel -->
<div id="adminPanel" style="display:none; padding:20px; direction:rtl; font-family:Arial;">
  <h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ ğŸ”‘</h2>
  <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="adminEmail"></span></p>
  
  <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-top:20px;">
    
    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <div style="background:#fff; padding:15px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
      <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
      <button onclick="loadUsers()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
      <div id="usersList"></div>
    </div>
    
    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div style="background:#fff; padding:15px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
      <h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
      <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: <span id="totalUsers">0</span></p>
      <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©: <span id="totalCalculations">0</span></p>
    </div>
    
    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© -->
    <div style="background:#fff; padding:15px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
      <h3>ğŸ’Š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</h3>
      <input type="text" id="drugName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡"><br>
      <input type="text" id="drugDose" placeholder="Ø§Ù„Ø¬Ø±Ø¹Ø©"><br>
      <input type="text" id="drugSide" placeholder="Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©"><br>
      <input type="text" id="drugTreatment" placeholder="Ø§Ù„Ø¹Ù„Ø§Ø¬"><br>
      <button onclick="addDrug()">Ø¥Ø¶Ø§ÙØ©</button>
      <div id="drugsList"></div>
    </div>
    
  </div>
  
  <button onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>


<!-- Login Screen -->
<div id="loginScreen" style="display:none;position:fixed;inset:0;z-index:99999;align-items:center;justify-content:center;background:#071223;color:#fff;font-family:Tahoma">
  <div style="background:#0b3045;padding:20px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.6);width:320px;text-align:center">
    <h2 style="margin-bottom:16px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input id="loginEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="width:100%;margin-bottom:10px;padding:10px;border-radius:6px;border:none"><br>
    <input id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:100%;margin-bottom:16px;padding:10px;border-radius:6px;border:none"><br>
    <button id="loginBtn" class="btn" style="width:100%;margin-bottom:8px">Ø¯Ø®ÙˆÙ„</button>
    <button id="googleLoginBtn" class="btn" style="width:100%;margin-bottom:8px;background:#fff;color:#333">Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</button>
    <button id="goSignup" class="btn ghost" style="width:100%">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
  </div>
</div>


<!-- Signup Screen -->
<div id="signupScreen" style="display:none;position:fixed;inset:0;z-index:99999;align-items:center;justify-content:center;background:#071223;color:#fff;font-family:Tahoma">
  <div style="background:#0b3045;padding:20px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.6);width:320px;text-align:center">
    <h2 style="margin-bottom:16px">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
    <input id="signupEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="width:100%;margin-bottom:10px;padding:10px;border-radius:6px;border:none"><br>
    <input id="signupPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:100%;margin-bottom:16px;padding:10px;border-radius:6px;border:none"><br>
    <button id="signupBtn" class="btn" style="width:100%;margin-bottom:8px">ØªØ³Ø¬ÙŠÙ„</button>
    <button id="goLogin" class="btn ghost" style="width:100%">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

</body>

<script type="module">
  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø§Øª Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    GoogleAuthProvider, 
    signInWithPopup 
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { 
    getFirestore, 
    setDoc, 
    doc, 
    serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Config (Ù‚ÙŠÙ… Ù…Ø´Ø±ÙˆØ¹Ùƒ)
  const firebaseConfig = {
    apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
    authDomain: "anesthesia-dose-262e3.firebaseapp.com",
    projectId: "anesthesia-dose-262e3",
    storageBucket: "anesthesia-dose-262e3.firebasestorage.app",
    messagingSenderId: "602244448093",
    appId: "1:602244448093:web:0a8d9905849126086ff2b4",
    measurementId: "G-SCHMQFCK3J"
  };

  // ØªÙ‡ÙŠØ¦Ø© Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ
  const OWNER_EMAIL = "bama47686@gmail.com";
  const OWNER_PASS = "mustafa@2006#2";

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
  const loginScreen = document.getElementById("loginScreen");
  const signupScreen = document.getElementById("signupScreen");

  // ğŸ”„ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Login / Signup
  document.getElementById("goSignup").addEventListener("click", ()=>{
    loginScreen.style.display = "none";
    signupScreen.style.display = "flex";
  });
  document.getElementById("goLogin").addEventListener("click", ()=>{
    signupScreen.style.display = "none";
    loginScreen.style.display = "flex";
  });

  // ğŸ”‘ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ (Ø¥Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯ ÙŠÙ†Ø´Ø¦Ù‡)
  document.getElementById("loginBtn").addEventListener("click", async ()=>{
    const email = document.getElementById("loginEmail").value.trim();
    const pass = document.getElementById("loginPass").value.trim();

    try {
      let cred;
      try {
        cred = await signInWithEmailAndPassword(auth, email, pass);
      } catch(err) {
        if (err.code === "auth/user-not-found") {
          cred = await createUserWithEmailAndPassword(auth, email, pass);
        } else {
          throw err;
        }
      }

      const user = cred.user;
      let role = (email === OWNER_EMAIL) ? "owner" : "user";

      await setDoc(doc(db,'users',user.uid), {
        email:user.email,
        uid:user.uid,
        role,
        createdAt: serverTimestamp()
      }, { merge:true });

      loginScreen.style.display = "none";
      console.log("âœ… Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­");
      window.location.href = "/"; // ÙŠØ­ÙˆÙ„Ùƒ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    } catch(err) {
      console.error("âŒ Ø®Ø·Ø£:", err.message);
      alert("âŒ Ø®Ø·Ø£: " + err.message);
    }
  });

  // ğŸ”‘ Ø²Ø± Google Login
  document.getElementById("googleLoginBtn").addEventListener("click", async ()=>{
    try {
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      let role = (user.email === OWNER_EMAIL) ? "owner" : "user";

      await setDoc(doc(db,'users',user.uid), {
        email:user.email,
        uid:user.uid,
        role,
        createdAt: serverTimestamp()
      }, { merge:true });

      loginScreen.style.display = "none";
      console.log("âœ… Ø¯Ø®ÙˆÙ„ Google Ù†Ø§Ø¬Ø­");
      window.location.href = "/";
    } catch(err) {
      console.error("âŒ Google:", err.message);
      alert("âŒ Ø®Ø·Ø£ Google: " + err.message);
    }
  });

  // â• Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
  document.getElementById("signupBtn").addEventListener("click", async ()=>{
    const email = document.getElementById("signupEmail").value.trim();
    const pass = document.getElementById("signupPass").value.trim();

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      const user = cred.user;

      let role = (email === OWNER_EMAIL) ? "owner" : "user";

      await setDoc(doc(db,'users',user.uid), {
        email:user.email,
        uid:user.uid,
        role,
        createdAt: serverTimestamp()
      });

      signupScreen.style.display = "none";
      loginScreen.style.display = "none";
      console.log("âœ… Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡");
      window.location.href = "/";
    } catch(err) {
      console.error("âŒ Signup:", err.message);
      alert("âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: " + err.message);
    }
  });

/* ========== AUTH: mandatory login flow ========== */

// Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
const appWrap     = document.getElementById('app');
const loginScreen = document.getElementById('loginScreen');
const userInfoEl  = document.getElementById('userInfo');
const btnLogout   = document.getElementById('btnLogout');

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Firebase
import { 
  onAuthStateChanged, signInWithEmailAndPassword,
  createUserWithEmailAndPassword, signOut,
  fetchSignInMethodsForEmail, setDoc, doc, getDoc,
  serverTimestamp, collection, getDocs, orderBy, query
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø±
    const bannedDoc = await getDoc(doc(db, 'banned', user.uid)).catch(()=>null);
    if (bannedDoc && bannedDoc.exists()) {
      alert('ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
      await signOut(auth);
      return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    const userDocRef = doc(db,'users',user.uid);
    const ud = await getDoc(userDocRef);
    if (!ud.exists()) {
      const role = (user.email === OWNER_EMAIL) ? 'owner' : 'user';
      await setDoc(userDocRef, { email:user.email, role, uid:user.uid, createdAt: serverTimestamp() });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    userInfoEl.textContent = user.email;
    const role = (await getDoc(userDocRef)).data().role || (user.email === OWNER_EMAIL ? 'owner' : 'user');
    if (role === 'owner') {
      document.getElementById('ownerControls').style.display = 'block';
      document.getElementById('adminContent').innerHTML =
        `<div class="muted">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©.</div>`;
      populateUsersList();
      populateHistory();
    } else {
      document.getElementById('ownerControls').style.display = 'none';
      document.getElementById('adminContent').innerHTML =
        `<div class="muted">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·.</div>`;
    }

    loginScreen.style.display = 'none';
    appWrap.style.display = 'block';

  } else {
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
    await requireLogin();
  }
});

// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠ
async function requireLogin() {
  if (loginScreen) {
    loginScreen.style.display = 'flex';
    appWrap.style.display = 'none';
  } else {
    // ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…ØµÙ…Ù…Ø©
    const email = prompt('Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:');
    const pass  = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:');
    if (email && pass) {
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        alert('Ø®Ø·Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (err && err.message ? err.message : err));
      }
    }
  }
}

// Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
btnLogout.addEventListener('click', async () => {
  await signOut(auth);
});

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù…Ø§Ù„Ùƒ
async function populateUsersList(){
  const ul = document.getElementById('usersList');
  ul.innerHTML = '<div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  const snaps = await getDocs(query(collection(db,'users'), orderBy('email','asc')));
  ul.innerHTML = '';
  snaps.forEach(s => {
    const d = s.data();
    const row = document.createElement('div');
    row.style.padding='8px';
    row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    row.innerHTML = `<div style="display:flex;gap:12px;justify-content:space-between;align-items:center">
      <div><strong>${d.email}</strong>
        <div class="muted">UID: ${d.uid} â€” Role: ${d.role||'user'}</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn ghost" onclick="toggleBan('${d.uid}','${d.email}')">Ø­Ø¸Ø±/Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn ghost" onclick="setRole('${d.uid}','user')">Ø§Ø¬Ø¹Ù„ Ù…Ø³ØªØ®Ø¯Ù…</button>
        <button class="btn ghost" onclick="setRole('${d.uid}','owner')">Ø§Ø¬Ø¹Ù„ Ù…Ø§Ù„Ùƒ</button>
      </div>
    </div>`;
    ul.appendChild(row);
  });
}
window.populateUsersList = populateUsersList;

async function toggleBan(uid,email){
  const bannedRef = doc(db,'banned',uid);
  const bb = await getDoc(bannedRef);
  if (bb.exists()) {
    await setDoc(bannedRef, { banned:false, uid }, { merge:true });
    alert(`${email} ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±`);
  } else {
    await setDoc(bannedRef, { banned:true, uid, by: auth.currentUser ? auth.currentUser.email : null, createdAt: serverTimestamp() });
    alert(`${email} ØªÙ… Ø­Ø¸Ø±Ù‡`);
  }
  populateUsersList();
}

async function setRole(uid,role){
  await setDoc(doc(db,'users',uid), { role }, { merge:true });
  alert('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
  populateUsersList();
}
</script>

</html>
