<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ANS — نظام حسابات التخدير</title>
<style>
  body{margin:0;font-family:"Tahoma",system-ui;background:#0a1124;color:#e8f0ff}
  .hidden{display:none!important}
  .card{background:#0f1830;border:1px solid #1c2a4f;border-radius:16px;padding:14px;margin:10px 0}
  .btn{cursor:pointer;padding:10px 16px;border-radius:12px;border:0;font-weight:700}
  .btn-primary{background:#3aa6ff;color:#00122b}
  .btn-danger{background:#ff5470;color:#2b0010}
  input,textarea{background:#0b1633;color:#fff;border:1px solid #1c2a4f;border-radius:10px;padding:8px;width:100%;margin:6px 0}
  #toast{position:fixed;bottom:16px;left:16px;background:#10214a;color:#fff;padding:10px 14px;border-radius:10px;display:none}
</style>
</head>
<body>

<!-- شاشة الدخول -->
<div id="loginScreen">
  <div class="card" style="max-width:360px;margin:50px auto">
    <h3>تسجيل الدخول</h3>
    <input id="emailInput" type="email" placeholder="البريد" />
    <input id="passInput" type="password" placeholder="كلمة المرور" />
    <button class="btn btn-primary" id="loginBtn">دخول</button>
    <button class="btn btn-danger" id="googleBtn">Google</button>
    <div id="authError" style="color:#f88;margin-top:6px"></div>
  </div>
</div>

<!-- التطبيق -->
<div id="app" class="hidden" style="padding:16px">
  <div class="card">
    <h3>✅ تم الدخول</h3>
    <div id="userInfo"></div>
    <button class="btn btn-danger" id="logoutBtn">خروج</button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { 
  getAuth, setPersistence, browserSessionPersistence,
  onAuthStateChanged, signInWithEmailAndPassword,
  GoogleAuthProvider, signInWithPopup, signOut
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { 
  getFirestore, doc, setDoc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
  authDomain: "anesthesia-dose-262e3.firebaseapp.com",
  projectId: "anesthesia-dose-262e3",
  storageBucket: "anesthesia-dose-262e3.appspot.com", // ✅ الصحيح
  messagingSenderId: "602244448093",
  appId: "1:602244448093:web:0a8d9905849126086ff2b4",
  measurementId: "G-SCHMQFCK3J"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// اجبار استخدام sessionStorage
setPersistence(auth, browserSessionPersistence)
  .then(()=>console.log("✅ Persistence = sessionStorage"))
  .catch(console.error);

const loginScreen=document.getElementById("loginScreen");
const appEl=document.getElementById("app");
const userInfo=document.getElementById("userInfo");
const toastEl=document.getElementById("toast");
function toast(msg){toastEl.textContent=msg;toastEl.style.display="block";setTimeout(()=>toastEl.style.display="none",3000);}

// تسجيل الدخول
loginBtn.onclick=()=>{
  const email=emailInput.value.trim();
  const pass=passInput.value.trim();
  signInWithEmailAndPassword(auth,email,pass).catch(e=>{
    authError.textContent=e.message;
  });
};
googleBtn.onclick=async ()=>{
  const provider=new GoogleAuthProvider();
  try{ await signInWithPopup(auth,provider); }catch(e){ authError.textContent=e.message; }
};
logoutBtn.onclick=()=>signOut(auth);

// مراقبة المستخدم
onAuthStateChanged(auth, async (u)=>{
  console.log("✅ onAuthStateChanged رجّع:", u);

  if(!u){
    // إذا ماكو مستخدم → أظهر شاشة الدخول
    loginScreen.classList.remove("hidden");
    appEl.classList.add("hidden");
    authError.textContent = "⚠️ لم يتم تسجيل الدخول. افتح الرابط من Chrome/Safari (المضيف: " + location.host + ")";
    return;
  }

  // إذا دخل المستخدم
  const role = (u.email === "bama47686@gmail.com") ? "owner" : "user";
  await setDoc(doc(db,"users",u.uid), {
    uid:u.uid,
    email:u.email,
    role,
    banned:false
  }, {merge:true});

  const us = (await getDoc(doc(db,"users",u.uid))).data();
  if(us?.banned){
    authError.textContent = "❌ حسابك محظور";
    await signOut(auth);
    return;
  }

  currentUser = u;
  currentRole = role;
  userInfo.textContent = `${u.email} — Role: ${role}`;

  // تبديل الشاشات
  loginScreen.classList.add("hidden");
  appEl.classList.remove("hidden");
});
</script>
</body>
</html>
