<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø£ÙƒØ§Ø¯Ù…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</title>
<link rel="icon" href="" />
<style>
  :root{
    --bg1:#071024; --bg2:#0b2b3a; --card:#071a27; --accent:#0a5275;
    --glass: rgba(255,255,255,0.04);
    --text:#eaf6ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh;overflow-x:hidden}
  /* Top banner above bars */
  .top-banner{width:100%;padding:14px 12px;background:linear-gradient(90deg,#06314a,#0a5275);text-align:center;position:fixed;top:0;left:0;z-index:10000}
  .top-banner h2{margin:0;font-size:18px}
  .top-banner p{margin:4px 0 0;font-size:13px;opacity:.9}

  /* SPLASH */
  #splash{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:18px;background:linear-gradient(135deg,#071024 0%, #0b2b3a 70%);overflow:hidden}
  .bars-wrap{width:92%;max-width:1000px;display:flex;flex-direction:column;gap:12px;align-items:stretch;transform:translateY(0)}
  .bar{
    background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    padding:18px;border-radius:12px;color:#eaf6ff;display:flex;flex-direction:column;gap:4px;align-items:flex-start;
    transform-origin:center;box-shadow:0 8px 30px rgba(0,0,0,0.7);
  }
  .bar h3{margin:0;font-size:18px}
  .bar p{margin:0;font-size:13px;color:#cfeafd}
  /* hierarchy: top narrow, middle, bottom (developer as last) */
  .bar.top { transform:scale(.92); opacity:.9; animation:barOutUp 5s ease forwards; }
  .bar.mid { transform:scale(.97); opacity:.95; animation:barOutLeft 5s ease forwards; animation-delay:.05s; }
  .bar.bottom { transform:scale(1); font-weight:700; animation:barOutRight 5s ease forwards; animation-delay:.1s; }

  @keyframes barOutLeft { 0% { transform:translateX(0); opacity:1 } 70%{opacity:1} 100%{transform:translateX(-150%);opacity:0} }
  @keyframes barOutRight{ 0%{transform:translateX(0);opacity:1}70%{opacity:1}100%{transform:translateX(150%);opacity:0} }
  @keyframes barOutUp{ 0%{transform:translateY(0);opacity:1}70%{opacity:1}100%{transform:translateY(-120%);opacity:0} }

  .splash-note{color:#bfe6ff;opacity:0.95}

  /* decorative bubbles & glows */
  .decoration{position:fixed;inset:0;pointer-events:none;z-index:5}
  .bubble{position:absolute;border-radius:50%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.12), rgba(255,255,255,0.02));filter:blur(6px);opacity:.5;animation:floatY linear infinite}
  @keyframes floatY{0%{transform:translateY(0)}50%{transform:translateY(-40px)}100%{transform:translateY(0)}}
  .glow{position:absolute;border-radius:50%;background:radial-gradient(circle, rgba(255,255,255,0.06), rgba(255,255,255,0));filter:blur(40px);opacity:.7;mix-blend-mode:screen}

  /* APP */
  #app{display:none;position:relative;z-index:10;padding:100px 28px 56px;max-width:1200px;margin:36px auto}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;box-shadow:0 18px 50px rgba(2,6,23,0.7);color:var(--text)}
  h1{margin:0 0 12px;text-align:center;color:var(--accent)}
  .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#0ea5a5,#0a5275);color:#fff;cursor:pointer;min-width:140px}
  .controls-row{display:flex;gap:8px;align-items:center}
  label{display:block;text-align:right;margin:6px 0;color:#dff6ff}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.015);color:var(--text)}
  .muted{color:#cfe8f7;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
  .result-box{background:rgba(0,0,0,0.25);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .pill{display:inline-block;padding:6px 10px;background:rgba(255,255,255,0.03);border-radius:999px;margin:6px 6px 0 0;color:#dff6ff;font-weight:600}
  .sideEffect{background:rgba(255,70,90,0.06);border-left:4px solid rgba(255,70,90,0.9);padding:10px;margin:8px 0;border-radius:8px;color:#ffecec}
  .chatBox{height:140px;overflow:auto;padding:10px;background:rgba(255,255,255,0.01);border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  footer{margin-top:14px;text-align:center;color:#93c1d8;font-size:13px}

  /* modals */
  .modal{position:fixed;inset:0;background:rgba(1,6,12,0.6);display:flex;align-items:center;justify-content:center;z-index:20000}
  .modal .box{background:#07182a;padding:18px;border-radius:10px;max-width:860px;width:92%;color:var(--text)}

  /* responsive tweaks */
  @media (max-width:720px){
    #app{padding:80px 12px}
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<!-- Top banner -->
<div class="top-banner">
  <h2>Ø£ÙƒØ§Ø¯Ù…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â˜†</h2>
  <p>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</p>
</div>

<!-- SPLASH -->
<div id="splash" aria-hidden="false">
  <div class="bars-wrap">
    <div class="bar top">
      <h3>Ø´Ø±ÙŠØ· Ù€ Ø£ÙˆÙ„ (ØªÙ†Ø¸ÙŠÙ…)</h3>
      <p>Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ± â€” Ù…Ù†Ø¸Ù… â€” @871c</p>
    </div>
    <div class="bar mid">
      <h3>Ø´Ø±ÙŠØ· Ù€ Ø«Ø§Ù†ÙŠ (ØªÙ†Ø¸ÙŠÙ…)</h3>
      <p>Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰ â€” Ù…Ù†Ø¸Ù… â€” @ans_mz1092</p>
    </div>
    <div class="bar bottom">
      <h3>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</h3>
      <p>Ù…Ù†Ø¸Ù… Ùˆ Ù…Ø·ÙˆØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” @ku56t</p>
    </div>
  </div>
  <div class="splash-note">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” Ø³ØªÙ†ØªÙ‚Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø­Ø±ÙƒØ©</div>
  <!-- small decorations -->
  <div style="position:absolute;inset:0;pointer-events:none">
    <div style="position:absolute;left:6%;top:20%;width:14px;height:14px;background:rgba(255,255,255,0.12);border-radius:50%;filter:blur(6px);animation:floatY 6s infinite;"></div>
    <div style="position:absolute;right:10%;top:35%;width:18px;height:18px;background:rgba(255,255,255,0.08);border-radius:50%;filter:blur(10px);animation:floatY 8s infinite;"></div>
  </div>
</div>

<!-- decoration layers -->
<div class="decoration" aria-hidden="true">
  <div class="bubble" style="left:6%;top:12%;width:160px;height:160px;animation-duration:10s"></div>
  <div class="bubble" style="left:78%;top:22%;width:120px;height:120px;animation-duration:12s"></div>
  <div class="bubble" style="left:22%;top:72%;width:90px;height:90px;animation-duration:9s"></div>
  <div class="bubble" style="left:68%;top:80%;width:140px;height:140px;animation-duration:11s"></div>
  <div class="glow" style="left:2%;top:72%;width:240px;height:240px;opacity:0.35"></div>
  <div class="glow" style="right:2%;top:60%;width:300px;height:300px;opacity:0.20"></div>
</div>

<!-- APP -->
<div id="app" aria-hidden="true">
  <div class="card">
    <h1>ğŸš‘ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ â€” Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</h1>

    <div class="row">
      <button class="btn" id="showDose">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</button>
      <button class="btn" id="showFluids">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</button>
      <button class="btn" id="showAirway">Ø§Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ & ETT</button>
      <button class="btn" id="showAdmin">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      <button class="btn" id="toggleTheme">ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ†/Ù†Ù‡Ø§Ø±ÙŠ</button>
      <button class="btn" id="aboutBtn">Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
      <div style="flex:1"></div>
      <div id="userArea" style="display:flex;gap:8px;align-items:center"></div>
    </div>

    <!-- ======= Dose panel ======= -->
    <div id="panelDose" class="panel">
      <h2 style="margin-top:0">ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ±</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
            <input id="patientNameDose" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
          </label>
          <label>ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØº)
            <input id="weightDose" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 70" min="0" step="0.1">
          </label>
          <label>Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
            <div style="display:flex;gap:8px">
              <input id="ageDose" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 40" min="0" step="0.1" style="flex:1">
              <select id="ageUnitDose" style="width:120px">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>ØªØµÙ†ÙŠÙ ASA
            <select id="asaSelect">
              <option value="I">ASA I</option>
              <option value="II">ASA II</option>
              <option value="III">ASA III</option>
              <option value="IV">ASA IV</option>
              <option value="V">ASA V</option>
            </select>
          </label>

          <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
            <select id="patientHealth">
              <option value="healthy">ØµØ­ÙŠ</option>
              <option value="unhealthy">Ù…Ø±ÙŠØ¶ (Ø£Ù…Ø±Ø§Ø¶ Ù…ØªØ¹Ø¯Ø¯Ø©)</option>
            </select>
          </label>

          <div id="diseaseDiv" style="display:none;margin-top:8px">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø¶)
              <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">
                <label><input type="checkbox" class="diseaseChk" value="diabetes"> Ø³ÙƒØ±ÙŠ</label>
                <label><input type="checkbox" class="diseaseChk" value="heart"> Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨ÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="lung"> Ø£Ù…Ø±Ø§Ø¶ Ø±Ø¦ÙˆÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="liver"> Ø£Ù…Ø±Ø§Ø¶ ÙƒØ¨Ø¯ÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="kidney"> Ø£Ù…Ø±Ø§Ø¶ ÙƒÙ„ÙˆÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="allergy"> ØªØ­Ø³Ø³</label>
                <label><input type="checkbox" class="diseaseChk" value="obesity"> Ø³Ù…Ù†Ø© Ù…ÙØ±Ø·Ø©</label>
              </div>
            </label>
          </div>

          <label>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡
            <select id="drugDose"></select>
          </label>

          <div style="margin-top:10px" class="controls-row">
            <button class="btn" id="calcDose">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
            <div class="small-muted" style="margin-left:10px">Ø§Ù„Ù†ØªÙŠØ¬Ø© ØªØ£Ø®Ø° Ø¨Ø§Ù„Ø¹Ù…Ø± ÙˆØ§Ù„ASA ÙˆØ§Ù„Ø£Ù…Ø±Ø§Ø¶</div>
          </div>
        </div>

        <div>
          <div id="doseResult" class="result-box muted"><b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</b></div>
          <div id="doseEffects" style="margin-top:12px"></div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.05);margin:16px 0">

      <h3 style="margin-bottom:8px">ğŸ’¬ Ø´Ø§Øª AI Ø·Ø¨ÙŠ (Ù…Ø­Ù„ÙŠ)</h3>
      <div class="chatBox" id="doseChat"></div>
      <textarea id="doseChatInput" placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø£Ùˆ Ø§Ù„Ø¢Ø«Ø§Ø±..." style="margin-top:8px"></textarea>
      <div style="margin-top:8px"><button class="btn" id="doseChatSend">Ø£Ø±Ø³Ù„</button></div>
    </div>

    <!-- ======= Fluids panel ======= -->
    <div id="panelFluids" class="panel">
      <h2>ğŸ’§ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
            <input id="patientNameFluid" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
          </label>
          <label>ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØº)
            <input id="weightFluid" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 70" min="0" step="0.1">
          </label>
          <label>Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
            <div style="display:flex;gap:8px">
              <input id="ageFluid" type="number" min="0" step="0.1" style="flex:1">
              <select id="ageUnitFluid" style="width:120px">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„
            <select id="fluidType">
              <option value="crystalloid">Crystalloid (NS, LR)</option>
              <option value="colloid">Colloid (Albumin)</option>
              <option value="blood">Ø¯Ù… ÙƒØ§Ù…Ù„ / Ø¨Ù„Ø§Ø²Ù…Ø§</option>
            </select>
          </label>

          <div style="margin-top:8px" class="controls-row">
            <button class="btn" id="calcFluids">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„/Ø§Ù„Ø¯Ù…</button>
            <div class="small-muted" style="margin-left:8px">ØªÙ‚Ø¯ÙŠØ± ØªÙ‚Ø±ÙŠØ¨ÙŠ</div>
          </div>
        </div>

        <div>
          <div id="fluidResult" class="result-box muted">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
        </div>
      </div>
    </div>

    <!-- ======= Airway panel ======= -->
    <div id="panelAirway" class="panel">
      <h2>ğŸ« Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ Ùˆ ETT</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
            <input id="patientNameAirway" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
          </label>
          <label>Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
            <div style="display:flex;gap:8px">
              <input id="ageAirway" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 3" min="0" step="0.1" style="flex:1">
              <select id="ageUnitAirway" style="width:120px">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØº)
            <input id="weightAirway" type="number" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" min="0" step="0.1">
          </label>

          <div style="margin-top:8px" class="controls-row">
            <button class="btn" id="calcAirway">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</button>
            <div class="small-muted" style="margin-left:8px">Ø­Ø³Ø§Ø¨ ØªÙ‚Ø±ÙŠØ¨ÙŠ</div>
          </div>
        </div>

        <div>
          <div id="airwayResult" class="result-box muted">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
        </div>
      </div>
    </div>

    <!-- ======= Admin panel ======= -->
    <div id="panelAdmin" class="panel">
      <h2>âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… (Admin)</h2>

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="min-width:320px;flex:1">
          <label>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø§Ù„Ùƒ (Email/Password Ø£Ùˆ Google)</label>
          <div style="display:flex;gap:8px">
            <input id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
            <input id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
            <button class="btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn" id="googleSign">Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„</button>
            <button class="btn" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>

        <div style="min-width:320px;flex:1">
          <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</h3>
          <div id="ownerPanel" style="display:none">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="refreshUsers">ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
              <button class="btn" id="showAllHistory">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ù…Ø§Ù„Ùƒ)</button>
              <button class="btn" id="inviteUserBtn">Ø§Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
            </div>
            <div id="usersList" style="margin-top:12px;max-height:240px;overflow:auto"></div>
          </div>
        </div>
      </div>

      <hr style="margin:12px 0; border-top:1px solid rgba(255,255,255,0.04)">

      <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
        <input id="searchBox" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶/Ø§Ù„Ø¯ÙˆØ§Ø¡/Ø§Ù„Ø¨Ø±ÙŠØ¯" style="flex:1" />
        <button class="btn" id="myHistoryBtn">Ø³Ø¬Ù„ÙŠ</button>
        <button class="btn" id="clearHistoryFilter">Ù…Ø³Ø­</button>
      </div>
      <div id="historyList" style="max-height:320px;overflow:auto"></div>
    </div>

    <footer>Â© Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ± â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ±ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹</footer>
  </div>
</div>

<!-- ABOUT modal (hidden) -->
<div id="aboutModal" class="modal" style="display:none">
  <div class="box">
    <h2>Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ±</h2>
    <p>Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ± Ù‡Ùˆ Ù…ÙˆÙ‚Ø¹ Ø®Ø§Øµ Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ± Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆÙ‚Ø¯ ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ÙÙƒØ±Ø© Ù…Ù† Ø·Ù„Ø¨Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø© Ù„Ù‚Ø³Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„ÙƒÙˆØª Ø³Ù†Ø© 2026 ÙˆØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨ÙŠÙ† 3 Ø·Ù„Ø¨Ø© Ù‚Ø§Ù…ÙˆØ§ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠÙ…ÙƒÙ†ÙƒÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø­Ø±ÙŠØ© Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø­Ø¸Ø§Ù‹ Ø·ÙŠØ¨Ø§Ù‹.</p>
    <h3>Ø§Ù„Ù…Ø°ÙƒÙˆØ±ÙˆÙ† ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ·</h3>
    <ul>
      <li>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§ â€” Ù…Ø·ÙˆØ± ÙˆÙ…Ø§Ù„Ùƒ â€” @ku56t</li>
      <li>Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ± â€” Ù…Ù†Ø¸Ù… â€” @871c</li>
      <li>Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰ â€” Ù…Ù†Ø¸Ù… â€” @ans_mz1092</li>
    </ul>
    <div style="text-align:left;margin-top:12px">
      <button class="btn" id="closeAbout">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- INVITE modal -->
<div id="inviteModal" class="modal" style="display:none">
  <div class="box">
    <h3>Ø¯Ø¹ÙˆØ© / Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
    <p>ÙƒÙ…Ø§Ù„ÙƒØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¨Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©.</p>
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
      <input id="inviteEmail" placeholder="email@example.com" />
    </label>
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      <input id="invitePass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" />
    </label>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="sendInvite">Ø¥Ù†Ø´Ø§Ø¡</button>
      <button class="btn" id="cancelInvite">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- CAMERA modal (scan) -->
<div id="cameraModal" class="modal" style="display:none">
  <div class="box">
    <h3>ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø³Ø­ Ø¶ÙˆØ¦ÙŠ â€” Ù…Ø­Ø§ÙƒØ§Ø©</h3>
    <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù„ÙƒÙŠØ³ Ø§Ù„Ù…Ø±ÙŠØ¶. Ù‡Ø°Ù‡ Ù…ÙŠØ²Ø© Ù…Ø­Ø§ÙƒØ§Ø©: Ù„Ù‚Ø±Ø§Ø¡Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ© ØªØ­ØªØ§Ø¬ Ø®Ø¯Ù…Ø© OCR Ø£Ùˆ Ø®Ø§Ø¯Ù….</p>
    <video id="camVideo" autoplay playsinline style="width:100%;height:auto;border-radius:8px;background:#000"></video>
    <canvas id="camCanvas" style="display:none"></canvas>
    <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
      <button class="btn" id="snapBtn">Ø§Ù„ØªÙ‚Ø§Ø·</button>
      <button class="btn" id="simulateReadBtn">Ù…Ø­Ø§ÙƒØ§Ø© Ù‚Ø±Ø§Ø¡Ø©</button>
      <button class="btn" id="closeCam">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="scanResult" style="margin-top:12px"></div>
  </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
/* ==================== Firebase init ==================== */
/* Use the Firebase config you supplied earlier */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, where, orderBy, updateDoc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
  authDomain: "anesthesia-dose-262e3.firebaseapp.com",
  projectId: "anesthesia-dose-262e3",
  storageBucket: "anesthesia-dose-262e3.appspot.com",
  messagingSenderId: "602244448093",
  appId: "1:602244448093:web:0a8d9905849126086ff2b4",
  measurementId: "G-SCHMQFCK3J"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ==================== App logic ==================== */

// owner account that gets owner role if email matches
const OWNER_EMAIL = "bama47686@gmail.com";

// UI shortcuts
const splash = document.getElementById('splash');
const appEl = document.getElementById('app');
const userArea = document.getElementById('userArea');
const ownerPanel = document.getElementById('ownerPanel');
const usersList = document.getElementById('usersList');
const historyList = document.getElementById('historyList');
const myHistoryBtn = document.getElementById('myHistoryBtn');
const showAllHistory = document.getElementById('showAllHistory');

let currentUser = null; // firebase user object
let currentProfile = null; // firestore user profile {uid, email, role, banned, displayName}

/* ========== Splash hide after 5s ========== */
setTimeout(()=>{
  splash.style.transition = 'opacity .6s ease, transform .6s ease';
  splash.style.opacity = '0';
  splash.style.transform = 'translateY(-20px)';
  setTimeout(()=>{ splash.style.display='none'; appEl.style.display='block'; },650);
}, 5000);

/* ========== Theme toggle ========== */
let dark = true;
document.getElementById('toggleTheme').addEventListener('click', ()=>{
  dark = !dark;
  document.body.style.background = dark ? 'linear-gradient(180deg,var(--bg1),var(--bg2))' : '#f6f9fb';
  document.querySelectorAll('.card').forEach(c=> c.style.background = dark ? 'linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))' : '#fff');
});

/* ========== About modal ======= */
const aboutModal = document.getElementById('aboutModal');
document.getElementById('aboutBtn').addEventListener('click', ()=> aboutModal.style.display='flex');
document.getElementById('closeAbout').addEventListener('click', ()=> aboutModal.style.display='none');

/* ========== Populate drugs (same DB as before with management & taper methods) ======= */
const drugData = {
  "Propofol": { dose:{infant:[2.5,3],child:[2,2.5],adult:2.5}, unitPerKg:'mg/kg', max:{value:300,unit:'mg'}, side_effects:["Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù…","ØªÙˆÙ‚Ù ØªÙ†ÙØ³ Ù…Ø¤Ù‚Øª","Ø£Ù„Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ù‚Ù†"], management:["Ø³ÙˆØ§Ø¦Ù„ Ùˆ/Ø£Ùˆ Vasopressors","ØªÙ‡ÙˆÙŠØ© ÙˆØ£ÙƒØ³Ø¬ÙŠÙ†","Lidocaine Ù‚Ø¨Ù„ Ø§Ù„Ø­Ù‚Ù†"], taper:"ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ³Ø±ÙŠØ¨ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ØŒ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…/ØªÙ†ÙØ³" },
  "Midazolam": { dose:{infant:[0.05,0.1],child:[0.05,0.2],adult:0.15}, unitPerKg:'mg/kg', max:{value:10,unit:'mg'}, side_effects:["ØªÙ‡Ø¯Ø¦Ø© Ù…ÙØ±Ø·Ø©"], management:["Ù…Ø±Ø§Ù‚Ø¨Ø©ØŒ Ø¯Ø¹Ù… ØªÙ†ÙØ³ÙŠ","Flumazenil ÙƒÙ…Ø¶Ø§Ø¯"], taper:"Ø§Ù†ØªØ¸Ø§Ø± ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø£Ùˆ Ø¥Ø¹Ø·Ø§Ø¡ Flumazenil ØªØ­Øª Ø¥Ø´Ø±Ø§Ù" },
  "Fentanyl": { dose:{infant:[1,2],child:[2,3],adult:2}, unitPerKg:'Âµg/kg', max:{value:300,unit:'Âµg'}, side_effects:["ØªØ«Ø¨ÙŠØ· ØªÙ†ÙØ³ÙŠ"], management:["Ø¯Ø¹Ù… ØªÙ†ÙØ³ÙŠØŒ Naloxone"], taper:"ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆØ¥ØªØ§Ø­Ø© Ø¯Ø¹Ù… ØªÙ†ÙØ³ÙŠ" },
  "Ketamine": { dose:{infant:[2,3],child:[4,5],adult:1.5}, unitPerKg:'mg/kg', max:{value:300,unit:'mg'}, side_effects:["Ø²ÙŠØ§Ø¯Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…","Ù‡Ù„ÙˆØ³Ø©"], management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…","Midazolam Ù„Ù„ØªÙ‡Ø¯Ø¦Ø©"], taper:"ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø© ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ØŒ Ù…Ù‡Ø¯Ø¦Ø§Øª Ø¥Ù† Ù„Ø²Ù…" },
  "Lidocaine": { dose:{infant:[1,2],child:[2,3],adult:3}, unitPerKg:'mg/kg', max:{value:300,unit:'mg'}, side_effects:["ØªØ´Ù†Ø¬Ø§Øª"], management:["Ø§ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø±ÙŠØ¨ØŒ Benzodiazepine Ù„Ù„ØªØ´Ù†Ø¬Ø§Øª"], taper:"Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø±ÙŠØ¨ ÙˆØªÙ‚Ø¯ÙŠÙ… Ø¯Ø¹Ù…" },
  "Bupivacaine": { dose:{infant:[1,2],child:[2,2],adult:2}, unitPerKg:'mg/kg', max:{value:200,unit:'mg'}, side_effects:["Ø³Ù…ÙŠØ© Ù‚Ù„Ø¨ÙŠØ©"], management:["Intralipid 20%"], taper:"Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ù‚Ù† ÙˆØ§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø³Ù…ÙŠØ© Ø¨Ø¥ÙŠÙ†ØªØ±Ø§Ù„Ø§ÙŠØ¨Ø¯" }
};
(function populateDrugs(){
  const sel = document.getElementById('drugDose');
  sel.innerHTML = '';
  Object.keys(drugData).forEach(name=>{
    const o = document.createElement('option'); o.value = name; o.textContent = name; sel.appendChild(o);
  });
})();

/* ========== Auth handling: onAuthStateChanged ========== */
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if(user){
    // get or create profile in Firestore
    const uref = doc(db, 'users', user.uid);
    const snap = await getDoc(uref);
    if(!snap.exists()){
      // create profile
      const role = (user.email === OWNER_EMAIL) ? 'owner' : 'user';
      await setDoc(uref, { uid:user.uid, email:user.email, displayName:user.displayName||user.email, role, banned:false, createdAt: serverTimestamp() });
    }
    const prof = (await getDoc(uref)).data();
    currentProfile = prof;
    // banned check
    if(prof && prof.banned){
      alert('Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ.');
      await signOut(auth);
      return;
    }
    renderUserArea();
    // show owner panel if owner
    if(prof.role === 'owner') ownerPanel.style.display = 'block'; else ownerPanel.style.display='none';
  } else {
    currentProfile = null;
    renderUserArea();
    ownerPanel.style.display = 'none';
  }
});

/* ========== Rendering user area ========== */
function renderUserArea(){
  userArea.innerHTML = '';
  if(currentUser){
    const span = document.createElement('span'); span.textContent = currentUser.email; span.style.opacity='.9';
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Ù„ÙˆØ­Ø©ÙŠ'; btn.onclick = ()=> document.getElementById('showAdmin').click();
    userArea.appendChild(span);
    userArea.appendChild(btn);
  } else {
    const btnLogin = document.createElement('button'); btnLogin.className='btn'; btnLogin.textContent='ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„'; btnLogin.onclick = ()=> document.getElementById('showAdmin').click();
    userArea.appendChild(btnLogin);
  }
}

/* ========== Login / Logout / Google Sign-in / Create user by owner ========= */
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!email || !pass){ alert('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
  } catch(e){ console.error(e); alert('ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+e.message); }
});

document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await signOut(auth);
  alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
});

const googleProvider = new GoogleAuthProvider();
document.getElementById('googleSign').addEventListener('click', async ()=>{
  try{
    await signInWithPopup(auth, googleProvider);
  } catch(e){ console.error(e); alert('ÙØ´Ù„ Ø¯Ø®ÙˆÙ„ Ø¬ÙˆØ¬Ù„: '+e.message); }
});

/* Invite user modal logic (owner) */
document.getElementById('inviteUserBtn').addEventListener('click', ()=> document.getElementById('inviteModal').style.display='flex');
document.getElementById('cancelInvite').addEventListener('click', ()=> document.getElementById('inviteModal').style.display='none');
document.getElementById('sendInvite').addEventListener('click', async ()=>{
  // only owner
  if(!currentProfile || currentProfile.role !== 'owner'){ alert('Ù…Ø®ØµØµ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·'); return; }
  const email = document.getElementById('inviteEmail').value.trim();
  const pass = document.getElementById('invitePass').value;
  if(!email || !pass){ alert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }
  try{
    // create user account (this will sign in as that user) -> workaround: create then sign out and restore owner session
    await createUserWithEmailAndPassword(auth, email, pass);
    const newUser = auth.currentUser;
    // set role user by default
    await setDoc(doc(db,'users', newUser.uid), { uid:newUser.uid, email:newUser.email, displayName:newUser.email, role:'user', banned:false, createdAt:serverTimestamp() });
    // sign out new user
    await signOut(auth);
    alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯/ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
    document.getElementById('inviteModal').style.display='none';
    // Note: owner will need to sign in again
  }catch(e){ console.error(e); alert('Ø®Ø·Ø£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: '+e.message); }
});

/* ========== Owner: list users & manage ========== */
document.getElementById('refreshUsers').addEventListener('click', listUsers);
async function listUsers(){
  usersList.innerHTML = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
  try{
    const q = query(collection(db,'users'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    usersList.innerHTML = '';
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const row = document.createElement('div');
      row.style.padding='8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.02)';
      row.innerHTML = `<div><b>${d.displayName||d.email}</b> â€” ${d.email}<br><small>UID: ${d.uid}</small></div>`;
      const btnBan = document.createElement('button'); btnBan.className='btn'; btnBan.textContent = d.banned ? 'Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±';
      btnBan.onclick = async ()=>{
        await updateDoc(doc(db,'users',d.uid), { banned: !d.banned });
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
        listUsers();
      };
      const roleBtn = document.createElement('button'); roleBtn.className='btn'; roleBtn.textContent = d.role === 'owner' ? 'Ù…Ø§Ù„Ùƒ' : 'Ù…Ø³ØªØ®Ø¯Ù…';
      roleBtn.onclick = async ()=>{
        const newRole = d.role === 'owner' ? 'user' : 'owner';
        await updateDoc(doc(db,'users',d.uid), { role: newRole });
        alert('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±ØªØ¨Ø©');
        listUsers();
      };
      row.appendChild(btnBan); row.appendChild(roleBtn);
      usersList.appendChild(row);
    });
  } catch(e){ console.error(e); usersList.innerHTML='ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„'; }
}

/* ========== History saving utilities ========= */
async function saveHistory(entry){
  // entry: {type:'dose'|'fluid'|'airway', patientName, inputs, result, userEmail, notes}
  try{
    await addDoc(collection(db,'history'), { ...entry, userEmail: currentUser ? currentUser.email : 'anonymous', uid: currentUser ? currentUser.uid : null, ts: serverTimestamp() });
  }catch(e){ console.error('saveHistory error', e); }
}

/* ========== Calculators (dose/fluid/airway) ========== */

// helper functions
function toYears(val, unit){
  const v = parseFloat(val);
  if(isNaN(v) || v < 0) return NaN;
  if(unit === 'years') return v;
  if(unit === 'months') return v/12;
  if(unit === 'days') return v/365;
  return v;
}
function ageCategory(years){
  if(years < 1) return 'infant';
  if(years < 12) return 'child';
  return 'adult';
}
function avgDose(dv){ return Array.isArray(dv)? (dv[0]+dv[1])/2 : dv; }

const asaFactors = { I:1.00, II:0.95, III:0.85, IV:0.75, V:0.65 };
const diseaseFactors = { diabetes:0.95, heart:0.80, lung:0.85, liver:0.70, kidney:0.75, allergy:0.90, obesity:1.05 };

document.getElementById('patientHealth').addEventListener('change', ()=>{
  document.getElementById('diseaseDiv').style.display = document.getElementById('patientHealth').value === 'unhealthy' ? 'block':'none';
  if(document.getElementById('patientHealth').value === 'healthy') document.querySelectorAll('.diseaseChk').forEach(c=>c.checked=false);
});

document.getElementById('calcDose').addEventListener('click', async ()=>{
  const patientName = document.getElementById('patientNameDose').value.trim();
  const weight = parseFloat(document.getElementById('weightDose').value);
  const ageVal = parseFloat(document.getElementById('ageDose').value);
  const ageUnit = document.getElementById('ageUnitDose').value;
  const asa = document.getElementById('asaSelect').value;
  const drug = document.getElementById('drugDose').value;
  if(!patientName || !weight || !ageVal || !drug){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ØŒ Ø§Ù„ÙˆØ²Ù†ØŒ Ø§Ù„Ø¹Ù…Ø±ØŒ ÙˆØ§Ù„Ø¯ÙˆØ§Ø¡'); return; }
  const ageYears = toYears(ageVal, ageUnit);
  if(isNaN(ageYears)){ alert('Ø§Ø¯Ø®Ù„ Ø¹Ù…Ø± ØµØ­ÙŠØ­'); return; }
  let diseases = [];
  if(document.getElementById('patientHealth').value === 'unhealthy') document.querySelectorAll('.diseaseChk:checked').forEach(ch=>diseases.push(ch.value));
  // compute
  const dd = drugData[drug];
  const cat = ageCategory(ageYears);
  const perKg = avgDose(dd.dose[cat]);
  // total
  let total = perKg * weight;
  total *= (asaFactors[asa] || 1.0);
  diseases.forEach(d=>{ if(diseaseFactors[d]) total *= diseaseFactors[d]; });
  if(dd.max && typeof dd.max.value === 'number' && total > dd.max.value) total = dd.max.value;
  // format
  const unit = dd.unitPerKg && dd.unitPerKg.includes('Âµg') ? 'Âµg' : 'mg';
  let display;
  if(unit === 'Âµg') display = Math.round(total) + ' Âµg';
  else display = (total < 10 ? total.toFixed(2) : total.toFixed(1)) + ' mg';
  // show taper & management
  const taper = dd.taper || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ®ÙÙŠÙ Ù…Ø­Ø¯Ø¯Ø©';
  const managementHTML = (dd.management || []).map(m=>`<li>${m}</li>`).join('');
  document.getElementById('doseResult').innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap">
    <span class="pill">${drug}</span><span class="pill">Ø§Ù„ÙˆØ²Ù†: ${weight} ÙƒØº</span><span class="pill">Ø§Ù„Ø¹Ù…Ø±: ${ageVal} ${ageUnit}</span><span class="pill">ASA: ${asa}</span>
    </div>
    <div style="margin-top:10px;font-weight:700;font-size:1.1rem;color:#dff6ff">Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©: ${display}</div>
    <div style="margin-top:8px;color:#cfeffd"><b>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</b> ${taper}</div>
    <div style="margin-top:8px"><b>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØ¹Ø§Ù…Ù„:</b><ul style="margin:6px 0 0 18px">${managementHTML}</ul></div>`;

  // side effects list
  let effHTML = '';
  (dd.side_effects || []).forEach((se,i)=> effHTML += `<div class="sideEffect"><b>Ø¹Ø±Ø¶ Ø¬Ø§Ù†Ø¨ÙŠ:</b> ${se}<br><b>Ø§Ù„ØªØ¹Ø§Ù…Ù„:</b> ${(dd.management && dd.management[i])? dd.management[i] : 'ØªØ¯Ø¨ÙŠØ± Ø¯Ø§Ø¹Ù… Ø¹Ø§Ù…'}</div>`);
  document.getElementById('doseEffects').innerHTML = effHTML;

  // save history
  await saveHistory({ type:'dose', patientName, inputs:{weight,ageVal,ageUnit,asa,diseases,drug}, result:display, notes:{taper,management:dd.management} });
});

document.getElementById('calcFluids').addEventListener('click', async ()=>{
  const patientName = document.getElementById('patientNameFluid').value.trim();
  const w = parseFloat(document.getElementById('weightFluid').value);
  const ageVal = parseFloat(document.getElementById('ageFluid').value) || 0;
  const ageUnit = document.getElementById('ageUnitFluid').value;
  const type = document.getElementById('fluidType').value;
  if(!patientName || !w){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„ÙˆØ²Ù†'); return; }
  const ageYears = toYears(ageVal, ageUnit) || 30;
  let maintenance;
  if(ageYears < 1) maintenance = 100 * w;
  else if(ageYears < 10) maintenance = 50 * w;
  else maintenance = 30 * w;
  // adjust by type
  let note = '';
  if(type === 'crystalloid') { maintenance = maintenance; note = 'Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø³ÙˆØ§Ø¦Ù„ Ø¨Ù„ÙˆØ±ÙŠØ© (NS/LR)'; }
  if(type === 'colloid') { maintenance = maintenance * 0.8; note = 'Ø³ÙˆØ§Ø¦Ù„ ÙƒÙˆÙ„ÙˆÙŠØ¯ â€” ØªØ£Ø«ÙŠØ± ØªÙˆØ²ÙŠØ¹ Ù…Ø®ØªÙ„ÙØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø­Ø°Ø±'; }
  if(type === 'blood') { maintenance = maintenance * 0.6; note = 'Ù†Ø·Ø§Ù‚ Ø¯Ù…ÙˆÙŠ â€” Ø±Ø§Ø¬Ø¹ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ù†Ù‚Ù„ Ø§Ù„Ø¯Ù… Ù„Ù„Ù…Ø²ÙŠØ¯'; }
  const bloodVol = (ageYears < 1 ? 85 : (ageYears < 10 ? 80 : 70)) * w;
  document.getElementById('fluidResult').innerHTML = `<div><b>ØµÙŠØ§Ù†Ø© (24h):</b> ${Math.round(maintenance)} ml â€” (${note})</div><div style="margin-top:6px"><b>Ø­Ø¬Ù… Ø¯Ù… ØªÙ‚Ø±ÙŠØ¨ÙŠ:</b> ${Math.round(bloodVol)} ml</div>`;
  await saveHistory({ type:'fluid', patientName, inputs:{weight:w,ageYears,type}, result:`maintenance:${Math.round(maintenance)} ml`, notes:note });
});

document.getElementById('calcAirway').addEventListener('click', async ()=>{
  const patientName = document.getElementById('patientNameAirway').value.trim();
  const ageVal = parseFloat(document.getElementById('ageAirway').value);
  const ageUnit = document.getElementById('ageUnitAirway').value;
  if(!patientName || !ageVal){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„Ø¹Ù…Ø±'); return; }
  const ageYears = toYears(ageVal, ageUnit);
  let blade='', ett='';
  if(ageYears < 1){ blade='Blade 0-1 (Neonate/Infant)'; ett='3.0 - 3.5 mm'; }
  else if(ageYears < 5){ blade='Pediatric blade 1-2'; ett='4.0 - 4.5 mm'; }
  else if(ageYears < 10){ blade='Pediatric blade 2'; ett='5.0 - 5.5 mm'; }
  else { blade='Adult blade (3-4)'; ett='6.0 - 8.0 mm'; }
  const ettByAge = (ageYears>=1 && ageYears<12) ? ` â€” uncuffed (age/4 +4): ${Math.floor(ageYears/4 +4)}.0 mm` : '';
  document.getElementById('airwayResult').innerHTML = `<div><b>Ø´ÙØ±Ø© Ù…Ù†Ø§Ø³Ø¨Ø©:</b> ${blade}</div><div style="margin-top:6px"><b>ETT Ø§Ù‚ØªØ±Ø§Ø­:</b> ${ett}${ettByAge}</div>`;
  await saveHistory({ type:'airway', patientName, inputs:{ageYears}, result:`blade:${blade} ett:${ett}` });
});

/* ========== History viewing ========== */
async function loadHistory(filter = {}){ // filter: {mine:true} or {}
  historyList.innerHTML = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
  try{
    let qRef = collection(db,'history');
    const snap = await getDocs(query(qRef, orderBy('ts','desc'), limit(200)));
    historyList.innerHTML = '';
    snap.forEach(s=>{
      const d = s.data();
      // simple client filter
      if(filter.mine && currentUser && d.uid !== currentUser.uid) return;
      if(filter.search){
        const sStr = JSON.stringify(d).toLowerCase();
        if(!sStr.includes(filter.search.toLowerCase())) return;
      }
      const el = document.createElement('div');
      el.style.padding='8px'; el.style.borderBottom='1px solid rgba(255,255,255,0.02)';
      el.innerHTML = `<div><b>${d.patientName || 'â€”'}</b> â€” ${d.type} â€” ${d.result || ''}</div>
        <div style="font-size:12px;color:#cfeffd">Ø¨ÙˆØ§Ø³Ø·Ø©: ${d.userEmail||'â€”'} â€” ${d.ts? new Date(d.ts.seconds*1000).toLocaleString() : ''}</div>`;
      historyList.appendChild(el);
    });
    if(historyList.innerHTML === '') historyList.innerHTML = 'Ù„Ø§ Ø³Ø¬Ù„Ø§Øª';
  }catch(e){ console.error(e); historyList.innerHTML='Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„'; }
}

document.getElementById('myHistoryBtn').addEventListener('click', ()=> loadHistory({mine:true}));
document.getElementById('showAllHistory').addEventListener('click', ()=> loadHistory({}));
document.getElementById('clearHistoryFilter').addEventListener('click', ()=> loadHistory({}));

// search box
document.getElementById('searchBox').addEventListener('input', (e)=>{
  const v = e.target.value.trim();
  loadHistory({search:v});
});

/* ========== Camera scan (simulation) ========== */
let stream = null;
const camModal = document.getElementById('cameraModal');
document.getElementById('closeCam').addEventListener('click', ()=> {
  camModal.style.display='none';
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
});
document.getElementById('snapBtn').addEventListener('click', ()=>{
  const video = document.getElementById('camVideo');
  const canvas = document.getElementById('camCanvas');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const data = canvas.toDataURL('image/png');
  document.getElementById('scanResult').innerHTML = `<img src="${data}" style="max-width:100%;border-radius:6px" />`;
});
document.getElementById('simulateReadBtn').addEventListener('click', ()=>{
  // This is a simulated OCR: you can ask user to type a sample label in a prompt,
  // or we can pretend to detect common fields.
  const simulated = prompt("Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„ÙƒÙŠØ³ (Ù…Ø«Ù„Ø§Ù‹: Drug: Propofol 10mg/ml 20ml) Ø£Ùˆ Ø§ØªØ±Ùƒ ÙØ§Ø±Øº Ù„Ù…Ø­Ø§ÙƒØ§Ø©:", "");
  if(!simulated){ alert('Ù„Ø§ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø®Ù„ Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©'); return; }
  // crude parsing
  const txt = simulated.toLowerCase();
  let foundDrug = null;
  Object.keys(drugData).forEach(k=>{ if(txt.includes(k.toLowerCase())) foundDrug = k; });
  const out = foundDrug ? `ØªÙ… Ø§ÙƒØªØ´Ø§Ù: ${foundDrug}. (Ù‡Ø°Ù‡ Ù…Ø­Ø§ÙƒØ§Ø© â€” Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø³Ø±ÙŠØ±ÙŠØ§Ù‹)` : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¯ÙˆØ§Ø¡ Ù…Ø­Ø¯Ø¯ (Ù…Ø­Ø§ÙƒØ§Ø©)';
  document.getElementById('scanResult').innerHTML = `<div style="padding:8px">${out}</div>`;
});
document.getElementById('cameraModal').addEventListener('click', (ev)=>{
  if(ev.target === document.getElementById('cameraModal')){
    document.getElementById('closeCam').click();
  }
});
async function openCameraModal(){
  camModal.style.display='flex';
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
    document.getElementById('camVideo').srcObject = stream;
  }catch(e){ alert('ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: '+e.message); }
}
// for convenience add camera button to modal entry points (not visible in UI: you can call openCameraModal())
/* Example: openCameraModal() can be called from console or by adding a button. */

/* ========== Setup chats (local canned) ========== */
function setupChat(btnId, chatId, inputId){
  document.getElementById(btnId).addEventListener('click', ()=>{
    const msg = document.getElementById(inputId).value.trim();
    if(!msg) return;
    const cb = document.getElementById(chatId);
    cb.innerHTML += `<div style="margin-bottom:6px"><b>Ø£Ù†Øª:</b> ${msg}</div>`;
    document.getElementById(inputId).value='';
    cb.innerHTML += `<div style="margin-bottom:6px;color:#bfe9ff"><b>Ù†Ø¸Ø§Ù…:</b> Ø±Ø¯ ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ OpenAI ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>`;
    cb.scrollTop = cb.scrollHeight;
  });
}
setupChat('doseChatSend','doseChat','doseChatInput');
setupChat('fluidChatSend','fluidChat','fluidChatInput');
setupChat('airwayChatSend','airwayChat','airwayChatInput');

/* ========== Initial loads ========= */
loadHistory();

/* ========== Helpful: keyboard shortcut to open camera (Ctrl+Shift+C) for quick testing ========== */
document.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.shiftKey && e.code === 'KeyC'){ openCameraModal(); }
});
</script>
</body>
</html>
