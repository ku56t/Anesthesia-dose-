<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø¯ÙŠØ±</title>

<!-- Ø³ØªØ§ÙŠÙ„Ø§Øª Ù…Ø¨Ø³Ø·Ø© ÙˆØ¬Ù…ÙŠÙ„Ø© -->
<style>
  :root{
    --bg1:#071426; --bg2:#0b3550; --card:rgba(255,255,255,0.04); --accent:#0a98b3;
    --glass: rgba(255,255,255,0.03); --text:#e6f7ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh;overflow-x:hidden}
  .center{max-width:1150px;margin:28px auto;padding:18px}
  .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;background:linear-gradient(135deg,#071024,#0b2b3a);z-index:9999}
  .top-banner{background:linear-gradient(90deg,#073a4d,#0a8aa2);padding:10px;border-radius:8px;text-align:center;font-weight:700;margin-bottom:12px}
  .bars{width:92%;max-width:900px;display:flex;flex-direction:column;gap:8px;align-items:center}
  .bar{width:100%;padding:14px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));box-shadow:0 8px 30px rgba(0,0,0,.45);text-align:right}
  .bar.small{width:92%}
  .bar b{display:block}
  .muted{color:#b8dce6;font-size:13px}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 18px 40px rgba(0,0,0,.6)}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;justify-content:center}
  .btn{padding:10px 14px;border-radius:8px;border:none;background:linear-gradient(90deg,#0ea5a5,#0a5275);color:#fff;cursor:pointer}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
  label{display:block;margin:8px 0;text-align:right}
  .panel{display:none;margin-top:12px}
  .result{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-top:8px}
  .sideEffect{background:rgba(255,70,90,0.06);padding:8px;border-left:4px solid rgba(255,70,90,0.9);border-radius:6px;margin:8px 0}
  .controls{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:#bcdfe9}
  .top-right{position:fixed;right:14px;top:14px;display:flex;gap:8px;z-index:600}
  .hidden{display:none}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:right}
  .pill{display:inline-block;padding:6px 8px;background:rgba(255,255,255,0.02);border-radius:999px;margin-left:8px}
  .darkbody{background:linear-gradient(180deg,#000814,#001022)}
  footer{margin-top:18px;text-align:center;color:#9ecfe0}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal .box{background:var(--card);padding:18px;border-radius:10px;max-width:720px;width:92%}
  .camera-preview{width:100%;height:240px;background:#000;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999}
</style>
</head>
<body>

<!-- Splash with top big banner -->
<div id="splash" class="splash">
  <div class="top-banner">
    Ø£ÙƒØ§Ø¯Ù…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â˜† â€” Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±
  </div>

  <div class="bars">
    <!-- Ù‡Ø±Ù…ÙŠ: smaller on top, developer last -->
    <div class="bar" style="transform:scale(0.9) translateY(12px)">
      <b>Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰</b>
      <small class="muted">Ù…Ù†Ø¸Ù…</small>
      <div class="muted">@ans_mz1092</div>
    </div>
    <div class="bar" style="transform:scale(0.96) translateY(6px)">
      <b>Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ±</b>
      <small class="muted">Ù…Ù†Ø¸Ù…</small>
      <div class="muted">@871c</div>
    </div>
    <div class="bar small" style="transform:scale(1)">
      <b>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</b>
      <small class="muted">Ù…Ù†Ø¸Ù… Ùˆ Ù…Ø·ÙˆØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</small>
      <div class="muted">@ku56t</div>
    </div>
  </div>

  <div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” Ø³ÙŠØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...</div>
</div>

<!-- top right controls (dark mode / about / logout) -->
<div class="top-right">
  <button id="themeToggle" class="btn small">ÙˆØ¶Ø¹ Ù…Ø¸Ù„Ù…</button>
  <button id="aboutBtn" class="btn small">Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
  <button id="logoutBtn" class="btn small hidden">Ø®Ø±ÙˆØ¬</button>
</div>

<!-- main content area (hidden until login) -->
<div class="center" id="main" style="display:none">
  <div class="card">
    <h2 style="margin:0">ğŸš‘ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø¯ÙŠØ± â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…Ù„</h2>
    <div class="muted small">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ø³Ø¨Ø§Øª â€” Ù…ÙˆØ«Ù‘Ù‚ Ù…Ø¹ Firebase</div>

    <!-- AUTH UI -->
    <div id="authUI" style="margin-top:12px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
        <input id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password" />
        <button id="loginBtn" class="btn">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
        <button id="googleBtn" class="btn">Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„</button>
      </div>
      <div class="muted small" style="margin-top:8px">Ø§Ù„Ù…Ø§Ù„Ùƒ: <b>bama47686@gmail.com</b> (role: owner)</div>
    </div>

    <!-- app UI (Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
    <div id="appUI" class="hidden" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <button id="showDose" class="btn">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</button>
          <button id="showFluids" class="btn">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„</button>
          <button id="showAirway" class="btn">Ø§Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨</button>
          <button id="showHistory" class="btn">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
          <button id="showAdmin" class="btn">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</button>
        </div>
        <div>
          <span id="userInfo" class="muted"></span>
        </div>
      </div>

      <!-- Panels -->
      <!-- Dose Panel -->
      <div id="panelDose" class="panel">
        <h3>ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶<input id="patientNameDose" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶"></label>
            <label>ÙˆØ²Ù† (ÙƒØº)<input id="weightDose" type="number" min="0" step="0.1"></label>
            <label>Ø¹Ù…Ø±<input id="ageDose" type="number" min="0" step="0.1"></label>
            <label>ÙˆØ­Ø¯Ø© Ø§Ù„Ø¹Ù…Ø±
              <select id="ageUnitDose"><option value="years">Ø³Ù†ÙˆØ§Øª</option><option value="months">Ø£Ø´Ù‡Ø±</option><option value="days">Ø£ÙŠØ§Ù…</option></select>
            </label>
            <label>ØªØµÙ†ÙŠÙ ASA
              <select id="asaDose"><option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option></select>
            </label>
            <label>Ø§Ø¶Ø§ÙØ© Ø£Ù…Ø±Ø§Ø¶ (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø©)
              <div><label><input type="checkbox" class="diseaseDose" value="diabetes"> Ø³ÙƒØ±ÙŠ</label> <label><input type="checkbox" class="diseaseDose" value="heart"> Ù‚Ù„Ø¨</label></div>
              <div><label><input type="checkbox" class="diseaseDose" value="lung"> Ø±Ø¦ÙˆÙŠ</label> <label><input type="checkbox" class="diseaseDose" value="liver"> ÙƒØ¨Ø¯</label></div>
            </label>
            <label>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡
              <select id="drugDose">
                <option>Propofol</option><option>Midazolam</option><option>Fentanyl</option><option>Ketamine</option><option>Etomidate</option><option>Thiopental</option><option>Dexmedetomidine</option><option>Succinylcholine</option><option>Lidocaine</option><option>Bupivacaine</option>
              </select>
            </label>
            <div class="controls" style="margin-top:8px">
              <button id="calcDoseBtn" class="btn">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
              <button id="saveDoseBtn" class="btn">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
            <div style="margin-top:8px">
              <button id="scanBagDose" class="btn">ÙƒØ§Ù…ÙŠØ±Ø§: Ù…Ø³Ø­ ÙƒÙŠØ³ Ø§Ù„Ù…Ø±ÙŠØ¶</button>
            </div>
          </div>
          <div>
            <div id="doseResult" class="result">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
            <div id="doseSide" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- Fluids panel -->
      <div id="panelFluids" class="panel">
        <h3>ğŸ’§ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶<input id="patientNameFluid" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶"></label>
            <label>ÙˆØ²Ù† (ÙƒØº)<input id="weightFluid" type="number" min="0" step="0.1"></label>
            <label>Ø¹Ù…Ø±<input id="ageFluid" type="number" min="0" step="0.1"></label>
            <label>ÙˆØ­Ø¯Ø© Ø§Ù„Ø¹Ù…Ø±
              <select id="ageUnitFluid"><option value="years">Ø³Ù†ÙˆØ§Øª</option><option value="months">Ø£Ø´Ù‡Ø±</option><option value="days">Ø£ÙŠØ§Ù…</option></select>
            </label>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¦Ù„
              <select id="fluidType">
                <option value="crystalloid">Crystalloid (Ringer/Saline)</option>
                <option value="colloid">Colloid (Albumin)</option>
                <option value="blood">Blood (PRBC)</option>
              </select>
            </label>
            <div style="margin-top:8px" class="controls">
              <button id="calcFluidsBtn" class="btn">Ø§Ø­Ø³Ø¨</button>
              <button id="saveFluidBtn" class="btn">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
          </div>
          <div>
            <div id="fluidResult" class="result">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          </div>
        </div>
      </div>

      <!-- Airway panel -->
      <div id="panelAirway" class="panel">
        <h3>ğŸ« Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ Ùˆ ETT</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶<input id="patientNameAirway" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶"></label>
            <label>Ø¹Ù…Ø±<input id="ageAirway" type="number" min="0" step="0.1"></label>
            <label>ÙˆØ­Ø¯Ø© Ø§Ù„Ø¹Ù…Ø±
              <select id="ageUnitAirway"><option value="years">Ø³Ù†ÙˆØ§Øª</option><option value="months">Ø£Ø´Ù‡Ø±</option><option value="days">Ø£ÙŠØ§Ù…</option></select>
            </label>
            <label>ÙˆØ²Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)<input id="weightAirway" type="number" min="0" step="0.1"></label>
            <div style="margin-top:8px" class="controls">
              <button id="calcAirwayBtn" class="btn">Ø§Ø­Ø³Ø¨</button>
              <button id="saveAirwayBtn" class="btn">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
            <div style="margin-top:8px">
              <button id="scanBagAirway" class="btn">ÙƒØ§Ù…ÙŠØ±Ø§: Ù…Ø³Ø­ ÙƒÙŠØ³ Ø§Ù„Ù…Ø±ÙŠØ¶</button>
            </div>
          </div>
          <div>
            <div id="airwayResult" class="result">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          </div>
        </div>
      </div>

      <!-- History panel -->
      <div id="panelHistory" class="panel">
        <h3>ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (History)</h3>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="searchHistory" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¯ÙˆØ§Ø¡/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" />
          <button id="myRecordsBtn" class="btn">Ø³Ø¬Ù„Ø§ØªÙŠ</button>
          <button id="allRecordsBtn" class="btn">ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·)</button>
        </div>
        <div id="historyList" style="margin-top:12px"></div>
      </div>

      <!-- Admin (owner) panel -->
      <div id="panelAdminMain" class="panel">
        <h3>ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ (Owner)</h3>
        <div id="ownerOnly" class="muted">Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ.</div>
        <div style="margin-top:8px">
          <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
          <table class="table" id="usersTable"><thead><tr><th>Ø§Ù„Ø¥Ø³Ù…</th><th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th>UID</th><th>Role</th><th>Ø­Ø¸Ø±</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

    </div>

    <footer class="muted">Â© Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â€” ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø±ÙŠØ±ÙŠØ© Ù‚Ø¨Ù„ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</footer>
  </div>
</div>

<!-- Modal about -->
<div id="aboutModal" class="modal hidden">
  <div class="box">
    <h3>Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
    <p>
      Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ± Ù‡Ùˆ Ù…ÙˆÙ‚Ø¹ Ø®Ø§Øµ Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ± Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆÙ‚Ø¯ ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ÙÙƒØ±Ø© Ù…Ù† Ø·Ù„Ø¨Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø±Ø§Ø¨Ø¹Ù‡ Ù„Ù‚Ø³Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„ÙƒÙˆØª Ø³Ù†Ø© 2026
      ÙˆØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨ÙŠÙ† 3 Ø·Ù„Ø¨Ø© Ù‚Ø§Ù…ÙˆØ§ Ø¨Ø§Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹:
    </p>
    <ul>
      <li>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§ â€” Ù…Ù†Ø¸Ù… Ùˆ Ù…Ø·ÙˆØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” @ku56t</li>
      <li>Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ± â€” Ù…Ù†Ø¸Ù… â€” @871c</li>
      <li>Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰ â€” Ù…Ù†Ø¸Ù… â€” @ans_mz1092</li>
    </ul>
    <p>Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ ASA ÙˆØ§Ù„Ø£Ù…Ø±Ø§Ø¶ØŒ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŒ Ù„ÙˆØ­Ø© Ù…Ø§Ù„Ùƒ Ù„Ù„Ø­Ø¸Ø± ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ Ø§Ø®ØªÙŠØ§Ø± Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ØŒ ÙˆØ§Ø¬Ù‡Ø© ØªØµÙˆÙŠØ± Ù…Ø³Ø§Ø¹Ø¯Ø©ØŒ ÙˆÙˆØ¶Ø¹ Ù…Ø¸Ù„Ù….</p>
    <div style="text-align:left;margin-top:8px"><button id="closeAbout" class="btn">Ø§ØºÙ„Ø§Ù‚</button></div>
  </div>
</div>

<!-- Modal camera -->
<div id="cameraModal" class="modal hidden">
  <div class="box">
    <h3>ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø³Ø­ Ø§Ù„ÙƒÙŠØ³ (Ù…ÙŠØ²Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©)</h3>
    <div class="camera-preview" id="cameraPreview">Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="startCam" class="btn">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="takePhoto" class="btn">Ø§Ù„ØªÙ‚Ø§Ø·</button>
      <button id="stopCam" class="btn">Ø§ÙŠÙ‚Ø§Ù</button>
      <button id="closeCam" class="btn">Ø§ØºÙ„Ø§Ù‚</button>
    </div>
    <p class="muted small" style="margin-top:8px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¶ÙˆØ¦ÙŠØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ©. Ù„Ø§ ØªØ¹ÙˆÙ‘Ù„ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ ØªØ´Ø®ÙŠØµÙŠØ©.</p>
  </div>
</div>

<!-- Firebase + App script -->
<script type="module">
/* ======================= Firebase config (from user) ======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut,
         onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, updateDoc, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
  authDomain: "anesthesia-dose-262e3.firebaseapp.com",
  projectId: "anesthesia-dose-262e3",
  storageBucket: "anesthesia-dose-262e3.appspot.com",
  messagingSenderId: "602244448093",
  appId: "1:602244448093:web:0a8d9905849126086ff2b4",
  measurementId: "G-SCHMQFCK3J"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========== Globals & UI refs ========== */
const splash = document.getElementById('splash');
const main = document.getElementById('main');
const authUI = document.getElementById('authUI');
const appUI = document.getElementById('appUI');
const userInfo = document.getElementById('userInfo');
const logoutBtn = document.getElementById('logoutBtn');
const aboutModal = document.getElementById('aboutModal');
const cameraModal = document.getElementById('cameraModal');
const ownerEmail = "bama47686@gmail.com"; // owner fixed by user

/* ========== Splash hide after 5s ========== */
setTimeout(()=>{ splash.style.display='none'; main.style.display='block'; }, 5000);

/* ========== Theme toggle ========== */
const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click', ()=>{
  document.body.classList.toggle('darkbody');
  themeToggle.textContent = document.body.classList.contains('darkbody') ? 'ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ' : 'ÙˆØ¶Ø¹ Ù…Ø¸Ù„Ù…';
});

/* ========== About modal ========== */
document.getElementById('aboutBtn').addEventListener('click', ()=> aboutModal.classList.remove('hidden'));
document.getElementById('closeAbout').addEventListener('click', ()=> aboutModal.classList.add('hidden'));

/* ========== Auth: Email login/register + Google ========== */
const emailInput = document.getElementById('email');
const passInput = document.getElementById('password');
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const email = emailInput.value.trim();
  const pass = passInput.value.trim();
  if(!email || !pass){ alert('Ø£Ø¯Ø®Ù„ Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±'); return; }
  try{
    // Try sign in, if fail try sign up
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      // if sign-in failed, create account (register)
      await createUserWithEmailAndPassword(auth, email, pass);
    }
  }catch(err){
    alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + err.message);
  }
});

const googleBtn = document.getElementById('googleBtn');
googleBtn.addEventListener('click', async ()=>{
  const provider = new GoogleAuthProvider();
  try{
    await signInWithPopup(auth, provider);
  }catch(err){ alert('Ø®Ø·Ø£ Google Sign: '+err.message); }
});

/* ========== Auth state listener ========= */
onAuthStateChanged(auth, async (user)=>{
  if(user){
    // check banned flag in users collection
    const uRef = doc(db, 'users', user.uid);
    const uSnap = await getDoc(uRef);
    let userDoc = uSnap.exists() ? uSnap.data() : null;
    // create user doc if not exists
    if(!userDoc){
      // role owner if email equals ownerEmail
      const role = (user.email === ownerEmail) ? 'owner' : 'user';
      await setDoc(uRef, { displayName: user.displayName || '', email: user.email, role, banned:false, uid: user.uid });
      userDoc = { displayName:user.displayName||'', email:user.email, role, banned:false, uid:user.uid };
    }
    if(userDoc.banned){
      alert('Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¸ÙˆØ±. Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø§Ù„Ùƒ.');
      await signOut(auth);
      return;
    }
    // If owner, ensure role marked owner in doc
    if(user.email === ownerEmail && userDoc.role !== 'owner'){
      await updateDoc(uRef, { role:'owner' });
      userDoc.role = 'owner';
    }

    // show app UI
    authUI.classList.add('hidden');
    appUI.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    userInfo.textContent = `${user.email} â€” Ø¯ÙˆØ±: ${userDoc.role}`;
    // show owner panel button only if owner
    document.getElementById('showAdmin').style.display = (userDoc.role === 'owner') ? 'inline-block' : 'none';

  } else {
    // not logged in
    authUI.classList.remove('hidden');
    appUI.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    userInfo.textContent = '';
  }
});

/* ========== Logout ========= */
logoutBtn.addEventListener('click', async ()=>{ await signOut(auth); location.reload(); });

/* ================== Panel navigation ================== */
const panelMap = {
  showDose: 'panelDose',
  showFluids: 'panelFluids',
  showAirway: 'panelAirway',
  showHistory: 'panelHistory',
  showAdmin: 'panelAdminMain'
};
Object.keys(panelMap).forEach(btnId=>{
  const el = document.getElementById(btnId);
  if(!el) return;
  el.addEventListener('click', ()=>{
    Object.values(panelMap).forEach(pid=> document.getElementById(pid).style.display='none');
    document.getElementById(panelMap[btnId]).style.display='block';
  });
});
// default open dose after login (will be triggered by auth state changed)
document.getElementById('showDose').addEventListener('click', ()=>{});

/* ================== Dose calculation logic (simplified realistic) ================== */
function toYears(val, unit){
  const v = parseFloat(val);
  if(isNaN(v)) return 0;
  if(unit==='years') return v;
  if(unit==='months') return v/12;
  if(unit==='days') return v/365;
  return v;
}
const drugDatabase = {
  Propofol: { perKg: 2.5, unit:'mg', range:[2,3], max:300,
    side:['Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù…','ØªÙˆÙ‚Ù ØªÙ†ÙØ³ÙŠ','Ø£Ù„Ù… Ø­Ù‚Ù†'], manage:['Ø³ÙˆØ§Ø¦Ù„/ Vasopressors','ØªÙ‡ÙˆÙŠØ© + Ø£ÙƒØ³Ø¬ÙŠÙ†','Lidocaine Ù‚Ø¨Ù„ Ø§Ù„Ø­Ù‚Ù†']},
  Midazolam:{ perKg:0.15, unit:'mg', range:[0.05,0.2], max:10, side:['ØªÙ‡Ø¯Ø¦Ø© Ù…ÙØ±Ø·Ø©'], manage:['Flumazenil Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©']},
  Fentanyl:{ perKg:2, unit:'Âµg', range:[1,3], max:300, side:['ÙƒØ¨Øª ØªÙ†ÙØ³ÙŠ'], manage:['Naloxone Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©']},
  Ketamine:{ perKg:2, unit:'mg', range:[1.5,5], max:300, side:['Ø²ÙŠØ§Ø¯Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…','Ù‡Ù„ÙˆØ³Ø©'], manage:['Midazolam Ù„Ù„ØªÙ‡Ø¯Ø¦Ø©']},
  Etomidate:{ perKg:0.3, unit:'mg', range:[0.15,0.3], max:50, side:['Myoclonus'], manage:['Benzodiazepine']},
  Thiopental:{ perKg:12.5, unit:'mg', range:[10,15], max:400, side:['ÙƒØ¨Øª ØªÙ†ÙØ³ÙŠ'], manage:['ØªÙ‡ÙˆÙŠØ©/Ø¯Ø¹Ù… Ø¶ØºØ·']},
  Dexmedetomidine:{ perKg:1.0, unit:'Âµg', range:[0.5,2], max:200, side:['Ø¨Ø·Ø¡ Ù‚Ù„Ø¨'], manage:['Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ù„Ø¨ÙŠØ©']},
  Succinylcholine:{ perKg:1.5, unit:'mg', range:[1,2], max:200, side:['Hyperkalemia'], manage:['Dantrolene Ø¹Ù†Ø¯ MH']},
  Lidocaine:{ perKg:3, unit:'mg', range:[1,3], max:300, side:['ØªØ´Ù†Ø¬Ø§Øª'], manage:['Ø§ÙŠÙ‚Ø§Ù + Benzodiazepine']},
  Bupivacaine:{ perKg:2, unit:'mg', range:[1,2], max:200, side:['Ø³Ù…ÙŠØ© Ù‚Ù„Ø¨ÙŠØ©'], manage:['Intralipid 20%']}
};

const asaFactors = { I:1.0, II:0.95, III:0.85, IV:0.75, V:0.65 };
const diseaseFactors = { diabetes:0.95, heart:0.8, lung:0.85, liver:0.7, kidney:0.75, allergy:0.9, obesity:1.05 };

function computeDose(drugName, weight, ageYears, asa, diseases=[]){
  const d = drugDatabase[drugName];
  if(!d) return null;
  // use perKg but modify for pediatrics (younger infants may require adjusted values)
  let perKg = d.perKg;
  if(ageYears < 1) perKg = Array.isArray(d.range) ? d.range[1] : perKg; // choose upper pediatric
  else if(ageYears < 12) perKg = (Array.isArray(d.range) ? (d.range[0]+d.range[1])/2 : perKg);
  // numeric total
  let total = perKg * weight;
  // ASA
  total *= asaFactors[asa] || 1.0;
  // diseases multiply
  diseases.forEach(x=>{ if(diseaseFactors[x]) total *= diseaseFactors[x]; });
  // cap
  if(d.max && total > d.max) total = d.max;
  // prepare reductions guidance (tapering)
  const taper = `Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªØ®ÙÙŠÙ Ø§Ù„Ø¬Ø±Ø¹Ø©: Ù‚Ù„Ù‘Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø¨Ù…Ù‚Ø¯Ø§Ø± ${(1- (asaFactors[asa]||1))*100).toFixed(0)}% Ø¨Ø³Ø¨Ø¨ ASAØŒ ÙˆØ±Ø§Ø¬Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø­Ø¨ (Ù…Ø«Ù„ ØªÙ‚Ù„ÙŠÙ„ ${d.perKg} Ø¥Ù„Ù‰ ${ (d.perKg*0.75).toFixed(2) } ÙÙŠ Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙƒØ¨Ø¯).`;
  return { total, unit:d.unit, side:d.side, manage:d.manage, taper };
}

/* calculate dose button */
document.getElementById('calcDoseBtn').addEventListener('click', ()=>{
  const name = document.getElementById('patientNameDose').value || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  const weight = parseFloat(document.getElementById('weightDose').value);
  const age = parseFloat(document.getElementById('ageDose').value);
  const ageUnit = document.getElementById('ageUnitDose').value;
  const ageYears = toYears(age, ageUnit);
  const asa = document.getElementById('asaDose').value;
  const drug = document.getElementById('drugDose').value;
  const diseases = Array.from(document.querySelectorAll('.diseaseDose:checked')).map(i=>i.value);
  if(!weight){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ²Ù†'); return; }
  const res = computeDose(drug, weight, ageYears, asa, diseases);
  if(!res){ alert('Ø¯ÙˆØ§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); return;}
  document.getElementById('doseResult').innerHTML = `<b>Ø§Ù„Ù…Ø±ÙŠØ¶:</b> ${name}<br><b>Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</b> ${res.total.toFixed(2)} ${res.unit}<div style="margin-top:8px;color:#cfeffd">${res.taper}</div>`;
  // side effects
  const seEl = document.getElementById('doseSide'); seEl.innerHTML = '';
  res.side.forEach((s,idx)=>{
    const m = res.manage[idx]||'ØªØ¯Ø¨ÙŠØ± Ø¯Ø§Ø¹Ù… Ø¹Ø§Ù…';
    seEl.innerHTML += `<div class="sideEffect"><b>Ø¹Ø±Ø¶ Ø¬Ø§Ù†Ø¨ÙŠ:</b> ${s}<br><b>Ø§Ù„ØªØ¹Ø§Ù…Ù„:</b> ${m}</div>`;
  });
});

/* Save dose record to Firestore */
document.getElementById('saveDoseBtn').addEventListener('click', async ()=>{
  const user = auth.currentUser;
  if(!user){ alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const name = document.getElementById('patientNameDose').value || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  const weight = parseFloat(document.getElementById('weightDose').value);
  const age = parseFloat(document.getElementById('ageDose').value);
  const ageUnit = document.getElementById('ageUnitDose').value;
  const ageYears = toYears(age, ageUnit);
  const asa = document.getElementById('asaDose').value;
  const drug = document.getElementById('drugDose').value;
  const diseases = Array.from(document.querySelectorAll('.diseaseDose:checked')).map(i=>i.value);
  const res = computeDose(drug, weight, ageYears, asa, diseases);
  if(!res) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø­ÙØ¸'); return; }
  try{
    await addDoc(collection(db,'history'), {
      type:'dose',
      patientName: name,
      inputs:{ weight, age:{value:age, unit:ageUnit}, asa, diseases, drug },
      result: `${res.total.toFixed(2)} ${res.unit}`,
      sideEffects: res.side,
      management: res.manage,
      taper: res.taper,
      userEmail: user.email,
      uid: user.uid,
      createdAt: serverTimestamp()
    });
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ History');
  }catch(err){ alert('Ø®Ø·Ø£ Ø­ÙØ¸: '+err.message); }
});

/* ================= Fluids calculation (with fluid types) ================= */
function computeFluids(weight, ageYears, fluidType){
  // maintenance (simplified adult ~30 ml/kg/day, pediatric differences)
  let m;
  if(ageYears < 1) m = 100 * weight;
  else if(ageYears < 10) m = 50 * weight;
  else m = 30 * weight;
  // adjust by fluid type
  let factor = 1;
  if(fluidType === 'colloid') factor = 0.7; // colloid gives more intravascular effect -> less volume
  if(fluidType === 'blood') factor = 0.2; // blood is concentrated -> less volume but transfuse by need (example)
  const suggested = Math.round(m * factor);
  const bloodVol = Math.round(((ageYears<1)?85: (ageYears<10 ? 80:70)) * weight);
  return { suggested, bloodVol, maintenance:m, factor };
}

document.getElementById('calcFluidsBtn').addEventListener('click', ()=>{
  const name = document.getElementById('patientNameFluid').value || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  const w = parseFloat(document.getElementById('weightFluid').value);
  const ageVal = parseFloat(document.getElementById('ageFluid').value) || 30;
  const ageUnit = document.getElementById('ageUnitFluid').value;
  const ageYears = toYears(ageVal, ageUnit);
  const type = document.getElementById('fluidType').value;
  if(!w){ alert('Ø§Ø¯Ø®Ù„ Ø§Ù„ÙˆØ²Ù†'); return; }
  const res = computeFluids(w, ageYears, type);
  document.getElementById('fluidResult').innerHTML = `<b>Ø§Ù„Ù…Ø±ÙŠØ¶:</b> ${name}<br><b>Ø³Ø§Ø¦Ù„ ØµÙŠØ§Ù†Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠ /24h:</b> ${res.suggested} ml (Ù†ÙˆØ¹: ${type})<br><b>Ø­Ø¬Ù… Ø¯Ù… ØªÙ‚Ø±ÙŠØ¨ÙŠ:</b> ${res.bloodVol} ml`;
});

/* Save fluids record */
document.getElementById('saveFluidBtn').addEventListener('click', async ()=>{
  const user = auth.currentUser; if(!user){ alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„'); return; }
  const name = document.getElementById('patientNameFluid').value || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  const w = parseFloat(document.getElementById('weightFluid').value);
  const ageVal = parseFloat(document.getElementById('ageFluid').value) || 30;
  const ageUnit = document.getElementById('ageUnitFluid').value;
  const ageYears = toYears(ageVal, ageUnit);
  const type = document.getElementById('fluidType').value;
  const res = computeFluids(w, ageYears, type);
  try{
    await addDoc(collection(db,'history'), {
      type:'fluids',
      patientName: name,
      inputs:{ weight:w, age:{value:ageVal,unit:ageUnit}, fluidType:type },
      result: `${res.suggested} ml/24h`,
      details: { maintenance: res.maintenance, bloodVol: res.bloodVol },
      userEmail: user.email, uid: user.uid,
      createdAt: serverTimestamp()
    });
    alert('ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„');
  }catch(e){ alert('Ø®Ø·Ø£: '+e.message); }
});

/* Airway calculation */
document.getElementById('calcAirwayBtn').addEventListener('click', ()=>{
  const name = document.getElementById('patientNameAirway').value || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  const ageVal = parseFloat(document.getElementById('ageAirway').value);
  const ageUnit = document.getElementById('ageUnitAirway').value;
  const weight = parseFloat(document.getElementById('weightAirway').value) || null;
  if(!ageVal){ alert('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø±'); return; }
  const ageYears = toYears(ageVal, ageUnit);
  let blade = '', ett = '';
  if(ageYears < 1){ blade='Ø´ÙØ±Ø© Ø±Ø¶ÙŠØ¹ 0-1'; ett='3.0 - 3.5 mm'; }
  else if(ageYears < 5){ blade='Ø´ÙØ±Ø© Ø£Ø·ÙØ§Ù„ 1-2'; ett='4.0 - 4.5 mm'; }
  else if(ageYears < 10){ blade='Ø´ÙØ±Ø© Ø£Ø·ÙØ§Ù„ 2'; ett='5.0 - 5.5 mm'; }
  else { blade='Ø´ÙØ±Ø© Ø¨Ø§Ù„Øº 3-4'; ett='6.0 - 8.0 mm'; }
  let ettExtra = '';
  if(ageYears >=1 && ageYears < 12){ ettExtra = ` (Ù‚Ø§Ø¹Ø¯Ø©: uncuffed = ${Math.floor(ageYears/4 + 4)}.0 mm)`; }
  document.getElementById('airwayResult').innerHTML = `<b>Ø§Ù„Ù…Ø±ÙŠØ¶:</b> ${name}<br><b>Ø´ÙØ±Ø©:</b> ${blade}<br><b>Ø§Ù‚ØªØ±Ø§Ø­ ETT:</b> ${ett}${ettExtra}`;
});

/* Save airway record */
document.getElementById('saveAirwayBtn').addEventListener('click', async ()=>{
  const user = auth.currentUser; if(!user){ alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„'); return; }
  const name = document.getElementById('patientNameAirway').value || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  const ageVal = parseFloat(document.getElementById('ageAirway').value);
  const ageUnit = document.getElementById('ageUnitAirway').value;
  const weight = parseFloat(document.getElementById('weightAirway').value) || null;
  const ageYears = toYears(ageVal, ageUnit);
  const r = document.getElementById('airwayResult').innerText || '';
  try{
    await addDoc(collection(db,'history'), {
      type:'airway',
      patientName: name,
      inputs:{ age:{value:ageVal,unit:ageUnit}, weight },
      result: r,
      userEmail: user.email, uid: user.uid,
      createdAt: serverTimestamp()
    });
    alert('ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ airway');
  }catch(e){ alert('Ø®Ø·Ø£: '+e.message); }
});

/* ========== Camera (simple) ========= */
let stream = null;
const cameraPreview = document.getElementById('cameraPreview');
document.getElementById('scanBagDose').addEventListener('click', ()=> openCameraModal('dose'));
document.getElementById('scanBagAirway').addEventListener('click', ()=> openCameraModal('airway'));
function openCameraModal(ctx){
  cameraModal.classList.remove('hidden');
  cameraModal.dataset.ctx = ctx;
}
document.getElementById('closeCam').addEventListener('click', ()=> { stopCam(); cameraModal.classList.add('hidden'); });
document.getElementById('startCam').addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:true });
    const video = document.createElement('video');
    video.autoplay = true; video.srcObject = stream;
    cameraPreview.innerHTML = ''; cameraPreview.appendChild(video);
    await video.play();
  }catch(err){ cameraPreview.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§'; }
});
document.getElementById('stopCam').addEventListener('click', ()=> stopCam());
function stopCam(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; cameraPreview.textContent = 'ØªÙ… Ø§ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'; } }
document.getElementById('takePhoto').addEventListener('click', ()=>{
  if(!stream){ alert('Ø´ØºÙ‘Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const video = cameraPreview.querySelector('video');
  if(!video) return;
  const canvas = document.createElement('canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d'); ctx.drawImage(video,0,0);
  const dataUrl = canvas.toDataURL('image/png');
  // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ù…ØµØºØ±Ø© (Ù„Ø§ ÙŠÙˆØ¬Ø¯ OCR Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ù†Ø§) â€” Ù†Ø¶Ø¹ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù† Ø§Ù„ØªØ´Ø®ÙŠØµ ØºÙŠØ± Ù…Ù…ÙƒÙ†
  cameraPreview.innerHTML = `<img src="${dataUrl}" style="max-width:100%;border-radius:6px" />`;
  alert('ØªÙ… Ø£Ø®Ø° Ø§Ù„ØµÙˆØ±Ø© â€” Ù‡Ø°Ù‡ Ù…ÙŠØ²Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆÙ„ÙŠØ³ Ø¨Ø¯ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø·Ø¨ÙŠ.');
});

/* ========== History listing (search) ========== */
async function loadHistory(filter = {}) {
  // filter: { myOnly: bool, all: bool, q: string }
  const list = document.getElementById('historyList'); list.innerHTML = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
  try{
    let qRef = collection(db,'history');
    const snaps = await getDocs(query(qRef, orderBy('createdAt','desc')));
    const docs = [];
    snaps.forEach(s=> docs.push({ id:s.id, ...s.data() }));
    // filter client-side
    const currentUser = auth.currentUser;
    let filtered = docs;
    if(filter.myOnly){
      filtered = filtered.filter(r=> r.uid === currentUser.uid);
    } else if(filter.all && currentUser){
      // if owner only show all; else show only own
      const uRef = doc(db,'users', currentUser.uid);
      const uSnap = await getDoc(uRef);
      const role = uSnap.exists() ? uSnap.data().role : 'user';
      if(role !== 'owner') filtered = filtered.filter(r=> r.uid === currentUser.uid);
    } else if(filter.q){
      const ql = filter.q.toLowerCase();
      filtered = filtered.filter(r => (r.patientName && r.patientName.toLowerCase().includes(ql)) || (r.inputs && JSON.stringify(r.inputs).toLowerCase().includes(ql)) || (r.userEmail && r.userEmail.toLowerCase().includes(ql)));
    } else {
      // default: show user's records
      const current = auth.currentUser;
      if(current) filtered = filtered.filter(r=> r.uid === current.uid);
    }
    // render
    if(filtered.length === 0){ list.innerHTML = '<div class="muted">Ù„Ø§ Ø³Ø¬Ù„Ø§Øª</div>'; return; }
    let html = '<table class="table"><thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th></tr></thead><tbody>';
    filtered.forEach(r=>{
      const t = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : '-';
      html += `<tr><td>${t}</td><td>${r.patientName||'-'}</td><td>${r.type}</td><td>${r.result||'-'}</td><td>${r.userEmail||'-'}</td></tr>`;
    });
    html += '</tbody></table>';
    list.innerHTML = html;
  }catch(e){ list.innerHTML = 'Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: '+e.message; }
}
document.getElementById('myRecordsBtn').addEventListener('click', ()=> loadHistory({ myOnly:true }));
document.getElementById('allRecordsBtn').addEventListener('click', ()=> loadHistory({ all:true }));
document.getElementById('searchHistory').addEventListener('input', (e)=> loadHistory({ q: e.target.value }));

/* ========== Owner: user management (banning) ========== */
async function loadUsersForOwner(){
  const tbody = document.querySelector('#usersTable tbody'); tbody.innerHTML = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
  try{
    const snaps = await getDocs(collection(db,'users'));
    let html = '';
    snaps.forEach(s=>{
      const d = s.data();
      html += `<tr><td>${d.displayName||'-'}</td><td>${d.email||'-'}</td><td>${d.uid}</td><td>${d.role||'user'}</td><td>${d.banned?'<button class="btn unban" data-uid="'+s.id+'">Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±</button>':'<button class="btn ban" data-uid="'+s.id+'">Ø­Ø¸Ø±</button>'}</td></tr>`;
    });
    tbody.innerHTML = html;
    // attach listeners
    tbody.querySelectorAll('button.ban').forEach(b=>{
      b.addEventListener('click', async (ev)=>{
        const uid = ev.currentTarget.dataset.uid;
        await updateDoc(doc(db,'users',uid), { banned:true });
        alert('ØªÙ… Ø§Ù„Ø­Ø¸Ø±'); loadUsersForOwner();
      });
    });
    tbody.querySelectorAll('button.unban').forEach(b=>{
      b.addEventListener('click', async (ev)=>{
        const uid = ev.currentTarget.dataset.uid;
        await updateDoc(doc(db,'users',uid), { banned:false });
        alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±'); loadUsersForOwner();
      });
    });
  }catch(e){ tbody.innerHTML = 'Ø®Ø·Ø£: '+e.message; }
}

/* show admin panel only for owner */
document.getElementById('showAdmin').addEventListener('click', async ()=>{
  const user = auth.currentUser;
  if(!user){ alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„'); return; }
  const uRef = doc(db,'users', user.uid);
  const snap = await getDoc(uRef);
  const role = snap.exists() ? snap.data().role : 'user';
  if(role !== 'owner'){ alert('Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ ØªØ¸Ù‡Ø± Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·'); return; }
  loadUsersForOwner();
});

/* ========== On load: nothing else ========== */

</script>
</body>
</html>
