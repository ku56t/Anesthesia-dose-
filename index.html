<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>نظام حساب جرعات التخدير</title>
<style>
  body{font-family:Arial, sans-serif;direction:rtl;background:#f0f2f5;margin:0;padding:20px}
  .wrap{max-width:900px;margin:0 auto}
  h1{color:#0a5275}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:8px;border:none;background:#007bff;color:#fff;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .panel{background:#fff;padding:18px;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.06);margin-top:16px}
  label{display:block;text-align:right;margin:6px 0}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #cfcfcf;margin-top:6px}
  .sideEffect{background:#fff6f6;border-left:4px solid #ff6b6b;padding:10px;margin:8px 0;border-radius:6px;text-align:right}
  .chatBox{height:200px;overflow:auto;padding:10px;background:#eef2f7;border-radius:8px}
  .muted{color:#666;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>🚑 نظام حساب جرعات التخدير - متكامل</h1>

  <!-- أزرار التنقل -->
  <div class="row">
    <button class="btn" id="showDose">حساب الجرعات</button>
    <button class="btn" id="showFluids">حساب السوائل والدم</button>
    <button class="btn" id="showAirway">الارنغوسكوب و ETT</button>
    <button class="btn" id="showAdmin">لوحة التحكم</button>
  </div>

  <!-- قسم الجرعات -->
  <div class="panel" id="panelDose" style="display:none">
    <h2>💉 حساب جرعات التخدير</h2>
    <div class="grid">
      <div>
        <label>وزن المريض (كغ)
          <input id="weightDose" type="number" min="0" step="0.1" placeholder="مثلاً: 70">
        </label>
        <label>عمر المريض
          <div style="display:flex;gap:8px">
            <input id="ageDose" type="number" min="0" step="1" placeholder="ضع قيمة العمر">
            <select id="ageUnitDose" style="width:150px">
              <option value="years">سنوات</option>
              <option value="months">أشهر</option>
              <option value="days">أيام</option>
            </select>
          </div>
        </label>
        <label>اختر الدواء
          <select id="drugDose"></select>
        </label>
        <button class="btn" id="calcDose">احسب الجرعة</button>
      </div>

      <div>
        <div id="doseResult" class="muted">النتيجة ستظهر هنا</div>
        <div id="doseEffects" style="margin-top:12px"></div>
      </div>
    </div>

    <hr style="margin:12px 0">

    <h3>💬 شات القسم</h3>
    <div class="chatBox" id="doseChat"></div>
    <textarea id="doseChatInput" placeholder="اكتب سؤالك هنا..." style="margin-top:8px"></textarea>
    <div style="margin-top:8px">
      <button class="btn" id="doseChatSend">أرسل</button>
    </div>
  </div>

  <!-- قسم السوائل -->
  <div class="panel" id="panelFluids" style="display:none">
    <h2>💧 حساب السوائل والدم</h2>
    <div class="grid">
      <div>
        <label>وزن المريض (كغ)
          <input id="weightFluids" type="number" min="0" step="0.1">
        </label>
        <label>عمر المريض
          <div style="display:flex;gap:8px">
            <input id="ageFluids" type="number" min="0" step="1">
            <select id="ageUnitFluids" style="width:150px">
              <option value="years">سنوات</option>
              <option value="months">أشهر</option>
              <option value="days">أيام</option>
            </select>
          </div>
        </label>
        <button class="btn" id="calcFluids">احسب السوائل/الدم</button>
      </div>

      <div>
        <div id="fluidsResult" class="muted">النتيجة ستظهر هنا</div>
      </div>
    </div>

    <hr style="margin:12px 0">
    <h3>💬 شات القسم</h3>
    <div class="chatBox" id="fluidsChat"></div>
    <textarea id="fluidsChatInput" placeholder="اكتب سؤالك هنا..." style="margin-top:8px"></textarea>
    <div style="margin-top:8px">
      <button class="btn" id="fluidsChatSend">أرسل</button>
    </div>
  </div>

  <!-- قسم اللارنغوسكوب/ETT -->
  <div class="panel" id="panelAirway" style="display:none">
    <h2>😷 اللارنغوسكوب و ETT</h2>
    <div class="grid">
      <div>
        <label>عمر المريض
          <div style="display:flex;gap:8px">
            <input id="ageAirway" type="number" min="0" step="1">
            <select id="ageUnitAirway" style="width:150px">
              <option value="years">سنوات</option>
              <option value="months">أشهر</option>
              <option value="days">أيام</option>
            </select>
          </div>
        </label>
        <label>وزن المريض (اختياري)
          <input id="weightAirway" type="number" step="0.1">
        </label>
        <button class="btn" id="calcAirway">حساب الحجم</button>
      </div>

      <div>
        <div id="airwayResult" class="muted">النتيجة ستظهر هنا</div>
      </div>
    </div>

    <hr style="margin:12px 0">
    <h3>💬 شات القسم</h3>
    <div class="chatBox" id="airwayChat"></div>
    <textarea id="airwayChatInput" placeholder="اكتب سؤالك هنا..." style="margin-top:8px"></textarea>
    <div style="margin-top:8px">
      <button class="btn" id="airwayChatSend">أرسل</button>
    </div>
  </div>

  <!-- لوحة التحكم البسيطة -->
  <div class="panel" id="panelAdmin" style="display:none">
    <h2>🔧 لوحة التحكم (مالك)</h2>
    <label>كلمة مرور المالك
      <input id="adminPass" type="password">
    </label>
    <div style="margin-top:8px">
      <button class="btn" id="adminLogin">دخول</button>
    </div>

    <div id="adminArea" style="display:none;margin-top:12px">
      <h3>تعديل قاعدة الأعراض مؤقتاً</h3>
      <p class="muted">صيغة كل سطر: drug, dosePerKg, side, treatment</p>
      <textarea id="adminEdit" rows="6" placeholder="مثال: propofol,2,دوخة,رفع القدم"></textarea>
      <div style="margin-top:8px">
        <button class="btn" id="adminSave">حفظ التعديلات</button>
      </div>
    </div>
  </div>

</div>

<script type="module">
  // ---------- قاعدة الأدوية والأعراض ----------
  const sideEffectsData = {
    "propofol": [
      { dosePerKg: 2.0, side: "انخفاض ضغط الدم", treatment: "رفع القدمين، إبطاء الحقن، محلول وريدي" },
      { dosePerKg: 2.0, side: "تثبيط تنفسي", treatment: "مراقبة التنفس، دعم أكسجين، تجهيز الأدوات التنفسية" },
      { dosePerKg: 2.0, side: "غثيان/قيء بعد العملية", treatment: "أدوية مضادة للغثيان (ondansetron)" }
    ],
    "midazolam": [
      { dosePerKg: 0.1, side: "نعاس/تخدير مفرط", treatment: "مراقبة التنفس والوظائف الحيوية، تقليل الجرعة" },
      { dosePerKg: 0.1, side: "ارتخاء عضلي", treatment: "مراقبة الحركات التنفسية، دعم تنفسي عند الحاجة" }
    ],
    "fentanyl": [
      { dosePerKg: 0.002, side: "تثبيط تنفسي شديد", treatment: "دعم الأكسجين، نالوكسون إذا لزم، مراقبة صفة التنفس" },
      { dosePerKg: 0.002, side: "غثيان/قيء", treatment: "مضادات القيء" },
      { dosePerKg: 0.002, side: "حكة", treatment: "مضادات هستامين عند الضرورة" }
    ],
    "ketamine": [
      { dosePerKg: 1.5, side: "هلوسة/كوابيس نفسية", treatment: "استخدام بنزوديازيبين كمضاد (مثلاً midazolam) ومحيط هادئ" },
      { dosePerKg: 1.5, side: "ارتفاع ضغط الدم ومعدل ضربات القلب", treatment: "مراقبة الضغط، أدوية خافضة عند الحاجة" },
      { dosePerKg: 1.5, side: "زيادة إفراز اللعاب", treatment: "مُقَِلّات الإفراز (glycopyrrolate) عند الحاجة" }
    ]
  };

  // ---------- عناصر التحكم ----------
  const panels = {
    dose: document.getElementById('panelDose'),
    fluids: document.getElementById('panelFluids'),
    airway: document.getElementById('panelAirway'),
    admin: document.getElementById('panelAdmin')
  };

  function hideAll(){ Object.values(panels).forEach(p => p.style.display = 'none'); }

  document.getElementById('showDose').addEventListener('click', ()=> { hideAll(); panels.dose.style.display='block'; });
  document.getElementById('showFluids').addEventListener('click', ()=> { hideAll(); panels.fluids.style.display='block'; });
  document.getElementById('showAirway').addEventListener('click', ()=> { hideAll(); panels.airway.style.display='block'; });
  document.getElementById('showAdmin').addEventListener('click', ()=> { hideAll(); panels.admin.style.display='block'; });

  // ---------- قائمة الأدوية ----------
  const drugSelect = document.getElementById('drugDose');
  function populateDrugs(){
    drugSelect.innerHTML = '';
    const keys = Object.keys(sideEffectsData);
    if(keys.length===0){
      const opt=document.createElement('option'); opt.value=''; opt.textContent='لا توجد أدوية في القاعدة'; drugSelect.appendChild(opt);
    } else {
      keys.forEach(k=>{
        const opt=document.createElement('option'); opt.value=k; opt.textContent=k; drugSelect.appendChild(opt);
      });
    }
  }
  populateDrugs();

  // ---------- تحويل العمر ----------
  function ageToYears(value,unit){
    const v=parseFloat(value);
    if(isNaN(v)||v<0) return NaN;
    if(unit==='years') return v;
    if(unit==='months') return v/12;
    if(unit==='days') return v/365;
    return NaN;
  }

  // ---------- حساب الجرعة ----------
  document.getElementById('calcDose').addEventListener('click', ()=>{
    const w=parseFloat(document.getElementById('weightDose').value);
    const ageVal=document.getElementById('ageDose').value;
    const ageUnit=document.getElementById('ageUnitDose').value;
    const drug=document.getElementById('drugDose').value;

    if(isNaN(w)||w<=0){ alert('أدخل وزن صحيح'); return; }
    if(!drug || !sideEffectsData[drug]){ alert('اختر دواء صحيح'); return; }

    const effects = sideEffectsData[drug];
    const effectsDiv = document.getElementById('doseEffects');
    effectsDiv.innerHTML = '';

    // حساب كل الجرعات لكل تأثير
    effects.forEach(e=>{
      const dose = e.dosePerKg * w;
      const div = document.createElement('div');
      div.className='sideEffect';
      div.innerHTML=`<strong>الجرعة:</strong> ${dose.toFixed(2)} مل/كغ<br><strong>العرض:</strong> ${e.side}<br><strong>العلاج:</strong> ${e.treatment}`;
      effectsDiv.appendChild(div);
    });

    document.getElementById('doseResult').innerHTML = `<strong>تم حساب جميع الجرعات لكل تأثير دوائي.</strong>`;
  });

  // ---------- حساب السوائل/الدم ----------
  document.getElementById('calcFluids').addEventListener('click', ()=>{
    const w=parseFloat(document.getElementById('weightFluids').value);
    if(isNaN(w)||w<=0){ alert('أدخل وزن صحيح'); return; }
    const fluidRate = 10*w;
    document.getElementById('fluidsResult').innerHTML = `<strong>معدل السوائل:</strong> ${fluidRate.toFixed(2)} مل/ساعة`;
  });

  // ---------- حساب اللارنغوسكوب/ETT ----------
  document.getElementById('calcAirway').addEventListener('click', ()=>{
    const age=parseFloat(document.getElementById('ageAirway').value);
    if(isNaN(age)||age<0){ alert('أدخل عمر صحيح'); return; }
    let tubeSize=0;
    if(age<1) tubeSize=3.0;
    else if(age<2) tubeSize=3.5;
    else if(age<4) tubeSize=4.0;
    else if(age<6) tubeSize=4.5;
    else tubeSize=5 + ((age-6)/4);
    document.getElementById('airwayResult').innerHTML=`الحجم الموصى به للـ ETT: ${tubeSize.toFixed(1)} مم`;
  });

  // ---------- لوحة التحكم ----------
  const adminPass = "mustafa@2006#2";
  document.getElementById('adminLogin').addEventListener('click', ()=>{
    const val=document.getElementById('adminPass').value;
    if(val===adminPass){
      document.getElementById('adminArea').style.display='block';
      alert('تم تسجيل الدخول');
      setTimeout(()=>{document.getElementById('adminArea').style.display='none'; alert('تم تسجيل الخروج تلقائياً');},5*60*1000);
    } else alert('كلمة مرور خاطئة');
  });

  document.getElementById('adminSave').addEventListener('click', ()=>{
    const text = document.getElementById('adminEdit').value;
    const lines=text.split("\n");
    lines.forEach(l=>{
      const parts=l.split(",");
      if(parts.length>=4){
        const drug=parts[0].trim();
        const dose=parseFloat(parts[1].trim());
        const side=parts[2].trim();
        const treatment=parts[3].trim();
        if(!sideEffectsData[drug]) sideEffectsData[drug]=[];
        sideEffectsData[drug].push({dosePerKg:dose, side, treatment});
      }
    });
    populateDrugs();
    alert('تم حفظ التعديلات');
  });

  // ---------- شات وهمي لكل قسم ----------
  function setupChat(inputId, chatId){
    const input=document.getElementById(inputId);
    const chat=document.getElementById(chatId);
    document.getElementById(inputId+'Send').addEventListener('click', ()=>{
      const msg=input.value.trim(); if(!msg) return;
      const userDiv=document.createElement('div'); userDiv.innerHTML=`<strong>أنت:</strong> ${msg}`; chat.appendChild(userDiv);
      input.value='';
      const botDiv=document.createElement('div'); botDiv.innerHTML=`<strong>AI:</strong> سيتم الرد بناءً على قاعدة البيانات`; chat.appendChild(botDiv);
      chat.scrollTop=chat.scrollHeight;
    });
  }
  setupChat('doseChatInput','doseChat');
  setupChat('fluidsChatInput','fluidsChat');
  setupChat('airwayChatInput','airwayChat');

</script>
</body>
</html>
