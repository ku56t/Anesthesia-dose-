<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ - ÙƒØ§Ù…Ù„</title>
<style>
  :root{
    --accent:#0a5275; --btn:#007bff;
  }
  *{box-sizing:border-box}
  body{font-family:Arial, sans-serif;direction:rtl;background:#0f1724;color:#0b1220;margin:0;padding:0;min-height:100vh;overflow-x:hidden}
  /* Splash */
  .splash{position:fixed;inset:0;background:linear-gradient(135deg,#071024 0%, #0b2b3a 60%);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;transition:opacity .6s ease,transform .6s ease}
  .bars{width:90%;max-width:800px}
  .bar{background:rgba(255,255,255,0.07);padding:14px;border-radius:10px;margin:8px 0;color:#fff;display:flex;flex-direction:column;gap:4px;transform-origin:center;animation:barIn .9s ease forwards}
  .bar small{opacity:0.8;font-size:13px}
  .bar b{font-size:18px}
  .bar .user{opacity:0.9;font-size:13px;color:#d0e8ff}
  .branding{margin-top:16px;color:#cbe9ff;opacity:.95}
  @keyframes barIn{0%{transform:translateX(0);opacity:0}80%{opacity:1}100%{transform:translateX(-120%);opacity:0}}
  /* After hide */
  .splash.hidden{opacity:0;pointer-events:none;transform:translateY(-20px)}
  /* decorative bubbles */
  .bg-bubbles{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
  .bg-bubbles span{position:absolute;width:90px;height:90px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.01));animation:float 8s ease-in-out infinite;filter:blur(6px);opacity:.6}
  @keyframes float{0%{transform:translateY(0) translateX(0)}50%{transform:translateY(-40px) translateX(20px)}100%{transform:translateY(0) translateX(0)}}
  /* page layout */
  .wrap{position:relative;z-index:1;max-width:1100px;margin:28px auto;padding:22px;background:#fff;border-radius:12px;box-shadow:0 20px 50px rgba(2,6,23,.35);direction:rtl}
  h1{color:var(--accent);margin:0 0 12px;text-align:center}
  .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .btn{padding:10px 14px;border-radius:8px;border:none;background:var(--btn);color:#fff;cursor:pointer}
  .panel{display:none;margin-top:16px}
  label{display:block;text-align:right;margin:6px 0;color:#0b1220}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #cfcfcf;margin-top:6px}
  .muted{color:#555;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
  .sideEffect{background:#fff6f6;border-left:4px solid #ff6b6b;padding:10px;margin:8px 0;border-radius:6px;text-align:right;color:#222}
  .chatBox{height:160px;overflow:auto;padding:10px;background:#f5f7fb;border-radius:8px;border:1px solid #e6eef6}
  footer{margin-top:16px;text-align:center;color:#6b7280;font-size:13px}
  .controls-row{display:flex;gap:8px;align-items:center}
  .small-muted{font-size:12px;color:#666}
  /* responsive */
  @media (max-width:640px){
    .wrap{margin:12px;padding:12px}
    .bar b{font-size:16px}
  }
</style>
</head>
<body>

<!-- SPLASH -->
<div class="splash" id="splash">
  <div class="bars" style="width:85%">
    <div class="bar" style="animation-delay:0s">
      <b>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</b>
      <small>Ù…Ù†Ø¸Ù… Ùˆ Ù…Ø·ÙˆØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</small>
      <div class="user">@ku56t</div>
    </div>
    <div class="bar" style="animation-delay:.15s">
      <b>Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ±</b>
      <small>Ù…Ù†Ø¸Ù…</small>
      <div class="user">@871c</div>
    </div>
    <div class="bar" style="animation-delay:.3s">
      <b>Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰</b>
      <small>Ù…Ù†Ø¸Ù…</small>
      <div class="user">@ans_mz1092</div>
    </div>
  </div>
  <div class="branding">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>
</div>

<!-- decorative bubbles -->
<div class="bg-bubbles" aria-hidden="true">
  <span style="left:5%;top:10%;width:140px;height:140px;animation-duration:10s"></span>
  <span style="left:85%;top:20%;width:100px;height:100px;animation-duration:12s"></span>
  <span style="left:20%;top:75%;width:90px;height:90px;animation-duration:9s"></span>
  <span style="left:70%;top:80%;width:120px;height:120px;animation-duration:11s"></span>
</div>

<!-- MAIN UI -->
<div class="wrap" id="app" style="display:none">
  <h1>ğŸš‘ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ - ÙƒØ§Ù…Ù„</h1>

  <div class="row">
    <button class="btn" id="showDose">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</button>
    <button class="btn" id="showFluids">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</button>
    <button class="btn" id="showAirway">Ø§Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ Ùˆ ETT</button>
    <button class="btn" id="showAdmin">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  </div>

  <!-- Dose panel -->
  <div class="panel" id="panelDose">
    <h2>ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ±</h2>
    <div class="grid">
      <div>
        <label>ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØº)
          <input id="weightDose" type="number" min="0" step="0.1" placeholder="Ù…Ø«Ù„Ø§Ù‹: 12.5">
        </label>

        <label>Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
          <div style="display:flex;gap:8px">
            <input id="ageDose" type="number" min="0" step="1" placeholder="Ù…Ø«Ù„Ø§Ù‹: 6">
            <select id="ageUnitDose" style="width:130px">
              <option value="years">Ø³Ù†ÙˆØ§Øª</option>
              <option value="months">Ø£Ø´Ù‡Ø±</option>
              <option value="days">Ø£ÙŠØ§Ù…</option>
            </select>
          </div>
        </label>

        <label>ØªØµÙ†ÙŠÙ ASA
          <select id="asaSelect">
            <option value="I">ASA I (Ø³Ù„ÙŠÙ…)</option>
            <option value="II">ASA II (Ù…Ø±Ø¶ Ø®ÙÙŠÙ)</option>
            <option value="III">ASA III (Ù…Ø±Ø¶ Ù…ØªÙˆØ³Ø·)</option>
            <option value="IV">ASA IV (Ø®Ø·ÙØ± Ù…Ø³ØªÙ…Ø±)</option>
            <option value="V">ASA V (Ù…Ø±ÙŠØ¶ Ø­Ø±Ø¬ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ø¬Ø§Ø© Ø¯ÙˆÙ† Ø¹Ù…Ù„ÙŠØ©)</option>
            <option value="VI">ASA VI (Ù…ÙŠØª Ø¯Ù…Ø§ØºÙŠ)</option>
          </select>
        </label>

        <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
          <select id="patientHealth">
            <option value="healthy">ØµØ­ÙŠ</option>
            <option value="unhealthy">ØºÙŠØ± ØµØ­ÙŠ (Ø£Ù…Ø±Ø§Ø¶)</option>
          </select>
        </label>

        <div id="diseaseDiv" style="display:none;margin-top:8px">
          <label>Ø§Ø®ØªØ± Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ (ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ø£ÙƒØ«Ø± Ù…Ù† Ø®ÙŠØ§Ø±)
            <div style="display:flex;flex-direction:column;gap:6px">
              <label><input type="checkbox" class="diseaseChk" value="diabetes"> Ø³ÙƒØ±ÙŠ</label>
              <label><input type="checkbox" class="diseaseChk" value="heart"> Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨ (CHF, IHD)</label>
              <label><input type="checkbox" class="diseaseChk" value="lung"> Ø£Ù…Ø±Ø§Ø¶ Ø±Ø¦ÙˆÙŠØ© (COPD, Asthma)</label>
              <label><input type="checkbox" class="diseaseChk" value="liver"> Ø£Ù…Ø±Ø§Ø¶ ÙƒØ¨Ø¯</label>
              <label><input type="checkbox" class="diseaseChk" value="kidney"> Ø£Ù…Ø±Ø§Ø¶ ÙƒÙ„Ù‰</label>
              <label><input type="checkbox" class="diseaseChk" value="allergy"> ØªØ­Ø³Ø³/Ø­Ø³Ø§Ø³ÙŠØ©</label>
              <label><input type="checkbox" class="diseaseChk" value="obesity"> Ø³Ù…Ù†Ø© Ù…ÙØ±Ø·Ø© (BMI â‰¥40)</label>
            </div>
          </label>
        </div>

        <label>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡
          <select id="drugDose"></select>
        </label>

        <div style="margin-top:10px" class="controls-row">
          <button class="btn" id="calcDose">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
          <div class="small-muted" style="margin-left:8px">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ£Ø®Ø° Ø¨Ø¹ÙŠÙ† Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ù…Ø±ØŒ Ø§Ù„ÙˆØ²Ù†ØŒ ASA ÙˆØ§Ù„Ø£Ù…Ø±Ø§Ø¶</div>
        </div>
      </div>

      <div>
        <div id="doseResult" class="muted"><b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</b></div>
        <div id="doseEffects" style="margin-top:12px"></div>
      </div>
    </div>

    <hr style="margin:12px 0">

    <h3>ğŸ’¬ Ø´Ø§Øª AI Ø·Ø¨ÙŠ (Ù…Ø­Ù„ÙŠ/Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>
    <div class="chatBox" id="doseChat"></div>
    <textarea id="doseChatInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." style="margin-top:8px"></textarea>
    <div style="margin-top:8px">
      <button class="btn" id="doseChatSend">Ø£Ø±Ø³Ù„</button>
    </div>
  </div>

  <!-- Fluids -->
  <div class="panel" id="panelFluids">
    <h2>ğŸ’§ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</h2>
    <div class="grid">
      <div>
        <label>ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØº)
          <input id="weightFluid" type="number" min="0" step="0.1">
        </label>
        <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
          <select id="healthFluid">
            <option value="healthy">ØµØ­ÙŠ</option>
            <option value="unhealthy">ØºÙŠØ± ØµØ­ÙŠ</option>
          </select>
        </label>
        <div style="margin-top:8px" class="controls-row">
          <button class="btn" id="calcFluids">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„</button>
          <div class="small-muted" style="margin-left:8px">Ø³Ø­Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø­Ø³Ø¨ Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø¹Ù…Ø±</div>
        </div>
      </div>
      <div>
        <div id="fluidResult" class="muted">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
      </div>
    </div>

    <hr style="margin:12px 0">

    <h3>ğŸ’¬ Ø´Ø§Øª AI Ø·Ø¨ÙŠ</h3>
    <div class="chatBox" id="fluidChat"></div>
    <textarea id="fluidChatInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."></textarea>
    <button class="btn" id="fluidChatSend">Ø£Ø±Ø³Ù„</button>
  </div>

  <!-- Airway -->
  <div class="panel" id="panelAirway">
    <h2>ğŸ« Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ Ùˆ ETT</h2>
    <div class="grid">
      <div>
        <label>Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
          <input id="ageAirway" type="number" min="0" step="0.1" placeholder="Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø£Ùˆ Ø¨Ø§Ù„Ø£Ø´Ù‡Ø± Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø£Ø¯Ù†Ø§Ù‡">
        </label>
        <label>ÙˆØ­Ø¯Ø© Ø§Ù„Ø¹Ù…Ø±
          <select id="ageUnitAirway" style="width:150px">
            <option value="years">Ø³Ù†ÙˆØ§Øª</option>
            <option value="months">Ø£Ø´Ù‡Ø±</option>
            <option value="days">Ø£ÙŠØ§Ù…</option>
          </select>
        </label>

        <label>ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØº)
          <input id="weightAirway" type="number" min="0" step="0.1">
        </label>

        <div style="margin-top:8px" class="controls-row">
          <button class="btn" id="calcAirway">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</button>
        </div>
      </div>

      <div>
        <div id="airwayResult" class="muted">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
        <div style="margin-top:8px" class="muted">Ø³ØªØ¸Ù‡Ø± Ø£ÙŠØ¶Ø§Ù‹ Ù†ØµØ§Ø¦Ø­ Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø¬Ù… Ø§Ù„Ø´ÙØ±Ø© ÙˆØ§Ù„Ù€ ETT Ù„ÙƒÙ„ ÙØ¦Ø©.</div>
      </div>
    </div>

    <hr style="margin:12px 0">

    <h3>ğŸ’¬ Ø´Ø§Øª AI Ø·Ø¨ÙŠ</h3>
    <div class="chatBox" id="airwayChat"></div>
    <textarea id="airwayChatInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."></textarea>
    <button class="btn" id="airwayChatSend">Ø£Ø±Ø³Ù„</button>
  </div>

  <!-- Admin -->
  <div class="panel" id="panelAdmin">
    <h2>âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Admin</h2>
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
      <input type="password" id="adminPass">
    </label>
    <div style="margin-top:8px">
      <button class="btn" id="loginAdmin">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="adminPanelContent" style="margin-top:12px"></div>
  </div>

  <footer>Â© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø¯ÙŠØ± â€” ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø³Ø±ÙŠØ±ÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</footer>
</div>

<script>
/*
  Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ØªØ¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Ø­Ø³Ø§Ø³Ø© Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¹Ù†Ø¯ Ù†Ø´Ø±Ù‡ Ø¹Ù„Ù†ÙŠØ§Ù‹.
  Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªÙØ¹ÙŠÙ„ OpenAIØŒ Ø¹ÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ± OPENAI_API_KEY = 'Ø¶Ø¹ Ø§Ù„Ù…ÙØªØ§Ø­ Ù‡Ù†Ø§' Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª ÙŠØ¯ÙˆÙŠØ§Ù‹.
*/
document.addEventListener('DOMContentLoaded', ()=>{

  // ---------- UI init ----------
  const splash = document.getElementById('splash');
  const app = document.getElementById('app');

  // show splash for 2.2s then hide and show app
  setTimeout(()=> {
    splash.classList.add('hidden');
    setTimeout(()=>{ splash.style.display='none'; app.style.display='block'; }, 700);
  }, 2200);

  // Panels
  const panels = {
    showDose:'panelDose',
    showFluids:'panelFluids',
    showAirway:'panelAirway',
    showAdmin:'panelAdmin'
  };
  Object.keys(panels).forEach(btnId=>{
    const el = document.getElementById(btnId);
    el.addEventListener('click', ()=>{
      Object.values(panels).forEach(pid => document.getElementById(pid).style.display='none');
      document.getElementById(panels[btnId]).style.display='block';
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });
  // default open dose
  document.getElementById('showDose').click();

  // ---------- Drug database ----------
  // structured: dose per age category (values are mg/kg or Âµg/kg), max total (units), side effects array and management array
  const drugData = {
    "Propofol":{
      dose:{ infant:[2.5,3.0], child:[2.0,2.5], adult:2.5 },
      max:{value:200,unit:'mg'},
      unitPerKg:'mg/kg',
      side_effects:["Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù…","ØªÙˆÙ‚Ù ØªÙ†ÙØ³ Ù…Ø¤Ù‚Øª","Ø£Ù„Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ù‚Ù†","Propofol infusion syndrome Ø¹Ù†Ø¯ ØªØ³Ø±ÙŠØ¨ Ø·ÙˆÙŠÙ„"],
      management:["Ø±ÙØ¹ Ø§Ù„Ù‚Ø¯Ù…ÙŠÙ†ØŒ Ø³ÙˆØ§Ø¦Ù„ØŒ Vasopressors Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©","ØªØ®Ø·ÙŠØ· ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ†ÙØ³ ÙˆØ¯Ø¹Ù… ØªÙ‡ÙˆÙŠØ©","Lidocaine Ù‚Ø¨Ù„ Ø§Ù„Ø­Ù‚Ù† Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£Ù„Ù…","Ø¥ÙŠÙ‚Ø§Ù ÙÙˆØ±Ø§Ù‹ ÙˆØ¯Ø¹Ù… Ù‚Ù„Ø¨ÙŠ/ØªÙ†ÙØ³ÙŠ"]
    },
    "Midazolam":{
      dose:{ infant:[0.05,0.1], child:[0.05,0.2], adult:0.15 },
      max:{value:10,unit:'mg'},
      unitPerKg:'mg/kg',
      side_effects:["ØªÙ‡Ø¯Ø¦Ø© Ù…ÙØ±Ø·Ø©","Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ·","Ø±Ø¯ ÙØ¹Ù„ Ø¹ÙƒØ³ÙŠ (Ù‡ÙŠØ§Ø¬)"],
      management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­ÙŠÙˆÙŠØ©ØŒ Ø¯Ø¹Ù… ØªÙ†ÙØ³ÙŠ","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø£Ùˆ Ø¯Ø¹Ù… Ø¶ØºØ·","Flumazenil ÙƒÙ…Ø¶Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©"]
    },
    "Fentanyl":{
      dose:{ infant:[1,2], child:[2,3], adult:2.5 }, // adult in Âµg/kg typical bolus 1-2, but we'll use conservative
      max:{value:200,unit:'Âµg'},
      unitPerKg:'Âµg/kg',
      side_effects:["ØªØ«Ø¨ÙŠØ· ØªÙ†ÙØ³ÙŠ","ØªØ¨Ø§Ø·Ø¤ Ù‚Ù„Ø¨","ØºØ«ÙŠØ§Ù†/ØªÙ‚ÙŠØ¤","Ø­ÙƒØ©"],
      management:["Ø¯Ø¹Ù… ØªÙ†ÙØ³ÙŠØŒ Naloxone Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©","Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ù„Ø¨ÙŠØ©","Ù…Ø¶Ø§Ø¯Ø§Øª ØºØ«ÙŠØ§Ù†","Ù…Ø¶Ø§Ø¯Ø§Øª Ù‡Ø³ØªØ§Ù…ÙŠÙ† Ø¹Ù†Ø¯ Ø­Ø§Ø¬Ø©"]
    },
    "Ketamine":{
      dose:{ infant:[2,3], child:[4,5], adult:2 }, // note: induction adult 1-2 mg/kg; using 2 conservative for IV
      max:{value:200,unit:'mg'},
      unitPerKg:'mg/kg',
      side_effects:["Ø²ÙŠØ§Ø¯Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù… ÙˆÙ…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¨Ø¶","ØªÙŠØ¨Ù‘Ø³ Ø¹Ø¶Ù„ÙŠ","Ù‡Ù„ÙˆØ³Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙØ§Ù‚Ø©"],
      management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…/Ù†Ø¨Ø¶","Midazolam ÙƒÙ…Ù‡Ø¯Ø¦ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙØ§Ù‚Ø©","Ø¨ÙŠØ¦Ø© Ù‡Ø§Ø¯Ø¦Ø©"]
    },
    "Thiopental":{
      dose:{ infant:[10,15], child:[10,12.5], adult:12.5 },
      max:{value:300,unit:'mg'},
      unitPerKg:'mg/kg',
      side_effects:["ØªØ«Ø¨ÙŠØ· ØªÙ†ÙØ³ÙŠ Ø­Ø§Ø¯","Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ·"],
      management:["ØªÙ‡ÙˆÙŠØ©/Ø£ÙƒØ³Ø¬ÙŠÙ†","Ø¯Ø¹Ù… Ø¶ØºØ· Ø§Ù„Ø¯Ù…"]
    },
    "Etomidate":{
      dose:{ infant:[0.15,0.3], child:[0.2,0.3], adult:0.3 },
      max:{value:30,unit:'mg'},
      unitPerKg:'mg/kg',
      side_effects:["Myoclonus","ÙƒØ¨Øª Ø§Ù„ØºØ¯Ø© Ø§Ù„ÙƒØ¸Ø±ÙŠØ©"],
      management:["Benzodiazepines Ù„ØªÙ‚Ù„ÙŠÙ„ Myoclonus","Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ØµÙŠØ± ÙÙ‚Ø·"]
    },
    "Dexmedetomidine":{
      dose:{ infant:[0.5,1.0], child:[1.0,2.0], adult:1.0 }, // adult mcg/kg loading/bolus varies; simplified
      max:{value:100,unit:'Âµg'},
      unitPerKg:'Âµg/kg',
      side_effects:["Ø¨Ø·Ø¡ Ù‚Ù„Ø¨","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"],
      management:["Ø¨Ø§ÙŠÙ‚Ø§Ù† Atipamezole ÙƒÙ…Ø¶Ø§Ø¯ (veterinary note) - in humans use reversal per guidelines","Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ù„Ø¨ÙŠØ©"]
    },
    "Isoflurane":{
      dose:{ infant:[1.3,1.6], child:[1.3,1.6], adult:1.45 },
      max:{value:100,unit:'%MAC'},
      unitPerKg:'%MAC',
      side_effects:["Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ·","ÙƒØ¨Øª ØªÙ†ÙØ³ÙŠ"],
      management:["ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ¯Ø¹Ù… Ø§Ù„ØªÙ†ÙØ³"]
    },
    "Succinylcholine":{
      dose:{ infant:[1,2], child:[1,2], adult:1.5 },
      max:{value:150,unit:'mg'},
      unitPerKg:'mg/kg',
      side_effects:["Hyperkalemia","Malignant hyperthermia"],
      management:["ØªÙ‡ÙˆÙŠØ© Ø§ØµØ·Ù†Ø§Ø¹ÙŠØ©ØŒ Dantrolene ÙÙŠ Ø­Ø§Ù„ MH"]
    },
    "Lidocaine":{
      dose:{ infant:[1,2], child:[2,3], adult:3 },
      max:{value:300,unit:'mg'},
      unitPerKg:'mg/kg',
      side_effects:["ØªØ´Ù†Ø¬Ø§Øª","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"],
      management:["Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø±ÙŠØ¨ØŒ Benzodiazepines Ù„Ù„ØªØ´Ù†Ø¬Ø§Øª"]
    },
    "Bupivacaine":{
      dose:{ infant:[1,2], child:[2,2], adult:2 },
      max:{value:200,unit:'mg'},
      unitPerKg:'mg/kg',
      side_effects:["Ø³Ù…ÙŠØ© Ù‚Ù„Ø¨ÙŠØ©","ØªØ´Ù†Ø¬Ø§Øª"],
      management:["Intralipid 20% therapyØŒ Ø¯Ø¹Ù… Ù‚Ù„Ø¨ ÙˆØªÙ†ÙØ³"]
    }
  };

  // populate drug select
  const drugSelect = document.getElementById('drugDose');
  (function populateDrugs(){
    drugSelect.innerHTML = '';
    Object.keys(drugData).forEach(name=>{
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      drugSelect.appendChild(opt);
    });
  })();

  // disease controls show/hide
  const patientHealth = document.getElementById('patientHealth');
  const diseaseDiv = document.getElementById('diseaseDiv');
  patientHealth.addEventListener('change', ()=> {
    diseaseDiv.style.display = patientHealth.value === 'unhealthy' ? 'block' : 'none';
    // uncheck when hiding
    if(patientHealth.value==='healthy'){
      document.querySelectorAll('.diseaseChk').forEach(ch=>ch.checked=false);
    }
  });

  // ASA factors: multipliers for dose (example clinical/safer approximations)
  const asaFactors = {
    'I': 1.00,
    'II': 0.95,
    'III': 0.85,
    'IV': 0.75,
    'V': 0.65,
    'VI': 0.5
  };

  // disease factors: multiply baseline dose by these (conservative reductions)
  const diseaseFactors = {
    diabetes: 0.95,
    heart: 0.8,
    lung: 0.85,
    liver: 0.7,
    kidney: 0.75,
    allergy: 0.9,
    obesity: 1.05 // obesity may increase distribution for some drugs but increases risk; treat carefully
  };

  // util: convert age to years float
  function ageToYears(val, unit){
    const v = parseFloat(val);
    if(isNaN(v) || v < 0) return NaN;
    if(unit === 'years') return v;
    if(unit === 'months') return v / 12;
    if(unit === 'days') return v / 365;
    return NaN;
  }

  // classify age into infant/child/adult
  function getAgeCategory(ageYears){
    if(ageYears < 1) return 'infant';
    if(ageYears < 12) return 'child';
    return 'adult';
  }

  // compute average if range array else return value
  function normDoseValue(dv){
    return Array.isArray(dv) ? (dv[0] + dv[1]) / 2 : dv;
  }

  // calculate total dose
  function calculateTotalDose(drugName, weightKg, ageYears, asaClass, diseasesArray){
    const doc = drugData[drugName];
    if(!doc) return null;

    const ageCat = getAgeCategory(ageYears);
    const dosePerKg = normDoseValue(doc.dose[ageCat]);
    // If unit is %MAC, we show concentration not mg â€” handle separately
    if(doc.unitPerKg === '%MAC'){
      // return MAC as % (not weight dependent)
      const mac = normDoseValue(doc.dose[ageCat]);
      // apply ASA/disease adjustments to MAC as percent (conservative)
      let factor = asaFactors[asaClass] || 1.0;
      diseasesArray.forEach(d=>{
        if(diseaseFactors[d]) factor *= diseaseFactors[d];
      });
      return { value: (mac * factor).toFixed(2), unit: '% MAC', note: 'ØªØ±ÙƒÙŠØ² ØºØ§Ø²ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ' };
    }

    // compute base total
    let total = dosePerKg * weightKg; // unitPerKg * kg = total mg or Âµg
    // apply ASA factor
    const asaF = asaFactors[asaClass] || 1.0;
    total *= asaF;
    // apply disease multipliers (multiply cumulative)
    diseasesArray.forEach(d=>{
      if(diseaseFactors[d]) total *= diseaseFactors[d];
    });

    // check max
    const maxObj = doc.max || null;
    if(maxObj){
      if(maxObj.unit === 'mg' || maxObj.unit === 'Âµg'){
        if(total > maxObj.value) total = maxObj.value;
      }
    }
    return { value: total, unitPerKg: doc.unitPerKg, unitTotal: doc.max ? doc.max.unit : (doc.unitPerKg.includes('Âµg') ? 'Âµg' : 'mg') };
  }

  // format result nicely
  function formatDoseResult(calc){
    if(!calc) return 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨';
    if(calc.unit === '% MAC') return `${calc.value} % MAC (${calc.note||''})`;
    // else total value numeric
    const unit = calc.unitTotal || (calc.unitPerKg && calc.unitPerKg.includes('Âµg') ? 'Âµg' : 'mg');
    // round sensible:
    let val = parseFloat(calc.value);
    if(isNaN(val)) return 'Ø®Ø·Ø£';
    if(unit === 'Âµg') val = Math.round(val);
    else if(val < 1) val = val.toFixed(2);
    else if(val < 10) val = val.toFixed(2);
    else val = val.toFixed(1);
    return `${val} ${unit}`;
  }

  // when calculate button clicked
  document.getElementById('calcDose').addEventListener('click', ()=>{
    const weight = parseFloat(document.getElementById('weightDose').value);
    const age = parseFloat(document.getElementById('ageDose').value);
    const ageUnit = document.getElementById('ageUnitDose').value;
    const asaClass = document.getElementById('asaSelect').value;
    const drugName = drugSelect.value;

    if(!weight || !age || !drugName){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù†ØŒ Ø§Ù„Ø¹Ù…Ø±ØŒ ÙˆØ§Ù„Ø¯ÙˆØ§Ø¡'); return; }

    const ageYears = ageToYears(age, ageUnit);
    if(isNaN(ageYears)){ alert('Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø±Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§'); return; }

    // collect diseases
    let diseases = [];
    if(document.getElementById('patientHealth').value === 'unhealthy')
