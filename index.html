<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</title>

<!-- ********** Ø³ØªØ§ÙŠÙ„ Ù…ØªÙƒØ§Ù…Ù„ (Dark/Light ready) ********** -->
<style>
  :root{
    --bg-dark:#071223; --bg-dark-2:#0b3045; --card:#0f2333;
    --accent:#0a9bd6; --accent-2:#11cdef; --glass: rgba(255,255,255,0.04);
    --success:#16a34a; --danger:#ff5252;
    --text:#e6f6ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg-dark),var(--bg-dark-2));color:var(--text);min-height:100vh;overflow-x:hidden;transition:background .35s,color .35s}
  .light body,.light :root{ /* not used directly but can flip classes if needed */ }
  header{padding:8px 18px;text-align:center;font-weight:700;background:linear-gradient(90deg,#072a40,#0a5f86);box-shadow:0 6px 20px rgba(2,6,23,.45)}
  header h1{margin:0;padding:6px 0;font-size:1.1rem}
  
  /* splash */
  #splash{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;background:linear-gradient(135deg,#071024 0%, #06293a 70%);overflow:hidden}
  .splash-top{width:92%;max-width:900px;display:flex;flex-direction:column;gap:12px;align-items:stretch;transform-origin:center}
  .splash-bar{
    background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    padding:18px;border-radius:12px;color:#eaf6ff;display:flex;flex-direction:column;gap:6px;
    box-shadow:0 10px 40px rgba(0,0,0,0.6);
  }
  .splash-bar .role{opacity:.9;font-size:13px;color:#cfefff}
  .splash-bar.dev{animation:barOutDev 5s cubic-bezier(.2,.9,.3,1) forwards}
  .splash-bar.mid{animation:barOutMid 5s cubic-bezier(.2,.9,.3,1) forwards}
  .splash-bar.top{animation:barOutTop 5s cubic-bezier(.2,.9,.3,1) forwards}
  @keyframes barOutTop{0%{transform:translateX(0);opacity:1}60%{opacity:1}100%{transform:translateX(-150%);opacity:0}}
  @keyframes barOutMid{0%{transform:translateX(0);opacity:1}60%{opacity:1}100%{transform:translateY(-120%);opacity:0}}
  @keyframes barOutDev{0%{transform:translateX(0);opacity:1}60%{opacity:1}100%{transform:translateX(150%);opacity:0}}
  .splash-note{color:#cfefff;opacity:.95}
  
  /* decorations */
  .decoration{position:fixed;inset:0;pointer-events:none;z-index:5}
  .bubble{position:absolute;border-radius:50%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.08), rgba(255,255,255,0.01));filter:blur(8px);opacity:.5;animation:float 9s ease-in-out infinite}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-50px)}100%{transform:translateY(0)}}
  .glow{position:absolute;border-radius:50%;filter:blur(40px);opacity:.7}
  
  /* app container */
  .app-wrap{position:relative;z-index:10;max-width:1200px;margin:34px auto;padding:20px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,0.6)}
  .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .btn{padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#042a3a;cursor:pointer;font-weight:700;min-width:140px}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .panel{display:none;margin-top:14px}
  label{display:block;margin:8px 0;text-align:right}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px}
  .result-box{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.2));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .pill{display:inline-block;padding:6px 10px;background:rgba(255,255,255,0.03);border-radius:999px;margin:6px 6px 0 0;color:#dff6ff}
  .sideEffect{background:rgba(255,60,60,0.06);border-left:4px solid rgba(255,80,80,0.9);padding:10px;margin:8px 0;border-radius:6px}
  .muted{color:#bcdcec;font-size:13px}
  footer{margin-top:18px;text-align:center;color:#93c1d8;font-size:13px}
  .chatBox{height:140px;overflow:auto;padding:10px;background:rgba(255,255,255,0.012);border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .controls-row{display:flex;gap:8px;align-items:center}
  .small-muted{font-size:12px;color:#a9d7ee}
  
  /* responsive tweaks */
  @media (max-width:720px){
    .grid{grid-template-columns:1fr}
    .top-actions{flex-direction:column}
  }
  
  /* light mode (toggle) */
  body.light{background:linear-gradient(180deg,#f5f8fb,#ffffff);color:#052036}
  body.light .card{background:#fff;box-shadow:0 12px 30px rgba(2,6,23,0.06)}
  body.light input,body.light select,body.light textarea{background:#fff;color:#052036;border:1px solid #e6eef6}
  body.light .splash-bar{color:#072a40}
  
  /* Login/Signup Screens */
  .auth-screen{position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#071024 0%, #06293a 70%);color:#fff;font-family:Tahoma}
  .auth-card{background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));padding:24px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.8);width:360px;text-align:center;border:1px solid rgba(255,255,255,0.1)}
  .auth-input{width:100%;margin-bottom:12px;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:#fff;font-size:14px}
  .auth-input::placeholder{color:#bcdcec}
  .auth-btn{width:100%;margin-bottom:10px;padding:12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#042a3a;font-weight:700;cursor:pointer;font-size:14px}
  .auth-btn.google{background:#fff;color:#333}
  .auth-btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.2);color:#fff}
  .error-msg{color:#ff5252;font-size:13px;margin-top:8px;display:none}
</style>
</head>
<body>

<!-- SPLASH / HIERARCHICAL BARS -->
<div id="splash">
  <div class="splash-top" style="width:86%">
    <!-- hierarchical: top -> middle -> dev (dev is last to disappear as requested) -->
    <div class="splash-bar top">
      <strong>Ø´Ø±ÙŠØ· 1 â€” Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ©</strong>
      <div class="role">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</div>
    </div>

    <div class="splash-bar mid">
      <strong>Ø´Ø±ÙŠØ· 2 â€” Ù…Ù†Ø¸Ù‘Ù…</strong>
      <div class="role">Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ± â€” @871c</div>
    </div>

    <div class="splash-bar dev">
      <strong>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</strong>
      <div class="role">Ù…Ù†Ø¸Ù… Ùˆ Ù…Ø·ÙˆØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” @ku56t</div>
    </div>
  </div>

  <div class="splash-note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙØªØ­ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ø·ÙŠØ¦Ø© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª)</div>

  <!-- decorative sparkles -->
  <div style="position:absolute;inset:0;pointer-events:none">
    <div style="position:absolute;left:6%;top:20%;width:14px;height:14px;background:rgba(255,255,255,0.12);border-radius:50%;filter:blur(6px);animation:float 7s infinite;"></div>
    <div style="position:absolute;right:12%;top:36%;width:18px;height:18px;background:rgba(255,255,255,0.08);border-radius:50%;filter:blur(9px);animation:float 9s infinite;"></div>
  </div>
</div>

<!-- decoration bubbles -->
<div class="decoration" aria-hidden="true">
  <div class="bubble" style="left:3%;top:10%;width:140px;height:140px;animation-duration:10s"></div>
  <div class="bubble" style="left:82%;top:18%;width:100px;height:100px;animation-duration:12s"></div>
  <div class="bubble" style="left:22%;top:75%;width:90px;height:90px;animation-duration:8s"></div>
  <div class="bubble" style="left:68%;top:82%;width:120px;height:120px;animation-duration:11s"></div>
  <div class="glow" style="left:2%;top:72%;width:300px;height:300px;background:radial-gradient(circle,#11cdef44,transparent);"></div>
  <div class="glow" style="right:2%;top:60%;width:260px;height:260px;background:radial-gradient(circle,#0a9bd644,transparent);"></div>
</div>

<!-- Login Screen -->
<div id="loginScreen" class="auth-screen" style="display:none">
  <div class="auth-card">
    <h2 style="margin-bottom:20px;color:#11cdef">Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ©</h2>
    <h3 style="margin-bottom:20px;font-size:16px">Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± Ø§Ù„Ù…ØªØ·ÙˆØ±</h3>
    
    <input id="loginEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="auth-input" data-testid="input-email">
    <input id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="auth-input" data-testid="input-password">
    
    <button id="loginBtn" class="auth-btn" data-testid="button-login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <button id="googleLoginBtn" class="auth-btn google" data-testid="button-google-signin">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google</button>
    
    <div style="margin:12px 0;color:#bcdcec">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</div>
    <button id="goSignup" class="auth-btn ghost" data-testid="link-signup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    
    <div id="loginError" class="error-msg" data-testid="error-message"></div>
    
    <div style="margin-top:16px;font-size:12px;color:#93c1d8">
      Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹
    </div>
  </div>
</div>

<!-- Signup Screen -->
<div id="signupScreen" class="auth-screen" style="display:none">
  <div class="auth-card">
    <h2 style="margin-bottom:20px;color:#11cdef">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    
    <input id="signupEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="auth-input" data-testid="input-signup-email">
    <input id="signupPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" class="auth-input" data-testid="input-signup-password">
    
    <button id="signupBtn" class="auth-btn" data-testid="button-signup">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    
    <div style="margin:12px 0;color:#bcdcec">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ</div>
    <button id="goLogin" class="auth-btn ghost" data-testid="link-login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    
    <div id="signupError" class="error-msg" data-testid="signup-error-message"></div>
  </div>
</div>

<!-- APP MAIN -->
<div class="app-wrap" id="app" style="display:none" data-testid="main-app">
  <div class="card">
    <header data-testid="header"><h1>Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â˜† â€” Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆÙ‘Ø±</h1></header>

    <div class="top-actions" style="margin-top:12px" data-testid="navigation">
      <button class="btn" id="showDose" data-testid="button-dose-panel">ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</button>
      <button class="btn" id="showFluids" data-testid="button-fluids-panel">ğŸ’§ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</button>
      <button class="btn" id="showAirway" data-testid="button-airway-panel">ğŸ« Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ / ETT</button>
      <button class="btn" id="showAdmin" data-testid="button-admin-panel">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      <button class="btn ghost" id="showAbout" data-testid="button-about-panel">â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
      <button class="btn ghost" id="toggleTheme" data-testid="button-toggle-theme">ğŸŒ™ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
      <div style="flex:1"></div>
      <div id="userInfo" class="muted" style="align-self:center" data-testid="text-user-email"></div>
      <button class="btn ghost" id="btnLogout" style="min-width:110px" data-testid="button-logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <!-- Panels -->
    <!-- Dose panel -->
    <section id="panelDose" class="panel">
      <h2>ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ±</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
            <input id="patientNameDose" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" data-testid="input-patient-name">
          </label>

          <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº)
            <input id="weightDose" type="number" placeholder="Ù…Ø«Ø§Ù„: 70" data-testid="input-weight">
          </label>

          <label>Ø§Ù„Ø¹Ù…Ø±
            <div style="display:flex;gap:8px">
              <input id="ageDose" type="number" placeholder="Ù…Ø«Ø§Ù„: 40" style="flex:1" data-testid="input-age">
              <select id="ageUnitDose" style="width:120px" data-testid="select-age-unit">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>ØªØµÙ†ÙŠÙ ASA
            <select id="asaSelect" data-testid="select-asa">
              <option value="I">ASA I</option>
              <option value="II">ASA II</option>
              <option value="III">ASA III</option>
              <option value="IV">ASA IV</option>
              <option value="V">ASA V</option>
            </select>
          </label>

          <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
            <select id="patientHealth" data-testid="select-patient-health">
              <option value="healthy">ØµØ­ÙŠ</option>
              <option value="unhealthy">Ù…Ø±ÙŠØ¶</option>
            </select>
          </label>

          <div id="diseaseDiv" style="display:none;margin-top:6px">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ (Ù…ØªØ¹Ø¯Ø¯)
              <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">
                <label><input type="checkbox" class="diseaseChk" value="diabetes"> Ø³ÙƒØ±ÙŠ</label>
                <label><input type="checkbox" class="diseaseChk" value="heart"> Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨ÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="lung"> Ø£Ù…Ø±Ø§Ø¶ Ø±Ø¦ÙˆÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="liver"> Ø£Ù…Ø±Ø§Ø¶ ÙƒØ¨Ø¯ÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="kidney"> Ø£Ù…Ø±Ø§Ø¶ ÙƒÙ„ÙˆÙŠÙ‘Ø©</label>
                <label><input type="checkbox" class="diseaseChk" value="allergy"> Ø­Ø³Ø§Ø³ÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="obesity"> Ø³Ù…Ù†Ø© Ù…ÙØ±Ø·Ø©</label>
              </div>
            </label>
          </div>

          <label>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡
            <select id="drugDose" data-testid="select-drug"></select>
          </label>

          <div class="controls-row" style="margin-top:8px">
            <button class="btn" id="calcDose" data-testid="button-calculate">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
            <button class="btn ghost" id="scanBagBtn" title="ÙØªØ­ ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ" data-testid="button-scan">ğŸ“· Ù…Ø³Ø­ ÙƒÙŠØ³ Ø§Ù„Ù…Ø±ÙŠØ¶</button>
            <div style="flex:1"></div>
          </div>

          <div style="margin-top:6px" class="small-muted">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ‚Ø±ÙŠØ¨ÙŠØ© â€” Ø±Ø§Ø¬Ø¹ Ø³Ø±ÙŠØ±ÙŠØ§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹.</div>
        </div>

        <div>
          <div id="doseResult" class="result-box" data-testid="result-dose"><b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</b></div>
          <div id="doseEffects" style="margin-top:12px"></div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

      <h3>Ø´Ø§Øª/Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
      <div class="chatBox" id="doseChat"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="doseChatInput" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ùˆ Ø³Ø¤Ø§Ù„" data-testid="input-chat">
        <button class="btn ghost" id="doseChatSend" data-testid="button-send-chat">Ø£Ø±Ø³Ù„</button>
      </div>
    </section>

    <!-- Fluids -->
    <section id="panelFluids" class="panel">
      <h2>ğŸ’§ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
            <input id="patientNameFluid" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" data-testid="input-patient-name-fluid">
          </label>

          <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº)
            <input id="weightFluid" type="number" placeholder="Ù…Ø«Ø§Ù„: 70" data-testid="input-weight-fluid">
          </label>

          <label>Ø§Ù„Ø¹Ù…Ø±
            <div style="display:flex;gap:8px">
              <input id="ageFluid" type="number" placeholder="Ù…Ø«Ø§Ù„: 40" style="flex:1" data-testid="input-age-fluid">
              <select id="ageUnitFluid" style="width:120px" data-testid="select-age-unit-fluid">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¦Ù„
            <select id="fluidType" data-testid="select-fluid-type">
              <option value="NS">Normal Saline (0.9% NaCl)</option>
              <option value="RL">Ringer Lactate</option>
              <option value="D5W">Dextrose 5% (D5W)</option>
              <option value="PRBC">PRBC - Ù†Ù‚Ù„ Ø¯Ù… (1 ÙˆØ­Ø¯Ø©)</option>
            </select>
          </label>

          <div style="margin-top:8px" class="controls-row">
            <button class="btn" id="calcFluids" data-testid="button-calculate-fluids">Ø§Ø­Ø³Ø¨</button>
            <div style="flex:1"></div>
          </div>
        </div>

        <div>
          <div id="fluidResult" class="result-box" data-testid="result-fluids"><b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</b></div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

      <h3>Ø´Ø§Øª/Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³ÙˆØ§Ø¦Ù„</h3>
      <div class="chatBox" id="fluidChat"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="fluidChatInput" placeholder="Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø³ÙˆØ§Ø¦Ù„/Ù†Ù‚Ù„ Ø¯Ù…" data-testid="input-fluid-chat">
        <button class="btn ghost" id="fluidChatSend" data-testid="button-send-fluid-chat">Ø£Ø±Ø³Ù„</button>
      </div>
    </section>

    <!-- Airway -->
    <section id="panelAirway" class="panel">
      <h2>ğŸ« Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ Ùˆ ETT</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
            <input id="patientNameAirway" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" data-testid="input-patient-name-airway">
          </label>

          <label>Ø§Ù„Ø¹Ù…Ø±
            <div style="display:flex;gap:8px">
              <input id="ageAirway" type="number" placeholder="Ù…Ø«Ø§Ù„: 3" style="flex:1" data-testid="input-age-airway">
              <select id="ageUnitAirway" style="width:120px" data-testid="select-age-unit-airway">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>Ø§Ù„ÙˆØ²Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            <input id="weightAirway" type="number" placeholder="ÙƒØº" data-testid="input-weight-airway">
          </label>

          <div style="margin-top:8px" class="controls-row">
            <button class="btn" id="calcAirway" data-testid="button-calculate-airway">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­</button>
            <button class="btn ghost" id="showScanner" data-testid="button-scan-airway">ğŸ” ÙƒØ§Ù…ÙŠØ±Ø§ (Ù…Ø³Ø­ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¶ÙˆØ¡)</button>
          </div>
        </div>

        <div>
          <div id="airwayResult" class="result-box" data-testid="result-airway">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

      <h3>Ø´Ø§Øª/Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
      <div class="chatBox" id="airwayChat"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="airwayChatInput" placeholder="Ø³Ø¤Ø§Ù„ Ø¹Ù† Airway/ETT" data-testid="input-airway-chat">
        <button class="btn ghost" id="airwayChatSend" data-testid="button-send-airway-chat">Ø£Ø±Ø³Ù„</button>
      </div>
    </section>

    <!-- Admin panel -->
    <section id="panelAdmin" class="panel">
      <h2>âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</h2>
      <div id="adminContent"></div>
      <div id="ownerControls" style="display:none;margin-top:10px">
        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
        <div>
          <button class="btn" id="btnRefreshUsers" data-testid="button-refresh-users">ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
          <div id="usersList" style="margin-top:8px"></div>
        </div>

        <h3 style="margin-top:12px">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (History)</h3>
        <div>
          <input id="searchHistory" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/Ø§Ù„Ø¯ÙˆØ§Ø¡" data-testid="input-search-history">
          <button class="btn ghost" id="btnSearchHistory" data-testid="button-search-history">Ø¨Ø­Ø«</button>
          <div id="historyList" style="margin-top:8px"></div>
        </div>
        
        <h3 style="margin-top:12px">Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯</h3>
        <div style="display:grid;gap:8px">
          <input id="drugName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡" data-testid="input-drug-name">
          <input id="drugDose" placeholder="Ø§Ù„Ø¬Ø±Ø¹Ø© (mg/kg Ø£Ùˆ Âµg/kg)" data-testid="input-drug-dose">
          <input id="drugSide" placeholder="Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©" data-testid="input-drug-side">
          <input id="drugTreatment" placeholder="Ø§Ù„Ø¹Ù„Ø§Ø¬" data-testid="input-drug-treatment">
          <button class="btn" onclick="addDrug()" data-testid="button-add-drug">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡</button>
          <div id="drugsList" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- About -->
    <section id="panelAbout" class="panel">
      <h2>â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
      <div class="result-box">
        <p>Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ± â€” Ù…ÙˆÙ‚Ø¹ ØªØ¹Ù„ÙŠÙ…ÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± ÙˆØ§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØªÙˆØµÙŠØ§Øª airway. Ø§Ù„ÙÙƒØ±Ø© Ù…Ù‚ØªØ±Ø­Ø© Ù…Ù† Ø·Ù„Ø§Ø¨ Ù‚Ø³Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„ÙƒÙˆØª (Ø§Ù„Ù…Ø±Ø­Ù„ØªØ§Ù† Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø±Ø§Ø¨Ø¹Ø©) Ø³Ù†Ø© 2026.</p>
        <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ÙˆØªØ·ÙˆÙŠØ±Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø©: <strong>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</strong> (@ku56t) â€” Ù…Ø·ÙˆØ± ÙˆÙ…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹. Ù…Ù†Ø¸Ù‘Ù…ÙˆÙ†: <strong>Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ±</strong> (@871c) Ùˆ <strong>Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰</strong> (@ans_mz1092).</p>
        <p>ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙÙ‚Ø·. Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ‚Ø±ÙŠØ¨ÙŠØ© â€” Ù„Ø§ ØªØ¹ÙˆÙ‘Ù„ Ø¹Ù„ÙŠÙ‡Ø§ Ø³Ø±ÙŠØ±ÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ø¨ÙŠØ¨ Ù…Ø®ØªØµ.</p>
      </div>
    </section>

    <footer>Â© Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ø±Ø§Ø¬Ø¹ Ø¯ÙˆÙ…Ø§Ù‹ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ±ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙŠ Ø¬Ø±Ø¹Ø©</footer>
  </div>
</div>

<!-- Camera modal / scanner (simple) -->
<div id="scannerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;align-items:center;justify-content:center">
  <div style="background:#021827;padding:12px;border-radius:12px;max-width:900px;width:90%;">
    <h3 style="margin:0 0 8px">ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ (Ù…Ø­Ø§ÙƒØ§Ø©)</h3>
    <p style="margin:0 0 8px;color:#cfe8ff">Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù„ÙƒÙŠØ³ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø£Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯ â€” Ù‡Ø°Ù‡ Ø®Ø§ØµÙŠØ© Ù…Ø­Ø§ÙƒØ§Ø©. Ù„ØªÙ…ÙƒÙŠÙ† OCR Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ù…Ø¬ Tesseract.js Ø£Ùˆ Ø®Ø¯Ù…Ø© Cloud Vision.</p>
    <video id="scannerVideo" autoplay style="width:100%;border-radius:8px;background:#000" data-testid="video-scanner"></video>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="captureBtn" class="btn" data-testid="button-capture">Ø§Ù„ØªÙ‚Ø§Ø·</button>
      <button id="closeScanner" class="btn ghost" data-testid="button-close-scanner">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="scanResult" style="margin-top:12px" class="result-box" data-testid="result-scan"></div>
  </div>
</div>

<!-- Firebase & App Script (module) -->
<script type="module">
/* ===================== Firebase init ===================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, createUserWithEmailAndPassword, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, updateDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
  authDomain: "anesthesia-dose-262e3.firebaseapp.com",
  projectId: "anesthesia-dose-262e3",
  storageBucket: "anesthesia-dose-262e3.appspot.com",
  messagingSenderId: "602244448093",
  appId: "1:602244448093:web:0a8d9905849126086ff2b4",
  measurementId: "G-SCHMQFCK3J"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===================== Settings & constants ===================== */
const OWNER_EMAIL = "bama47686@gmail.com"; // owner fixed

/* Helper UI refs */
const splash = document.getElementById('splash');
const appWrap = document.getElementById('app');
const userInfoEl = document.getElementById('userInfo');
const btnLogout = document.getElementById('btnLogout');
const loginScreen = document.getElementById('loginScreen');
const signupScreen = document.getElementById('signupScreen');

/* Auth state management */
let currentUser = null;

/* Arabic error messages */
const getErrorMessage = (errorCode) => {
  const errorMessages = {
    'auth/user-not-found': 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
    'auth/wrong-password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
    'auth/invalid-email': 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­',
    'auth/user-disabled': 'ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨',
    'auth/too-many-requests': 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ø§Øª ÙƒØ«ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹',
    'auth/email-already-in-use': 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„',
    'auth/weak-password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹',
    'auth/operation-not-allowed': 'Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø©',
    'auth/popup-closed-by-user': 'ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©',
    'auth/cancelled-popup-request': 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©',
    'auth/invalid-credential': 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­Ø©'
  };
  return errorMessages[errorCode] || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹';
};

/* Show error message */
function showError(elementId, message) {
  const errorEl = document.getElementById(elementId);
  errorEl.textContent = message;
  errorEl.style.display = 'block';
  setTimeout(() => {
    errorEl.style.display = 'none';
  }, 5000);
}

/* Panels */
const panels = { showDose:'panelDose', showFluids:'panelFluids', showAirway:'panelAirway', showAdmin:'panelAdmin', showAbout:'panelAbout' };
Object.keys(panels).forEach(btnId=>{
  const el = document.getElementById(btnId);
  if(!el) return;
  el.addEventListener('click', ()=> showPanel(panels[btnId]));
});
function showPanel(id){ 
  Object.values(panels).forEach(pid=>document.getElementById(pid).style.display='none'); 
  document.getElementById(id).style.display='block'; 
  window.scrollTo({top:0,behavior:'smooth'}); 
}

/* Splash hide after 5s (bars animations) */
let splashTimeout = setTimeout(hideSplash, 5000);
function hideSplash(){
  if(!splash || splash.style.display === 'none') return;
  splash.style.transition='opacity .25s, transform .25s';
  splash.style.opacity='0';
  splash.style.transform='translateY(-20px)';
  setTimeout(()=>{ splash.style.display='none'; appWrap.style.display='block'; },300);
}
// allow user to skip splash by click or Escape key
splash.addEventListener('click', ()=>{ clearTimeout(splashTimeout); hideSplash(); });
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ clearTimeout(splashTimeout); hideSplash(); } });

/* Auth navigation */
document.getElementById('goSignup').addEventListener('click', ()=>{
  loginScreen.style.display = 'none';
  signupScreen.style.display = 'flex';
});
document.getElementById('goLogin').addEventListener('click', ()=>{
  signupScreen.style.display = 'none';
  loginScreen.style.display = 'flex';
});

/* Login */
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPass').value.trim();
  
  if (!email || !password) {
    showError('loginError', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    return;
  }

  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (error) {
    showError('loginError', getErrorMessage(error.code));
  }
});

/* Signup */
document.getElementById('signupBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPass').value.trim();
  
  if (!email || !password) {
    showError('signupError', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    return;
  }
  
  if (password.length < 6) {
    showError('signupError', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    return;
  }

  try {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    const user = cred.user;
    
    // Save user data to Firestore
    await setDoc(doc(db, 'users', user.uid), {
      email: user.email,
      uid: user.uid,
      role: (email === OWNER_EMAIL) ? 'owner' : 'user',
      createdAt: serverTimestamp()
    });
  } catch (error) {
    showError('signupError', getErrorMessage(error.code));
  }
});

/* Google Sign-in */
document.getElementById('googleLoginBtn').addEventListener('click', async ()=>{
  try {
    const provider = new GoogleAuthProvider();
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    
    // Save user data to Firestore
    await setDoc(doc(db, 'users', user.uid), {
      email: user.email,
      uid: user.uid,
      role: (user.email === OWNER_EMAIL) ? 'owner' : 'user',
      createdAt: serverTimestamp()
    }, { merge: true });
  } catch (error) {
    showError('loginError', getErrorMessage(error.code));
  }
});

/* Logout */
btnLogout.addEventListener('click', async ()=>{
  try {
    await signOut(auth);
  } catch (error) {
    console.error('Logout error:', error);
  }
});

/* Auth state listener */
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    userInfoEl.textContent = user.email;
    
    // Hide auth screens and splash, show app
    loginScreen.style.display = 'none';
    signupScreen.style.display = 'none';
    clearTimeout(splashTimeout);
    hideSplash();
    
    // Check if user is owner
    if (user.email === OWNER_EMAIL) {
      document.getElementById('ownerControls').style.display = 'block';
      document.getElementById('adminContent').innerHTML = '<p style="color:#16a34a">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø§Ù„Ù…Ø§Ù„Ùƒ: ' + user.email + '</p>';
    } else {
      document.getElementById('ownerControls').style.display = 'none';
      document.getElementById('adminContent').innerHTML = '<p>Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ø®ØµØµ Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙ‚Ø·.</p>';
    }
    
    // Show dose panel by default
    showPanel('panelDose');
  } else {
    currentUser = null;
    userInfoEl.textContent = '';
    appWrap.style.display = 'none';
    splash.style.display = 'none';
    loginScreen.style.display = 'flex';
    signupScreen.style.display = 'none';
  }
});

/* Toggle theme */
document.getElementById('toggleTheme').addEventListener('click', ()=>{
  document.body.classList.toggle('light');
});

/* ========== Drug database with side effects + reduction methods ==========
   You can extend this object: add drugs with dose (per age category mg/kg or Âµg/kg), max, side_effects[], management[], reduce (text)
*/
const drugData = {
  "Propofol":{
    dose:{ infant:[2.5,3.0], child:[2.0,2.5], adult:2.5 },
    max:{value:300,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù…","ØªÙˆÙ‚Ù ØªÙ†ÙÙ‘Ø³ Ù…Ø¤Ù‚Øª","Ø£Ù„Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ù‚Ù†","Propofol infusion syndrome Ø¹Ù†Ø¯ ØªØ³Ø±ÙŠØ¨ Ø·ÙˆÙŠÙ„"],
    management:["Ø³ÙˆØ§Ø¦Ù„ Ùˆ/Ø£Ùˆ Vasopressors","Ø¯Ø¹Ù… Ø§Ù„ØªÙ†ÙÙ‘Ø³ ÙˆØªÙ‡ÙˆÙŠØ©","Lidocaine Ù‚Ø¨Ù„ Ø§Ù„Ø­Ù‚Ù†","Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø±ÙŠØ¨ ÙˆØ¯Ø¹Ù… Ù‚Ù„Ø¨ÙŠ/ØªÙ†ÙØ³ÙŠ"],
    reduce:"Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø±Ø¹Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù†Ø®ÙØ¶Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… ØªØ³Ø±ÙŠØ¨ Ù…Ø³ØªÙ…Ø± Ø¨Ø·ÙŠØ¡ØŒ Ù‚Ù„Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆÙ…Ø±Ø¶Ù‰ Ø§Ù„Ù‚Ù„Ø¨."
  },
  "Midazolam":{
    dose:{ infant:[0.05,0.1], child:[0.05,0.2], adult:0.15 },
    max:{value:10,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["ØªÙ‡Ø¯Ø¦Ø© Ù…ÙØ±Ø·Ø©","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·","Ø±Ø¯ÙˆØ¯ Ø¹ÙƒØ³ÙŠØ© Ù†Ø§Ø¯Ø±Ø©"],
    management:["Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¹Ù†Ø§ÙŠØ© ØªÙ†ÙÙ‘Ø³ÙŠØ©","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø£Ùˆ Flumazenil (Ù…Ø¶Ø§Ø¯)"],
    reduce:"Ù‚Ù„Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆØ£ÙŠØ¶Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù†Ø®ÙØ§Ø¶ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙƒØ¨Ø¯."
  },
  "Fentanyl":{
    dose:{ infant:[1,2], child:[2,3], adult:2 }, // Âµg/kg
    max:{value:300,unit:'Âµg'}, unitPerKg:'Âµg/kg',
    side_effects:["ØªØ«Ø¨ÙŠØ· ØªÙ†ÙØ³ÙŠ","ØªØ¨Ø§Ø·Ø¤ Ù†Ø¨Ø¶ Ø§Ù„Ù‚Ù„Ø¨","ØºØ«ÙŠØ§Ù†/Ù‚ÙŠØ¡"],
    management:["Ø¯Ø¹Ù… ØªÙ†ÙØ³ÙŠØŒ Naloxone Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©","Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ù„Ø¨ÙŠØ©","Ø£Ø¯ÙˆÙŠØ© Ù…Ø¶Ø§Ø¯Ø© Ù„Ù„ØºØ«ÙŠØ§Ù†"],
    reduce:"Ø§Ø³ØªØ®Ø¯Ù… Ø¬Ø±Ø¹Ø§Øª Ù…Ù‚Ø³Ù…Ø© (titrate) ÙˆØ§Ø¨ØªØ¹Ø¯ Ø¹Ù† Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„ØªØ±ÙƒÙŠØ² ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆØ§Ù„Ù…ØµØ§Ø¨ÙŠÙ† Ø¨Ø£Ù…Ø±Ø§Ø¶ Ø±Ø¦ÙˆÙŠØ©."
  },
  "Ketamine":{
    dose:{ infant:[2,3], child:[4,5], adult:1.5 }, // mg/kg
    max:{value:300,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["Ø²ÙŠØ§Ø¯Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…","ØªÙŠØ¨Ù‘Ø³ Ø¹Ø¶Ù„ÙŠ","Ù‡Ù„ÙˆØ³Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙØ§Ù‚Ø©"],
    management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· ÙˆÙ†Ø¨Ø¶","Midazolam ÙƒÙ…Ù‡Ø¯Ø¦ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©","Ø¨ÙŠØ¦Ø© Ù‡Ø§Ø¯Ø¦Ø© Ù„Ù„Ù…Ø±Ø¶Ù‰"],
    reduce:"Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ø±Ø¹Ø§Øª Ø£ØµØºØ± Ø¹Ù†Ø¯ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆØ®Ù„Ø·Ù‡Ø§ Ù…Ø¹ Ù…Ø³ÙƒÙ†Ø§Øª Ø£Ùˆ Ø¨Ù†Ø²ÙˆØ¯ÙŠØ§Ø²ÙŠØ¨ÙŠÙ† Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡Ù„ÙˆØ³Ø©."
  },
  "Thiopental":{
    dose:{ infant:[5,8], child:[6,8], adult:5 },
    max:{value:500,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø´Ø¯ÙŠØ¯","ØªÙˆÙ‚Ù ØªÙ†ÙØ³","ØªØ­Ø³Ø³ Ù†Ø§Ø¯Ø±"],
    management:["Ø³ÙˆØ§Ø¦Ù„ ÙˆVasopressors ÙÙˆØ±ÙŠØ©","ØªÙ‡ÙˆÙŠØ© Ø§ØµØ·Ù†Ø§Ø¹ÙŠØ©","Ù…Ø¶Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø³ÙŠØ© Ø¥Ø°Ø§ Ù„Ø²Ù…"],
    reduce:"ØªØ¬Ù†Ø¨ ÙÙŠ Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù‚Ù„Ø¨ Ø£Ùˆ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ù…Ù†Ø®ÙØ¶ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¬Ø±Ø¹Ø§Øª ØµØºÙŠØ±Ø© Ù…ØªØ¯Ø±Ø¬Ø©."
  },
  "Sevoflurane":{
    dose:{ infant:[2,3], child:[2.5,3], adult:2 }, // MAC
    max:{value:8,unit:'%'}, unitPerKg:'MAC',
    side_effects:["Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ·","ØªØ«Ø¨ÙŠØ· ØªÙ†ÙØ³","ØºØ«ÙŠØ§Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ø±Ø§Ø­Ø©"],
    management:["ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ²","Ø¯Ø¹Ù… Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø¯Ù…ÙˆÙŠØ©","Ø£Ø¯ÙˆÙŠØ© Ù…Ø¶Ø§Ø¯Ø© Ù„Ù„ØºØ«ÙŠØ§Ù†"],
    reduce:"Ø§Ø¨Ø¯Ø£ Ø¨ØªØ±Ø§ÙƒÙŠØ² Ù…Ù†Ø®ÙØ¶Ø© ÙˆØ§Ø±ÙØ¹ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ØŒ Ù‚Ù„Ù„ ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù†."
  },
  "Rocuronium":{
    dose:{ infant:[0.6,1.2], child:[0.6,1.2], adult:0.6 },
    max:{value:100,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["Ø´Ù„Ù„ Ø¹Ø¶Ù„ÙŠ Ù…Ø·ÙˆÙ„","ØµØ¹ÙˆØ¨Ø© ØªÙ†ÙØ³"],
    management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ø¶Ù„ÙŠØ©","Sugammadex Ù„Ù„Ø¹ÙƒØ³","ØªÙ‡ÙˆÙŠØ© Ù…Ø³Ø§Ø¹Ø¯Ø©"],
    reduce:"Ø§Ø³ØªØ®Ø¯Ù… Ø¬Ø±Ø¹Ø§Øª Ø£Ù‚Ù„ Ù…Ø¹ Ù…Ø±Ø§Ù‚Ø¨Ø© TOFØŒ ØªØ¬Ù†Ø¨ ÙÙŠ Ù…Ø±Ø¶Ù‰ Ø§Ù„ÙˆÙ‡Ù† Ø§Ù„Ø¹Ø¶Ù„ÙŠ."
  },
  "Atracurium":{
    dose:{ infant:[0.3,0.5], child:[0.4,0.5], adult:0.5 },
    max:{value:50,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["Ø¥Ø·Ù„Ø§Ù‚ Ù‡Ø³ØªØ§Ù…ÙŠÙ†","Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø®ÙÙŠÙ"],
    management:["Ù…Ø¶Ø§Ø¯Ø§Øª Ù‡Ø³ØªØ§Ù…ÙŠÙ†","Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…"],
    reduce:"Ù‚Ù„Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø­Ø³Ø§Ø³ÙŠØ©ØŒ Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ."
  },
  "Lidocaine":{
    dose:{ infant:[1,2], child:[2,3], adult:3 },
    max:{value:300,unit:'mg'}, unitPerKg:'mg/kg',
    side_effects:["ØªØ´Ù†Ø¬Ø§Øª","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"],
    management:["Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø±ÙŠØ¨ØŒ Benzodiazepine Ù„Ù„ØªØ´Ù†Ø¬Ø§Øª"],
    reduce:"Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù‚ØµÙˆÙ‰ØŒ Ø±Ø§Ù‚Ø¨ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø³Ù…ÙŠØ©."
  }
};

/* Initialize drug dropdown */
function initDrugDropdown(){
  const select = document.getElementById('drugDose');
  select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡ --</option>';
  Object.keys(drugData).forEach(drug => {
    const option = document.createElement('option');
    option.value = drug;
    option.textContent = drug;
    select.appendChild(option);
  });
}

/* Disease visibility toggle */
document.getElementById('patientHealth').addEventListener('change', function(){
  const diseaseDiv = document.getElementById('diseaseDiv');
  diseaseDiv.style.display = this.value === 'unhealthy' ? 'block' : 'none';
});

/* Age conversion helper */
function convertToMonths(age, unit) {
  if (unit === 'years') return age * 12;
  if (unit === 'days') return age / 30;
  return age; // months
}

/* Get age category */
function getAgeCategory(ageInMonths) {
  if (ageInMonths < 12) return 'infant';
  if (ageInMonths < 144) return 'child'; // < 12 years
  return 'adult';
}

/* Calculate dose */
document.getElementById('calcDose').addEventListener('click', async function(){
  const patientName = document.getElementById('patientNameDose').value;
  const weight = parseFloat(document.getElementById('weightDose').value);
  const age = parseFloat(document.getElementById('ageDose').value);
  const ageUnit = document.getElementById('ageUnitDose').value;
  const drug = document.getElementById('drugDose').value;
  const asa = document.getElementById('asaSelect').value;
  const health = document.getElementById('patientHealth').value;
  
  if (!weight || !age || !drug) {
    document.getElementById('doseResult').innerHTML = '<b style="color:#ff5252">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø¹Ù…Ø± ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ§Ø¡</b>';
    return;
  }
  
  const drugInfo = drugData[drug];
  const ageInMonths = convertToMonths(age, ageUnit);
  const ageCategory = getAgeCategory(ageInMonths);
  
  let doseRange = drugInfo.dose[ageCategory];
  if (Array.isArray(doseRange)) {
    doseRange = doseRange[0]; // Use lower end for safety
  }
  
  // Adjust for ASA and health status
  let adjustmentFactor = 1;
  if (asa === 'III' || asa === 'IV' || asa === 'V') adjustmentFactor *= 0.8;
  if (health === 'unhealthy') adjustmentFactor *= 0.9;
  
  const calculatedDose = (doseRange * weight * adjustmentFactor).toFixed(2);
  const maxDose = drugInfo.max.value;
  const finalDose = Math.min(calculatedDose, maxDose);
  
  let result = `
    <div style="border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;margin-bottom:8px">
      <b>Ø§Ù„Ù…Ø±ÙŠØ¶:</b> ${patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
      <b>Ø§Ù„ÙˆØ²Ù†:</b> ${weight} ÙƒØº | <b>Ø§Ù„Ø¹Ù…Ø±:</b> ${age} ${ageUnit === 'years' ? 'Ø³Ù†Ø©' : ageUnit === 'months' ? 'Ø´Ù‡Ø±' : 'ÙŠÙˆÙ…'}<br>
      <b>ØªØµÙ†ÙŠÙ ASA:</b> ${asa} | <b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${health === 'healthy' ? 'ØµØ­ÙŠ' : 'Ù…Ø±ÙŠØ¶'}
    </div>
    
    <div style="background:rgba(16,163,74,0.1);padding:10px;border-radius:8px;border-left:4px solid #16a34a">
      <h4 style="margin:0 0 8px;color:#16a34a">${drug}</h4>
      <b>Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©:</b> ${finalDose} ${drugInfo.unitPerKg.replace('/kg', '')}<br>
      <b>Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</b> ${doseRange} ${drugInfo.unitPerKg}<br>
      <b>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰:</b> ${drugInfo.max.value} ${drugInfo.max.unit}
    </div>
  `;
  
  if (finalDose < calculatedDose) {
    result += `<div style="color:#fbbf24;margin-top:8px">âš ï¸ ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­</div>`;
  }
  
  document.getElementById('doseResult').innerHTML = result;
  
  // Show side effects
  let effectsHtml = `
    <div style="margin-top:12px">
      <h4>Ø§Ù„Ø¢Ø«Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:</h4>
  `;
  drugInfo.side_effects.forEach(effect => {
    effectsHtml += `<div class="sideEffect">${effect}</div>`;
  });
  
  effectsHtml += `<h4>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ø§Ù„Ø¹Ù„Ø§Ø¬:</h4>`;
  drugInfo.management.forEach(mgmt => {
    effectsHtml += `<div class="pill">${mgmt}</div>`;
  });
  
  effectsHtml += `<div style="margin-top:12px"><b>Ù†ØµØ§Ø¦Ø­ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±:</b><br><div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;margin-top:4px">${drugInfo.reduce}</div></div>`;
  effectsHtml += `</div>`;
  
  document.getElementById('doseEffects').innerHTML = effectsHtml;
  
  // Log calculation to Firebase if user is logged in
  if (currentUser) {
    try {
      await addDoc(collection(db, 'calculations'), {
        userId: currentUser.uid,
        userEmail: currentUser.email,
        patientName: patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        type: 'dose',
        drug: drug,
        weight: weight,
        age: age,
        ageUnit: ageUnit,
        calculatedDose: finalDose,
        timestamp: serverTimestamp()
      });
    } catch (error) {
      console.error('Error logging calculation:', error);
    }
  }
});

/* Fluids calculation */
document.getElementById('calcFluids').addEventListener('click', async function(){
  const patientName = document.getElementById('patientNameFluid').value;
  const weight = parseFloat(document.getElementById('weightFluid').value);
  const age = parseFloat(document.getElementById('ageFluid').value);
  const ageUnit = document.getElementById('ageUnitFluid').value;
  const fluidType = document.getElementById('fluidType').value;
  
  if (!weight || !age) {
    document.getElementById('fluidResult').innerHTML = '<b style="color:#ff5252">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø¹Ù…Ø±</b>';
    return;
  }
  
  // Basic fluid calculation - Holliday-Segar method
  let maintenanceFluid = 0;
  if (weight <= 10) {
    maintenanceFluid = weight * 100;
  } else if (weight <= 20) {
    maintenanceFluid = 1000 + (weight - 10) * 50;
  } else {
    maintenanceFluid = 1500 + (weight - 20) * 20;
  }
  
  let result = `
    <div style="border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;margin-bottom:8px">
      <b>Ø§Ù„Ù…Ø±ÙŠØ¶:</b> ${patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
      <b>Ø§Ù„ÙˆØ²Ù†:</b> ${weight} ÙƒØº | <b>Ø§Ù„Ø¹Ù…Ø±:</b> ${age} ${ageUnit === 'years' ? 'Ø³Ù†Ø©' : ageUnit === 'months' ? 'Ø´Ù‡Ø±' : 'ÙŠÙˆÙ…'}
    </div>
    
    <div style="background:rgba(16,163,74,0.1);padding:10px;border-radius:8px;border-left:4px solid #16a34a">
      <h4 style="margin:0 0 8px;color:#16a34a">${fluidType}</h4>
      <b>Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</b> ${maintenanceFluid} Ù…Ù„/24 Ø³Ø§Ø¹Ø©<br>
      <b>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ³Ø±ÙŠØ¨:</b> ${(maintenanceFluid / 24).toFixed(1)} Ù…Ù„/Ø³Ø§Ø¹Ø©
    </div>
  `;
  
  if (fluidType === 'PRBC') {
    const prbcVolume = weight * 10; // 10-15 ml/kg typically
    result += `
      <div style="background:rgba(220,38,38,0.1);padding:10px;border-radius:8px;border-left:4px solid #dc2626;margin-top:8px">
        <b>Ù†Ù‚Ù„ Ø§Ù„Ø¯Ù… (PRBC):</b><br>
        <b>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­:</b> ${prbcVolume} Ù…Ù„ (10 Ù…Ù„/ÙƒØº)<br>
        <b>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ³Ø±ÙŠØ¨:</b> 1-2 Ù…Ù„/ÙƒØº/Ø³Ø§Ø¹Ø©<br>
        <b>Ø§Ù„Ù…Ø¯Ø©:</b> 2-4 Ø³Ø§Ø¹Ø§Øª ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
      </div>
    `;
  }
  
  document.getElementById('fluidResult').innerHTML = result;
  
  // Log calculation
  if (currentUser) {
    try {
      await addDoc(collection(db, 'calculations'), {
        userId: currentUser.uid,
        userEmail: currentUser.email,
        patientName: patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        type: 'fluids',
        fluidType: fluidType,
        weight: weight,
        age: age,
        ageUnit: ageUnit,
        maintenanceFluid: maintenanceFluid,
        timestamp: serverTimestamp()
      });
    } catch (error) {
      console.error('Error logging calculation:', error);
    }
  }
});

/* Airway calculation */
document.getElementById('calcAirway').addEventListener('click', async function(){
  const patientName = document.getElementById('patientNameAirway').value;
  const age = parseFloat(document.getElementById('ageAirway').value);
  const ageUnit = document.getElementById('ageUnitAirway').value;
  const weight = parseFloat(document.getElementById('weightAirway').value);
  
  if (!age) {
    document.getElementById('airwayResult').innerHTML = '<b style="color:#ff5252">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù…Ø±</b>';
    return;
  }
  
  const ageInYears = ageUnit === 'years' ? age : ageUnit === 'months' ? age / 12 : age / 365;
  
  // ETT size calculation
  let ettSize;
  if (ageInYears < 1) {
    ettSize = 3.5;
  } else if (ageInYears < 2) {
    ettSize = 4.0;
  } else {
    ettSize = (ageInYears / 4) + 4;
  }
  
  // Laryngoscope blade
  let bladeSize;
  if (ageInYears < 1) {
    bladeSize = "0-1 (Miller)";
  } else if (ageInYears < 3) {
    bladeSize = "1-2 (Miller Ø£Ùˆ Mac)";
  } else if (ageInYears < 8) {
    bladeSize = "2-3 (Macintosh)";
  } else {
    bladeSize = "3-4 (Macintosh)";
  }
  
  // Depth calculation
  const depth = ettSize * 3;
  
  let result = `
    <div style="border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;margin-bottom:8px">
      <b>Ø§Ù„Ù…Ø±ÙŠØ¶:</b> ${patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
      <b>Ø§Ù„Ø¹Ù…Ø±:</b> ${age} ${ageUnit === 'years' ? 'Ø³Ù†Ø©' : ageUnit === 'months' ? 'Ø´Ù‡Ø±' : 'ÙŠÙˆÙ…'}
      ${weight ? `<br><b>Ø§Ù„ÙˆØ²Ù†:</b> ${weight} ÙƒØº` : ''}
    </div>
    
    <div style="background:rgba(16,163,74,0.1);padding:10px;border-radius:8px;border-left:4px solid #16a34a">
      <h4 style="margin:0 0 8px;color:#16a34a">ØªÙˆØµÙŠØ§Øª Airway</h4>
      <b>Ø­Ø¬Ù… ETT:</b> ${ettSize.toFixed(1)} Ù…Ù…<br>
      <b>Ø¹Ù…Ù‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„:</b> ${depth.toFixed(1)} Ø³Ù…<br>
      <b>Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨:</b> ${bladeSize}
    </div>
  `;
  
  if (ageInYears < 8) {
    result += `<div style="color:#fbbf24;margin-top:8px">âš ï¸ Ù„Ù„Ø£Ø·ÙØ§Ù„ ØªØ­Øª 8 Ø³Ù†ÙˆØ§Øª: Ø§Ø³ØªØ®Ø¯Ù… uncuffed ETT Ø£Ùˆ low-pressure cuffed</div>`;
  }
  
  document.getElementById('airwayResult').innerHTML = result;
  
  // Log calculation
  if (currentUser) {
    try {
      await addDoc(collection(db, 'calculations'), {
        userId: currentUser.uid,
        userEmail: currentUser.email,
        patientName: patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        type: 'airway',
        age: age,
        ageUnit: ageUnit,
        weight: weight || null,
        ettSize: ettSize,
        depth: depth,
        timestamp: serverTimestamp()
      });
    } catch (error) {
      console.error('Error logging calculation:', error);
    }
  }
});

/* Camera/Scanner functionality */
const scannerModal = document.getElementById('scannerModal');
const scannerVideo = document.getElementById('scannerVideo');
let mediaStream = null;

// Open scanner for dose panel
document.getElementById('scanBagBtn').addEventListener('click', openScanner);
document.getElementById('showScanner').addEventListener('click', openScanner);

async function openScanner() {
  try {
    scannerModal.style.display = 'flex';
    mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
    scannerVideo.srcObject = mediaStream;
    
    document.getElementById('scanResult').innerHTML = 'ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø© - ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¢Ù†';
  } catch (error) {
    document.getElementById('scanResult').innerHTML = 'Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + error.message;
  }
}

document.getElementById('captureBtn').addEventListener('click', function(){
  const canvas = document.createElement('canvas');
  const context = canvas.getContext('2d');
  canvas.width = scannerVideo.videoWidth;
  canvas.height = scannerVideo.videoHeight;
  context.drawImage(scannerVideo, 0, 0);
  
  // Simulate OCR result
  document.getElementById('scanResult').innerHTML = `
    <div style="color:#16a34a">âœ… ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©</div>
    <div style="margin-top:8px">Ù†ØªÙŠØ¬Ø© Ù…Ø­Ø§ÙƒØ§Ø© OCR:<br>
    â€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯<br>
    â€¢ Ø§Ù„ÙˆØ²Ù†: 70 ÙƒØº<br>
    â€¢ Ø§Ù„Ø¹Ù…Ø±: 45 Ø³Ù†Ø©<br>
    â€¢ Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠØ±: 12A</div>
    <div style="margin-top:8px;font-size:12px;color:#93c1d8">
    Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ù†ØªÙŠØ¬Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©. ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙƒØªØ¨Ø© OCR Ù…Ø«Ù„ Tesseract.js
    </div>
  `;
});

document.getElementById('closeScanner').addEventListener('click', function(){
  if (mediaStream) {
    mediaStream.getTracks().forEach(track => track.stop());
    mediaStream = null;
  }
  scannerModal.style.display = 'none';
});

/* Admin functions */
window.loadUsers = function(){
  const usersList = document.getElementById("usersList");
  usersList.innerHTML = "<p>Ù…ÙŠØ²Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªØªØ·Ù„Ø¨ Firebase Admin SDK (ÙŠØ´ØªØºÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙ‚Ø·).</p>";
}

window.addDrug = function(){
  const name = document.getElementById("drugName").value;
  const dose = document.getElementById("drugDose").value;
  const side = document.getElementById("drugSide").value;
  const treatment = document.getElementById("drugTreatment").value;
  if(name && dose){
    const div = document.createElement("div");
    div.style.border = "1px solid #ddd";
    div.style.padding = "5px";
    div.style.marginTop = "5px";
    div.innerHTML = "<b>"+name+"</b> | Ø¬Ø±Ø¹Ø©: "+dose+" | Ø£Ø¹Ø±Ø§Ø¶: "+side+" | Ø¹Ù„Ø§Ø¬: "+treatment;
    document.getElementById("drugsList").appendChild(div);
    
    // Clear inputs
    document.getElementById("drugName").value = "";
    document.getElementById("drugDose").value = "";
    document.getElementById("drugSide").value = "";
    document.getElementById("drugTreatment").value = "";
  }
}

/* Search history */
document.getElementById('btnSearchHistory').addEventListener('click', async function(){
  if (!currentUser || currentUser.email !== OWNER_EMAIL) return;
  
  const searchTerm = document.getElementById('searchHistory').value.trim();
  const historyList = document.getElementById('historyList');
  
  try {
    let q = collection(db, 'calculations');
    if (searchTerm) {
      // This is a simple search - in production you'd want full-text search
      q = query(q, orderBy('timestamp', 'desc'), limit(50));
    } else {
      q = query(q, orderBy('timestamp', 'desc'), limit(20));
    }
    
    const snapshot = await getDocs(q);
    let html = '<div style="max-height:300px;overflow:auto">';
    
    snapshot.forEach(doc => {
      const data = doc.data();
      const date = data.timestamp ? data.timestamp.toDate().toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      html += `
        <div style="border:1px solid rgba(255,255,255,0.1);padding:8px;margin:4px 0;border-radius:6px">
          <b>${data.patientName}</b> | ${data.userEmail}<br>
          Ø§Ù„Ù†ÙˆØ¹: ${data.type} | Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}
        </div>
      `;
    });
    
    html += '</div>';
    historyList.innerHTML = html;
  } catch (error) {
    historyList.innerHTML = 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message;
  }
});

/* Refresh users */
document.getElementById('btnRefreshUsers').addEventListener('click', async function(){
  if (!currentUser || currentUser.email !== OWNER_EMAIL) return;
  
  try {
    const snapshot = await getDocs(collection(db, 'users'));
    let html = '<div style="max-height:200px;overflow:auto">';
    
    snapshot.forEach(doc => {
      const data = doc.data();
      html += `
        <div style="border:1px solid rgba(255,255,255,0.1);padding:6px;margin:2px 0;border-radius:4px">
          ${data.email} | Ø¯ÙˆØ±: ${data.role}
        </div>
      `;
    });
    
    html += '</div>';
    document.getElementById('usersList').innerHTML = html;
  } catch (error) {
    document.getElementById('usersList').innerHTML = 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ' + error.message;
  }
});

/* Initialize app */
initDrugDropdown();

/* ========== Simple page-ready message ========== */
console.log('ANS Anesthesia app loaded.');

</script>

<!-- AI Chat Integration -->
<script type="module">
// OpenAI API Key (Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙØªØ§Ø­ ØµØ§Ù„Ø­)
const OPENAI_API_KEY = "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";

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ AI
async function callAI(message) {
  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [{ 
          role: "system", 
          content: "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø·Ø¨ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„ØªØ®Ø¯ÙŠØ± ÙˆØ§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ²Ø©. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆÙ‚Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ø­ÙˆÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆØ§Ù„Ø£Ø¯ÙˆÙŠØ© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©. ØªØ°ÙƒØ± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø£Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„ØªØ¹Ù„ÙŠÙ… ÙÙ‚Ø· ÙˆÙ„ÙŠØ³Øª Ø¨Ø¯ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ©."
        }, { 
          role: "user", 
          content: message 
        }]
      })
    });
    const data = await res.json();
    if (data.choices && data.choices[0]) {
      return data.choices[0].message.content;
    } else {
      return "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.";
    }
  } catch (error) {
    return "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ: " + error.message;
  }
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø´Ø§Øª Ù„ÙƒÙ„ Ù‚Ø³Ù…
function setupChat(btnId, chatId, inputId, section) {
  const btn = document.getElementById(btnId);
  const input = document.getElementById(inputId);
  
  if (!btn || !input) return;
  
  const sendMessage = async () => {
    const msg = input.value.trim();
    if(!msg) return;
    
    const cb = document.getElementById(chatId);
    cb.innerHTML += `<div style="margin:4px 0;padding:6px;background:rgba(255,255,255,0.05);border-radius:6px"><b>Ø£Ù†Øª:</b> ${msg}</div>`;
    input.value = '';
    cb.scrollTop = cb.scrollHeight;

    cb.innerHTML += `<div style="color:#aaa;margin:4px 0">â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø¯...</div>`;
    cb.scrollTop = cb.scrollHeight;
    
    const reply = await callAI(`[${section}] ${msg}`);
    
    // Remove loading message
    const loadingMsg = cb.lastElementChild;
    if (loadingMsg && loadingMsg.textContent.includes('â³')) {
      loadingMsg.remove();
    }
    
    cb.innerHTML += `<div style="color:#bfe9ff;margin:4px 0;padding:6px;background:rgba(0,150,255,0.1);border-radius:6px;border-left:3px solid #0096ff"><b>AI:</b> ${reply}</div>`;
    cb.scrollTop = cb.scrollHeight;
  };
  
  btn.addEventListener('click', sendMessage);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
}

// Ø±Ø¨Ø· Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø£Ù‚Ø³Ø§Ù…
setupChat('doseChatSend','doseChat','doseChatInput','Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª');
setupChat('fluidChatSend','fluidChat','fluidChatInput','Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…');
setupChat('airwayChatSend','airwayChat','airwayChatInput','Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ & ETT');
</script>

</body>
</html>
