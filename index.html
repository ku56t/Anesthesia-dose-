<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ANS â€” Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ±</title>
<style>
  :root{
    --bg:#0a1124;--panel:#0f1830;--line:#1c2a4f;--text:#e8f0ff;--muted:#9fb1e6;
    --pri:#3aa6ff;--pri-ink:#00122b;--danger:#ff5470;--danger-ink:#2b0010;--ghost:#152549;
    --ok:#29d391;--warn:#ffb84d;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Tahoma",system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text)}
  .hidden{display:none!important}
  a{color:#9ac7ff}
  .btn{cursor:pointer;padding:11px 16px;border-radius:12px;border:0;font-weight:700;transition:transform .05s}
  .btn:active{transform:scale(.98)}
  .btn-primary{background:var(--pri);color:var(--pri-ink)}
  .btn-danger{background:var(--danger);color:var(--danger-ink)}
  .btn-ghost{background:#122146;color:#dbe7ff;border:1px solid var(--line)}
  .btn-chip{background:var(--ghost);color:#cfe1ff;padding:6px 10px;border-radius:999px;border:1px solid var(--line)}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  input,select,textarea{background:#0b1633;color:var(--text);border:1px solid var(--line);border-radius:12px;padding:10px;width:100%;margin:6px 0}
  label{font-size:13px;color:var(--muted)}
  .title{font-size:20px;margin:0 0 8px}
  .tabs{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
  .tab{padding:10px 14px;border-radius:12px;background:#0d1a36;color:#cde1ff;cursor:pointer;border:1px solid var(--line)}
  .tab.active{background:#173069}
  #chatBox{height:260px;overflow-y:auto;background:#0b1634;padding:10px;border-radius:12px;border:1px solid var(--line)}
  .msg{margin:6px 0;padding:8px;background:#152c58;border-radius:10px}
  .chip{background:#162448;padding:6px 10px;border-radius:999px;font-size:12px;margin:2px;display:inline-block;border:1px solid var(--line)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 220px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .divider{height:1px;background:var(--line);margin:8px 0}
  .k{color:#9cc0ff}
  .toast{position:fixed;bottom:16px;left:16px;background:#10214a;border:1px solid var(--line);color:#dfe9ff;border-radius:12px;padding:10px 14px;z-index:99999}
  .banner{position:fixed;top:0;left:0;right:0;background:#1b2b57;border-bottom:1px solid var(--line);padding:6px 10px;font-size:12px;color:#cfe1ff;z-index:10000}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#10224a;border:1px solid var(--line);border-radius:999px}
  #overlay{position:fixed;inset:0;background:rgba(7,17,42,.98);color:#fff;display:none;align-items:center;justify-content:center;z-index:100000}
</style>
</head>
<body>

<!-- Debug Banner -->
<div id="dbg" class="banner hidden"></div>
<div id="overlay"><div style="padding:40px;text-align:center">
  <h2>âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</h2>
  <p>Firebase Ù„Ù… ÙŠØ±Ø¬Ù‘Ø¹ Ù…Ø³ØªØ®Ø¯Ù…. Ø¬Ø±Ø¨ ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† <b>Chrome/Safari</b> Ù…Ø¨Ø§Ø´Ø±Ø© (Ù…Ùˆ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª).</p>
  <p>Ø§Ù„Ù…Ø¶ÙŠÙ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b id="hostHere"></b></p>
</div></div>

<!-- Splash -->
<div id="splash" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#07112a;z-index:9999">
  <div class="card" style="max-width:360px;text-align:center">
    <div style="font-size:28px;margin-bottom:6px">ANS</div>
    <div class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>
</div>

<!-- Login -->
<div id="loginScreen" class="" style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:16px">
  <div class="card" style="max-width:420px;width:100%">
    <h3 class="title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input id="emailInput" type="email" placeholder="you@example.com" />
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="passInput" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    <button class="btn btn-primary" id="loginBtn" style="width:100%;margin-top:8px">Ø¯Ø®ÙˆÙ„</button>
    <div class="divider"></div>
    <button class="btn btn-ghost" id="googleBtn" style="width:100%">Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google</button>
    <div class="muted" style="margin-top:8px">Ø§Ù„Ù…Ø§Ù„Ùƒ: <b class="k">bama47686@gmail.com</b> (role = owner)</div>
    <div id="authError" class="muted" style="margin-top:6px;color:#ffb3bf"></div>
  </div>
</div>

<!-- App -->
<div id="app" class="hidden" style="padding:16px;max-width:1200px;margin:auto">
  <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <div>
      <div style="font-size:18px">Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± â€” ANS</div>
      <div id="userInfo" class="muted"></div>
    </div>
    <div class="toolbar">
      <button id="btnGoHistory" class="btn btn-chip">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
      <button id="logoutBtn" class="btn btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-target="panelDose">âš–ï¸ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</div>
    <div class="tab" data-target="panelFluids">ğŸ’§ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„</div>
    <div class="tab" data-target="panelASA">ğŸ“Š ASA</div>
    <div class="tab" data-target="panelChat">ğŸ’¬ Ø§Ù„Ø´Ø§Øª</div>
    <div class="tab hidden" id="tabAdmin" data-target="panelAdmin">âš™ï¸ Ø§Ù„Ù…Ø§Ù„Ùƒ</div>
    <div class="tab" data-target="panelHistory">ğŸ—‚ï¸ Ø§Ù„Ø³Ø¬Ù„</div>
  </div>

  <!-- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª -->
  <div id="panelDose" class="card">
    <h3 class="title">âš–ï¸ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</h3>
    <div class="row">
      <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label><input id="doseName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ" /></div>
      <div class="col"><label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</label><input id="doseWeight" type="number" placeholder="70" /></div>
      <div class="col"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="doseNotes" placeholder="Ø­Ø³Ø§Ø³ÙŠØ©ØŒ Ø£Ø¯ÙˆÙŠØ© Ø«Ø§Ø¨ØªØ©..." /></div>
    </div>
    <div class="row">
      <div class="col"><label>Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶</label><textarea id="doseSymptoms" rows="2" placeholder="Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠØ©"></textarea></div>
      <div class="col"><label>Ø·Ø±Ù‚ Ø§Ù„ØªØ®ÙÙŠÙ</label><textarea id="doseRelief" rows="2" placeholder="Ø®Ø·Ø·/ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ®ÙÙŠÙ"></textarea></div>
    </div>
    <div class="toolbar">
      <button class="btn btn-primary" id="btnDoseCalc">Ø§Ø­Ø³Ø¨</button>
      <div id="doseResult" class="row"></div>
    </div>
  </div>

  <!-- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ -->
  <div id="panelFluids" class="card hidden">
    <h3 class="title">ğŸ’§ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„</h3>
    <div class="row">
      <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label><input id="fluidName" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ø±Ø© Ù…Ø­Ù…Ø¯" /></div>
      <div class="col"><label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</label><input id="fluidWeight" type="number" placeholder="65" /></div>
    </div>
    <div class="row">
      <div class="col"><label>Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶</label><textarea id="fluidSymptoms" rows="2" placeholder="Ø¹Ø·Ø´ØŒ Ø¬ÙØ§Ù..."></textarea></div>
      <div class="col"><label>Ø·Ø±Ù‚ Ø§Ù„ØªØ®ÙÙŠÙ</label><textarea id="fluidRelief" rows="2" placeholder="IV Fluids..."></textarea></div>
    </div>
    <div class="toolbar">
      <button class="btn btn-primary" id="btnFluidCalc">Ø§Ø­Ø³Ø¨</button>
      <div id="fluidResult" class="row"></div>
    </div>
  </div>

  <!-- ASA -->
  <div id="panelASA" class="card hidden">
    <h3 class="title">ğŸ“Š ØªÙ‚ÙŠÙŠÙ… ASA</h3>
    <div class="row">
      <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label><input id="asaName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" /></div>
      <div class="col"><label>Ø§Ù„Ø¹Ù…Ø±</label><input id="asaAge" type="number" placeholder="35" /></div>
      <div class="col">
        <label>Ù…Ø±Ø§ÙÙ‚</label>
        <select id="asaCom" multiple style="min-height:104px">
          <option>Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
          <option>Ø³ÙƒØ±ÙŠ ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·</option>
          <option>Ø¶ØºØ· Ø´Ø¯ÙŠØ¯</option>
          <option>ÙØ´Ù„ Ù‚Ù„Ø¨ÙŠ</option>
          <option>Ù‚ØµÙˆØ± ÙƒØ¨Ø¯ÙŠ/ÙƒÙ„ÙˆÙŠ</option>
          <option>Ø­Ø§Ù„Ø© Ø¥Ø³Ø¹Ø§ÙÙŠØ©</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="col"><label>Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶</label><textarea id="asaSymptoms" rows="2"></textarea></div>
      <div class="col"><label>Ø·Ø±Ù‚ Ø§Ù„ØªØ®ÙÙŠÙ</label><textarea id="asaRelief" rows="2"></textarea></div>
    </div>
    <div class="toolbar">
      <button class="btn btn-primary" id="btnASACalc">ØªÙ‚ÙŠÙŠÙ…</button>
      <div id="asaResult" class="row"></div>
    </div>
  </div>

  <!-- Ø§Ù„Ø´Ø§Øª -->
  <div id="panelChat" class="card hidden">
    <h3 class="title">ğŸ’¬ Ø§Ù„Ø´Ø§Øª</h3>
    <div id="chatBox"></div>
    <div class="row">
      <div class="col"><input id="chatInput" placeholder="Ø±Ø³Ø§Ù„ØªÙƒ..." /></div>
      <div><button id="chatSend" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„</button></div>
    </div>
  </div>

  <!-- Ø§Ù„Ø³Ø¬Ù„ -->
  <div id="panelHistory" class="card hidden">
    <h3 class="title">ğŸ—‚ï¸ Ø§Ù„Ø³Ø¬Ù„</h3>
    <div class="toolbar" id="historyToolbar">
      <button class="btn btn-chip" id="btnMyHistory">Ø³Ø¬Ù„ÙŠ</button>
      <button class="btn btn-chip hidden" id="btnAllHistory">ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ù…Ø§Ù„Ùƒ)</button>
      <input id="historySearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„/Ø§Ù„Ø¯ÙˆØ§Ø¡..." style="min-width:220px" />
    </div>
    <div id="historyList" class="grid"></div>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ -->
  <div id="panelAdmin" class="card hidden">
    <h3 class="title">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</h3>
    <div class="muted" style="margin-bottom:6px">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø­Ø¸Ø±/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø± (Ø­Ø³Ø¨ UID)</div>
    <div id="usersList" class="grid"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden"></div>

<script type="module">
  /*************** Firebase ***************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { 
    getAuth, setPersistence, browserLocalPersistence,
    onAuthStateChanged, signInWithEmailAndPassword, 
    GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut 
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { 
    getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, addDoc, 
    serverTimestamp, query, orderBy, where, onSnapshot, limit 
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
    authDomain: "anesthesia-dose-262e3.firebaseapp.com",
    projectId: "anesthesia-dose-262e3",
    storageBucket: "anesthesia-dose-262e3.appspot.com", // âœ… Ø§Ù„ØµØ­ÙŠØ­
    messagingSenderId: "602244448093",
    appId: "1:602244448093:web:0a8d9905849126086ff2b4",
    measurementId: "G-SCHMQFCK3J"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // Ø¥Ø¬Ø¨Ø§Ø± Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø§Ù„Ù€ localStorage
  setPersistence(auth, browserLocalPersistence)
    .then(()=>console.log("âœ… Persistence = localStorage"))
    .catch(err=>console.error("Persistence error:",err));

  /*************** UI helpers ***************/
  const splash       = document.getElementById("splash");
  const loginScreen  = document.getElementById("loginScreen");
  const appEl        = document.getElementById("app");
  const userInfo     = document.getElementById("userInfo");
  const tabAdmin     = document.getElementById("tabAdmin");
  const historyList  = document.getElementById("historyList");
  const btnAllHistory= document.getElementById("btnAllHistory");
  const btnMyHistory = document.getElementById("btnMyHistory");
  const historySearch= document.getElementById("historySearch");
  const toastEl      = document.getElementById("toast");
  const authError    = document.getElementById("authError");
  const dbg          = document.getElementById("dbg");
  const overlay      = document.getElementById("overlay");
  const hostHere     = document.getElementById("hostHere");
  let currentUser=null, currentRole="user", showingAll=false, allHistoryCache=[], myHistoryCache=[];

  function toast(msg){ toastEl.textContent=msg; toastEl.classList.remove("hidden"); setTimeout(()=>toastEl.classList.add("hidden"),3500); }
  function banner(msg){ dbg.textContent=msg; dbg.classList.remove("hidden"); }
  setTimeout(()=>splash.classList.add("hidden"),900);

  window.addEventListener("error", (e)=>{ console.error("WindowError:", e.message, e.error); toast("Ø®Ø·Ø£: "+e.message); });
  window.addEventListener("unhandledrejection", (e)=>{ console.error("PromiseRejection:", e.reason); toast("ÙˆØ¹Ø¯ Ù…Ø±ÙÙˆØ¶: "+(e.reason?.message||e.reason)); });

  // Tabs
  document.querySelectorAll(".tab").forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      ["panelDose","panelFluids","panelASA","panelChat","panelHistory","panelAdmin"]
        .forEach(id=>document.getElementById(id).classList.add("hidden"));
      document.getElementById(t.dataset.target).classList.remove("hidden");
    };
  });
  document.getElementById("btnGoHistory").onclick=()=>{ document.querySelector('[data-target="panelHistory"]').click(); };

  /*************** Domain check ***************/
  (function checkDomain(){
    const host = location.host;
    const ok = /(localhost|127\.0\.0\.1|github\.io|render\.com)$/i.test(host);
    if(!ok){
      banner("âš ï¸ Ù‚Ø¯ ØªÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø¯ÙˆÙ…ÙŠÙ† ØºÙŠØ± Ù…Ø¶Ø§Ù ÙÙŠ Firebase Authorized domains: "+host);
      console.warn("Add this domain in Firebase Authorized domains:", host);
    }
  })();

  /*************** Auth ***************/
  loginBtn.onclick=()=>{
    const email=emailInput.value.trim();
    const pass=passInput.value.trim();
    authError.textContent="";
    if(!email||!pass){authError.textContent="Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";return;}
    signInWithEmailAndPassword(auth,email,pass)
      .then(()=>toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"))
      .catch(e=>{
        console.error(e);
        authError.textContent = `Ø®Ø·Ø£: ${e.code.replace("auth/","")} â€” ${e.message}`;
      });
  };

  // Google with Popup â†’ fallback to Redirect if blocked
  googleBtn.onclick=async ()=>{
    authError.textContent="";
    const provider = new GoogleAuthProvider();
    try{
      await signInWithPopup(auth, provider);
      toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google");
    }catch(e){
      console.warn("Popup failed, using redirect.", e);
      authError.textContent = "Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„ (Redirect) Ø¨Ø³Ø¨Ø¨ Ø­Ø¬Ø¨ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©...";
      await signInWithRedirect(auth, provider);
    }
  };

  getRedirectResult(auth).then(res=>{
    if(res?.user){ toast("ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Google (Redirect)"); }
  }).catch(e=>{ console.error("Redirect error:", e); toast("Redirect error: "+e.message); });

  logoutBtn.onclick=()=>signOut(auth);

  // <<< Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø³ÙŠØ· Ø§Ù„Ø°ÙŠ Ø§Ø´ØªØºÙ„ Ø¹Ù†Ø¯Ùƒ >>>
  onAuthStateChanged(auth, async (u)=>{
    console.log("âœ… onAuthStateChanged Ø±Ø¬Ù‘Ø¹:", u);

    if(!u){
      // Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ù…Ø³ØªØ®Ø¯Ù… â†’ Ø£Ø¸Ù‡Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
      loginScreen.classList.remove("hidden");
      appEl.classList.add("hidden");
      hostHere.textContent = location.host;
      overlay.style.display = "flex"; // Ù†Ø¹Ø±Ø¶ Ù†ØµÙŠØ­Ø© Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†
      return;
    }

    // Ø¥Ø°Ø§ Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â†’ Ø£Ø®ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ£Ø¸Ù‡Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    overlay.style.display = "none";
    loginScreen.classList.add("hidden");
    appEl.classList.remove("hidden");

    // Ø¯ÙˆØ± Ø§Ù„Ù…Ø§Ù„Ùƒ + ØªØ­Ù‚Ù‚ Ø§Ù„Ø­Ø¸Ø±
    const role = (u.email === "bama47686@gmail.com") ? "owner" : "user";
    await setDoc(doc(db,"users",u.uid), {
      uid:u.uid, email:u.email, role, banned:false
    }, {merge:true});
    const us = (await getDoc(doc(db,"users",u.uid))).data();
    if(us?.banned){
      authError.textContent = "âŒ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±";
      await signOut(auth);
      return;
    }
    currentUser = u; currentRole = role;
    userInfo.textContent = `${u.email} â€” Role: ${role}`;
    tabAdmin.classList.toggle("hidden", role!=="owner");
    btnAllHistory.classList.toggle("hidden", role!=="owner");

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    initChat();
    await loadMyHistory();
    if(role==="owner"){ loadUsers(); await loadAllHistory(); }
  });

  /*************** History Save/Load ***************/
  async function saveHistory(obj){
    if(!currentUser) return;
    await addDoc(collection(db,"history"),{
      ...obj,
      uid:currentUser.uid,
      email:currentUser.email,
      createdAt: serverTimestamp()
    });
    await loadMyHistory();
    if(currentRole==="owner" && showingAll) await loadAllHistory();
    toast("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ âœ…");
  }

  function fmtDate(ts){
    if(!ts) return "";
    const d = ts?.toDate? ts.toDate(): new Date(ts);
    return d.toLocaleString("ar-IQ");
  }
  function cleanKV(o){
    if(!o) return "â€”";
    try{ return Object.entries(o).map(([k,v])=>`${k}: ${v}`).join(" | "); }
    catch{ return String(o) }
  }

  function renderHistory(cards){
    const q = (historySearch.value||"").trim().toLowerCase();
    historyList.innerHTML="";
    cards.filter(h=>{
      if(!q) return true;
      const hay = JSON.stringify(h).toLowerCase();
      return hay.includes(q);
    }).forEach(h=>{
      const wrap=document.createElement("div");
      wrap.className="card";
      wrap.innerHTML = `
        <div class="row" style="align-items:center;justify-content:space-between">
          <div><b>ğŸ§‘â€âš•ï¸ ${h.patientName || "â€”"}</b></div>
          <div>${h.type? `<span class="chip">${h.type}</span>`:""}</div>
        </div>
        <div class="muted">${fmtDate(h.createdAt)} â€” ${h.email||""}</div>
        <div class="divider"></div>
        ${h.inputs? `<div>ğŸ“ <span class="k">${cleanKV(h.inputs)}</span></div>`:""}
        ${h.result? `<div>ğŸ’Š <span class="k">${cleanKV(h.result)}</span></div>`:""}
        ${h.symptoms? `<div>âš ï¸ <span class="k">${h.symptoms}</span></div>`:""}
        ${h.relief?   `<div>ğŸ’¡ <span class="k">${h.relief}</span></div>`:""}
      `;
      historyList.appendChild(wrap);
    });
    if(!historyList.children.length){
      historyList.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>`;
    }
  }

  async function loadMyHistory(){
    if(!currentUser) return;
    const qy = query(
      collection(db,"history"),
      where("uid","==",currentUser.uid),
      orderBy("createdAt","desc")
    );
    const snap = await getDocs(qy);
    myHistoryCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
    if(!showingAll) renderHistory(myHistoryCache);
  }
  async function loadAllHistory(){
    const qy = query(collection(db,"history"), orderBy("createdAt","desc"), limit(500));
    const snap = await getDocs(qy);
    allHistoryCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
    if(showingAll) renderHistory(allHistoryCache);
  }
  btnMyHistory.onclick = ()=>{ showingAll=false; renderHistory(myHistoryCache); };
  btnAllHistory.onclick = async ()=>{ if(currentRole!=="owner") return; showingAll=true; if(!allHistoryCache.length) await loadAllHistory(); renderHistory(allHistoryCache); };
  historySearch.oninput = ()=>{ renderHistory(showingAll? allHistoryCache : myHistoryCache); };

  /*************** Users (Owner) ***************/
  async function loadUsers(){
    const snap = await getDocs(collection(db,"users"));
    const box  = document.getElementById("usersList");
    box.innerHTML="";
    snap.forEach(d=>{
      const u = d.data();
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div><b>${u.email||""}</b></div>
            <div class="muted">UID: ${u.uid}</div>
            <div class="muted">Role: ${u.role}</div>
          </div>
          <div class="toolbar">
            <span class="pill" title="Ø§Ù„Ø­Ø§Ù„Ø©">${u.banned? "ğŸš« Ù…Ø­Ø¸ÙˆØ±":"âœ… ÙØ¹Ø§Ù„"}</span>
            <button class="btn ${u.banned? "btn-primary":"btn-danger"}" onclick="toggleBan('${u.uid}', ${!!u.banned})">
              ${u.banned? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±":"Ø­Ø¸Ø±"}
            </button>
          </div>
        </div>
      `;
      box.appendChild(card);
    });
  }
  window.toggleBan = async (uid,cur)=>{
    await updateDoc(doc(db,"users",uid),{banned:!cur});
    loadUsers();
  };

  /*************** Calculators ***************/
  // Ø¬Ø±Ø¹Ø§Øª
  btnDoseCalc.onclick = async ()=>{
    const w = +doseWeight.value;
    const name = doseName.value.trim();
    const notes= doseNotes.value.trim();
    const sym  = doseSymptoms.value.trim();
    const rel  = doseRelief.value.trim();
    if(!w || !name){ toast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„ÙˆØ²Ù†."); return; }

    // Ø£Ù…Ø«Ù„Ø© â€” Ø¹Ø¯Ù„ Ø­Ø³Ø¨ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ùƒ
    const result = {
      Propofol: `${(2*w).toFixed(0)}â€“${(3*w).toFixed(0)} mg`,
      Fentanyl:`${(1*w).toFixed(0)} mcg`,
      Midazolam:`${(0.1*w).toFixed(1)} mg`
    };
    doseResult.innerHTML =
      Object.entries(result).map(([k,v])=>`<span class="chip">${k}: ${v}</span>`).join(" ");

    await saveHistory({
      type:"dose",
      patientName:name,
      inputs:{weight:w,notes},
      result,
      symptoms:sym,
      relief:rel
    });
  };

  // Ø³ÙˆØ§Ø¦Ù„
  btnFluidCalc.onclick = async ()=>{
    const w = +fluidWeight.value;
    const name = fluidName.value.trim();
    const sym  = fluidSymptoms.value.trim();
    const rel  = fluidRelief.value.trim();
    if(!w || !name){ toast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„ÙˆØ²Ù†."); return; }

    // Ù…Ø«Ø§Ù„ ØªÙ‚Ø±ÙŠØ¨ÙŠ
    const fluids = `${(w*30).toFixed(0)} ml/day`;
    fluidResult.innerHTML = `<span class="chip">${fluids}</span>`;

    await saveHistory({
      type:"fluids",
      patientName:name,
      inputs:{weight:w},
      result:{fluids},
      symptoms:sym,
      relief:rel
    });
  };

  // ASA
  btnASACalc.onclick = async ()=>{
    const age = +asaAge.value;
    const name= asaName.value.trim();
    const sel = [...asaCom.selectedOptions].map(o=>o.value);
    const sym = asaSymptoms.value.trim();
    const rel = asaRelief.value.trim();
    if(!name || !age){ toast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„Ø¹Ù…Ø±."); return; }

    let score="ASA I";
    if(sel.includes("ÙØ´Ù„ Ù‚Ù„Ø¨ÙŠ")||sel.includes("Ù‚ØµÙˆØ± ÙƒØ¨Ø¯ÙŠ/ÙƒÙ„ÙˆÙŠ")) score="ASA IV";
    else if(sel.includes("Ø³ÙƒØ±ÙŠ ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·")||sel.includes("Ø¶ØºØ· Ø´Ø¯ÙŠØ¯")) score="ASA III";
    else if(sel.includes("Ù„Ø§ ÙŠÙˆØ¬Ø¯")||sel.length===0) score="ASA I";
    else score="ASA II";
    if(sel.includes("Ø­Ø§Ù„Ø© Ø¥Ø³Ø¹Ø§ÙÙŠØ©")) score += " (E)";

    asaResult.innerHTML = `<span class="chip">${score}</span>`;

    await saveHistory({
      type:"asa",
      patientName:name,
      inputs:{age,comorbidities:sel},
      result:{score},
      symptoms:sym,
      relief:rel
    });
  };

  /*************** Chat ***************/
  function initChat(){
    const qy = query(collection(db,"chat"), orderBy("time"));
    onSnapshot(qy, snap=>{
      const box=document.getElementById("chatBox");
      box.innerHTML="";
      snap.forEach(m=>{
        const d=m.data();
        const div=document.createElement("div");
        div.className="msg";
        div.innerHTML = `<b>${d.email||"Ù…Ø³ØªØ®Ø¯Ù…"}:</b> ${d.text||""}`;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    });
  }
  chatSend.onclick = async ()=>{
    const text=(chatInput.value||"").trim();
    if(!text || !currentUser) return;
    await addDoc(collection(db,"chat"),{
      uid:currentUser.uid,
      email:currentUser.email,
      text,
      time:serverTimestamp()
    });
    chatInput.value="";
  };

</script>
</body>
</html> 
