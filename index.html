<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>حساب الجرعات المتطور</title>
<!-- ستايل -->
<style>
  :root{
    --bg-dark:#071223; --bg-dark-2:#0b3045; --card:#0f2333;
    --accent:#0a9bd6; --accent-2:#11cdef; --text:#e6f6ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg-dark),var(--bg-dark-2));color:var(--text);min-height:100vh;overflow-x:hidden}
  header{padding:8px 18px;text-align:center;font-weight:700;background:linear-gradient(90deg,#072a40,#0a5f86);box-shadow:0 6px 20px rgba(2,6,23,.45)}
  header h1{margin:0}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,0.6)}
  .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .btn{padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#042a3a;cursor:pointer;font-weight:700;min-width:140px}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)}
  .panel{display:none;margin-top:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px}
  .result-box{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.2));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .pill{display:inline-block;padding:6px 10px;background:rgba(255,255,255,0.03);border-radius:999px;margin:6px 6px 0 0;color:#dff6ff}
  .sideEffect{background:rgba(255,60,60,0.06);border-left:4px solid rgba(255,80,80,0.9);padding:10px;margin:8px 0;border-radius:6px}
  .muted{color:#bcdcec;font-size:13px}
  .chatBox{height:140px;overflow:auto;padding:10px;background:rgba(255,255,255,0.012);border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .controls-row{display:flex;gap:8px;align-items:center}
  footer{margin-top:18px;text-align:center;color:#93c1d8;font-size:13px}
  @media (max-width:720px){.grid{grid-template-columns:1fr}.top-actions{flex-direction:column}}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash" style="position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;background:linear-gradient(135deg,#071024 0%, #06293a 70%);">
  <div style="text-align:center">
    <h2 style="margin:0;color:#eaf6ff">جارٍ التحميل...</h2>
    <div style="margin-top:8px;color:#cfefff">شاشة بداية — ستغلق تلقائياً بعد التهيئة أو عند تسجيل الدخول.</div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none;max-width:1200px;margin:34px auto;padding:20px">
  <div class="card">
    <header><h1>حساب الجرعات المتطوّر</h1></header>

    <div class="top-actions" style="margin-top:12px">
      <button class="btn" id="showDose">💉 حساب الجرعات</button>
      <button class="btn" id="showFluids">💧 السوائل والدم</button>
      <button class="btn" id="showAirway">🫁 اللارنغوسكوب / ETT</button>
      <button class="btn" id="showAdmin">⚙️ لوحة التحكم</button>
      <button class="btn ghost" id="showAbout">ℹ️ حول الموقع</button>
      <button class="btn ghost" id="toggleTheme">🌙 تبديل الوضع</button>
      <div style="flex:1"></div>
      <div id="userInfo" class="muted" style="align-self:center"></div>
      <button class="btn ghost" id="btnLogout" style="min-width:110px">تسجيل خروج</button>
    </div>

    <!-- Panel: Dose -->
    <section id="panelDose" class="panel">
      <h2>💉 حساب جرعات التخدير</h2>
      <div class="grid">
        <div>
          <label>اسم المريض
            <input id="patientNameDose" placeholder="اسم المريض">
          </label>

          <label>الوزن (كغ)
            <input id="weightDose" type="number" placeholder="مثال: 70">
          </label>

          <label>العمر
            <div style="display:flex;gap:8px">
              <input id="ageDose" type="number" placeholder="مثال: 40" style="flex:1">
              <select id="ageUnitDose" style="width:120px">
                <option value="years">سنوات</option>
                <option value="months">أشهر</option>
                <option value="days">أيام</option>
              </select>
            </div>
          </label>

          <label>تصنيف ASA
            <select id="asaSelect">
              <option value="I">ASA I</option>
              <option value="II">ASA II</option>
              <option value="III">ASA III</option>
              <option value="IV">ASA IV</option>
              <option value="V">ASA V</option>
            </select>
          </label>

          <label>حالة المريض
            <select id="patientHealth">
              <option value="healthy">صحي</option>
              <option value="unhealthy">مريض</option>
            </select>
          </label>

          <div id="diseaseDiv" style="display:none;margin-top:6px">
            <label>اختر الأمراض (متعدد)
              <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">
                <label><input type="checkbox" class="diseaseChk" value="diabetes"> سكري</label>
                <label><input type="checkbox" class="diseaseChk" value="heart"> أمراض قلبية</label>
                <label><input type="checkbox" class="diseaseChk" value="lung"> أمراض رئوية</label>
                <label><input type="checkbox" class="diseaseChk" value="liver"> أمراض كبدية</label>
                <label><input type="checkbox" class="diseaseChk" value="kidney"> أمراض كلويّة</label>
                <label><input type="checkbox" class="diseaseChk" value="allergy"> حساسية</label>
                <label><input type="checkbox" class="diseaseChk" value="obesity"> سمنة مفرطة</label>
              </div>
            </label>
          </div>

          <label>اختر الدواء
            <select id="drugDose"></select>
          </label>

          <div class="controls-row" style="margin-top:8px">
            <button class="btn" id="calcDose">احسب الجرعة</button>
            <button class="btn ghost" id="scanBagBtn" title="فتح كاميرا المسح الضوئي">📷 مسح كيس المريض</button>
            <div style="flex:1"></div>
          </div>

          <div style="margin-top:6px" class="muted">ملاحظة: النتائج تقريبية — راجع سريريًا دائمًا.</div>
        </div>

        <div>
          <div id="doseResult" class="result-box"><b>النتيجة ستظهر هنا</b></div>
          <div id="doseEffects" style="margin-top:12px"></div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

      <h3>ملاحظات</h3>
      <div class="chatBox" id="doseNotes"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="doseNoteInput" placeholder="اكتب ملاحظة او تعليق">
        <button class="btn ghost" id="doseNoteSend">أضف</button>
      </div>
    </section>

    <!-- Panel: Fluids -->
    <section id="panelFluids" class="panel">
      <h2>💧 حساب السوائل والدم</h2>
      <div class="grid">
        <div>
          <label>اسم المريض
            <input id="patientNameFluid" placeholder="اسم المريض">
          </label>

          <label>الوزن (كغ)
            <input id="weightFluid" type="number" placeholder="مثال: 70">
          </label>

          <label>العمر
            <div style="display:flex;gap:8px">
              <input id="ageFluid" type="number" placeholder="مثال: 40" style="flex:1">
              <select id="ageUnitFluid" style="width:120px">
                <option value="years">سنوات</option>
                <option value="months">أشهر</option>
                <option value="days">أيام</option>
              </select>
            </div>
          </label>

          <label>نوع السائل
            <select id="fluidType">
              <option value="NS">Normal Saline (0.9% NaCl)</option>
              <option value="RL">Ringer Lactate</option>
              <option value="D5W">Dextrose 5% (D5W)</option>
              <option value="PRBC">PRBC - نقل دم (1 وحدة)</option>
            </select>
          </label>

          <div style="margin-top:8px" class="controls-row">
            <button class="btn" id="calcFluids">احسب</button>
            <div style="flex:1"></div>
          </div>
        </div>

        <div>
          <div id="fluidResult" class="result-box"><b>النتيجة ستظهر هنا</b></div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

      <h3>ملاحظات السوائل</h3>
      <div class="chatBox" id="fluidNotes"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="fluidNoteInput" placeholder="اكتب ملاحظة او تعليق">
        <button class="btn ghost" id="fluidNoteSend">أضف</button>
      </div>
    </section>

    <!-- Panel: Airway -->
    <section id="panelAirway" class="panel">
      <h2>🫁 اللارنغوسكوب و ETT</h2>
      <div class="grid">
        <div>
          <label>اسم المريض
            <input id="patientNameAirway" placeholder="اسم المريض">
          </label>

          <label>العمر
            <div style="display:flex;gap:8px">
              <input id="ageAirway" type="number" placeholder="مثال: 3" style="flex:1">
              <select id="ageUnitAirway" style="width:120px">
                <option value="years">سنوات</option>
                <option value="months">أشهر</option>
                <option value="days">أيام</option>
              </select>
            </div>
          </label>

          <label>الوزن (اختياري)
            <input id="weightAirway" type="number" placeholder="كغ">
          </label>

          <div style="margin-top:8px" class="controls-row">
            <button class="btn" id="calcAirway">حساب الحجم المقترح</button>
            <button class="btn ghost" id="showScanner">🔍 كاميرا (مسح عن طريق الضوء)</button>
          </div>
        </div>

        <div>
          <div id="airwayResult" class="result-box">النتيجة ستظهر هنا</div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

      <h3>ملاحظات</h3>
      <div class="chatBox" id="airwayNotes"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="airwayNoteInput" placeholder="اكتب ملاحظة او تعليق">
        <button class="btn ghost" id="airwayNoteSend">أضف</button>
      </div>
    </section>

    <!-- Panel: Admin -->
    <section id="panelAdmin" class="panel">
      <h2>⚙️ لوحة تحكم المالك</h2>
      <div id="adminContent" class="result-box">لوحة المسؤول</div>
      <div id="ownerControls" style="display:none;margin-top:10px">
        <h3>إدارة المستخدمين</h3>
        <div>
          <button class="btn" id="btnRefreshUsers">تحديث قائمة المستخدمين</button>
          <div id="usersList" style="margin-top:8px"></div>
        </div>

        <h3 style="margin-top:12px">سجلات الحسابات (History)</h3>
        <div>
          <input id="searchHistory" placeholder="بحث بالاسم/المستخدم/الدواء">
          <button class="btn ghost" id="btnSearchHistory">بحث</button>
          <div id="historyList" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- Panel: About -->
    <section id="panelAbout" class="panel">
      <h2>ℹ️ حول الموقع</h2>
      <div class="result-box">
        <p>موقع تعليمي لحساب جرعات التخدير والسوائل وتوصيات airway. الفكرة مقترحة لأغراض تدريبية.</p>
        <p>تم تطوير الواجهة بواسطة فريق التطوير. تحذير: هذا الموقع للتدريب فقط — لا تعوّل عليه سريريًا بدون استشارة مختص.</p>
      </div>
    </section>

    <footer>© — راجع دوماً الإرشادات السريرية قبل إعطاء أي جرعة</footer>
  </div>
</div>

<!-- Scanner Modal -->
<div id="scannerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;align-items:center;justify-content:center">
  <div style="background:#021827;padding:12px;border-radius:12px;max-width:900px;width:90%;">
    <h3 style="margin:0 0 8px">كاميرا المسح الضوئي (محاكاة)</h3>
    <p style="margin:0 0 8px;color:#cfe8ff">التقاط صورة لكيس المريض أو باركود — هذه خاصية محاكاة. لتمكين OCR حقيقي، يمكنك دمج Tesseract.js أو خدمة Cloud Vision.</p>
    <video id="scannerVideo" autoplay style="width:100%;border-radius:8px;background:#000"></video>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="captureBtn" class="btn">التقاط</button>
      <button id="closeScanner" class="btn ghost">إغلاق</button>
    </div>
    <div id="scanResult" style="margin-top:12px" class="result-box"></div>
  </div>
</div>

<!-- Auth modal (simple) -->
<div id="loginScreen" style="display:none;position:fixed;inset:0;z-index:99999;align-items:center;justify-content:center;background:#071223;color:#fff;font-family:Tahoma">
  <div style="background:#0b3045;padding:20px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.6);width:320px;text-align:center">
    <h2 style="margin-bottom:16px">تسجيل الدخول</h2>
    <input id="loginEmail" type="email" placeholder="البريد الإلكتروني" style="width:100%;margin-bottom:10px;padding:10px;border-radius:6px;border:none"><br>
    <input id="loginPass" type="password" placeholder="كلمة المرور" style="width:100%;margin-bottom:16px;padding:10px;border-radius:6px;border:none"><br>
    <button id="loginBtn" class="btn" style="width:100%;margin-bottom:8px">دخول</button>
    <button id="googleLoginBtn" class="btn" style="width:100%;margin-bottom:8px;background:#fff;color:#333">دخول بحساب Google</button>
    <button id="goSignup" class="btn ghost" style="width:100%">إنشاء حساب جديد</button>
  </div>
</div>

<div id="signupScreen" style="display:none;position:fixed;inset:0;z-index:99999;align-items:center;justify-content:center;background:#071223;color:#fff;font-family:Tahoma">
  <div style="background:#0b3045;padding:20px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.6);width:320px;text-align:center">
    <h2 style="margin-bottom:16px">إنشاء حساب</h2>
    <input id="signupEmail" type="email" placeholder="البريد الإلكتروني" style="width:100%;margin-bottom:10px;padding:10px;border-radius:6px;border:none"><br>
    <input id="signupPass" type="password" placeholder="كلمة المرور" style="width:100%;margin-bottom:16px;padding:10px;border-radius:6px;border:none"><br>
    <button id="signupBtn" class="btn" style="width:100%;margin-bottom:8px">تسجيل</button>
    <button id="goLogin" class="btn ghost" style="width:100%">لديك حساب بالفعل؟ تسجيل الدخول</button>
  </div>
</div>

<!-- Firebase + App logic -->
<script type="module">
/* ========== Firebase init ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
  authDomain: "anesthesia-dose-262e3.firebaseapp.com",
  projectId: "anesthesia-dose-262e3",
  storageBucket: "anesthesia-dose-262e3.appspot.com",
  messagingSenderId: "602244448093",
  appId: "1:602244448093:web:0a8d9905849126086ff2b4",
  measurementId: "G-SCHMQFCK3J"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========== Settings ========== */
const OWNER_EMAIL = "bama47686@gmail.com"; // owner address (kept)
const OWNER_DEFAULT_PASS = ""; // keep empty or set if you know (we don't auto-create by default)

/* UI refs */
const splash = document.getElementById('splash');
const appWrap = document.getElementById('app');
const loginScreen = document.getElementById('loginScreen');
const signupScreen = document.getElementById('signupScreen');
const userInfoEl = document.getElementById('userInfo');
const btnLogout = document.getElementById('btnLogout');

/* Panels wiring */
const panels = { showDose:'panelDose', showFluids:'panelFluids', showAirway:'panelAirway', showAdmin:'panelAdmin', showAbout:'panelAbout' };
Object.keys(panels).forEach(btnId=>{
  const el = document.getElementById(btnId);
  if(!el) return;
  el.addEventListener('click', ()=> showPanel(panels[btnId]));
});
function showPanel(id){
  Object.values(panels).forEach(pid=>document.getElementById(pid).style.display='none');
  document.getElementById(id).style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
}

/* Splash hide after 4s (safety) */
let splashTimeout = setTimeout(hideSplash, 4200);
function hideSplash(){ if(splash){ splash.style.display='none'; document.getElementById('app').style.display='block'; } }
splash.addEventListener('click', ()=>{ clearTimeout(splashTimeout); hideSplash(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ clearTimeout(splashTimeout); hideSplash(); } });

/* Toggle theme */
document.getElementById('toggleTheme').addEventListener('click', ()=>{ document.body.classList.toggle('light'); });

/* ========== Drug database (extended) ========== */
/* This is a broad list — extend as needed */
const drugData = {
  "Propofol":{dose:{infant:[2.5,3.0],child:[2.0,2.5],adult:2.5},max:{value:300,unit:'mg'},unitPerKg:'mg/kg',side_effects:["انخفاض ضغط الدم","توقف تنفّس مؤقت","ألم عند الحقن"],management:["سوائل و/أو Vasopressors","دعم التنفّس","Lidocaine قبل الحقن"],reduce:"ابدأ بجرعة تحميل منخفضة"},
  "Fentanyl":{dose:{infant:[1,2],child:[2,3],adult:2},max:{value:300,unit:'µg'},unitPerKg:'µg/kg',side_effects:["تثبيط تنفسي","تباطؤ نبض القلب"],management:["دعم تنفّسي","Naloxone عند الحاجة"],reduce:"قسم الجرعة"},
  "Midazolam":{dose:{infant:[0.05,0.1],child:[0.05,0.2],adult:0.15},max:{value:10,unit:'mg'},unitPerKg:'mg/kg',side_effects:["تهدئة مفرطة","هبوط ضغط"],management:["مراقبة وتنفس","Flumazenil عند الحاجة"],reduce:"قلل الجرعة في كبار السن"},
  "Ketamine":{dose:{infant:[2,3],child:[4,5],adult:1.5},max:{value:300,unit:'mg'},unitPerKg:'mg/kg',side_effects:["زيادة ضغط الدم","تيبّس عضلي","هلوسة"],management:["مراقبة ضغط/نبض","Midazolam كمهدئ"],reduce:"استخدم جرعات أصغر لكبار السن"},
  "Thiopental":{dose:{infant:[10,15],child:[10,12.5],adult:12.5},max:{value:400,unit:'mg'},unitPerKg:'mg/kg',side_effects:["كبت تنفسي","هبوط ضغط"],management:["تهوية/أكسجين","دعم ضغط الدم"],reduce:"تجنّب الجرعات الكبيرة في كبار السن"},
  "Etomidate":{dose:{infant:[0.15,0.3],child:[0.2,0.3],adult:0.3},max:{value:40,unit:'mg'},unitPerKg:'mg/kg',side_effects:["Myoclonus","قمع محور الغدد الكظرية"],management:["Benzodiazepine للتقليل"],reduce:"لا يفضل التسريب المستمر"},
  "Dexmedetomidine":{dose:{infant:[0.5,1.0],child:[1.0,2.0],adult:1.0},max:{value:200,unit:'µg'},unitPerKg:'µg/kg',side_effects:["بطء قلب","هبوط ضغط"],management:["مراقبة قلبية"],reduce:"خفض جرعة التحميل"},
  "Isoflurane":{dose:{infant:[1.3,1.6],child:[1.3,1.6],adult:1.45},max:{value:100,unit:'%MAC'},unitPerKg:'%MAC',side_effects:["هبوط ضغط","كبت تنفسي"],management:["تعديل التركيز"],reduce:"ابدأ بMAC منخفض في كبار السن"},
  "Sevoflurane":{dose:{infant:[2.5,3.5],child:[2.5,3.5],adult:2.0},max:{value:100,unit:'%MAC'},unitPerKg:'%MAC',side_effects:["تهيج مجاري هوائية","هبوط ضغط"],management:["تعديل التركيز"],reduce:"مناسب للأطفال لكن خفّض في كبار السن"},
  "Succinylcholine":{dose:{infant:[1,2],child:[1,2],adult:1.5},max:{value:200,unit:'mg'},unitPerKg:'mg/kg',side_effects:["Hyperkalemia","Malignant Hyperthermia"],management:["دعم تنفسي","Dantrolene عند MH"],reduce:"تجنّب بالمخاطر"},
  "Rocuronium":{dose:{infant:[0.6,1.2],child:[0.6,1.2],adult:0.6},max:{value:100,unit:'mg'},unitPerKg:'mg/kg',side_effects:["تأخير استرجاع العضلات"],management:["Neostigmine/صيانة"],reduce:"اضبط حسب الحالة"},
  "Vecuronium":{dose:{infant:[0.05,0.1],child:[0.05,0.1],adult:0.1},max:{value:100,unit:'mg'},unitPerKg:'mg/kg',side_effects:["هبوط ضغط طفيف"],management:["مراقبة التنفس"],reduce:"اضبط للمرضى كبار السن"},
  "Lidocaine":{dose:{infant:[1,2],child:[2,3],adult:3},max:{value:300,unit:'mg'},unitPerKg:'mg/kg',side_effects:["تشنجات","هبوط ضغط"],management:["إيقاف التسريب","Benzodiazepine للتشنجات"],reduce:"تحسب mg الإجمالي"},
  "Bupivacaine":{dose:{infant:[1,2],child:[2,2],adult:2},max:{value:200,unit:'mg'},unitPerKg:'mg/kg',side_effects:["سمية قلبية","تشنجات"],management:["Intralipid 20%"],reduce:"استعمل أقل تركيز ممكن"},
  "Morphine":{dose:{infant:[0.05,0.1],child:[0.05,0.1],adult:0.1},max:{value:20,unit:'mg'},unitPerKg:'mg/kg',side_effects:["تثبيط تنفسي","غثيان"],management:["دعم تنفسي","Naloxone عند الحاجة"],reduce:"جرعات مقسمة"},
  "Paracetamol":{dose:{infant:[10,15],child:[10,15],adult:15},max:{value:4000,unit:'mg'},unitPerKg:'mg/kg',side_effects:["نادرًا تهيج كبدي"],management:["دعم كبدي"],reduce:"تجنب بالجرعات العالية"},
  "Ketorolac":{dose:{infant:[0.5,1],child:[0.5,1],adult:0.5},max:{value:120,unit:'mg'},unitPerKg:'mg/kg',side_effects:["نزيف","تأثير كلوي"],management:["وقف عند وجود نزيف"],reduce:"لا تستخدم لفترات طويلة"},
  "Tranexamic Acid":{dose:{infant:[10,15],child:[10,15],adult:15},max:{value:2000,unit:'mg'},unitPerKg:'mg/kg',side_effects:["تخثر زائد"],management:["مراقبة تخثر"],reduce:"استخدم حسب إرشادات النزف"}
};

/* populate drug select */
const drugSelect = document.getElementById('drugDose');
Object.keys(drugData).forEach(name=>{
  const opt = document.createElement('option'); opt.value = name; opt.textContent = name; drugSelect.appendChild(opt);
});

/* UI toggles */
document.getElementById('patientHealth').addEventListener('change',(e)=>{
  document.getElementById('diseaseDiv').style.display = e.target.value === 'unhealthy' ? 'block' : 'none';
  if(e.target.value === 'healthy') document.querySelectorAll('.diseaseChk').forEach(c=>c.checked=false);
});

/* utilities */
function toYears(val, unit){
  const v = parseFloat(val);
  if(isNaN(v) || v < 0) return NaN;
  if(unit === 'years') return v;
  if(unit === 'months') return v/12;
  if(unit === 'days') return v/365;
  return v;
}
function ageCategory(years){ if(years < 1) return 'infant'; if(years < 12) return 'child'; return 'adult'; }
function avgDose(dv){ return Array.isArray(dv) ? (dv[0]+dv[1])/2 : dv; }
const asaFactors = { I:1.00, II:0.95, III:0.85, IV:0.75, V:0.65 };
const diseaseFactors = { diabetes:0.95, heart:0.8, lung:0.85, liver:0.7, kidney:0.75, allergy:0.9, obesity:1.05 };

/* calculation core */
function calculateTotalDose(drugName, weightKg, ageYears, asaClass, diseases){
  const doc = drugData[drugName];
  if(!doc) return null;
  const cat = ageCategory(ageYears);
  const perKg = avgDose(doc.dose[cat]);
  if(doc.unitPerKg === '%MAC'){
    let factor = asaFactors[asaClass] || 1.0;
    diseases.forEach(d => { if(diseaseFactors[d]) factor *= diseaseFactors[d]; });
    return { value: (perKg * factor).toFixed(2), unit: '% MAC', note: 'تركيز غازي تقريبي' };
  }
  let total = perKg * weightKg;
  total *= (asaFactors[asaClass] || 1.0);
  diseases.forEach(d => { if(diseaseFactors[d]) total *= diseaseFactors[d]; });
  if(doc.max && typeof doc.max.value === 'number' && total > doc.max.value) total = doc.max.value;
  return { value: total, unitPerKg: doc.unitPerKg, unitTotal: (doc.max && doc.max.unit) ? doc.max.unit : (doc.unitPerKg.includes('µg') ? 'µg' : 'mg') };
}
function formatDose(calc){
  if(!calc) return 'خطأ بالحساب';
  if(calc.unit === '% MAC') return `${calc.value} ${calc.unit}`;
  let v = parseFloat(calc.value);
  if(isNaN(v)) return 'خطأ';
  const unit = calc.unitTotal || (calc.unitPerKg && calc.unitPerKg.includes('µg') ? 'µg' : 'mg');
  if(unit === 'µg') v = Math.round(v);
  else if(v < 10) v = v.toFixed(2);
  else v = v.toFixed(1);
  return `${v} ${unit}`;
}

/* save history */
async function saveHistory(entry){
  try{ await addDoc(collection(db,'history'), { ...entry, createdAt: serverTimestamp() }); }
  catch(e){ console.error('saveHistory err', e); }
}

/* Dose handler */
document.getElementById('calcDose').addEventListener('click', async ()=>{
  const pname = document.getElementById('patientNameDose').value.trim();
  const weight = parseFloat(document.getElementById('weightDose').value);
  const ageVal = parseFloat(document.getElementById('ageDose').value);
  const ageUnit = document.getElementById('ageUnitDose').value;
  const asa = document.getElementById('asaSelect').value;
  const drug = drugSelect.value;
  if(!weight || !ageVal || !drug){ alert('الرجاء إدخال الاسم (مفضل)، الوزن، العمر، والدواء'); return; }
  const ageYears = toYears(ageVal, ageUnit);
  const diseases = [];
  if(document.getElementById('patientHealth').value === 'unhealthy'){ document.querySelectorAll('.diseaseChk:checked').forEach(ch=>diseases.push(ch.value)); }
  const calc = calculateTotalDose(drug, weight, ageYears, asa, diseases);
  const display = formatDose(calc);
  const rEl = document.getElementById('doseResult');
  rEl.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap"><span class="pill">${drug}</span><span class="pill">وزن: ${weight} كغ</span><span class="pill">عمر: ${ageVal} ${ageUnit}</span><span class="pill">ASA: ${asa}</span></div>
    <div style="margin-top:10px;font-weight:700;font-size:1.1rem;color:var(--accent)">الجرعة المحسوبة: ${display}</div>
    <div style="margin-top:6px;color:#bfe8ff">ملاحظة: ${drugData[drug].reduce || 'لا توجد ملاحظة'}</div>`;
  const ddata = drugData[drug];
  let effHTML = '';
  ddata.side_effects.forEach((se,i)=> effHTML += `<div class="sideEffect"><b>عرض جانبي:</b> ${se}<br><b>التعامل:</b> ${ddata.management[i] || 'تدبير داعم'}</div>`);
  document.getElementById('doseEffects').innerHTML = effHTML;
  const user = auth.currentUser;
  if(user){ await saveHistory({ type:'dose', patientName: pname || null, inputs:{weight,ageVal,ageUnit,asa,diseases,drug}, result:display, uid:user.uid, userEmail:user.email }); }
});

/* Fluids handler */
document.getElementById('calcFluids').addEventListener('click', async ()=>{
  const pname = document.getElementById('patientNameFluid').value.trim();
  const w = parseFloat(document.getElementById('weightFluid').value);
  const ageVal = parseFloat(document.getElementById('ageFluid').value) || 30;
  const ageUnit = document.getElementById('ageUnitFluid').value;
  const ftype = document.getElementById('fluidType').value;
  if(!w){ alert('أدخل وزن المريض'); return; }
  const ageYears = toYears(ageVal, ageUnit);
  let maintenance;
  if(ageYears < 1) maintenance = 100 * w;
  else if(ageYears < 10) maintenance = 50 * w;
  else maintenance = 30 * w;
  let factor = 1.0; let note = '';
  if(ftype === 'RL'){ factor = 1.02; note = 'Ringer Lactate تركيبة مختلفة قليلاً'; }
  if(ftype === 'D5W'){ factor = 0.9; note = 'D5W لا يعد بديلًا للأملاح بشكل كامل'; }
  if(ftype === 'PRBC'){ factor = 1.0; note = 'PRBC واحد ~300 ml (تقديري)'; }
  const maintenanceAdj = Math.round(maintenance * factor);
  const bloodVol = Math.round((ageYears < 1 ? 85 : (ageYears < 10 ? 80 : 70)) * w);
  document.getElementById('fluidResult').innerHTML = `<div><b>صيانة (24h) - ${ftype}:</b> ${maintenanceAdj} ml</div>
    <div style="margin-top:6px"><b>حجم دم تقريبي:</b> ${bloodVol} ml</div><div class="muted">${note}</div>`;
  const user = auth.currentUser;
  if(user){ await saveHistory({ type:'fluids', patientName:pname||null, inputs:{weight:w,ageVal,ageUnit,fluidType:ftype}, result:{maintenance:maintenanceAdj,bloodVol}, uid:user.uid, userEmail:user.email }); }
});

/* Airway handler */
document.getElementById('calcAirway').addEventListener('click', async ()=>{
  const pname = document.getElementById('patientNameAirway').value.trim();
  const ageVal = parseFloat(document.getElementById('ageAirway').value);
  const ageUnit = document.getElementById('ageUnitAirway').value;
  const weight = parseFloat(document.getElementById('weightAirway').value) || null;
  if(!ageVal){ alert('أدخل العمر'); return; }
  const ageYears = toYears(ageVal, ageUnit);
  let blade='', ett='';
  if(ageYears < 1){ blade='Blade 0-1 (Neonate/Infant)'; ett='3.0 - 3.5 mm'; }
  else if(ageYears < 5){ blade='Blade 1-2 (Pediatric)'; ett='4.0 - 4.5 mm'; }
  else if(ageYears < 10){ blade='Blade 2 (Pediatric)'; ett='5.0 - 5.5 mm'; }
  else { blade='Adult blade (3-4)'; ett='6.0 - 8.0 mm'; }
  let ettByAge = '';
  if(ageYears>=1 && ageYears < 12){ const e = Math.floor(ageYears/4 + 4); ettByAge=`طريقة سريعة (uncuffed): ${e}.0 mm`; }
  document.getElementById('airwayResult').innerHTML = `<div><b>شفرة مقترحة:</b> ${blade}</div>
    <div style="margin-top:6px"><b>ETT مقترح:</b> ${ett} ${ettByAge}</div>
    <div style="margin-top:8px;color:#bfe8ff">تحقق سريرياً.</div>`;
  const user = auth.currentUser;
  if(user){ await saveHistory({ type:'airway', patientName:pname||null, inputs:{ageVal,ageUnit,weight}, result:{blade,ett}, uid:user.uid, userEmail:user.email }); }
});

/* Chat-like local notes (placeholders) */
function setupLocalNote(btnId, boxId, inputId){
  document.getElementById(btnId).addEventListener('click', ()=>{
    const txt = document.getElementById(inputId).value.trim();
    if(!txt) return;
    const cb = document.getElementById(boxId);
    cb.innerHTML += `<div style="margin-bottom:6px"><b>ملاحظة:</b> ${txt}</div>`;
    document.getElementById(inputId).value='';
    cb.scrollTop = cb.scrollHeight;
  });
}
setupLocalNote('doseNoteSend','doseNotes','doseNoteInput');
setupLocalNote('fluidNoteSend','fluidNotes','fluidNoteInput');
setupLocalNote('airwayNoteSend','airwayNotes','airwayNoteInput');

/* Scanner (camera) simulation */
const scannerModal = document.getElementById('scannerModal');
const scannerVideo = document.getElementById('scannerVideo');
const captureBtn = document.getElementById('captureBtn');
const closeScanner = document.getElementById('closeScanner');
const scanResult = document.getElementById('scanResult');
let streamRef = null;

document.getElementById('scanBagBtn').addEventListener('click', ()=> openScanner());
document.getElementById('showScanner').addEventListener('click', ()=> openScanner());

async function openScanner(){
  try{
    scannerModal.style.display='flex';
    streamRef = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    scannerVideo.srcObject = streamRef;
  }catch(err){
    alert('تعذر الوصول إلى الكاميرا: ' + err.message);
    scannerModal.style.display='none';
  }
}
captureBtn.addEventListener('click', ()=>{
  const v = scannerVideo;
  const canvas = document.createElement('canvas');
  canvas.width = v.videoWidth; canvas.height = v.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(v,0,0,canvas.width,canvas.height);
  const dataURL = canvas.toDataURL('image/png');
  scanResult.innerHTML = `<div><b>تم التقاط الصورة — تحليل (محاكاة)</b></div>
    <div style="margin-top:8px">نموذج التحليل: تم الكشف عن نص قابل للقراءة (محاكاة). تحقق من الملصق يدوياً.</div>
    <div style="margin-top:8px"><img src="${dataURL}" style="width:160px;border-radius:6px"/></div>`;
});
closeScanner.addEventListener('click', ()=> stopScanner());
function stopScanner(){ scannerModal.style.display='none'; if(streamRef){ streamRef.getTracks().forEach(t=>t.stop()); streamRef=null; scannerVideo.srcObject=null; scanResult.innerHTML=''; } }

/* ========== AUTH: UI handlers (modal screens) ========== */
document.getElementById('goSignup').addEventListener('click', ()=>{ loginScreen.style.display='none'; signupScreen.style.display='flex'; });
document.getElementById('goLogin').addEventListener('click', ()=>{ signupScreen.style.display='none'; loginScreen.style.display='flex'; });

document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if(!email || !pass){ alert('أدخل البريد وكلمة المرور'); return; }
  try{
    let cred;
    try{ cred = await signInWithEmailAndPassword(auth, email, pass); }
    catch(err){
      if(err.code === 'auth/user-not-found'){
        cred = await createUserWithEmailAndPassword(auth, email, pass);
      } else throw err;
    }
    const user = cred.user;
    const role = (user.email === OWNER_EMAIL) ? 'owner' : 'user';
    await setDoc(doc(db,'users',user.uid), { email:user.email, uid:user.uid, role, createdAt: serverTimestamp() }, { merge:true });
    loginScreen.style.display='none';
    splash.style.display='none';
    appWrap.style.display='block';
  }catch(err){ alert('فشل تسجيل الدخول: '+ (err.message||err)); }
});

document.getElementById('signupBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('signupEmail').value.trim();
  const pass = document.getElementById('signupPass').value.trim();
  if(!email || !pass){ alert('أدخل البريد وكلمة المرور'); return; }
  try{
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    const user = cred.user;
    const role = (user.email === OWNER_EMAIL) ? 'owner' : 'user';
    await setDoc(doc(db,'users',user.uid), { email:user.email, uid:user.uid, role, createdAt: serverTimestamp() });
    signupScreen.style.display='none'; loginScreen.style.display='none';
  }catch(err){ alert('فشل التسجيل: '+ (err.message||err)); }
});

/* Google sign-in */
document.getElementById('googleLoginBtn').addEventListener('click', async ()=>{
  try{
    const provider = new GoogleAuthProvider();
    const res = await signInWithPopup(auth, provider);
    const user = res.user;
    const role = (user.email === OWNER_EMAIL) ? 'owner' : 'user';
    await setDoc(doc(db,'users',user.uid), { email:user.email, uid:user.uid, role, createdAt: serverTimestamp() }, { merge:true });
    loginScreen.style.display='none';
    splash.style.display='none';
    appWrap.style.display='block';
  }catch(err){ alert('فشل Google: '+ (err.message||err)); }
});

/* Observe auth state */
onAuthStateChanged(auth, async (user)=>{
  if(user){
    loginScreen.style.display='none';
    signupScreen.style.display='none';
    hideSplash();
    userInfoEl.textContent = user.email;
    // ensure user doc
    try{
      const uref = doc(db,'users',user.uid);
      const ud = await getDoc(uref);
      if(!ud.exists()){
        const role = (user.email === OWNER_EMAIL) ? 'owner' : 'user';
        await setDoc(uref, { email:user.email, uid:user.uid, role, createdAt: serverTimestamp() });
      }
      const udoc = await getDoc(uref);
      const role = udoc.exists() ? udoc.data().role : (user.email === OWNER_EMAIL ? 'owner' : 'user');
      if(role === 'owner'){ document.getElementById('ownerControls').style.display='block'; populateUsersList(); populateHistory(); }
      else document.getElementById('ownerControls').style.display='none';
    }catch(e){ console.error(e); }
  } else {
    // force login
    loginScreen.style.display='flex';
    appWrap.style.display='none';
  }
});

/* Logout */
btnLogout.addEventListener('click', async ()=>{ await signOut(auth); location.reload(); });

/* ========== Owner functions ========== */
async function populateUsersList(){
  const ul = document.getElementById('usersList');
  ul.innerHTML = '<div class="muted">جارٍ التحميل...</div>';
  try{
    const snaps = await getDocs(query(collection(db,'users'), orderBy('email','asc')));
    ul.innerHTML = '';
    snaps.forEach(s => {
      const data = s.data();
      const row = document.createElement('div');
      row.style.padding='8px'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
      row.innerHTML = `<div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div><strong>${data.email}</strong><div class="muted">UID: ${data.uid} — Role: ${data.role || 'user'}</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" onclick="toggleBan('${data.uid}','${data.email}')">حظر/إلغاء</button>
          <button class="btn ghost" onclick="setRole('${data.uid}','user')">اجعل مستخدم</button>
          <button class="btn ghost" onclick="setRole('${data.uid}','owner')">اجعل مالك</button>
        </div></div>`;
      ul.appendChild(row);
    });
  }catch(e){ ul.innerHTML = '<div class="muted">فشل جلب المستخدمين</div>'; console.error(e); }
}
window.populateUsersList = populateUsersList;

async function toggleBan(uid,email){
  const bannedRef = doc(db,'banned',uid);
  const bb = await getDoc(bannedRef);
  if(bb.exists()){ await setDoc(bannedRef, { banned:false, uid }, { merge:true }); alert(`${email} تم إلغاء الحظر`); }
  else { await setDoc(bannedRef, { banned:true, uid, by: auth.currentUser ? auth.currentUser.email : null, createdAt: serverTimestamp() }); alert(`${email} تم حظره`); }
  populateUsersList();
}
window.toggleBan = toggleBan;

async function setRole(uid, role){
  await setDoc(doc(db,'users',uid), { role }, { merge:true });
  alert('تم تغيير الصلاحية');
  populateUsersList();
}
window.setRole = setRole;

/* History (owner) */
async function populateHistory(qStr=''){
  const container = document.getElementById('historyList');
  container.innerHTML = '<div class="muted">جارٍ التحميل...</div>';
  try{
    if(qStr && qStr.trim().length){
      const snaps = await getDocs(query(collection(db,'history'), orderBy('createdAt','desc'), limit(200)));
      const list = snaps.docs.map(d=>({id:d.id, ...d.data()})).filter(item => JSON.stringify(item).toLowerCase().includes(qStr.toLowerCase()));
      renderHistoryList(list);
      return;
    } else {
      const snaps = await getDocs(query(collection(db,'history'), orderBy('createdAt','desc'), limit(100)));
      const list = snaps.docs.map(d=>({id:d.id, ...d.data()}));
      renderHistoryList(list);
    }
  }catch(e){ container.innerHTML = '<div class="muted">فشل تحميل السجلات</div>'; console.error(e); }
}
function renderHistoryList(list){
  const container = document.getElementById('historyList');
  container.innerHTML = '';
  if(!list || !list.length){ container.innerHTML = '<div class="muted">لا توجد سجلات</div>'; return; }
  list.forEach(item=>{
    const el = document.createElement('div');
    el.style.padding='8px'; el.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    el.innerHTML = `<div style="display:flex;gap:12px;justify-content:space-between">
      <div><strong>${item.type.toUpperCase()} — ${item.patientName||'—'}</strong>
        <div class="muted">المستخدم: ${item.userEmail||'—'} — ${item.createdAt ? new Date(item.createdAt.seconds*1000).toLocaleString() : ''}</div>
        <div class="muted">مدخلات: ${JSON.stringify(item.inputs)}</div>
      </div>
      <div style="text-align:left"><b>نتيجة:</b><div>${JSON.stringify(item.result)}</div></div>
    </div>`;
    container.appendChild(el);
  });
}

document.getElementById('btnSearchHistory').addEventListener('click', ()=> populateHistory(document.getElementById('searchHistory').value.trim()));
document.getElementById('btnRefreshUsers').addEventListener('click', ()=> populateUsersList());

/* default panel */
showPanel('panelDose');

/* ready */
console.log('App loaded (no AI)');

</script>
</body>
</html>
