<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± â€” Ø£ÙƒØ§Ø¯Ù…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ©</title>
<style>
  :root{
    --bg1:#09142a; --bg2:#0b3550; --card:#ffffff; --accent:#0a5275;
    --text:#e6f3ff; --muted:#9fcbe0; --glass: rgba(255,255,255,0.04);
    --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
  }
  [data-theme="light"]{
    --bg1:#f0f6fb; --bg2:#e8f2f8; --card:#fff; --accent:#0a5275;
    --text:#062433; --muted:#475b64; --glass: rgba(10,82,117,0.06);
    color-scheme: light;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh;overflow-x:hidden}
  .top-banner{position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:10010;background:linear-gradient(90deg,#072836,#0a5275);padding:14px 22px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.5);text-align:center;font-weight:700}
  .top-banner small{display:block;font-weight:400;opacity:0.9;margin-top:6px}
  #splash{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:18px;background:linear-gradient(135deg,#071024 0%, #0b2b3a 70%);overflow:hidden}
  .bars-wrap{width:92%;max-width:1000px;display:flex;flex-direction:column;gap:12px;align-items:stretch}
  .bar{background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));padding:18px;border-radius:12px;color:#eaf6ff;display:flex;flex-direction:column;gap:4px;align-items:flex-start;transform-origin:center;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
  .bar b{font-size:20px}
  .bar small{opacity:0.85;color:#d8f0ff}
  .bar .user{font-size:13px;color:#bfe6ff}
  .bar.top{animation:barOutTop 5s cubic-bezier(.2,.9,.3,1) forwards}
  .bar.mid{animation:barOutMid 5s cubic-bezier(.2,.9,.3,1) forwards}
  .bar.dev{animation:barOutDev 6s cubic-bezier(.2,.9,.3,1) forwards}
  @keyframes barOutTop {0%{transform:translateX(0);opacity:1}60%{transform:translateX(0);opacity:1}100%{transform:translateX(-140%);opacity:0}}
  @keyframes barOutMid {0%{transform:translateX(0);opacity:1}70%{transform:translateX(0);opacity:1}100%{transform:translateX(140%);opacity:0}}
  @keyframes barOutDev {0%{transform:translateY(0);opacity:1}70%{transform:translateY(0);opacity:1}100%{transform:translateY(-120%);opacity:0}}
  .splash-note{color:#bfe6ff;opacity:0.95}
  .decoration{position:fixed;inset:0;pointer-events:none;z-index:5}
  .bubble{position:absolute;border-radius:50%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.14), rgba(255,255,255,0.02));filter:blur(6px);opacity:.6;animation:floatY linear infinite}
  @keyframes floatY{0%{transform:translateY(0) translateX(0)}50%{transform:translateY(-60px) translateX(20px)}100%{transform:translateY(0) translateX(0)}}
  .glow{position:absolute;width:220px;height:220px;border-radius:50%;background:radial-gradient(circle, rgba(255,255,255,0.06), rgba(255,255,255,0));filter:blur(40px);opacity:0.8;mix-blend-mode:screen}
  #app{display:none;position:relative;z-index:10;padding:28px;max-width:1200px;margin:36px auto}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;box-shadow:0 18px 50px rgba(2,6,23,0.6);color:var(--text)}
  h1{margin:0 0 14px;text-align:center;color:var(--accent)}
  .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#0ea5a5,#0a5275);color:#fff;cursor:pointer;min-width:140px}
  .btn.secondary{background:linear-gradient(90deg,#6b7280,#0b5f7a)}
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.2)}
  .panel{display:none;margin-top:16px}
  label{display:block;text-align:right;margin:6px 0;color:var(--text)}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
  .sideEffect{background:rgba(255,70,90,0.06);border-left:4px solid rgba(255,70,90,0.9);padding:10px;margin:8px 0;border-radius:8px;color:#ffecec}
  .chatBox{height:160px;overflow:auto;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
  .controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small-muted{font-size:12px;color:var(--muted)}
  .result-box{background:rgba(0,0,0,0.18);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .pill{display:inline-block;padding:6px 10px;background:rgba(255,255,255,0.05);border-radius:999px;margin:6px 6px 0 0;color:#dff6ff;font-weight:600}
  .pill.good{background:rgba(16,185,129,0.15)}
  .pill.warn{background:rgba(245,158,11,0.18)}
  .pill.bad{background:rgba(239,68,68,0.18)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:10020}
  .modal .box{background:var(--card);color:var(--text);padding:18px;border-radius:12px;max-width:900px;width:92%}
  @media (max-width:720px){#app{padding:14px}.grid{grid-template-columns:1fr}}
  /* ===== Login gate ===== */
  #gate{position:fixed;inset:0;background:linear-gradient(135deg,#03101a,#0b2b3a);display:flex;align-items:center;justify-content:center;z-index:10050}
  .gate-card{background:rgba(255,255,255,0.06);backdrop-filter:blur(8px);padding:18px;border-radius:14px;box-shadow:0 18px 60px rgba(0,0,0,0.5);width:95%;max-width:520px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px dashed rgba(255,255,255,0.08);padding:8px;text-align:right;font-size:14px}
  .table th{opacity:0.8}
</style>
</head>
<body>

<!-- TOP BANNER -->
<div class="top-banner" id="topBanner">
  <div style="font-size:18px">Ø£ÙƒØ§Ø¯Ù…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â˜†</div>
  <small>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</small>
</div>

<!-- SPLASH -->
<div id="splash">
  <div class="bars-wrap" style="width:86%">
    <div class="bar top"><b>Ø§Ù„Ù…Ù†Ø¸Ù…: Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ±</b><small>Ù…Ù†Ø¸Ù…</small><div class="user">@871c</div></div>
    <div class="bar mid"><b>Ø§Ù„Ù…Ù†Ø¸Ù…: Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰</b><small>Ù…Ù†Ø¸Ù…</small><div class="user">@ans_mz1092</div></div>
    <div class="bar dev"><b>Ø§Ù„Ù…Ø·ÙˆØ±: Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</b><small>Ù…Ù†Ø¸Ù… Ùˆ Ù…Ø·ÙˆØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ù„Ù…Ø§Ù„Ùƒ)</small><div class="user">@ku56t</div></div>
  </div>
  <div class="splash-note">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ©</div>
</div>

<!-- decoration -->
<div class="decoration" aria-hidden="true">
  <div class="bubble" style="left:6%;top:12%;width:160px;height:160px;animation-duration:10s"></div>
  <div class="bubble" style="left:78%;top:22%;width:120px;height:120px;animation-duration:12s"></div>
  <div class="bubble" style="left:22%;top:72%;width:90px;height:90px;animation-duration:9s"></div>
  <div class="bubble" style="left:68%;top:80%;width:140px;height:140px;animation-duration:11s"></div>
  <div class="glow" style="left:2%;top:72%;opacity:0.4"></div>
  <div class="glow" style="right:2%;top:60%;opacity:0.25"></div>
</div>

<!-- ===== LOGIN GATE (mandatory) ===== -->
<div id="gate">
  <div class="gate-card">
    <h2 style="margin:0 0 6px">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</h2>
    <div class="muted">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ (LocalStorage) Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø·.</div>
    <div class="grid" style="margin-top:10px">
      <div>
        <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
          <input id="authEmail" type="email" placeholder="example@mail.com">
        </label>
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
          <input id="authPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </label>
        <div class="controls-row">
          <button class="btn" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <button class="btn secondary" id="btnRegister">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
          <button class="btn ghost" id="btnGoogle">Ø±Ø¨Ø· Ø¹Ù† Ø·Ø±ÙŠÙ‚ Google (ÙˆÙ‡Ù…ÙŠ)</button>
        </div>
      </div>
      <div>
        <div class="result-box">
          <b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b>
          <ul style="margin:8px 0 0 0;padding-right:18px;line-height:1.6;color:var(--muted)">
            <li>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠÙØ®Ø²Ù†ÙˆÙ† Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù…Ø¹: IDØŒ Ø§Ø³Ù…ØŒ Ø¥ÙŠÙ…ÙŠÙ„ØŒ RoleØŒ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±.</li>
            <li>Ø¥Ù† ÙƒÙ†Øª Ù…Ø§Ù„ÙƒÙ‹Ø§ (owner) Ø³ØªØ±Ù‰ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„.</li>
            <li>Ø§Ù„Ø­Ø¸Ø± ÙŠØªÙ… Ø¹Ø¨Ø± <b>ID</b> ÙˆÙ„Ø§ ØªØ¸Ù‡Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø± Ø¥Ù„Ø§ Ù„Ù„Ù…Ø§Ù„ÙƒÙŠÙ†.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="card">
    <h1>ğŸš‘ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± â€” Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ</h1>

    <div class="row">
      <button class="btn" id="showDose">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</button>
      <button class="btn" id="showFluids">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</button>
      <button class="btn" id="showAirway">Ø§Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ & ETT</button>
      <button class="btn" id="showAdmin">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      <button class="btn secondary" id="aboutBtn">Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
      <button class="btn secondary" id="themeToggle">ÙˆØ¶Ø¹: Ø¯Ø§ÙƒÙ†</button>
      <button class="btn secondary" id="scanBtn">Ù…Ø³Ø­ ÙƒÙŠØ³ Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØ§Ù…ÙŠØ±Ø§)</button>
    </div>

    <!-- ========== Dose panel ========== -->
    <div id="panelDose" class="panel">
      <h2 style="margin-top:0">ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ±</h2>
      <div class="grid">
        <div>
          <label>ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØº)
            <input id="weightDose" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 70" min="0" step="0.1">
          </label>

          <label>Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
            <div style="display:flex;gap:8px">
              <input id="ageDose" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 40" min="0" step="0.1" style="flex:1">
              <select id="ageUnitDose" style="width:120px">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>ØªØµÙ†ÙŠÙ ASA
            <select id="asaSelect">
              <option value="I">ASA I (Ø³Ù„ÙŠÙ…)</option>
              <option value="II">ASA II (Ù…Ø±Ø¶ Ø®ÙÙŠÙ)</option>
              <option value="III">ASA III (Ù…Ø±Ø¶ Ù…ØªÙˆØ³Ø·)</option>
              <option value="IV">ASA IV (Ø®Ø·Ø± Ø«Ø§Ø¨Øª)</option>
              <option value="V">ASA V (Ø­Ø±Ø¬)</option>
            </select>
          </label>

          <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
            <select id="patientHealth">
              <option value="healthy">ØµØ­ÙŠ</option>
              <option value="unhealthy">Ù…Ø±ÙŠØ¶ (Ø£Ù…Ø±Ø§Ø¶ Ù…ØªØ¹Ø¯Ø¯Ø©)</option>
            </select>
          </label>

          <div id="diseaseDiv" style="display:none;margin-top:8px">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø¶)
              <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">
                <label><input type="checkbox" class="diseaseChk" value="diabetes"> Ø³ÙƒØ±ÙŠ</label>
                <label><input type="checkbox" class="diseaseChk" value="heart"> Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨ÙŠØ© (CHF/IHD)</label>
                <label><input type="checkbox" class="diseaseChk" value="lung"> Ø£Ù…Ø±Ø§Ø¶ Ø±Ø¦ÙˆÙŠØ© (COPD/Asthma)</label>
                <label><input type="checkbox" class="diseaseChk" value="liver"> Ø£Ù…Ø±Ø§Ø¶ ÙƒØ¨Ø¯ÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="kidney"> Ø£Ù…Ø±Ø§Ø¶ ÙƒÙ„ÙˆÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="allergy"> ØªØ­Ø³Ø³ / Ø­Ø³Ø§Ø³ÙŠØ© Ø¯ÙˆØ§Ø¦ÙŠØ©</label>
                <label><input type="checkbox" class="diseaseChk" value="obesity"> Ø³Ù…Ù†Ø© Ù…ÙØ±Ø·Ø© (BMI â‰¥40)</label>
              </div>
            </label>
          </div>

          <label>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡
            <select id="drugDose"></select>
          </label>

          <div class="controls-row" style="margin-top:10px">
            <button class="btn" id="calcDose">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
            <button class="btn secondary" id="resetDoseChat">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø§Øª</button>
            <div class="small-muted">Ø§Ù„Ù†ØªÙŠØ¬Ø© ØªÙØ¸Ù‡Ø± Ø¬Ø±Ø¹Ø©/ÙƒØº + Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¹ Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰.</div>
          </div>
        </div>

        <div>
          <div id="doseResult" class="result-box muted"><b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</b></div>
          <div id="doseWarnings" style="margin-top:8px"></div>
          <div id="doseEffects" style="margin-top:12px"></div>
          <div id="reductionMethods" style="margin-top:12px"></div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.05);margin:16px 0">

      <h3 style="margin-bottom:8px">ğŸ’¬ Ø´Ø§Øª Ø§Ù„Ù‚Ø³Ù… (Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹)</h3>
      <div class="chatBox" id="doseChat"></div>
      <div class="controls-row" style="margin-top:8px">
        <textarea id="doseChatInput" placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø£Ùˆ Ø§Ù„Ø¢Ø«Ø§Ø±..." style="flex:1"></textarea>
        <button class="btn" id="doseChatSend">Ø£Ø±Ø³Ù„</button>
      </div>
    </div>

    <!-- ========== Fluids panel ========== -->
    <div id="panelFluids" class="panel">
      <h2>ğŸ’§ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</h2>
      <div class="grid">
        <div>
          <label>ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØº)
            <input id="weightFluid" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 70" min="0" step="0.1">
          </label>

          <label>Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
            <div style="display:flex;gap:8px">
              <input id="ageFluid" type="number" min="0" step="0.1" style="flex:1">
              <select id="ageUnitFluid" style="width:120px">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>Ù†ÙˆØ¹ Ø§Ù„ÙÙ„ÙˆØ¯
            <select id="fluidType">
              <option value="NS">Normal Saline (0.9% NaCl)</option>
              <option value="LR">Lactated Ringer</option>
              <option value="D5W">D5W (5% Dextrose)</option>
              <option value="blood">Ø¯Ù… ÙƒØ§Ù…Ù„/Ø­Ø²Ù… Ø§Ù„Ø¯Ù…</option>
            </select>
          </label>

          <div class="controls-row" style="margin-top:8px">
            <button class="btn" id="calcFluids">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„/Ø§Ù„Ø¯Ù…</button>
            <button class="btn secondary" id="resetFluidChat">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø§Øª</button>
            <div class="small-muted">Ø§Ù„ØªÙ‚Ø¯ÙŠØ± ÙŠØªØºÙŠØ± Ø¨Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ÙÙ„ÙˆØ¯.</div>
          </div>
        </div>

        <div>
          <div id="fluidResult" class="result-box muted">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.05);margin:16px 0">
      <h3>ğŸ’¬ Ø´Ø§Øª Ø§Ù„Ù‚Ø³Ù… (Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹)</h3>
      <div class="chatBox" id="fluidChat"></div>
      <div class="controls-row" style="margin-top:8px">
        <textarea id="fluidChatInput" placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„Ø³ÙˆØ§Ø¦Ù„/Ù†Ù‚Ù„ Ø§Ù„Ø¯Ù…..." style="flex:1"></textarea>
        <button class="btn" id="fluidChatSend">Ø£Ø±Ø³Ù„</button>
      </div>
    </div>

    <!-- ========== Airway panel ========== -->
    <div id="panelAirway" class="panel">
      <h2>ğŸ« Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ Ùˆ ETT</h2>
      <div class="grid">
        <div>
          <label>Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
            <div style="display:flex;gap:8px">
              <input id="ageAirway" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 3" min="0" step="0.1" style="flex:1">
              <select id="ageUnitAirway" style="width:120px">
                <option value="years">Ø³Ù†ÙˆØ§Øª</option>
                <option value="months">Ø£Ø´Ù‡Ø±</option>
                <option value="days">Ø£ÙŠØ§Ù…</option>
              </select>
            </div>
          </label>

          <label>ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØº)
            <input id="weightAirway" type="number" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" min="0" step="0.1">
          </label>

          <div class="controls-row" style="margin-top:8px">
            <button class="btn" id="calcAirway">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</button>
            <button class="btn secondary" id="resetAirwayChat">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø§Øª</button>
            <div class="small-muted">Ø­Ø³Ø§Ø¨ ØªÙ‚Ø±ÙŠØ¨ÙŠ.</div>
          </div>
        </div>

        <div>
          <div id="airwayResult" class="result-box muted">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.05);margin:16px 0">
      <h3>ğŸ’¬ Ø´Ø§Øª Ø§Ù„Ù‚Ø³Ù… (Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹)</h3>
      <div class="chatBox" id="airwayChat"></div>
      <div class="controls-row" style="margin-top:8px">
        <textarea id="airwayChatInput" placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´ÙØ±Ø© Ø£Ùˆ Ø­Ø¬Ù… ETT..." style="flex:1"></textarea>
        <button class="btn" id="airwayChatSend">Ø£Ø±Ø³Ù„</button>
      </div>
    </div>

    <!-- ========== Admin panel ========== -->
    <div id="panelAdmin" class="panel">
      <h2>âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… (Admin/Owner)</h2>

      <div class="grid">
        <div>
          <div class="result-box" id="whoamiBox">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: â€”</div>
          <div class="small-muted" style="margin-top:6px">ØªØ¸Ù‡Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯ÙˆØ±Ùƒ <b>owner</b>.</div>

          <div id="ownerTools" style="display:none;margin-top:10px">
            <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <div class="controls-row">
              <input id="newUserEmail" placeholder="Ø¥ÙŠÙ…ÙŠÙ„">
              <input id="newUserName" placeholder="Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…">
              <input id="newUserPass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" type="password">
              <button class="btn" id="addUserBtn">Ø£Ø¶Ù</button>
            </div>

            <div class="controls-row" style="margin-top:8px">
              <button class="btn secondary" id="listUsersBtn">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
            </div>
            <div id="usersList" style="margin-top:8px"></div>

            <hr style="margin:14px 0">
            <h3>ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Audit Log)</h3>
            <div class="controls-row">
              <input id="logFilter" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ (Ù†ÙˆØ¹/Ø¯ÙˆØ§Ø¡/Ø¥ÙŠÙ…ÙŠÙ„/Ù†ØªÙŠØ¬Ø©)">
              <button class="btn" id="refreshLog">ØªØ­Ø¯ÙŠØ«</button>
              <button class="btn ghost" id="exportLog">ØªØµØ¯ÙŠØ± JSON</button>
            </div>
            <div id="logBox" class="result-box" style="margin-top:8px;max-height:280px;overflow:auto">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ Ø¨Ø¹Ø¯.</div>
            <div class="small-muted">ÙŠØ³Ø¬Ù‘Ù„: ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø§Ù„Ù†ÙˆØ¹ (Dose/Fluids/Airway)ØŒ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø©.</div>
          </div>
        </div>

        <div>
          <div class="result-box">
            <h3 style="margin:0 0 6px">Ø®Ø±ÙˆØ¬/ØªØ¨Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨</h3>
            <button class="btn" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
          </div>
          <div class="small-muted" style="margin-top:8px">ØªØ°ÙƒÙŠØ±: Ù‡Ø°Ø§ Ù†Ù…ÙˆØ°Ø¬ Ù…Ø­Ù„ÙŠ â€” Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ØªØ­ØªØ§Ø¬ Backend Ø¢Ù…Ù† ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª.</div>
        </div>
      </div>
    </div>

    <footer>Â© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± â€” Ø±Ø§Ø¬Ø¹ Ø¯ÙˆÙ…Ø§Ù‹ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ±ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙŠ Ø¬Ø±Ø¹Ø©</footer>
  </div>
</div>

<!-- ABOUT modal -->
<div class="modal" id="aboutModal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3 style="margin:0">Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
        <small class="muted">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</small>
      </div>
      <div><button class="btn" id="closeAbout">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>

    <div style="margin-top:12px;color:var(--muted);line-height:1.6">
      <p><strong>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</strong> Ù‡Ùˆ Ù…ÙˆÙ‚Ø¹ Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± ÙˆØ§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ù‡ÙˆØ§Ø¦ÙŠØ§Øª. ØµÙÙ…Ù… Ù„Ù„ØªØ¹Ù„Ù‘Ù… ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© â€” Ù„Ø§ ÙŠÙØ³ØªØºÙ†Ù‰ Ø¨Ù‡ Ø¹Ù† Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ.</p>
      <p>Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø°ÙƒÙˆØ±ÙˆÙ† ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ù„Ø£Ø´Ø±Ø·Ø©):</p>
      <ul>
        <li>Ø§Ù„Ù…Ø·ÙˆØ± ÙˆØ§Ù„Ù…Ø§Ù„Ùƒ: <b>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</b> â€” @ku56t</li>
        <li>Ù…Ù†Ø¸Ù…: <b>Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ±</b> â€” @871c</li>
        <li>Ù…Ù†Ø¸Ù…: <b>Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰</b> â€” @ans_mz1092</li>
      </ul>
      <p>Ù…ÙŠØ²Ø§Øª: Ø¯Ø®ÙˆÙ„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠØŒ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø¨Ø± IDØŒ Ø­Ø¸Ø± Ø¹Ø¨Ø± ID Ù„Ù„Ù…Ø§Ù„ÙƒÙŠÙ† ÙÙ‚Ø·ØŒ Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§ØªØŒ Ø´Ø§Øª Ù…Ø­ÙÙˆØ¸ Ù„ÙƒÙ„ Ù‚Ø³Ù…ØŒ ÙˆØªØ­Ø°ÙŠØ±Ø§Øª Ø£Ù…Ø±Ø§Ø¶ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø±Ø¹Ø©.</p>
      <p style="margin-top:8px;color:#ffdede"><strong>ØªÙ†Ø¨ÙŠÙ‡ Ø·Ø¨ÙŠ:</strong> Ø£Ø¯Ø§Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©/ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙÙ‚Ø·.</p>
    </div>
  </div>
</div>

<script>
/* ========= Utilities & Initialization ========= */
document.addEventListener('DOMContentLoaded', ()=>{

  /* ======= Splash timing ======= */
  setTimeout(()=> {
    const splash = document.getElementById('splash');
    splash.style.transition = 'opacity .6s ease, transform .6s ease';
    splash.style.opacity = '0';
    splash.style.transform = 'translateY(-20px)';
    setTimeout(()=>{ splash.style.display='none'; }, 700);
  }, 6000);

  /* ======= Theming ======= */
  const themeBtn = document.getElementById('themeToggle');
  let dark = true;
  themeBtn.addEventListener('click', ()=>{
    dark = !dark;
    if(!dark) { document.documentElement.setAttribute('data-theme','light'); themeBtn.textContent='ÙˆØ¶Ø¹: ÙØ§ØªØ­'; }
    else { document.documentElement.removeAttribute('data-theme'); themeBtn.textContent='ÙˆØ¶Ø¹: Ø¯Ø§ÙƒÙ†'; }
  });

  /* ======= Panels ======= */
  const panels = { showDose:'panelDose', showFluids:'panelFluids', showAirway:'panelAirway', showAdmin:'panelAdmin' };
  Object.keys(panels).forEach(btnId=>{
    document.getElementById(btnId).addEventListener('click', ()=>{
      Object.values(panels).forEach(pid => document.getElementById(pid).style.display='none');
      document.getElementById(panels[btnId]).style.display='block';
      window.scrollTo({top:0, behavior:'smooth'});
    });
  });

  /* ======= LocalStorage helpers ======= */
  const LS = {
    usersKey: 'ans_users_v2',
    chatKey:  (section)=>`ans_chat_${section}`,
    auditKey: 'ans_audit_log_v1',
    whoKey:   'ans_current_user',
    load(k){ try{return JSON.parse(localStorage.getItem(k)||'null')}catch(_){return null} },
    save(k,v){ localStorage.setItem(k, JSON.stringify(v)) },
  };

  /* ======= Users & Auth ======= */
  function genId(){ return 'u-'+Math.random().toString(36).slice(2,10); }
  function nowISO(){ return new Date().toISOString(); }
  function initOwners(){
    let users = LS.load(LS.usersKey) || [];
    if(!users.find(u=>u.role==='owner')){
      users.push({ id: genId(), username:'owner', email:'owner@example.com', password:'mustafa@2006#2', role:'owner', banned:false, provider:'local' });
      LS.save(LS.usersKey, users);
    }
  }
  initOwners();

  function getUsers(){ return LS.load(LS.usersKey)||[]; }
  function setUsers(u){ LS.save(LS.usersKey,u); }
  function currentUser(){ return LS.load(LS.whoKey); }
  function setCurrentUser(u){ LS.save(LS.whoKey,u); }

  // Login Gate elements
  const gate = document.getElementById('gate');
  const app = document.getElementById('app');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');
  const btnGoogle = document.getElementById('btnGoogle');

  function openAppFor(user){
    setCurrentUser({ id:user.id, email:user.email, username:user.username, role:user.role });
    document.getElementById('whoamiBox').innerHTML = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${user.username}</b> â€” <span class="muted">${user.email}</span> â€” ID: ${user.id} â€” Role: ${user.role}${user.banned?'<span class="pill bad">Ù…Ø­Ø¸ÙˆØ±</span>':''}`;
    document.getElementById('ownerTools').style.display = (user.role==='owner') ? 'block' : 'none';
    // default panel
    document.getElementById('showDose').click();
    // show app, hide gate
    app.style.display='block';
    gate.style.display='none';
  }

  // Auto-login if remembered
  (()=>{ const u = currentUser(); if(u){ const full = (getUsers().find(x=>x.id===u.id)); if(full && !full.banned){ openAppFor(full); } } })();

  btnRegister.addEventListener('click', ()=>{
    const email = document.getElementById('authEmail').value.trim();
    const pass = document.getElementById('authPass').value.trim();
    if(!email || !pass){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
    let users = getUsers();
    if(users.find(u=>u.email.toLowerCase()===email.toLowerCase())){ alert('Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return; }
    const username = email.split('@')[0];
    const user = { id: genId(), email, username, password:pass, role:'user', banned:false, provider:'local' };
    users.push(user); setUsers(users);
    alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø³ÙØ¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.');
  });

  btnLogin.addEventListener('click', ()=>{
    const email = document.getElementById('authEmail').value.trim();
    const pass = document.getElementById('authPass').value.trim();
    const u = getUsers().find(x=>x.email.toLowerCase()===email.toLowerCase() && x.password===pass);
    if(!u) return alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©');
    if(u.banned) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ø¸ÙˆØ±');
    openAppFor(u);
  });

  // Fake Google link (creates/links an account)
  btnGoogle.addEventListener('click', ()=>{
    const rand = Math.random().toString(36).slice(2,8);
    const email = `user_${rand}@gmail.com`;
    let users = getUsers();
    let u = users.find(x=>x.email===email);
    if(!u){
      u = { id: genId(), email, username:`g_${rand}`, password:null, role:'user', banned:false, provider:'google' };
      users.push(u); setUsers(users);
    }
    openAppFor(u);
  });

  // logout
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem(LS.whoKey);
    location.reload();
  });

  /* ======= Admin â€” Manage users (owner only) ======= */
  document.getElementById('addUserBtn').addEventListener('click', ()=>{
    const me = currentUser(); if(!me || me.role!=='owner') return alert('Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
    const email = document.getElementById('newUserEmail').value.trim();
    const name = document.getElementById('newUserName').value.trim();
    const pass = document.getElementById('newUserPass').value.trim();
    if(!email || !name || !pass) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„');
    let users = getUsers();
    if(users.find(u=>u.email.toLowerCase()===email.toLowerCase())) return alert('Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯');
    users.push({ id: genId(), email, username:name, password:pass, role:'user', banned:false, provider:'local' });
    setUsers(users);
    document.getElementById('newUserEmail').value='';
    document.getElementById('newUserName').value='';
    document.getElementById('newUserPass').value='';
    alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
  });

  document.getElementById('listUsersBtn').addEventListener('click', ()=>{
    const me = currentUser(); if(!me || me.role!=='owner') return alert('Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
    const list = getUsers();
    const el = document.getElementById('usersList');
    if(!list.length){ el.innerHTML='Ù„Ø§ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'; return; }
    let html = '<div style="max-height:260px;overflow:auto;padding:6px">';
    list.forEach(u=>{
      html += `<div style="display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px;border-bottom:1px dashed rgba(255,255,255,0.08)">
        <div><b>${u.username}</b> <span class="muted">(${u.email})</span>
          <div style="font-size:12px;color:var(--muted)">ID: ${u.id} â€” Role: ${u.role} ${u.banned?'<span class="pill bad">Ù…Ø­Ø¸ÙˆØ±</span>':''}</div></div>
        <div style="display:flex;gap:6px">
          ${u.role!=='owner'?`<button class="btn" data-action="ban" data-id="${u.id}">${u.banned?'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±':'Ø­Ø¸Ø± (ID)'}</button>`:''}
          ${u.role!=='owner'?`<button class="btn secondary" data-action="del" data-id="${u.id}">Ø­Ø°Ù</button>`:''}
        </div>
      </div>`;
    });
    html += '</div>';
    el.innerHTML = html;

    el.querySelectorAll('button[data-action]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.id; const act = btn.dataset.action;
        let list = getUsers();
        const idx = list.findIndex(x=>x.id===id);
        if(idx<0) return;
        if(act==='ban'){ list[idx].banned = !list[idx].banned; setUsers(list); alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); document.getElementById('listUsersBtn').click(); }
        if(act==='del'){ if(confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')){ list.splice(idx,1); setUsers(list); alert('ØªÙ… Ø§Ù„Ø­Ø°Ù'); document.getElementById('listUsersBtn').click(); }}
      });
    });
  });

  /* ======= Drug DB & calculations ======= */
  const drugData = {
    "Propofol":{ dose:{ infant:[2.5,3.0], child:[2.0,2.5], adult:2.5 }, max:{value:300,unit:'mg'}, unitPerKg:'mg/kg',
      side_effects:["Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù…","ØªÙˆÙ‚Ù ØªÙ†ÙØ³ Ù…Ø¤Ù‚Øª","Ø£Ù„Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ù‚Ù†","Ù…ØªÙ„Ø§Ø²Ù…Ø© Ø§Ù„ØªØ³Ø±ÙŠØ¨ Ø§Ù„Ø·ÙˆÙŠÙ„ PRIS"],
      management:["Ø±ÙØ¹ Ø§Ù„Ø³Ø§Ù‚ÙŠÙ†/Ø³ÙˆØ§Ø¦Ù„/Vasopressors","ØªÙ‡ÙˆÙŠØ© ÙˆØ¯Ø¹Ù… ØªÙ†ÙØ³ÙŠ","Lidocaine Ù‚Ø¨Ù„ Ø§Ù„Ø­Ù‚Ù†","Ø¥ÙŠÙ‚Ø§Ù + Ø¯Ø¹Ù… Ù‚Ù„Ø¨ÙŠ/ÙƒÙ„ÙˆÙŠ"],
      reduction:"Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø±Ø¹Ø§Øª ØµØºÙŠØ±Ø© ÙˆÙ‚Ø³Ù‘Ù… Ø§Ù„Ù€bolusØ› Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¶ØºØ·." },
    "Midazolam":{ dose:{ infant:[0.05,0.1], child:[0.05,0.2], adult:0.15 }, max:{value:10,unit:'mg'}, unitPerKg:'mg/kg',
      side_effects:["ØªÙ‡Ø¯Ø¦Ø© Ù…ÙØ±Ø·Ø©","Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ·","Ø±Ø¯ ÙØ¹Ù„ Ø¹ÙƒØ³ÙŠ"],
      management:["Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØªÙ†ÙØ³","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø©","Flumazenil Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©"],
      reduction:"Ø®ÙØ¶ ØªØ¯Ø±ÙŠØ¬ÙŠ ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ†ÙØ³." },
    "Fentanyl":{ dose:{ infant:[1,2], child:[2,3], adult:2 }, max:{value:300,unit:'Âµg'}, unitPerKg:'Âµg/kg',
      side_effects:["ØªØ«Ø¨ÙŠØ· ØªÙ†ÙØ³ÙŠ","ØªØ¨Ø§Ø·Ø¤ Ù‚Ù„Ø¨","ØºØ«ÙŠØ§Ù†/Ù‚ÙŠØ¡"],
      management:["Ø¯Ø¹Ù… ØªÙ†ÙØ³ÙŠ/Naloxone","Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ù„Ø¨ÙŠØ©","Ù…Ø¶Ø§Ø¯ ØºØ«ÙŠØ§Ù†"],
      reduction:"Ø¬Ø±Ø¹Ø§Øª ØµØºÙŠØ±Ø© Ù…ØªÙØ±Ù‚Ø© Ø£Ùˆ CRI Ù…Ù†Ø®ÙØ¶." },
    "Ketamine":{ dose:{ infant:[2,3], child:[4,5], adult:1.5 }, max:{value:300,unit:'mg'}, unitPerKg:'mg/kg',
      side_effects:["Ø²ÙŠØ§Ø¯Ø© Ø¶ØºØ·","ØªÙŠØ¨Ø³","Ù‡Ù„Ø§ÙˆØ³ Ø§Ù„Ø¥ÙØ§Ù‚Ø©"],
      management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¶ØºØ·","Midazolam","Ø¨ÙŠØ¦Ø© Ù‡Ø§Ø¯Ø¦Ø©"],
      reduction:"Ø£Ø¶ÙÙ Ø¨Ù†Ø²ÙˆØ¯ÙŠØ§Ø²ÙŠØ¨ÙŠÙ† Ù„ØªÙ‚Ù„ÙŠÙ„ Ø®Ù„Ù„ Ø§Ù„Ø¥Ø¯Ø±Ø§Ùƒ." },
    "Thiopental":{ dose:{ infant:[10,15], child:[10,12.5], adult:12.5 }, max:{value:400,unit:'mg'}, unitPerKg:'mg/kg',
      side_effects:["ÙƒØ¨Øª ØªÙ†ÙØ³ÙŠ","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"], management:["ØªÙ‡ÙˆÙŠØ© ÙˆØ£ÙƒØ³Ø¬ÙŠÙ†","Ø¯Ø¹Ù… Ø§Ù„Ø¶ØºØ·"], reduction:"Ù‚Ø³Ù‘Ù… Ø§Ù„Ø¬Ø±Ø¹Ø© Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ù„ Ø¹Ù†Ø¯ Ù„Ø²Ù…." },
    "Etomidate":{ dose:{ infant:[0.15,0.3], child:[0.2,0.3], adult:0.3 }, max:{value:40,unit:'mg'}, unitPerKg:'mg/kg',
      side_effects:["Myoclonus","ÙƒØ¨Øª Ù‚Ø´Ø± Ø§Ù„ÙƒØ¸Ø±"], management:["BZD Ù„ØªÙ‚Ù„ÙŠÙ„Ù‡Ø§","Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ØµÙŠØ±"], reduction:"Ø£Ù‚Ù„ Ø¬Ø±Ø¹Ø© ÙØ¹Ù‘Ø§Ù„Ø© + BZD Ù‚Ø¨Ù„Ù‡." },
    "Dexmedetomidine":{ dose:{ infant:[0.5,1.0], child:[1.0,2.0], adult:1.0 }, max:{value:200,unit:'Âµg'}, unitPerKg:'Âµg/kg',
      side_effects:["Ø¨Ø·Ø¡ Ù‚Ù„Ø¨","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"], management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ù„Ø¨ÙŠØ©","Ø¹Ù„Ø§Ø¬ Ø¯Ø§Ø¹Ù…"], reduction:"Ø®ÙØ¶ Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ³Ø±ÙŠØ¨ ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© ECG." },
    "Isoflurane":{ dose:{ infant:[1.3,1.6], child:[1.3,1.6], adult:1.45 }, max:{value:100,unit:'%MAC'}, unitPerKg:'%MAC',
      side_effects:["Ù‡Ø¨ÙˆØ· Ø¶ØºØ·","ÙƒØ¨Øª ØªÙ†ÙØ³ÙŠ"], management:["ØªØ¹Ø¯ÙŠÙ„ MAC","Ø¯Ø¹Ù… ØªÙ†ÙØ³ÙŠ"], reduction:"Ø®ÙØ¶ ØªØ¯Ø±ÙŠØ¬ÙŠ ÙˆØ§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„ÙØ¹Ù‘Ø§Ù„." },
    "Succinylcholine":{ dose:{ infant:[1,2], child:[1,2], adult:1.5 }, max:{value:200,unit:'mg'}, unitPerKg:'mg/kg',
      side_effects:["Hyperkalemia","MH (Ù†Ø§Ø¯Ø±Ø§Ù‹)"], management:["ØªÙ‡ÙˆÙŠØ©Ø› Dantrolene Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©"], reduction:"ØªØ¬Ù†Ø¨Ù‡ Ø¹Ù†Ø¯ Ø®Ø·Ø± ÙØ±Ø· Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…." },
    "Lidocaine":{ dose:{ infant:[1,2], child:[2,3], adult:3 }, max:{value:300,unit:'mg'}, unitPerKg:'mg/kg',
      side_effects:["ØªØ´Ù†Ø¬Ø§Øª","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"], management:["Ø¥ÙŠÙ‚Ø§ÙØ› BZD Ù„Ù„ØªØ´Ù†Ø¬Ø§Øª"], reduction:"Ø£Ù‚Ù„ Ø¬Ø±Ø¹Ø© ÙØ¹Ø§Ù„Ø© + Ù…Ø±Ø§Ù‚Ø¨Ø©." },
    "Bupivacaine":{ dose:{ infant:[1,2], child:[2,2], adult:2 }, max:{value:200,unit:'mg'}, unitPerKg:'mg/kg',
      side_effects:["Ø³Ù…ÙŠØ© Ù‚Ù„Ø¨ÙŠØ©","ØªØ´Ù†Ø¬Ø§Øª"], management:["Intralipid 20% ÙˆØ¯Ø¹Ù…"], reduction:"Lowest effective dose + ECG." }
  };

  const drugSelect = document.getElementById('drugDose');
  Object.keys(drugData).forEach(name=>{
    const o = document.createElement('option'); o.value = name; o.textContent = name; drugSelect.appendChild(o);
  });

  // Disease toggle
  const patientHealth = document.getElementById('patientHealth');
  const diseaseDiv = document.getElementById('diseaseDiv');
  patientHealth.addEventListener('change', ()=> {
    diseaseDiv.style.display = patientHealth.value === 'unhealthy' ? 'block' : 'none';
    if(patientHealth.value === 'healthy') document.querySelectorAll('.diseaseChk').forEach(c=>c.checked=false);
  });

  const asaFactors = { I:1.00, II:0.95, III:0.85, IV:0.75, V:0.65 };
  const diseaseFactors = { diabetes:0.95, heart:0.80, lung:0.85, liver:0.70, kidney:0.75, allergy:0.90, obesity:1.05 };

  function toYears(val, unit){
    const v = parseFloat(val);
    if(isNaN(v) || v < 0) return NaN;
    if(unit === 'years') return v;
    if(unit === 'months') return v/12;
    if(unit === 'days') return v/365;
    return v;
  }
  function ageCategory(years){ if(years < 1) return 'infant'; if(years < 12) return 'child'; return 'adult'; }
  function avgDose(dv){ return Array.isArray(dv) ? (dv[0]+dv[1])/2 : dv; }

  function calculateTotalDose(drugName, weightKg, ageYears, asaClass, diseases){
    const doc = drugData[drugName];
    if(!doc) return null;
    const cat = ageCategory(ageYears);
    const perKg = avgDose(doc.dose[cat]);
    if(doc.unitPerKg === '%MAC'){
      let factor = asaFactors[asaClass] || 1.0;
      diseases.forEach(d => { if(diseaseFactors[d]) factor *= diseaseFactors[d]; });
      return { perKg, value: (perKg * factor), unit: '%MAC', capped:false, max:null };
    }
    let total = perKg * weightKg;
    total *= (asaFactors[asaClass] || 1.0);
    diseases.forEach(d => { if(diseaseFactors[d]) total *= diseaseFactors[d]; });
    let capped=false, maxInfo=null;
    if(doc.max && typeof doc.max.value === 'number'){
      if(total > doc.max.value){ total = doc.max.value; capped=true; maxInfo=doc.max; }
    }
    const totalUnit = (doc.max && doc.max.unit) ? doc.max.unit : (doc.unitPerKg.includes('Âµg') ? 'Âµg' : 'mg');
    return { perKg, value: total, unitPerKg: doc.unitPerKg, unitTotal: totalUnit, capped, max:maxInfo };
  }

  function fmt(n, unit){
    if(unit==='Âµg') return Math.round(n) + ' Âµg';
    if(n < 1) return n.toFixed(2)+' '+unit;
    if(n < 10) return n.toFixed(2)+' '+unit;
    return n.toFixed(1)+' '+unit;
  }

  function formatDoseDisplay(calc, weight, drugName){
    if(!calc) return 'Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨';
    if(calc.unit === '%MAC'){
      const v = calc.value.toFixed(2);
      return `<div class="pill">${drugName}</div>
              <div class="pill">Ø§Ù„ÙˆØ²Ù†: ${weight} ÙƒØº</div>
              <div class="pill">Ø§Ù„Ø¬Ø±Ø¹Ø©/ÙƒØº: ${calc.perKg} %MAC</div>
              <div class="pill good">Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${v} %MAC</div>`;
    }
    const perKgUnit = calc.unitPerKg || 'mg/kg';
    const totalUnit = calc.unitTotal || 'mg';
    const totalTxt = fmt(calc.value, totalUnit);
    const perKgTxt = `${calc.perKg} ${perKgUnit}`;
    const sizeClass = (calc.value<= (totalUnit==='Âµg'?200:5)) ? 'warn' : (calc.value>(totalUnit==='Âµg'?2000:200) ? 'bad' : 'good');
    const capTxt = calc.capped ? `<div class="pill bad">ØªÙ… Ø¨Ù„ÙˆØº Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${calc.max.value} ${calc.max.unit}</div>` : '';
    return `<div class="pill">${drugName}</div>
            <div class="pill">Ø§Ù„ÙˆØ²Ù†: ${weight} ÙƒØº</div>
            <div class="pill">Ø§Ù„Ø¬Ø±Ø¹Ø©/ÙƒØº: ${perKgTxt}</div>
            <div class="pill ${sizeClass}">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalTxt}</div>
            ${capTxt}`;
  }

  function diseaseWarnings(diseases, drug){
    if(!diseases || !diseases.length) return '';
    const map = {
      liver: `âš ï¸ Ø£Ù…Ø±Ø§Ø¶ ÙƒØ¨Ø¯ÙŠØ©: Ø®ÙÙ‘Ø¶ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ù„Ø¨Ø© ÙƒØ¨Ø¯ÙŠÙ‹Ø§ (${drug}).`,
      kidney:`âš ï¸ Ø£Ù…Ø±Ø§Ø¶ ÙƒÙ„ÙˆÙŠØ©: Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªØ±Ø§ÙƒÙ…ØŒ ÙÙƒÙ‘Ø± Ø¨ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø©/Ø§Ù„Ø¥Ø·Ø§Ù„Ø©.`,
      heart: `âš ï¸ Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨ÙŠØ©: ØªØ¬Ù†Ù‘Ø¨ Ù‡Ø¨ÙˆØ· Ø§Ù„Ø¶ØºØ·/Ø¨Ø·Ø¡ Ø§Ù„Ù‚Ù„Ø¨ â€” Ø±Ø§Ù‚Ø¨ closely.`,
      lung:  `âš ï¸ Ø£Ù…Ø±Ø§Ø¶ Ø±Ø¦ÙˆÙŠØ©: Ø§Ù†ØªØ¨Ù‡ Ù„ØªØ«Ø¨ÙŠØ· Ø§Ù„ØªÙ†ÙØ³ Ø®ØµÙˆØµÙ‹Ø§ Ù…Ø¹ Ø§Ù„Ø£ÙÙŠÙˆÙ†Ø§Øª/Ø§Ù„Ø¨Ù†Ø²ÙˆØ¯ÙŠØ§Ø²ÙŠØ¨ÙŠÙ†.`,
      diabetes:`â„¹ï¸ Ø³ÙƒØ±ÙŠ: Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³ÙƒØ± ÙˆØ§Ù„Ø³ÙˆØ§Ø¦Ù„.`,
      obesity:`â„¹ï¸ Ø³Ù…Ù†Ø©: ÙÙƒÙ‘Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… LBW/AdjBW Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©.`,
      allergy:`ğŸš¨ ØªØ­Ø³Ø³: ØªØ£ÙƒÙ‘Ø¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø­Ø³Ø§Ø³ÙŠØ© Ù…Ø¹Ø±ÙˆÙØ© Ù„Ù„Ø¯ÙˆØ§Ø¡/Ø§Ù„Ù…Ø°ÙŠØ¨.`
    };
    return diseases.map(d=>`<div class="sideEffect">${map[d]||'ØªÙ†Ø¨ÙŠÙ‡ Ø³Ø±ÙŠØ±ÙŠ Ø¹Ø§Ù…'}</div>`).join('');
  }

  function pushAudit(entry){
    const list = LS.load(LS.auditKey) || [];
    list.unshift(entry); // latest first
    LS.save(LS.auditKey, list);
  }

  // calculate dose click
  document.getElementById('calcDose').addEventListener('click', ()=>{
    const me = currentUser(); if(!me) return alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    const weight = parseFloat(document.getElementById('weightDose').value);
    const ageVal = parseFloat(document.getElementById('ageDose').value);
    const ageUnit = document.getElementById('ageUnitDose').value;
    const asaClass = document.getElementById('asaSelect').value;
    const drug = drugSelect.value;
    if(!weight || !ageVal || !drug){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø¹Ù…Ø± ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ§Ø¡'); return; }
    const ageYears = toYears(ageVal, ageUnit);
    if(isNaN(ageYears)){ alert('Ø§Ø¯Ø®Ù„ Ø¹Ù…Ø±Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹'); return; }
    let diseases = [];
    if(document.getElementById('patientHealth').value === 'unhealthy')
      document.querySelectorAll('.diseaseChk:checked').forEach(ch=>diseases.push(ch.value));
    const calc = calculateTotalDose(drug, weight, ageYears, asaClass, diseases);
    const rEl = document.getElementById('doseResult');
    rEl.innerHTML = formatDoseDisplay(calc, weight, drug);
    document.getElementById('doseWarnings').innerHTML = diseaseWarnings(diseases, drug);

    // side effects + reduction
    const ddata = drugData[drug];
    let effHTML = '';
    ddata.side_effects.forEach((se,i)=>{
      effHTML += `<div class="sideEffect"><b>Ø¹Ø±Ø¶ Ø¬Ø§Ù†Ø¨ÙŠ:</b> ${se}<br><b>Ø§Ù„ØªØ¹Ø§Ù…Ù„:</b> ${ddata.management[i] || 'ØªØ¯Ø¨ÙŠØ± Ø¯Ø§Ø¹Ù… Ø¹Ø§Ù…'}</div>`;
    });
    effHTML += `<div style="margin-top:8px;padding:10px;border-radius:8px;background:rgba(10,82,117,0.07)"><b>Ø·Ø±ÙŠÙ‚Ø© ØªØ®ÙÙŠÙ Ø§Ù„Ø¬Ø±Ø¹Ø© / Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±:</b><div style="margin-top:6px">${ddata.reduction || 'ØªØ¯Ø§Ø¨ÙŠØ± Ø¯Ø§Ø¹Ù…Ø© Ø¹Ø§Ù…Ø©'}</div></div>`;
    document.getElementById('doseEffects').innerHTML = effHTML;

    // audit
    pushAudit({ t: nowISO(), user: me.email, uid: me.id, type:'Dose',
      input:{weight, age:ageVal, ageUnit, asaClass, drug, diseases},
      result: rEl.textContent.trim()
    });
  });

  // fluids with types
  document.getElementById('calcFluids').addEventListener('click', ()=>{
    const me = currentUser(); if(!me) return alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    const w = parseFloat(document.getElementById('weightFluid').value);
    const ageVal = parseFloat(document.getElementById('ageFluid').value) || 0;
    const ageUnit = document.getElementById('ageUnitFluid').value;
    const type = document.getElementById('fluidType').value;
    if(!w){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ²Ù†'); return; }
    const ageYears = toYears(ageVal, ageUnit) || 30;
    let basePerKg;
    if(ageYears < 1) basePerKg = 100;
    else if(ageYears < 10) basePerKg = 50;
    else basePerKg = 30;
    const typeModifiers = { NS:1.0, LR:1.0, D5W:1.05, blood:0.5 };
    const maintenance = Math.round(basePerKg * w * (typeModifiers[type]||1));
    let bloodVol = Math.round((ageYears < 1 ? 85 : (ageYears < 10 ? 80 : 70)) * w);
    let bloodInfo = '';
    if(type === 'blood'){
      const unitVol = 350;
      const units = Math.max(1, Math.round(maintenance / unitVol));
      bloodInfo = `<div style="margin-top:8px"><b>Ø­Ø§Ø¬Ø© Ø¯Ù… (ÙˆØ­Ø¯Ø© â‰ˆ ${unitVol} ml):</b> ${units} ÙˆØ­Ø¯Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹</div>`;
    }
    const out = `<div><b>Ø³Ø§Ø¦Ù„ ØµÙŠØ§Ù†Ø© (ØªÙ‚Ø±ÙŠØ¨ÙŠ / 24h):</b> ${maintenance} ml (${type})</div>
      <div style="margin-top:6px"><b>Ø­Ø¬Ù… Ø¯Ù… ØªÙ‚Ø±ÙŠØ¨ÙŠ:</b> ${bloodVol} ml</div>${bloodInfo}`;
    document.getElementById('fluidResult').innerHTML = out;

    pushAudit({ t: nowISO(), user: me.email, uid: me.id, type:'Fluids',
      input:{weight:w, age:ageVal, ageUnit, type}, result: out.replace(/<[^>]+>/g,' ') });
  });

  // airway
  document.getElementById('calcAirway').addEventListener('click', ()=>{
    const me = currentUser(); if(!me) return alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    const ageVal = parseFloat(document.getElementById('ageAirway').value);
    const ageUnit = document.getElementById('ageUnitAirway').value;
    const weight = parseFloat(document.getElementById('weightAirway').value) || null;
    if(!ageVal){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø±'); return; }
    const ageYears = toYears(ageVal, ageUnit);
    let blade = '', ett = '';
    if(ageYears < 1){ blade = 'Neonate/Infant blade 0-1'; ett = '3.0 - 3.5 mm (approx)'; }
    else if(ageYears < 5){ blade = 'Pediatric blade 1-2'; ett = '4.0 - 4.5 mm'; }
    else if(ageYears < 10){ blade = 'Pediatric blade 2'; ett = '5.0 - 5.5 mm'; }
    else { blade = 'Standard adult blade (3-4)'; ett = '6.0 - 8.0 mm (Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³ ÙˆØ§Ù„ÙˆØ²Ù†)'; }
    let ettByAge = '';
    if(ageYears >= 1 && ageYears < 12){
      const e = Math.floor(ageYears/4 + 4);
      ettByAge = ` â€” Ø·Ø±ÙŠÙ‚Ø© Ø³Ø±ÙŠØ¹Ø© ETT (uncuffed): ${e}.0 mm`;
    }
    const out = `<div><b>Ø´ÙØ±Ø© Ù…Ù†Ø§Ø³Ø¨Ø©:</b> ${blade}</div><div style="margin-top:6px"><b>ETT Ø§Ù‚ØªØ±Ø§Ø­:</b> ${ett}${ettByAge}</div><div style="margin-top:8px;color:var(--muted)">Ù†ØµØ§Ø¦Ø­: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙˆØ§Ù„ØªÙ‡ÙˆÙŠØ© ÙˆÙ…Ù‚Ø§Ø³ÙŠÙ† Ø§Ø­ØªÙŠØ§Ø·.</div>`;
    document.getElementById('airwayResult').innerHTML = out;

    pushAudit({ t: nowISO(), user: me.email, uid: me.id, type:'Airway',
      input:{age:ageVal, ageUnit, weight}, result: out.replace(/<[^>]+>/g,' ') });
  });

  /* ======= Section Chats (persisted) ======= */
  function loadChat(section){
    const arr = LS.load(LS.chatKey(section)) || [];
    return arr;
  }
  function saveChat(section, arr){
    LS.save(LS.chatKey(section), arr);
  }
  function renderChat(section, boxId){
    const box = document.getElementById(boxId);
    const arr = loadChat(section);
    box.innerHTML = arr.map(m=>`<div style="margin-bottom:6px"><b>${m.who}:</b> ${m.text}</div>`).join('');
    box.scrollTop = box.scrollHeight;
  }
  function setupChat(section, sendBtnId, inputId, boxId, resetBtnId){
    renderChat(section, boxId);
    document.getElementById(sendBtnId).addEventListener('click', ()=>{
      const me = currentUser(); if(!me) return alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
      const input = document.getElementById(inputId);
      const txt = input.value.trim(); if(!txt) return;
      const arr = loadChat(section);
      arr.push({who:`${me.username}`, text:txt, t:nowISO()});
      // Ø±Ø¯ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ø­Ù„ÙŠ
      arr.push({who:'AI', text:'(Ø±Ø¯ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ø­Ù„ÙŠ â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø®Ø§Ø±Ø¬ÙŠ)', t:nowISO()});
      saveChat(section, arr);
      input.value='';
      renderChat(section, boxId);
    });
    document.getElementById(resetBtnId).addEventListener('click', ()=>{
      if(confirm('Ù…Ø³Ø­ Ø±Ø³Ø§Ø¦Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ')){ saveChat(section, []); renderChat(section, boxId); }
    });
  }
  setupChat('dose', 'doseChatSend','doseChatInput','doseChat','resetDoseChat');
  setupChat('fluids','fluidChatSend','fluidChatInput','fluidChat','resetFluidChat');
  setupChat('airway','airwayChatSend','airwayChatInput','airwayChat','resetAirwayChat');

  /* ======= About Modal ======= */
  document.getElementById('aboutBtn').addEventListener('click', ()=> document.getElementById('aboutModal').style.display='flex');
  document.getElementById('closeAbout').addEventListener('click', ()=> document.getElementById('aboutModal').style.display='none');

  /* ======= Scanner (BarcodeDetector if available) ======= */
  const scanBtn = document.getElementById('scanBtn');
  let scanning = false, streamRef=null;
  scanBtn.addEventListener('click', async ()=>{
    if(scanning) return stopScan();
    const overlay = document.createElement('div');
    overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(0,0,0,0.6)'; overlay.style.zIndex=10030; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
    overlay.innerHTML = `<div style="width:90%;max-width:720px;background:var(--card);color:var(--text);padding:12px;border-radius:12px">
      <div style="display:flex;justify-content:space-between;align-items:center"><b>Ù…Ø§Ø³Ø­ ÙƒÙŠØ³ Ø§Ù„Ù…Ø±ÙŠØ¶</b><button id="closeCam" class="btn secondary">Ø¥ØºÙ„Ø§Ù‚</button></div>
      <video id="camVideo" autoplay playsinline style="width:100%;margin-top:8px;border-radius:8px;background:#000"></video>
      <div id="scanResult" style="margin-top:8px;color:var(--muted)">Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù…Ø²...</div>
    </div>`;
    document.body.appendChild(overlay);
    scanning = true;
    const video = overlay.querySelector('#camVideo');
    const resultEl = overlay.querySelector('#scanResult');
    overlay.querySelector('#closeCam').addEventListener('click', ()=> stopScan());
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
      streamRef = stream; video.srcObject = stream; await video.play();
      if(window.BarcodeDetector){
        const formats = await BarcodeDetector.getSupportedFormats();
        const detector = new BarcodeDetector({formats});
        const loop = async ()=>{
          if(!scanning) return;
          try{
            const detections = await detector.detect(video);
            resultEl.textContent = detections && detections.length ? ('ØªÙ… Ø§Ù„ÙƒØ´Ù: '+detections.map(d=>d.rawValue).join(' | ')) : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² â€” Ø­Ø±Ù‘Ùƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø¨Ø·Ø¡.';
          }catch(e){ resultEl.textContent = 'Ø®Ø·Ø£ Ø¨Ø§Ù„Ù…Ø³Ø­: ' + e.message; }
          setTimeout(loop, 800);
        };
        loop();
      } else {
        resultEl.textContent = 'BarcodeDetector ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ.';
      }
    } catch(err){ alert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err.message); stopScan(); }
    function stopScan(){ scanning=false; if(streamRef){ streamRef.getTracks().forEach(t=>t.stop()); streamRef=null; } overlay.remove(); }
  });

}); // DOMContentLoaded
</script>
</body>
</html> 
