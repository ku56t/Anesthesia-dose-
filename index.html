<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆÙ‘Ø± â€” Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg-dark:#071223; --bg-dark-2:#04293a; --card:#081e2a;
    --accent:#0a9bd6; --accent-2:#11cdef; --glass:rgba(255,255,255,0.03);
    --text:#e6f6ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Tahoma,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg-dark),var(--bg-dark-2));color:var(--text);min-height:100vh;overflow-x:hidden}
  header{padding:14px;text-align:center;font-weight:700;background:linear-gradient(90deg,#072a40,#0a5f86);box-shadow:0 8px 34px rgba(2,6,23,.6)}
  .container{max-width:1200px;margin:32px auto;padding:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
  .top-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#042a3a;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px}
  .panel{display:none;margin-top:14px}
  .result-box{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.18));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .muted{color:#bcdcec;font-size:13px}
  footer{margin-top:18px;text-align:center;color:#93c1d8;font-size:13px}

  /* bubbles */
  #bubbles{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
  .bubble{position:absolute;border-radius:50%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), rgba(255,255,255,0.02));filter:blur(18px);opacity:.6;mix-blend-mode:screen;animation:float linear infinite}
  @keyframes float{0%{transform:translateY(110vh) scale(.6);opacity:0}10%{opacity:.2}50%{opacity:.6}100%{transform:translateY(-20vh) scale(1.1);opacity:0}}

  /* responsive */
  @media (max-width:720px){ .top-actions{flex-direction:column;align-items:stretch} }

  /* mandatory login overlay */
  #app{position:relative;z-index:3}
  #authModal{display:flex;position:fixed;inset:0;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(2,8,16,0.7),rgba(2,8,16,0.9));z-index:9999}
  .authCard{background:linear-gradient(180deg,#072634,#042c3c);padding:20px;border-radius:12px;min-width:320px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .small{font-size:13px;color:#cfefff;opacity:.9}
  .ownerBadge{display:inline-block;background:linear-gradient(90deg,#ffd166,#ff8fa3);color:#042a3a;padding:6px 10px;border-radius:999px;font-weight:700;margin-left:8px}
  .admin-panel{display:flex;gap:12px;flex-direction:column}
  .table{width:100%;border-collapse:collapse}
  .table th, .table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:right}
  .chartWrap{max-width:900px;margin:12px 0}

body.light {
  background: #f5f7fa;
  color: #0a0a0a;
}
body.light header {background: #e8f0f5; color: #111;}
body.light .card {background: #fff; color: #000;}
body.light .btn.ghost {color:#222; border-color: #ccc;}
body.light .result-box {background: #f0f0f0; color:#111;}

  /* ===== Ø£Ø´Ø±Ø·Ø© Ù…ØªØ­Ø±ÙƒØ© Ù‡Ø±Ù…ÙŠØ© ===== */
.ticker {
  position: relative;
  overflow: hidden;
  width: 100%;
  background: linear-gradient(90deg,#0a5f86,#072a40);
  color: #e6f6ff;
  font-weight: bold;
  padding: 6px 0;
  text-align: center;
  z-index: 99999;
}
.ticker-content {
  display: inline-block;
  white-space: nowrap;
  opacity:1;
}
/* Ø­Ø±ÙƒØ§Øª: Ø§Ù„Ø«Ø§Ù†ÙŠ ÙŠØ®ØªÙÙŠ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ø«Ø§Ù„Ø«ØŒ Ø«Ù… Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ù…Ø§Ù„Ùƒ) */
.t2 .ticker-content {
  animation: moveRight 4s linear forwards;
  animation-delay: 0s;
}
.t3 .ticker-content {
  animation: moveUp 4s linear forwards;
  animation-delay: 1s;
}
.t1 .ticker-content {
  animation: moveLeft 4s linear forwards;
  animation-delay: 2s;
}
/* Keyframes */
@keyframes moveLeft {
  0%   { transform: translateX(100%); opacity:1; }
  100% { transform: translateX(-100%); opacity:0; }
}
@keyframes moveRight {
  0%   { transform: translateX(-100%); opacity:1; }
  100% { transform: translateX(100%); opacity:0; }
}
@keyframes moveUp {
  0%   { transform: translateY(0%); opacity:1; }
  100% { transform: translateY(-100%); opacity:0; }
}
</style>
</head>
<body>
<!-- Ø£Ø´Ø±Ø·Ø© Ù…ØªØ­Ø±ÙƒØ© Ù‡Ø±Ù…ÙŠØ© -->
<div class="ticker t1">
  <div class="ticker-content">Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§ - Ù…Ø·ÙˆØ± Ùˆ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ - @ku56t</div>
</div>
<div class="ticker t2">
  <div class="ticker-content">Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ± - Ù…Ù†Ø¸Ù… - @871c</div>
</div>
<div class="ticker t3">
  <div class="ticker-content">Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰ - Ù…Ù†Ø¸Ù… - ans_mz1092</div>
</div>
  


<!-- Bubbles -->
<div id="bubbles" aria-hidden="true"></div>

<header>
  <h1>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆÙ‘Ø±</h1>
  <div class="small">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± ÙˆØ§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆAirway â€” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨</div>
</header>

<div class="top-actions" style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
  <button class="btn" id="showDose">ğŸ’‰ Ø¬Ø±Ø¹Ø§Øª</button>
  <button class="btn" id="showFluids">ğŸ’§ Ø³ÙˆØ§Ø¦Ù„</button>
  <button class="btn" id="showAirway">ğŸ« Airway</button>
  <button class="btn" id="showAdmin">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</button>
  <!-- Ø²Ø± Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙØ¹ÙŠØ¯ Ù‡Ù†Ø§ -->
  <button class="btn ghost" id="showAbout">â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
  <button class="btn ghost" id="toggleTheme">ğŸŒ™ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
  <div style="flex:1"></div>
  <div id="userInfo" class="muted">â€”</div>
  <button class="btn ghost" id="btnLogout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

    <!-- Panels (full content included via JS or inline below) -->
    <section id="panelDose" class="panel">
      <h2>ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ±</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ <input id="patientNameDose"></label>
          <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº) <input id="weightDose" type="number"></label>
          <label>Ø§Ù„Ø¹Ù…Ø±
            <div style="display:flex;gap:8px">
              <input id="ageDose" type="number" style="flex:1">
              <select id="ageUnitDose" style="width:120px"><option value="years">Ø³Ù†ÙˆØ§Øª</option><option value="months">Ø£Ø´Ù‡Ø±</option><option value="days">Ø£ÙŠØ§Ù…</option></select>
            </div>
          </label>
          <label>ØªØµÙ†ÙŠÙ ASA <select id="asaSelect"><option value="I">ASA I</option><option value="II">ASA II</option><option value="III">ASA III</option><option value="IV">ASA IV</option><option value="V">ASA V</option></select></label>

          <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
            <select id="patientHealth"><option value="healthy">ØµØ­ÙŠ</option><option value="unhealthy">Ù…Ø±ÙŠØ¶</option></select>
          </label>

          <div id="diseaseDiv" style="display:none;margin-top:6px">
  <label>Ø§Ù„Ø£Ù…Ø±Ø§Ø¶:
    <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px">
      <label><input type="checkbox" class="diseaseChk" value="diabetes"> Ø³ÙƒØ±ÙŠ</label>
      <label><input type="checkbox" class="diseaseChk" value="heart"> Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨ÙŠØ©</label>
      <label><input type="checkbox" class="diseaseChk" value="lung"> Ø£Ù…Ø±Ø§Ø¶ Ø±Ø¦ÙˆÙŠØ©</label>
      <label><input type="checkbox" class="diseaseChk" value="liver"> Ø£Ù…Ø±Ø§Ø¶ ÙƒØ¨Ø¯ÙŠØ©</label>
      <label><input type="checkbox" class="diseaseChk" value="kidney"> Ø£Ù…Ø±Ø§Ø¶ ÙƒÙ„ÙˆÙŠØ©</label>
      <label><input type="checkbox" class="diseaseChk" value="allergy"> Ø­Ø³Ø§Ø³ÙŠØ©</label>
      <label><input type="checkbox" class="diseaseChk" value="obesity"> Ø³Ù…Ù†Ø© Ù…ÙØ±Ø·Ø©</label>
    </div>
  </label>
</div>

          <label>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡ <select id="drugDose"></select></label>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="calcDose">Ø§Ø­Ø³Ø¨</button>
            <button class="btn ghost" id="scanBagBtn">ğŸ“· Ù…Ø³Ø­ (Ù…Ø­Ø§ÙƒØ§Ø©)</button>
            <div style="flex:1"></div>
          </div>
          <div class="small muted" style="margin-top:8px">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ‚Ø±ÙŠØ¨ÙŠØ© â€” Ø±Ø§Ø¬Ø¹ Ø³Ø±ÙŠØ±ÙŠÙ‹Ø§ Ø¯Ø§Ø¦Ù…Ù‹Ø§.</div>
        </div>

        <div>
          <div id="doseResult" class="result-box"><b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</b></div>
          <div id="doseEffects" style="margin-top:12px"></div>
        </div>
      </div>
    </section>

    <section id="panelFluids" class="panel">
      <h2>ğŸ’§ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ <input id="patientNameFluid"></label>
          <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº) <input id="weightFluid" type="number"></label>
          <label>Ø§Ù„Ø¹Ù…Ø±
            <div style="display:flex;gap:8px">
              <input id="ageFluid" type="number" style="flex:1">
              <select id="ageUnitFluid" style="width:120px"><option value="years">Ø³Ù†ÙˆØ§Øª</option><option value="months">Ø£Ø´Ù‡Ø±</option></select>
            </div>
          </label>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¦Ù„ <select id="fluidType"><option value="NS">Normal Saline</option><option value="RL">Ringer Lactate</option><option value="D5W">D5W</option><option value="PRBC">PRBC</option></select></label>
          <div style="margin-top:8px"><button class="btn" id="calcFluids">Ø§Ø­Ø³Ø¨</button></div>
        </div>
        <div>
          <div id="fluidResult" class="result-box"><b>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</b></div>
        </div>
      </div>
    </section>

    <section id="panelAirway" class="panel">
      <h2>ğŸ« Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ Ùˆ ETT</h2>
      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ <input id="patientNameAirway"></label>
          <label>Ø§Ù„Ø¹Ù…Ø±
            <div style="display:flex;gap:8px">
              <input id="ageAirway" type="number" style="flex:1">
              <select id="ageUnitAirway" style="width:120px"><option value="years">Ø³Ù†ÙˆØ§Øª</option><option value="months">Ø£Ø´Ù‡Ø±</option></select>
            </div>
          </label>
          <label>Ø§Ù„ÙˆØ²Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) <input id="weightAirway" type="number"></label>
          <div style="margin-top:8px"><button class="btn" id="calcAirway">Ø­Ø³Ø§Ø¨</button></div>
        </div>
        <div><div id="airwayResult" class="result-box">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div></div>
      </div>
    </section>

    <section id="panelAdmin" class="panel">
      <h2>âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ <span id="ownerBadge" class="ownerBadge" style="display:none">Ù…Ø§Ù„Ùƒ</span></h2>

      <div id="adminMain" class="admin-panel">
        <div style="display:flex;gap:12px;align-items:center">
          <input id="searchHistory" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª" style="flex:1">
          <button class="btn ghost" id="btnSearchHistory">Ø¨Ø­Ø«</button>
          <button class="btn" id="btnExportCSV">ØªØµØ¯ÙŠØ± CSV</button>
        </div>

        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <div style="flex:1;min-width:220px" class="result-box">
            <h4>Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h4>
            <div id="statUsers">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: â€”</div>
            <div id="statRecords">Ø§Ù„Ø³Ø¬Ù„Ø§Øª: â€”</div>
            <canvas id="chartUsage" style="max-height:200px"></canvas>
          </div>

          <div style="flex:2;min-width:300px" class="result-box">
            <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
            <div style="margin-top:8px"><button class="btn ghost" id="btnRefreshUsers">ØªØ­Ø¯ÙŠØ«</button></div>
            <div id="usersList" style="margin-top:8px"></div>
          </div>
        </div>

        <div style="margin-top:12px" class="result-box">
          <h4>Ø§Ù„Ø³Ø¬Ù„Ø§Øª (History)</h4>
          <div id="historyList" style="max-height:300px;overflow:auto;margin-top:8px"></div>
        </div>
      </div>
    </section>


    

    fl<section id="panelAbout" class="panel">
  <h2>â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
  <div class="result-box">

    <p>Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ± â€” Ù…ÙˆÙ‚Ø¹ ØªØ¹Ù„ÙŠÙ…ÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± ÙˆØ§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØªÙˆØµÙŠØ§Øª airway.</p>

    <!-- âœ¨ Ø£Ø¶Ù Ø§Ù„ÙÙ‚Ø±Ø© Ù‡Ù†Ø§ âœ¨ -->
    <p>
      Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ± Ù‡Ùˆ Ù…ÙˆÙ‚Ø¹ Ø®Ø§Øµ Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø© ØªØ®Ø¯ÙŠØ± Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆÙ‚Ø¯ ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ÙÙƒØ±Ø©
      Ù…Ù† Ø·Ù„Ø¨Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø±Ø§Ø¨Ø¹Ø© Ù„Ù‚Ø³Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„ÙƒÙˆØª Ø³Ù†Ø© 2026ØŒ
      ÙˆØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨ÙŠÙ† Ø«Ù„Ø§Ø«Ø© Ø·Ù„Ø¨Ø© Ù‚Ø§Ù…ÙˆØ§ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹.
      ÙŠÙ…ÙƒÙ†ÙƒÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø­Ø±ÙŠØ© ÙˆÙ†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø­Ø¸Ø§Ù‹ Ø·ÙŠØ¨Ø§Ù‹.
    </p>

    <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ÙˆØªØ·ÙˆÙŠØ±Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø©: <strong>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</strong> (@ku56t) â€” Ù…Ø·ÙˆØ± ÙˆÙ…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.  
       Ù…Ù†Ø¸Ù‘Ù…ÙˆÙ†: <strong>Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ±</strong> (@871c) 
      Ùˆ <strong>Ù…Ø­Ù…Ø¯ Ø·Ø§Ù‡Ø± ÙŠØ­ÙŠÙ‰</strong> (@ans_mz1092).</p>

    <p>ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙÙ‚Ø·. Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ‚Ø±ÙŠØ¨ÙŠØ© â€” Ù„Ø§ ÙŠÙØ¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø³Ø±ÙŠØ±ÙŠÙ‹Ø§.</p>
  </div>
    </section>
<footer>Â© â€” Ø±Ø§Ø¬Ø¹ Ø¯ÙˆÙ…Ø§Ù‹ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ±ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙŠ Ø¬Ø±Ø¹Ø©</footer>
  </div>
</div>

<!-- Scanner modal (simple) -->
<div id="scannerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;align-items:center;justify-content:center">
  <div style="background:#021827;padding:12px;border-radius:12px;max-width:900px;width:90%;">
    <h3 style="margin:0 0 8px">ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ (Ù…Ø­Ø§ÙƒØ§Ø©)</h3>
    <video id="scannerVideo" autoplay style="width:100%;border-radius:8px;background:#000"></video>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="captureBtn" class="btn">Ø§Ù„ØªÙ‚Ø§Ø·</button>
      <button id="closeScanner" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="scanResult" style="margin-top:12px" class="result-box"></div>
  </div>
</div>

<!-- Auth Modal (mandatory) -->
<div id="authModal" class="" style="display:flex">
  <div class="authCard">
    <h2 style="margin:0 0 10px">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <div style="display:flex;flex-direction:column;gap:8px">
      
      ex-direction:column;gap:8px">
      <input id="loginEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" value="bama47686@gmail.com">
      <input id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value="mustafa@2006#2">
      <div style="display:flex;gap:8px">
        <button class="btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn ghost" id="createOwnerBtn" title="Ø§Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)">Ø¥Ù†Ø´Ø§Ø¡/ØªØ£ÙƒØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ</button>
      </div>
      <div class="small muted">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø³ÙŠÙƒÙˆÙ† Ù…ØªØ§Ø­Ù‹Ø§ Ù„Ù„Ø¹Ø±Ø¶ Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>
    </div>
  </div>
</div>

<!-- Firebase + App JS -->
<script type="module">
// ---------------- Firebase imports ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, updateDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// ---------------- Config (already provided) ----------------
const firebaseConfig = {
  apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
  authDomain: "anesthesia-dose-262e3.firebaseapp.com",
  projectId: "anesthesia-dose-262e3",
  storageBucket: "anesthesia-dose-262e3.appspot.com",
  messagingSenderId: "602244448093",
  appId: "1:602244448093:web:0a8d9905849126086ff2b4",
  measurementId: "G-SCHMQFCK3J"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------------- Constants ----------------
const OWNER_EMAIL = "bama47686@gmail.com";
const OWNER_PASS = "mustafa@2006#2"; // provided by you

// ---------------- UI Refs ----------------
const authModal = document.getElementById('authModal');
const loginBtn = document.getElementById('loginBtn');
const createOwnerBtn = document.getElementById('createOwnerBtn');
const btnLogout = document.getElementById('btnLogout');
const userInfo = document.getElementById('userInfo');
const ownerBadge = document.getElementById('ownerBadge');

// panels
const panels = { showDose:'panelDose', showFluids:'panelFluids', showAirway:'panelAirway', showAdmin:'panelAdmin' };
document.getElementById('showDose').addEventListener('click', ()=> showPanel('panelDose'));
document.getElementById('showFluids').addEventListener('click', ()=> showPanel('panelFluids'));
document.getElementById('showAirway').addEventListener('click', ()=> showPanel('panelAirway'));
document.getElementById('showAdmin').addEventListener('click', ()=> showPanel('panelAdmin'));
function showPanel(id){ Object.values(panels).forEach(pid=>document.getElementById(pid).style.display='none'); document.getElementById(id).style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }

// bubbles generator
const bubbles = document.getElementById('bubbles');
for(let i=0;i<30;i++){
  const b = document.createElement('div');
  b.className = 'bubble';
  b.style.width = b.style.height = (30 + Math.random()*120) + 'px';
  b.style.left = (Math.random()*100) + '%';
  b.style.bottom = (-10 - Math.random()*40) + 'vh';
  b.style.animationDuration = (18 + Math.random()*22) + 's';
  b.style.animationDelay = (-Math.random()*25) + 's';
  b.style.opacity = (0.08 + Math.random()*0.5);
  bubbles.appendChild(b);
}

// theme toggle
document.getElementById('toggleTheme').addEventListener('click', ()=> document.body.classList.toggle('light'));

// ---------------- Drug DB (extended) ----------------
const drugData = {
  "Propofol":{dose:{infant:[2.5,3.0],child:[2.0,2.5],adult:2.5},max:{value:300,unit:'mg'},unitPerKg:'mg/kg',side_effects:["Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù…","ØªÙˆÙ‚Ù ØªÙ†ÙÙ‘Ø³ Ù…Ø¤Ù‚Øª","Ø£Ù„Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ù‚Ù†"],management:["Ø³ÙˆØ§Ø¦Ù„ØŒ Vasopressors","Ø¯Ø¹Ù… Ø§Ù„ØªÙ†ÙÙ‘Ø³","Lidocaine Ù‚Ø¨Ù„ Ø§Ù„Ø­Ù‚Ù†"],reduce:"Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø±Ø¹Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù†Ø®ÙØ¶Ø©"},
  "Fentanyl":{dose:{infant:[1,2],child:[2,3],adult:2},max:{value:300,unit:'Âµg'},unitPerKg:'Âµg/kg',side_effects:["ØªØ«Ø¨ÙŠØ· ØªÙ†ÙØ³ÙŠ","ØªØ¨Ø§Ø·Ø¤ Ù†Ø¨Ø¶ Ø§Ù„Ù‚Ù„Ø¨"],management:["Ø¯Ø¹Ù… ØªÙ†ÙÙ‘Ø³ÙŠ","Naloxone Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©"],reduce:"Ù‚Ø³Ù… Ø§Ù„Ø¬Ø±Ø¹Ø©"},
  "Midazolam":{dose:{infant:[0.05,0.1],child:[0.05,0.2],adult:0.15},max:{value:10,unit:'mg'},unitPerKg:'mg/kg',side_effects:["ØªÙ‡Ø¯Ø¦Ø© Ù…ÙØ±Ø·Ø©","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"],management:["Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØªÙ†ÙØ³","Flumazenil Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©"],reduce:"Ù‚Ù„Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù†"},
  "Ketamine":{dose:{infant:[2,3],child:[4,5],adult:1.5},const drugData = {
  "Propofol":{dose:{infant:[2.5,3.0],child:[2.0,2.5],adult:2.5},max:{value:300,unit:'mg'},unitPerKg:'mg/kg',side_effects:["Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù…","ØªÙˆÙ‚Ù ØªÙ†ÙÙ‘Ø³ Ù…Ø¤Ù‚Øª","Ø£Ù„Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ù‚Ù†","Propofol infusion syndrome"],management:["Ø³ÙˆØ§Ø¦Ù„/Ø£Ùˆ Vasopressors","Ø¯Ø¹Ù… Ø§Ù„ØªÙ†ÙÙ‘Ø³ ÙˆØªÙ‡ÙˆÙŠØ©","Lidocaine Ù‚Ø¨Ù„ Ø§Ù„Ø­Ù‚Ù†","Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø±ÙŠØ¨ ÙˆØ¯Ø¹Ù… Ù‚Ù„Ø¨ÙŠ/ØªÙ†ÙØ³ÙŠ"],reduce:"Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø±Ø¹Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù†Ø®ÙØ¶Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… ØªØ³Ø±ÙŠØ¨ Ù…Ø³ØªÙ…Ø± Ø¨Ø·ÙŠØ¡ØŒ Ù‚Ù„Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆÙ…Ø±Ø¶Ù‰ Ø§Ù„Ù‚Ù„Ø¨."},
  "Fentanyl":{dose:{infant:[1,2],child:[2,3],adult:2},max:{value:300,unit:'Âµg'},unitPerKg:'Âµg/kg',side_effects:["ØªØ«Ø¨ÙŠØ· ØªÙ†ÙØ³ÙŠ","ØªØ¨Ø§Ø·Ø¤ Ù†Ø¨Ø¶ Ø§Ù„Ù‚Ù„Ø¨","ØºØ«ÙŠØ§Ù†/Ù‚ÙŠØ¡"],management:["Ø¯Ø¹Ù… ØªÙ†ÙÙ‘Ø³ØŒ Naloxone Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©","Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ù„Ø¨ÙŠØ©","Ø£Ø¯ÙˆÙŠØ© Ù…Ø¶Ø§Ø¯Ø© Ù„Ù„ØºØ«ÙŠØ§Ù†"],reduce:"Ø§Ø³ØªØ®Ø¯Ù… Ø¬Ø±Ø¹Ø§Øª Ù…Ù‚Ø³Ù…Ø© (titrate) ÙˆØ§Ø¨ØªØ¹Ø¯ Ø¹Ù† Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„ØªØ±ÙƒÙŠØ² ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆØ§Ù„Ù…ØµØ§Ø¨ÙŠÙ† Ø¨Ø£Ù…Ø±Ø§Ø¶ Ø±Ø¦ÙˆÙŠØ©."},
  "Midazolam":{dose:{infant:[0.05,0.1],child:[0.05,0.2],adult:0.15},max:{value:10,unit:'mg'},unitPerKg:'mg/kg',side_effects:["ØªÙ‡Ø¯Ø¦Ø© Ù…ÙØ±Ø·Ø©","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·","Ø±Ø¯ÙˆØ¯ Ø¹ÙƒØ³ÙŠØ© Ù†Ø§Ø¯Ø±Ø©"],management:["Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¹Ù†Ø§ÙŠØ© ØªÙ†ÙÙ‘Ø³ÙŠØ©","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø£Ùˆ Flumazenil (Ù…Ø¶Ø§Ø¯)"],reduce:"Ù‚Ù„Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆØ£ÙŠØ¶Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù†Ø®ÙØ§Ø¶ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙƒØ¨Ø¯."},
  "Ketamine":{dose:{infant:[2,3],child:[4,5],adult:1.5},max:{value:300,unit:'mg'},unitPerKg:'mg/kg',side_effects:["Ø²ÙŠØ§Ø¯Ø© Ø¶ØºØ· Ø§Ù„Ø¯Ù…","ØªÙŠØ¨Ù‘Ø³ Ø¹Ø¶Ù„ÙŠ","Ù‡Ù„ÙˆØ³Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙØ§Ù‚Ø©"],management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¶ØºØ· ÙˆÙ†Ø¨Ø¶","Midazolam ÙƒÙ…Ù‡Ø¯Ø¦ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©","Ø¨ÙŠØ¦Ø© Ù‡Ø§Ø¯Ø¦Ø© Ù„Ù„Ù…Ø±Ø¶Ù‰"],reduce:"Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ø±Ø¹Ø§Øª Ø£ØµØºØ± Ø¹Ù†Ø¯ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆØ®Ù„Ø·Ù‡Ø§ Ù…Ø¹ Ù…Ø³ÙƒÙ†Ø§Øª Ø£Ùˆ Ø¨Ù†Ø²ÙˆØ¯ÙŠØ§Ø²ÙŠØ¨ÙŠÙ† Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡Ù„ÙˆØ³Ø©."},
  "Lidocaine":{dose:{infant:[1,2],child:[2,3],adult:3},max:{value:300,unit:'mg'},unitPerKg:'mg/kg',side_effects:["ØªØ´Ù†Ø¬Ø§Øª","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"],management:["Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø±ÙŠØ¨ØŒ Benzodiazepine Ù„Ù„ØªØ´Ù†Ø¬Ø§Øª"],reduce:"Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ mg Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø¬Ø±Ø¹Ø§Øª Ù…ÙˆØ¶Ø¹ÙŠØ©/Ù…Ø±ÙƒØ²Ø© ÙˆØªØ®ÙÙŠØ¶ Ø¹Ù†Ø¯ Ø¶Ø¹Ù Ø§Ù„ÙƒØ¨Ø¯."},
  "Etomidate":{dose:{infant:[0.15,0.3],child:[0.2,0.3],adult:0.3},max:{value:40,unit:'mg'},unitPerKg:'mg/kg',side_effects:["Myoclonus","Ù‚Ù…Ø¹ Ù…Ø­ÙˆØ± Ø§Ù„ØºØ¯Ø¯ Ø§Ù„ÙƒØ¸Ø±ÙŠØ©"],management:["Benzodiazepine Ù„Ù„ØªÙ‚Ù„ÙŠÙ„","Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ØµÙŠØ± Ø§Ù„Ù…Ø¯Ù‰"],reduce:"Ù„Ø§ ÙŠÙØ¶Ù„ Ø§Ù„ØªØ³Ø±ÙŠØ¨ Ø§Ù„Ù…Ø³ØªÙ…Ø±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù‚Ù„ Ø¬Ø±Ø¹Ø© ÙØ¹Ù‘Ø§Ù„Ø©."},
  "Thiopental":{dose:{infant:[10,15],child:[10,12.5],adult:12.5},max:{value:400,unit:'mg'},unitPerKg:'mg/kg',side_effects:["ÙƒØ¨Øª ØªÙ†ÙØ³ÙŠ","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"],management:["ØªÙ‡ÙˆÙŠØ©/Ø£ÙƒØ³Ø¬ÙŠÙ†","Ø¯Ø¹Ù… Ø¶ØºØ· Ø§Ù„Ø¯Ù…"],reduce:"ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆÙ…Ø±Ø¶Ù‰ Ø§Ù„Ù‚Ù„Ø¨."},
  "Dexmedetomidine":{dose:{infant:[0.5,1.0],child:[1.0,2.0],adult:1.0},max:{value:200,unit:'Âµg'},unitPerKg:'Âµg/kg',side_effects:["Ø¨Ø·Ø¡ Ù‚Ù„Ø¨","Ù‡Ø¨ÙˆØ· Ø¶ØºØ·"],management:["Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ù„Ø¨ÙŠØ©","Ø¹Ù„Ø§Ø¬ Ø¯Ø§Ø¹Ù… Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©"],reduce:"Ø®ÙØ¶ Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªØºÙ†Ø§Ø¡ Ø¹Ù†Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø¶Ø¹ÙØ§Ø¡."},
  "Isoflurane":{dose:{infant:[1.3,1.6],child:[1.3,1.6],adult:1.45},max:{value:100,unit:'%MAC'},unitPerKg:'%MAC',side_effects:["Ù‡Ø¨ÙˆØ· Ø¶ØºØ·","ÙƒØ¨Øª ØªÙ†ÙÙ‘Ø³ÙŠ"],management:["ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ¯Ø¹Ù… ØªÙ†ÙÙ‘Ø³ÙŠ"],reduce:"Ø§Ø¨Ø¯Ø£ Ø¨MAC Ù…Ù†Ø®ÙØ¶ ÙÙŠ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† ÙˆÙ‚Ù„Ù„ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹."},
  "Succinylcholine":{dose:{infant:[1,2],child:[1,2],adult:1.5},max:{value:200,unit:'mg'},unitPerKg:'mg/kg',side_effects:["Hyperkalemia","Malignant Hyperthermia (Ù†Ø§Ø¯Ø±)"],management:["ØªÙ‡ÙˆÙŠØ© Ø§ØµØ·Ù†Ø§Ø¹ÙŠØ©","Dantrolene Ø¹Ù†Ø¯ MH"],reduce:"ØªØ¬Ù†Ù‘Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…Ø¹Ø±Ø¶ÙŠÙ† Ù„Ø®Ø·Ø± Hyperkalemia."},
  "Bupivacaine":{dose:{infant:[1,2],child:[2,2],adult:2},max:{value:200,unit:'mg'},unitPerKg:'mg/kg',side_effects:["Ø³Ù…ÙŠØ© Ù‚Ù„Ø¨ÙŠØ©","ØªØ´Ù†Ø¬Ø§Øª"],management:["Intralipid 20%ØŒ Ø¯Ø¹Ù… Ù‚Ù„Ø¨/ØªÙ†ÙØ³"],reduce:"Ø§Ø³ØªØ¹Ù…Ù„ Ø£Ù‚Ù„ ØªØ±ÙƒÙŠØ² ÙˆÙƒÙ…ÙŠØ© ÙƒØ§ÙÙŠØ© ÙˆØªØ¬Ù†Ù‘Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©."}
};ney: 0.75,
  allergy: 0.90,
  obesity: 1.05
};

function calculateTotalDose(drugName, weightKg, ageYears, asaClass, diseases){
  const doc = drugData[drugName]; if(!doc) return null;
  const cat = ageCategory(ageYears); const perKg = avgDose(doc.dose[cat]);
  let total = perKg * weightKg; total *= (asaFactors[asaClass]||1.0); diseases.forEach(d=>{ if(diseaseFactors[d]) total*=diseaseFactors[d]; });
  if(doc.max && typeof doc.max.value==='number' && total>doc.max.value) total=doc.max.value;
  return { value: total, unitPerKg: doc.unitPerKg || 'mg/kg', unitTotal: (doc.max && doc.max.unit) ? doc.max.unit : 'mg' };
}
function formatDose(calc){ if(!calc) return 'Ø®Ø·Ø£'; const v=parseFloat(calc.value); if(isNaN(v)) return 'Ø®Ø·Ø£'; const unit = calc.unitTotal||'mg'; return (unit==='Âµg'?Math.round(v): (v<10?v.toFixed(2):v.toFixed(1))) + ' ' + unit; }

// ---------------- Firestore helpers ----------------
async function saveHistory(entry){ try{ await addDoc(collection(db,'history'), {...entry, createdAt: serverTimestamp()}); }catch(e){ console.error('saveHistory',e); } }

// ---------------- Handlers: Dose/Fluids/Airway ----------------
document.getElementById('calcDose').addEventListener('click', async ()=>{
  const pname = document.getElementById('patientNameDose').value.trim();
  const weight = parseFloat(document.getElementById('weightDose').value);
  const ageVal = parseFloat(document.getElementById('ageDose').value);
  const ageUnit = document.getElementById('ageUnitDose').value;
  const asa = document.getElementById('asaSelect').value;
  const drug = drugSelect.value;
  if(!weight||!ageVal||!drug){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù†ØŒ Ø§Ù„Ø¹Ù…Ø± ÙˆØ§Ù„Ø¯ÙˆØ§Ø¡'); return; }
  const ageYears = toYears(ageVal,ageUnit);
  const diseases = []; document.querySelectorAll('.diseaseChk:checked').forEach(c=>diseases.push(c.value));
  const calc = calculateTotalDose(drug,weight,ageYears,asa,diseases);
  const display = formatDose(calc);
  document.getElementById('doseResult').innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap"><span class="result-box" style="padding:8px">${drug}</span><span class="result-box" style="padding:8px">ÙˆØ²Ù†: ${weight} ÙƒØº</span></div>
    <div style="margin-top:10px;font-weight:700;font-size:1.1rem;color:var(--accent)">Ø§Ù„Ø¬Ø±Ø¹Ø©: ${display}</div>
    <div class="muted" style="margin-top:6px">Ù…Ù„Ø§Ø­Ø¸Ø©: ${drugData[drug].reduce||'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø©'}</div>`;
  // side effects
  let effHTML=''; (drugData[drug].side_effects||[]).forEach((s,i)=> effHTML += `<div class="result-box" style="margin-top:8px"><b>Ø¹Ø±Ø¶ Ø¬Ø§Ù†Ø¨ÙŠ:</b> ${s}<div class="muted">${(drugData[drug].management||[])[i]||''}</div></div>`);
  document.getElementById('doseEffects').innerHTML = effHTML;
  // save history if logged in
  const u = auth.currentUser;
  if(u) await saveHistory({ type:'dose', patientName:pname||null, inputs:{weight,ageVal,ageUnit,asa,drug,diseases}, result:display, uid:u.uid, userEmail:u.email });
});

document.getElementById('calcFluids').addEventListener('click', async ()=>{
  const w = parseFloat(document.getElementById('weightFluid').value);
  const ftype = document.getElementById('fluidType').value;
  if(!w){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ²Ù†'); return; }
  const maintenance = (w*30)|0;
  document.getElementById('fluidResult').innerHTML = `<div><b>ØµÙŠØ§Ù†Ø© (24h):</b> ${maintenance} ml</div><div class="muted">Ù†ÙˆØ¹: ${ftype}</div>`;
  const u = auth.currentUser; if(u) await saveHistory({ type:'fluids', inputs:{weight:w,fluidType:ftype}, result:{maintenance}, uid:u.uid, userEmail:u.email });
});

document.getElementById('calcAirway').addEventListener('click', async ()=>{
  const ageVal = parseFloat(document.getElementById('ageAirway').value);
  const ageUnit = document.getElementById('ageUnitAirway').value;
  if(!ageVal){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø±'); return; }
  const ageYears = toYears(ageVal,ageUnit);
  let blade='Adult'; let ett='7.0 mm';
  if(ageYears<1){ blade='Blade 0-1 (Infant)'; ett='3.0 - 3.5 mm'; }
  else if(ageYears<5){ blade='Blade 1-2'; ett='4.0 - 4.5 mm'; }
  else if(ageYears<10){ blade='Blade 2'; ett='5.0 - 5.5 mm'; }
  document.getElementById('airwayResult').innerHTML = `<div><b>Ø´ÙØ±Ø©:</b> ${blade}</div><div><b>ETT:</b> ${ett}</div>`;
  const u=auth.currentUser; if(u) await saveHistory({ type:'airway', inputs:{ageVal,ageUnit}, result:{blade,ett}, uid:u.uid, userEmail:u.email });
});

// ---------------- Scanner (simple) ----------------
const scannerModal = document.getElementById('scannerModal');
const scannerVideo = document.getElementById('scannerVideo');
let streamRef=null;
document.getElementById('scanBagBtn').addEventListener('click', openScanner);
document.getElementById('closeScanner').addEventListener('click', ()=>{ stopScanner(); });
document.getElementById('captureBtn').addEventListener('click', ()=>{
  if(!scannerVideo) return;
  const c = document.createElement('canvas'); c.width = scannerVideo.videoWidth; c.height = scannerVideo.videoHeight; const ctx = c.getContext('2d'); ctx.drawImage(scannerVideo,0,0);
  const data = c.toDataURL();
  document.getElementById('scanResult').innerHTML = `<div><b>ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· (Ù…Ø­Ø§ÙƒØ§Ø©)</b></div><img src="${data}" style="width:160px;border-radius:6px;margin-top:8px">`;
});
async function openScanner(){
  try{ scannerModal.style.display='flex'; streamRef = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); scannerVideo.srcObject = streamRef; }
  catch(e){ alert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: '+e.message); scannerModal.style.display='none'; }
}
function stopScanner(){ scannerModal.style.display='none'; if(streamRef){ streamRef.getTracks().forEach(t=>t.stop()); streamRef=null; scannerVideo.srcObject=null; } }

// ---------------- Auth flow ----------------
loginBtn.addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if(!email||!pass){ alert('Ø§Ø¯Ø®Ù„ Ø§ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±'); return; }
  try{
    const cred = await signInWithEmailAndPassword(auth,email,pass);
    // hide modal (onAuthStateChanged will handle)
  }catch(err){
    // if not exists, ask to create
    if(err.code === 'auth/user-not-found'){
      const create = confirm('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â€” Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ');
      if(create){
        try{ await createUserWithEmailAndPassword(auth,email,pass); alert('ØªÙ… Ø§Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.'); }
        catch(e){ alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+e.message); }
      }
    } else alert('ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+(err.message||err));
  }
});

// create owner (one-click) - will only create if not exists
createOwnerBtn.addEventListener('click', async ()=>{
  try{
    const methods = await fetchSignInMethodsForEmail(auth, OWNER_EMAIL);
    if(methods && methods.length){ alert('Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§.'); return; }
    await createUserWithEmailAndPassword(auth, OWNER_EMAIL, OWNER_PASS);
    alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ. Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.');
  }catch(e){ alert('Ø®Ø·Ø£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„Ùƒ: '+(e.message||e)); }
});

// logout
btnLogout.addEventListener('click', async ()=>{ await signOut(auth); location.reload(); });

// onAuthStateChanged
onAuthStateChanged(auth, async (user)=> {
  if(user){
    authModal.style.display='none';
    document.getElementById('app').style.zIndex = 5;
    userInfo.textContent = user.email + (user.email===OWNER_EMAIL ? ' â€” Ù…Ø§Ù„Ùƒ' : '');
    // ensure user doc
    try{
      const uref = doc(db,'users',user.uid);
      const ud = await getDoc(uref);
      if(!ud.exists()){
        await setDoc(uref, { email:user.email, uid:user.uid, role: user.email===OWNER_EMAIL ? 'owner' : 'user', createdAt: serverTimestamp() });
      }
      const role = (await getDoc(uref)).data().role || (user.email===OWNER_EMAIL ? 'owner' : 'user');
      if(role==='owner'){ ownerBadge.style.display='inline-block'; document.getElementById('panelAdmin').style.display='block'; populateUsersList(); populateHistory(); loadStats(); } else ownerBadge.style.display='none';
      // default panel
      showPanel('panelDose');
    }catch(e){ console.error(e); }
  } else {
    // force show modal
    authModal.style.display='flex';
    document.getElementById('app').style.zIndex = 1;
  }
});

// ---------------- Owner: users & history & stats ----------------
async function populateUsersList(){
  const ul = document.getElementById('usersList');
  ul.innerHTML = '<div class="muted">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  try{
    const snaps = await getDocs(query(collection(db,'users'), orderBy('email','asc')));
    ul.innerHTML = '';
    snaps.forEach(s => {
      const d = s.data();
      const row = document.createElement('div');
      row.style.padding='8px';
      row.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
      row.innerHTML = `<div style="display:flex;gap:12px;justify-content:space-between;align-items:center">
        <div><strong>${d.email}</strong><div class="muted">UID: ${d.uid} â€” Role: ${d.role||'user'}</div></div>
        <div style="display:flex;gap:6px">
          <button class="btn ghost" onclick="setRoleUI('${d.uid}','user')">Ø§Ø¬Ø¹Ù„ Ù…Ø³ØªØ®Ø¯Ù…</button>
          <button class="btn ghost" onclick="setRoleUI('${d.uid}','owner')">Ø§Ø¬Ø¹Ù„ Ù…Ø§Ù„Ùƒ</button>
          <button class="btn ghost" onclick="deleteUserUI('${d.uid}')">Ø­Ø°Ù</button>
        </div>
      </div>`;
      ul.appendChild(row);
    });
  }catch(e){ ul.innerHTML = '<div class="muted">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>'; console.error(e); }
}
window.populateUsersList = populateUsersList;

async function setRoleUI(uid, role){
  try{ await setDoc(doc(db,'users',uid), { role }, { merge:true }); alert('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©'); populateUsersList(); }
  catch(e){ alert('Ø®Ø·Ø£'); }
}
window.setRoleUI = setRoleUI;

async function deleteUserUI(uid){
  if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
  try{ await setDoc(doc(db,'users',uid), { deleted:true }, { merge:true }); alert('ØªÙ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø­Ø°Ù (soft)'); populateUsersList(); }
  catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù'); }
}
window.deleteUserUI = deleteUserUI;

async function populateHistory(qStr=''){
  const container = document.getElementById('historyList');
  container.innerHTML = '<div class="muted">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  try{
    const snaps = await getDocs(query(collection(db,'history'), orderBy('createdAt','desc'), limit(300)));
    let list = snaps.docs.map(d=>({id:d.id, ...d.data()}));
    if(qStr && qStr.trim().length) list = list.filter(it => JSON.stringify(it).toLowerCase().includes(qStr.toLowerCase()));
    container.innerHTML = '';
    if(!list.length) container.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</div>';
    list.forEach(item=>{
      const el = document.createElement('div');
      el.style.padding='8px'; el.style.borderBottom='1px solid rgba(255,255,255,0.03)';
      el.innerHTML = `<div style="display:flex;gap:12px;justify-content:space-between">
        <div><strong>${(item.type||'â€”').toUpperCase()} â€” ${item.patientName||'â€”'}</strong>
          <div class="muted">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${item.userEmail||'â€”'} â€” ${item.createdAt ? new Date(item.createdAt.seconds*1000).toLocaleString() : ''}</div>
          <div class="muted">Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª: ${JSON.stringify(item.inputs)}</div>
        </div>
        <div style="text-align:left"><b>Ù†ØªÙŠØ¬Ø©:</b><div>${JSON.stringify(item.result)}</div></div>
      </div>`;
      container.appendChild(el);
    });
  }catch(e){ container.innerHTML = '<div class="muted">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>'; console.error(e); }
}

document.getElementById('btnSearchHistory').addEventListener('click', ()=> populateHistory(document.getElementById('searchHistory').value.trim()));
document.getElementById('btnRefreshUsers').addEventListener('click', populateUsersList);

// stats & chart
let usageChart = null;
async function loadStats(){
  try{
    const usersSnap = await getDocs(collection(db,'users'));
    const usersCount = usersSnap.size;
    document.getElementById('statUsers').textContent = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ' + usersCount;
    const snaps = await getDocs(query(collection(db,'history'), orderBy('createdAt','desc'), limit(500)));
    const list = snaps.docs.map(d=>d.data());
    document.getElementById('statRecords').textContent = 'Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ' + list.length;
    // top types
    const counts = {};
    list.forEach(it => { counts[it.type] = (counts[it.type]||0) + 1; });
    const labels = Object.keys(counts);
    const data = Object.values(counts);
    const ctx = document.getElementById('chartUsage').getContext('2d');
    if(usageChart) usageChart.destroy();
    usageChart = new Chart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data, backgroundColor:['#11cdef','#0a9bd6','#ffd166','#ff8fa3'] }] }, options:{plugins:{legend:{position:'bottom'}}} });
  }catch(e){ console.error('loadStats',e); }
}

// CSV export
document.getElementById('btnExportCSV').addEventListener('click', async ()=>{
  try{
    const snaps = await getDocs(query(collection(db,'history'), orderBy('createdAt','desc'), limit(10000)));
    const rows = snaps.docs.map(d=>{
      const it = d.data();
      return {
        id: d.id,
        type: it.type||'',
        patientName: it.patientName||'',
        userEmail: it.userEmail||'',
        inputs: JSON.stringify(it.inputs||''),
        result: JSON.stringify(it.result||''),
        createdAt: it.createdAt ? new Date(it.createdAt.seconds*1000).toISOString() : ''
      };
    });
    // build CSV
    const header = Object.keys(rows[0] || {id:'id',type:'type',patientName:'patientName',userEmail:'userEmail',inputs:'inputs',result:'result',createdAt:'createdAt'});
    const csv = [header.join(',')].concat(rows.map(r=>header.map(h=>`"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'history_export.csv'; a.click(); URL.revokeObjectURL(url);
  }catch(e){ alert('ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±: '+(e.message||e)); }
});

// ---------------- Ensure owner exists (optional, safe) ----------------
async function ensureOwner(){
  try{
    const methods = await fetchSignInMethodsForEmail(auth, OWNER_EMAIL);
    if(!methods || !methods.length){
      // create owner account
      await createUserWithEmailAndPassword(auth, OWNER_EMAIL, OWNER_PASS);
      alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ. Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
    } else {
      alert('Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
    }
  }catch(e){ console.warn('ensureOwner', e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„Ùƒ: '+(e.message||e)); }
}
// tied to button already

// ---------------- on load: default ----------------
showPanel('panelDose');
console.log('App initialized (bubbles + admin + firebase).');

</script>
</body>
  
