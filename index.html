<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>نظام حساب جرعات التخدير</title>
<style>
  body{font-family:Arial, sans-serif;direction:rtl;background:#f0f2f5;margin:0;padding:20px}
  .wrap{max-width:900px;margin:0 auto}
  h1{color:#0a5275}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:8px;border:none;background:#007bff;color:#fff;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .panel{background:#fff;padding:18px;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.06);margin-top:16px}
  label{display:block;text-align:right;margin:6px 0}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #cfcfcf;margin-top:6px}
  .sideEffect{background:#fff6f6;border-left:4px solid #ff6b6b;padding:10px;margin:8px 0;border-radius:6px;text-align:right}
  .chatBox{height:200px;overflow:auto;padding:10px;background:#eef2f7;border-radius:8px}
  .muted{color:#666;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>🚑 نظام حساب جرعات التخدير - متكامل</h1>

  <!-- أزرار التنقل -->
  <div class="row">
    <button class="btn" id="showDose">حساب الجرعات</button>
    <button class="btn" id="showFluids">حساب السوائل والدم</button>
    <button class="btn" id="showAirway">الارنغوسكوب و ETT</button>
    <button class="btn" id="showAdmin">لوحة التحكم</button>
  </div>

  <!-- قسم الجرعات -->
  <div class="panel" id="panelDose" style="display:none">
    <h2>💉 حساب جرعات التخدير</h2>
    <div class="grid">
      <div>
        <label>وزن المريض (كغ)
          <input id="weightDose" type="number" min="0" step="0.1" placeholder="مثلاً: 70">
        </label>
        <label>عمر المريض
          <div style="display:flex;gap:8px">
            <input id="ageDose" type="number" min="0" step="1" placeholder="ضع قيمة العمر">
            <select id="ageUnitDose" style="width:150px">
              <option value="years">سنوات</option>
              <option value="months">أشهر</option>
              <option value="days">أيام</option>
            </select>
          </div>
        </label>
        <label>اختر الدواء
          <select id="drugDose"></select>
        </label>
        <button class="btn" id="calcDose">احسب الجرعة</button>
      </div>

      <div>
        <div id="doseResult" class="muted">النتيجة ستظهر هنا</div>
        <div id="doseEffects" style="margin-top:12px"></div>
      </div>
    </div>

    <hr style="margin:12px 0">

    <h3>💬 شات القسم</h3>
    <div class="chatBox" id="doseChat"></div>
    <textarea id="doseChatInput" placeholder="اكتب سؤالك هنا..." style="margin-top:8px"></textarea>
    <div style="margin-top:8px">
      <button class="btn" id="doseChatSend">أرسل</button>
    </div>
  </div>

  <!-- قسم السوائل -->
  <div class="panel" id="panelFluids" style="display:none">
    <h2>💧 حساب السوائل والدم</h2>
    <div class="grid">
      <div>
        <label>وزن المريض (كغ)
          <input id="weightFluids" type="number" min="0" step="0.1">
        </label>
        <label>عمر المريض
          <div style="display:flex;gap:8px">
            <input id="ageFluids" type="number" min="0" step="1">
            <select id="ageUnitFluids" style="width:150px">
              <option value="years">سنوات</option>
              <option value="months">أشهر</option>
              <option value="days">أيام</option>
            </select>
          </div>
        </label>
        <button class="btn" id="calcFluids">احسب السوائل/الدم</button>
      </div>

      <div>
        <div id="fluidsResult" class="muted">النتيجة ستظهر هنا</div>
      </div>
    </div>

    <hr style="margin:12px 0">
    <h3>💬 شات القسم</h3>
    <div class="chatBox" id="fluidsChat"></div>
    <textarea id="fluidsChatInput" placeholder="اكتب سؤالك هنا..." style="margin-top:8px"></textarea>
    <div style="margin-top:8px">
      <button class="btn" id="fluidsChatSend">أرسل</button>
    </div>
  </div>

  <!-- قسم اللارنغوسكوب/ETT -->
  <div class="panel" id="panelAirway" style="display:none">
    <h2>😷 اللارنغوسكوب و ETT</h2>
    <div class="grid">
      <div>
        <label>عمر المريض
          <div style="display:flex;gap:8px">
            <input id="ageAirway" type="number" min="0" step="1">
            <select id="ageUnitAirway" style="width:150px">
              <option value="years">سنوات</option>
              <option value="months">أشهر</option>
              <option value="days">أيام</option>
            </select>
          </div>
        </label>
        <label>وزن المريض (اختياري)
          <input id="weightAirway" type="number" step="0.1">
        </label>
        <button class="btn" id="calcAirway">حساب الحجم</button>
      </div>

      <div>
        <div id="airwayResult" class="muted">النتيجة ستظهر هنا</div>
      </div>
    </div>

    <hr style="margin:12px 0">
    <h3>💬 شات القسم</h3>
    <div class="chatBox" id="airwayChat"></div>
    <textarea id="airwayChatInput" placeholder="اكتب سؤالك هنا..." style="margin-top:8px"></textarea>
    <div style="margin-top:8px">
      <button class="btn" id="airwayChatSend">أرسل</button>
    </div>
  </div>

  <!-- لوحة التحكم البسيطة -->
  <div class="panel" id="panelAdmin" style="display:none">
    <h2>🔧 لوحة التحكم (مالك)</h2>
    <label>كلمة مرور المالك
      <input id="adminPass" type="password">
    </label>
    <div style="margin-top:8px">
      <button class="btn" id="adminLogin">دخول</button>
    </div>

    <div id="adminArea" style="display:none;margin-top:12px">
      <h3>تعديل قاعدة الأعراض مؤقتاً</h3>
      <p class="muted">صيغة كل سطر: drug, dosePerKg, side, treatment</p>
      <textarea id="adminEdit" rows="6" placeholder="مثال: propofol,2,دوخة,رفع القدم"></textarea>
      <div style="margin-top:8px">
        <button class="btn" id="adminSave">حفظ التعديلات</button>
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { sideEffectsData } from './sideEffects.js';

  // ---------- عناصر التحكم المرئية ----------
  const panels = {
    dose: document.getElementById('panelDose'),
    fluids: document.getElementById('panelFluids'),
    airway: document.getElementById('panelAirway'),
    admin: document.getElementById('panelAdmin')
  };

  function hideAll() {
    Object.values(panels).forEach(p => p.style.display = 'none');
  }

  document.getElementById('showDose').addEventListener('click', ()=> {
    hideAll(); panels.dose.style.display='block';
  });
  document.getElementById('showFluids').addEventListener('click', ()=> {
    hideAll(); panels.fluids.style.display='block';
  });
  document.getElementById('showAirway').addEventListener('click', ()=> {
    hideAll(); panels.airway.style.display='block';
  });
  document.getElementById('showAdmin').addEventListener('click', ()=> {
    hideAll(); panels.admin.style.display='block';
  });

  // ---------- تهيئة قائمة الأدوية من sideEffectsData ----------
  const drugSelect = document.getElementById('drugDose');
  function populateDrugs(){
    drugSelect.innerHTML = '';
    const keys = Object.keys(sideEffectsData);
    if(keys.length === 0){
      const opt = document.createElement('option'); opt.value=''; opt.textContent='لا توجد أدوية في القاعدة'; drugSelect.appendChild(opt);
    } else {
      keys.forEach(k=>{
        const opt = document.createElement('option'); opt.value = k; opt.textContent = k; drugSelect.appendChild(opt);
      });
    }
  }
  populateDrugs();

  // تحويل العمر الى سنوات (float)
  function ageToYears(value, unit){
    const v = parseFloat(value);
    if(isNaN(v) || v < 0) return NaN;
    if(unit === 'years') return v;
    if(unit === 'months') return v / 12;
    if(unit === 'days') return v / 365;
    return NaN;
  }

  // ---------- حساب الجرعة واظهار الأعراض من sideEffectsData ----------
  document.getElementById('calcDose').addEventListener('click', ()=>{
    const w = parseFloat(document.getElementById('weightDose').value);
    const ageVal = document.getElementById('ageDose').value;
    const ageUnit = document.getElementById('ageUnitDose').value;
    const drug = drugSelect.value;

    const resDiv = document.getElementById('doseResult');
    const effectsDiv = document.getElementById('doseEffects');
    resDiv.innerHTML = ''; effectsDiv.innerHTML = '';

    if(!drug){
      alert('اختر دواءً من القائمة');
      return;
    }
    if(isNaN(w) || w <= 0){
      alert('أدخل وزن صحيح (كغ)');
      return;
    }
    const ageYears = ageToYears(ageVal, ageUnit);
    if(isNaN(ageYears)){
      alert('أدخل عمر صحيح');
      return;
    }

    // نحسب الجرعة لكل مدخل في sideEffectsData[drug]
    const list = sideEffectsData[drug];
    if(!list || list.length === 0){
      resDiv.textContent = 'لا توجد بيانات لهذا الدواء في القاعدة';
      return;
    }

    // نعرض ملخص: (نحسب استخدام dosePerKg الأكثر شيوعًا داخل المدخلات كجرعة مرجعية)
    // بعض القواعد قد تحوي مدخلات متعددة لها نفس dosePerKg (أعراض مختلفة)
    const referenceDose = list[0].dosePerKg;
    const totalDose = w * Number(referenceDose); // ملغ أو وحدة حسب القاعدة
    resDiv.innerHTML = `<strong>الجرعة المرجعية (${referenceDose} ملغ/كغ):</strong> ${totalDose.toFixed(2)} ملغ`;

    // عرض الأعراض والعلاج؛ نتجنب التكرار
    const shown = new Set();
    list.forEach(item=>{
      const dpkg = Number(item.dosePerKg);
      if(isNaN(dpkg)){
        // تجاهل أو إعلام
        effectsDiv.innerHTML += `<div class="sideEffect">⚠ خطأ بجرعة لكل كغ للعرض: ${item.side}</div>`;
        return;
      }
      const doseForThis = (w * dpkg).toFixed(2);
      const key = `${item.side}||${item.treatment}||${doseForThis}`;
      if(shown.has(key)) return;
      shown.add(key);
      effectsDiv.innerHTML += `<div class="sideEffect">
        <div><strong>جرعة مرتبطة:</strong> ${doseForThis} ملغ</div>
        <div><strong>العرض:</strong> ${item.side}</div>
        <div><strong>العلاج المقترح:</strong> ${item.treatment}</div>
      </div>`;
    });
  });

  // ---------- حساب السوائل والدم ----------
  document.getElementById('calcFluids').addEventListener('click', ()=>{
    const w = parseFloat(document.getElementById('weightFluids').value);
    const ageVal = document.getElementById('ageFluids').value;
    const ageUnit = document.getElementById('ageUnitFluids').value;
    const out = document.getElementById('fluidsResult'); out.innerHTML='';

    if(isNaN(w) || w <= 0){ alert('أدخل وزن صحيح'); return; }
    const ageYears = ageToYears(ageVal, ageUnit);
    if(isNaN(ageYears)){ alert('أدخل عمر صحيح'); return; }

    // نهج حساب نموذجي (تعليمات عامة، عدل حسب بروتوكولاتكم)
    // سوائل أساسية بالمل/اليوم تقريباً = 30 مل لكل كغ
    const maintenance = (w * 30).toFixed(0);
    // إجمالي الدم التقريبي باللتر = وزن * 70 مل / 1000
    const bloodLiters = ((w * 70) / 1000).toFixed(2);

    out.innerHTML = `<div><strong>كمية السوائل المبدئية:</strong> ${maintenance} مل/اليوم</div>
                     <div><strong>حجم الدم التقريبي:</strong> ${bloodLiters} لتر</div>`;
  });

  // ---------- حساب اللارنغوسكوب و ETT ----------
  document.getElementById('calcAirway').addEventListener('click', ()=>{
    const ageVal = document.getElementById('ageAirway').value;
    const ageUnit = document.getElementById('ageUnitAirway').value;
    const w = parseFloat(document.getElementById('weightAirway').value);
    const out = document.getElementById('airwayResult'); out.innerHTML='';

    const ageYears = ageToYears(ageVal, ageUnit);
    if(isNaN(ageYears)){ alert('أدخل عمر صحيح'); return; }

    // قواعد تقريبية شائعة (غير ملزمة، راجع الدليل السريري)
    let bladeSize = '', ettSize = '';
    if(ageYears < 1){
      bladeSize = 'حجم 0';
      ettSize = '3.0 - 3.5 mm (حسب الوزن)';
    } else if(ageYears < 2){
      bladeSize = 'حجم 1';
      ettSize = '3.5 - 4.0 mm';
    } else if(ageYears < 5){
      bladeSize = 'حجم 2';
      ettSize = '4.0 - 4.5 mm';
    } else if(ageYears < 12){
      bladeSize = 'حجم 3';
      ettSize = '4.5 - 5.5 mm';
    } else {
      bladeSize = 'حجم 4 (بالغين)';
      // معادلة ETT تقريبية: (العمر/4) + 4
      ettSize = `${Math.floor((ageYears / 4) + 4)} mm (حجم داخلي تقريبي)`;
    }

    // لو الوزن موجود نعطي تقدير حسبه أيضاً
    if(!isNaN(w) && w > 0){
      out.innerHTML = `<div><strong>شفرة اللارنغو:</strong> ${bladeSize}</div>
                       <div><strong>ETT مقترح:</strong> ${ettSize}</div>
                       <div class="muted">ملاحظة: استخدم تقديرات الوزن للعناية الأطفال والرضع وراجع سياسات المستشفى.</div>`;
    } else {
      out.innerHTML = `<div><strong>شفرة اللارنغو:</strong> ${bladeSize}</div>
                       <div><strong>ETT مقترح:</strong> ${ettSize}</div>`;
    }
  });

  // ---------- شاتات بسيطة لكل قسم (محاكاة، يمكنك ربط backend لاحقاً) ----------
  function appendChat(boxId, role, text){
    const box = document.getElementById(boxId);
    const p = document.createElement('div');
    p.style.margin = '6px 0';
    p.innerHTML = `<strong>${role}:</strong> ${text}`;
    box.appendChild(p);
    box.scrollTop = box.scrollHeight;
  }

  // dose chat
  document.getElementById('doseChatSend').addEventListener('click', ()=>{
    const input = document.getElementById('doseChatInput');
    const text = input.value.trim(); if(!text) return;
    appendChat('doseChat','أنت',text);
    // محاكاة رد سريع
    appendChat('doseChat','AI','رد افتراضي: يرجى مراجعة السجل الطبي وإدخال التفاصيل (هذه محاكاة).');
    input.value='';
  });

  // fluids chat
  document.getElementById('fluidsChatSend').addEventListener('click', ()=>{
    const input = document.getElementById('fluidsChatInput');
    const text = input.value.trim(); if(!text) return;
    appendChat('fluidsChat','أنت',text);
    appendChat('fluidsChat','AI','رد افتراضي: تحقق من توازن السوائل والعلامات الحيوية.');
    input.value='';
  });

  // airway chat
  document.getElementById('airwayChatSend').addEventListener('click', ()=>{
    const input = document.getElementById('airwayChatInput');
    const text = input.value.trim(); if(!text) return;
    appendChat('airwayChat','أنت',text);
    appendChat('airwayChat','AI','رد افتراضي: تأكد من تحضير عدة تهوية مناسبة للأطفال والبالغين.');
    input.value='';
  });

  // ---------- لوحة التحكم: تعديل القاعدة مؤقتاً ----------
  document.getElementById('adminLogin').addEventListener('click', ()=>{
    const pass = document.getElementById('adminPass').value;
    if(pass === 'mustafa@2006#2'){
      document.getElementById('adminArea').style.display = 'block';
      alert('تم الدخول للوحة التحكم');
    } else alert('كلمة مرور خاطئة');
  });

  document.getElementById('adminSave').addEventListener('click', ()=>{
    const txt = document.getElementById('adminEdit').value.trim();
    if(!txt){ alert('أدخل بيانات'); return; }
    // صيغة كل سطر: drug, dosePerKg, side, treatment
    const lines = txt.split('\n');
    lines.forEach(line=>{
      const parts = line.split(',').map(s=>s.trim());
      if(parts.length < 4) return;
      const drug = parts[0];
      const dosePerKg = Number(parts[1]);
      const side = parts[2];
      const treatment = parts[3];
      if(!sideEffectsData[drug]) sideEffectsData[drug] = [];
      sideEffectsData[drug].push({ dosePerKg, side, treatment });
    });
    populateDrugs();
    alert('تم تحديث القاعدة محلياً');
  });

  // ---------- تهيئة العرض الابتدائي ----------
  hideAll();
  panels.dose.style.display = 'block';

</script>
</body>
</html>
