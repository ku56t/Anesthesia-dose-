<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</title>
    <meta name="description" content="ØªØ·Ø¨ÙŠÙ‚ Ù…ØªÙ‚Ø¯Ù… Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ± ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù… Ù…Ø¹ Firebase authentication">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&family=Noto+Sans+Arabic:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, updateDoc, deleteDoc, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration - Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹ Firebase Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
            authDomain: "anesthesia-dose-262e3.firebaseapp.com",
            projectId: "anesthesia-dose-262e3",
            storageBucket: "anesthesia-dose-262e3.firebasestorage.app",
            messagingSenderId: "602244448093",
            appId: "1:602244448093:web:0a8d9905849126086ff2b4",
            measurementId: "G-SCHMQFCK3J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.googleProvider = new GoogleAuthProvider();
        window.firebaseAuthFunctions = {
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithPopup,
            signInWithRedirect,
            getRedirectResult,
            GoogleAuthProvider
        };
        window.firebaseDbFunctions = {
            doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, updateDoc, deleteDoc, orderBy
        };
    </script>
    
    <style>
        /* === CSS VARIABLES & BASE STYLES === */
        :root {
            --bg-dark: #071223;
            --bg-dark-2: #0b3045;
            --card: #0f2333;
            --accent: #0a9bd6;
            --accent-2: #11cdef;
            --glass: rgba(255,255,255,0.04);
            --success: #16a34a;
            --danger: #ff5252;
            --warning: #f59e0b;
            --text: #e6f6ff;
            --text-muted: #93c1d8;
            --border: rgba(255,255,255,0.06);
            --radius: 12px;
            --font-sans: 'Cairo', 'Noto Sans Arabic', Tahoma, Arial, sans-serif;
        }

        /* Light Theme */
        body.light {
            --bg-dark: #f5f8fb;
            --bg-dark-2: #ffffff;
            --card: #ffffff;
            --text: #052036;
            --text-muted: #475569;
            --border: #e6eef6;
            --glass: rgba(0,0,0,0.02);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: var(--font-sans);
            background: linear-gradient(180deg, var(--bg-dark), var(--bg-dark-2));
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.35s, color 0.35s;
            direction: rtl;
        }

        /* === SPLASH SCREEN === */
        #splash {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 14px;
            background: linear-gradient(135deg, #071024 0%, #06293a 70%);
            overflow: hidden;
        }

        .splash-top {
            width: 92%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: stretch;
            transform-origin: center;
        }

        .splash-bar {
            background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            padding: 18px;
            border-radius: 12px;
            color: #eaf6ff;
            display: flex;
            flex-direction: column;
            gap: 6px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        .splash-bar .role {
            opacity: .9;
            font-size: 13px;
            color: #cfefff;
        }

        .splash-bar.dev { animation: barOutDev 5s cubic-bezier(.2,.9,.3,1) forwards; }
        .splash-bar.mid { animation: barOutMid 5s cubic-bezier(.2,.9,.3,1) forwards; }
        .splash-bar.top { animation: barOutTop 5s cubic-bezier(.2,.9,.3,1) forwards; }

        @keyframes barOutTop { 0%{transform:translateX(0);opacity:1} 60%{opacity:1} 100%{transform:translateX(-150%);opacity:0} }
        @keyframes barOutMid { 0%{transform:translateX(0);opacity:1} 60%{opacity:1} 100%{transform:translateY(-120%);opacity:0} }
        @keyframes barOutDev { 0%{transform:translateX(0);opacity:1} 60%{opacity:1} 100%{transform:translateX(150%);opacity:0} }

        .splash-note { color: #cfefff; opacity: .95; }

        /* === DECORATIONS === */
        .decoration {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 5;
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.08), rgba(255,255,255,0.01));
            filter: blur(8px);
            opacity: .5;
            animation: float 9s ease-in-out infinite;
        }

        @keyframes float { 0%{transform:translateY(0)} 50%{transform:translateY(-50px)} 100%{transform:translateY(0)} }

        .glow {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            opacity: .7;
        }

        /* === LOGIN SCREEN === */
        #login-screen {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #071024 0%, #06293a 70%);
        }

        .login-container {
            background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .login-title {
            text-align: center;
            color: #eaf6ff;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-input {
            width: 100%;
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #eaf6ff;
            font-family: var(--font-sans);
            font-size: 16px;
            direction: rtl;
        }

        .login-input::placeholder {
            color: rgba(234, 246, 255, 0.7);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(10, 155, 214, 0.3);
        }

        .login-btn {
            padding: 15px 30px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            color: var(--bg-dark);
            cursor: pointer;
            font-weight: 700;
            font-family: var(--font-sans);
            font-size: 16px;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(10, 155, 214, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            color: var(--danger);
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-line;
            padding: 10px;
            background: rgba(255, 82, 82, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 82, 82, 0.3);
        }

        .login-toggle {
            text-align: center;
            margin-top: 20px;
            color: rgba(234, 246, 255, 0.8);
            font-size: 14px;
        }

        .login-toggle button {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
            font-family: var(--font-sans);
        }

        /* === MAIN APPLICATION === */
        .app-container {
            position: relative;
            z-index: 10;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: none;
        }

        .main-card {
            background: linear-gradient(180deg, var(--glass), rgba(255,255,255,0.01));
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* === HEADER === */
        .header {
            padding: 16px 24px;
            text-align: center;
            font-weight: 700;
            background: linear-gradient(90deg, #072a40, #0a5f86);
            color: white;
            box-shadow: 0 6px 20px rgba(2,6,23,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.3rem;
            flex: 1;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .logout-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 12px;
        }

        /* === NAVIGATION === */
        .nav-container {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        /* === BUTTONS === */
        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            color: var(--bg-dark);
            cursor: pointer;
            font-weight: 700;
            min-width: 160px;
            font-family: var(--font-sans);
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(10, 155, 214, 0.3);
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn.ghost:hover {
            background: var(--glass);
            border-color: var(--accent);
        }

        .btn.active {
            opacity: 1;
            background: linear-gradient(90deg, var(--accent-2), var(--accent));
        }

        .btn.inactive {
            opacity: 0.7;
        }

        .btn.danger {
            background: linear-gradient(90deg, var(--danger), #ff7676);
        }

        /* === PANELS === */
        .panel {
            padding: 24px;
            display: none;
        }

        .panel.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        .panel-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 24px;
            text-align: right;
        }

        /* === FORMS === */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        @media (min-width: 1024px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--glass);
            color: var(--text);
            font-family: var(--font-sans);
            font-size: 14px;
            transition: all 0.3s;
            direction: rtl;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(10, 155, 214, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        /* === RESULTS === */
        .result-box {
            background: linear-gradient(180deg, rgba(0,0,0,0.3), rgba(0,0,0,0.2));
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            min-height: 120px;
        }

        .result-box.success {
            border-color: var(--success);
            background: linear-gradient(180deg, rgba(22,163,74,0.1), rgba(22,163,74,0.05));
        }

        .result-box.warning {
            border-color: var(--warning);
            background: linear-gradient(180deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));
        }

        .result-box.error {
            border-color: var(--danger);
            background: linear-gradient(180deg, rgba(255,82,82,0.1), rgba(255,82,82,0.05));
        }

        .result-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }

        .result-unit {
            font-size: 1rem;
            margin-right: 8px;
            color: var(--text-muted);
        }

        .result-details {
            margin-top: 12px;
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* === USER MANAGEMENT TABLE === */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--glass);
            border-radius: 12px;
            overflow: hidden;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .users-table th {
            background: var(--accent);
            color: white;
            font-weight: 600;
        }

        .users-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .user-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(22,163,74,0.2);
            color: var(--success);
        }

        .status-blocked {
            background: rgba(255,82,82,0.2);
            color: var(--danger);
        }

        .status-owner {
            background: rgba(245,158,11,0.2);
            color: var(--warning);
        }

        /* Chat and additional styles */
        .chatBox {
            height: 140px;
            overflow: auto;
            padding: 10px;
            background: rgba(255,255,255,0.012);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .sideEffect {
            background: rgba(255,60,60,0.06);
            border-left: 4px solid rgba(255,80,80,0.9);
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
        }

        .pill {
            display: inline-block;
            padding: 6px 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 999px;
            margin: 6px 6px 0 0;
            color: #dff6ff;
        }

        /* === ANIMATIONS === */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === UTILITIES === */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--text-muted); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .flex-1 { flex: 1; }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                min-width: 0;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .users-table {
                font-size: 12px;
            }
            
            .users-table th,
            .users-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- FIREBASE INSTRUCTIONS MODAL -->
    <div id="firebase-modal" class="hidden" style="position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #eaf6ff;">ğŸ”§ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¥Ø¹Ø¯Ø§Ø¯ Google Authentication</h3>
                <button onclick="hideFirebaseInstructions()" style="background: none; border: none; color: #eaf6ff; font-size: 20px; cursor: pointer;">âœ•</button>
            </div>
            
            <div style="color: #eaf6ff; line-height: 1.6; font-size: 14px;">
                <p><strong>Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ GoogleØŒ Ø§ØªØ¨Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ§Øª:</strong></p>
                
                <ol style="text-align: right; margin-right: 20px;">
                    <li><strong>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Firebase Console:</strong><br>
                        <a href="https://console.firebase.google.com/" target="_blank" style="color: #11cdef;">https://console.firebase.google.com/</a>
                    </li>
                    
                    <li><strong>Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹ "anesthesia-dose-262e3"</strong></li>
                    
                    <li><strong>ÙØ¹Ù‘Ù„ Google Authentication:</strong><br>
                        â€¢ Authentication â†’ Sign-in method<br>
                        â€¢ ÙØ¹Ù‘Ù„ "Google" ÙˆØ§Ø¶ØºØ· Save
                    </li>
                    
                    <li><strong>Ø£Ø¶Ù Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙØµØ±Ø­ Ø¨Ù‡Ø§:</strong><br>
                        â€¢ Authentication â†’ Settings â†’ Authorized domains<br>
                        â€¢ Ø£Ø¶Ù Ù†Ø·Ø§Ù‚ Ù…ÙˆÙ‚Ø¹Ùƒ (Ù…Ø«Ø§Ù„: yoursite.com)
                    </li>
                    
                    <li><strong>ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OAuth:</strong><br>
                        â€¢ Project Settings â†’ General<br>
                        â€¢ ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Support email
                    </li>
                </ol>
                
                <div style="background: rgba(255,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <strong>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:</strong><br>
                    Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù†ØªØ¸Ø§Ø± 5-10 Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­ØªÙ‰ ØªØµØ¨Ø­ ÙØ¹Ø§Ù„Ø©.
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button type="button" onclick="hideFirebaseInstructions()" class="login-btn" style="min-width: 120px;">ÙÙ‡Ù…Øª</button>
            </div>
        </div>
    </div>

    <!-- SPLASH SCREEN -->
    <div id="splash">
        <div class="splash-top" style="width:86%">
            <div class="splash-bar top">
                <strong>Ø´Ø±ÙŠØ· 1 â€” Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ©</strong>
                <div class="role">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</div>
            </div>

            <div class="splash-bar mid">
                <strong>Ø´Ø±ÙŠØ· 2 â€” Ù…Ù†Ø¸Ù‘Ù…</strong>
                <div class="role">Ù…ØµØ·ÙÙ‰ Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø´ÙƒÙŠØ± â€” @871c</div>
            </div>

            <div class="splash-bar dev">
                <strong>Ù…ØµØ·ÙÙ‰ Ù…ÙƒÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø¶Ø§</strong>
                <div class="role">Ù…Ù†Ø¸Ù… Ùˆ Ù…Ø·ÙˆØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” @ku56t</div>
            </div>
        </div>

        <div class="splash-note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙØªØ­ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</div>

        <!-- decorative sparkles -->
        <div style="position:absolute;inset:0;pointer-events:none">
            <div style="position:absolute;left:6%;top:20%;width:14px;height:14px;background:rgba(255,255,255,0.12);border-radius:50%;filter:blur(6px);animation:float 7s infinite;"></div>
            <div style="position:absolute;right:12%;top:36%;width:18px;height:18px;background:rgba(255,255,255,0.08);border-radius:50%;filter:blur(9px);animation:float 9s infinite;"></div>
        </div>
    </div>

    <!-- decoration bubbles -->
    <div class="decoration" aria-hidden="true">
        <div class="bubble" style="left:3%;top:10%;width:140px;height:140px;animation-duration:10s"></div>
        <div class="bubble" style="left:82%;top:18%;width:100px;height:100px;animation-duration:12s"></div>
        <div class="bubble" style="left:22%;top:75%;width:90px;height:90px;animation-duration:8s"></div>
        <div class="bubble" style="left:68%;top:82%;width:120px;height:120px;animation-duration:11s"></div>
        <div class="glow" style="left:2%;top:72%;width:300px;height:300px;background:radial-gradient(circle,#11cdef44,transparent);"></div>
        <div class="glow" style="right:2%;top:60%;width:260px;height:260px;background:radial-gradient(circle,#0a9bd644,transparent);"></div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-title">ğŸ¥ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ©</div>
            
            <div id="login-form" class="login-form">
                <input type="email" class="login-input" id="login-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                <input type="password" class="login-input" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                
                <button class="login-btn" id="login-btn" type="button" onclick="handleLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button class="login-btn" id="google-login-btn" type="button" onclick="handleGoogleLogin()" style="background: #4285f4; margin-top: 10px;">
                    ğŸ”— ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
                </button>
                <div id="login-error" class="login-error hidden"></div>
                
                <div class="login-toggle">
                    Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <button onclick="toggleLoginMode()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                </div>
                
                <div class="login-toggle">
                    Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ GoogleØŸ <button onclick="showFirebaseInstructions()">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(10,155,214,0.1); border-radius: 8px; border: 1px solid rgba(10,155,214,0.3);">
                    <h4 style="margin: 0 0 10px; color: #11cdef;">ğŸ”‘ Ø­Ø³Ø§Ø¨Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…ØªØ§Ø­Ø©:</h4>
                    <div style="font-size: 13px; color: #eaf6ff; line-height: 1.4;">
                        <strong>Ø§Ù„Ù…Ø§Ù„Ùƒ:</strong> bama47686@gmail.com / mustafa@2006#2<br>
                        <strong>ØªØ¬Ø±ÙŠØ¨ÙŠ:</strong> demo@ans.com / demo123
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: rgba(234, 246, 255, 0.7);">
                        âš ï¸ ÙŠØ¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase
                    </div>
                </div>
            </div>
            
            <div id="register-form" class="login-form hidden">
                <input type="text" class="login-input" id="register-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
                <input type="email" class="login-input" id="register-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                <input type="password" class="login-input" id="register-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" required>
                <input type="password" class="login-input" id="register-confirm" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                <button class="login-btn" id="register-btn" type="button" onclick="handleRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                <button class="login-btn" id="google-register-btn" type="button" onclick="handleGoogleLogin()" style="background: #4285f4; margin-top: 10px;">
                    ğŸ”— Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù€ Google
                </button>
                <div id="register-error" class="login-error hidden"></div>
                
                <div class="login-toggle">
                    Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <button onclick="toggleLoginMode()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                </div>
                
                <div class="login-toggle">
                    Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù€ GoogleØŸ <button onclick="showFirebaseInstructions()">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(10,155,214,0.1); border-radius: 8px; border: 1px solid rgba(10,155,214,0.3);">
                    <h4 style="margin: 0 0 10px; color: #11cdef;">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</h4>
                    <div style="font-size: 13px; color: #eaf6ff; line-height: 1.4;">
                        â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­<br>
                        â€¢ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„<br>
                        â€¢ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div class="app-container" id="app">
        <div class="main-card">
            <!-- HEADER -->
            <div class="header">
                <h1>ğŸ¥ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ANS Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</h1>
                <div class="user-info">
                    <span id="user-name">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
                    <span id="user-id" class="text-muted"></span>
                    <button class="logout-btn" onclick="handleLogout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>

            <!-- NAVIGATION -->
            <div class="nav-container">
                <div class="nav-buttons">
                    <button class="btn" id="dose-btn" onclick="showPanel('dose')">ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</button>
                    <button class="btn" id="fluid-btn" onclick="showPanel('fluid')">ğŸ’§ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</button>
                    <button class="btn" id="airway-btn" onclick="showPanel('airway')">ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¦ÙŠ</button>
                    <button class="btn" id="admin-btn" onclick="showPanel('admin')" style="display: none;">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                    <button class="btn ghost" onclick="toggleTheme()">ğŸŒ™ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
                </div>
            </div>

            <!-- DOSE CALCULATION PANEL -->
            <div id="dose-panel" class="panel active">
                <h2 class="panel-title">ğŸ’‰ Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø§Øª Ø§Ù„ØªØ®Ø¯ÙŠØ±</h2>
                
                <div class="form-grid">
                    <div class="form-section">
                        <div class="form-group">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
                            <input type="text" class="form-input" id="patient-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</label>
                                <input type="number" class="form-input" id="patient-weight" placeholder="70">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Ø§Ù„Ø¹Ù…Ø±</label>
                                <input type="number" class="form-input" id="patient-age" placeholder="40">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
                            <select class="form-select" id="drug-select">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¹Ø©</label>
                            <select class="form-select" id="dose-type">
                                <option value="induction">Ø¬Ø±Ø¹Ø© Ø§Ù„Ø­Ø«</option>
                                <option value="maintenance">Ø¬Ø±Ø¹Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
                                <option value="pediatric">Ø¬Ø±Ø¹Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„</option>
                            </select>
                        </div>
                        
                        <div class="form-controls">
                            <button class="btn" onclick="calculateDose()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©</button>
                            <button class="btn ghost" onclick="clearDoseForm()">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                            <button class="btn ghost" onclick="openScanner()">ğŸ“· Ù…Ø³Ø­ Ø¶ÙˆØ¦ÙŠ</button>
                        </div>
                        
                        <div style="margin-top: 12px; font-size: 13px; color: var(--text-muted);">
                            âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¥Ø±Ø´Ø§Ø¯ Ø§Ù„Ø·Ø¨ÙŠ ÙÙ‚Ø· - Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ±ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div id="dose-result" class="result-box">
                            <h3>Ø§Ù„Ù†ØªÙŠØ¬Ø©</h3>
                            <p>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„Ø¯ÙˆØ§Ø¡ ÙˆØ§Ù†Ù‚Ø± "Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©"</p>
                        </div>
                        
                        <div id="drug-info" class="result-box" style="margin-top: 16px; display: none;">
                            <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¡</h4>
                            <div id="drug-details"></div>
                        </div>
                    </div>
                </div>

                <!-- Chat Section -->
                <div style="margin-top: 24px;">
                    <h3>ğŸ’¬ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</h3>
                    <div class="chatBox" id="dose-chat"></div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input class="form-input" id="dose-chat-input" placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø£Ùˆ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©..." style="flex: 1;">
                        <button class="btn" onclick="sendChatMessage('dose')">Ø£Ø±Ø³Ù„</button>
                    </div>
                </div>
            </div>

            <!-- FLUID CALCULATION PANEL -->
            <div id="fluid-panel" class="panel">
                <h2 class="panel-title">ğŸ’§ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</h2>
                
                <div class="form-grid">
                    <div class="form-section">
                        <div class="form-group">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
                            <input type="text" class="form-input" id="fluid-patient-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</label>
                                <input type="number" class="form-input" id="fluid-weight" placeholder="70">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Ø§Ù„Ø¹Ù…Ø±</label>
                                <input type="number" class="form-input" id="fluid-age" placeholder="40">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¦Ù„</label>
                            <select class="form-select" id="fluid-type">
                                <option value="maintenance">Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</option>
                                <option value="replacement">Ø³ÙˆØ§Ø¦Ù„ Ø§Ù„ØªØ¹ÙˆÙŠØ¶</option>
                                <option value="blood">Ù†Ù‚Ù„ Ø§Ù„Ø¯Ù…</option>
                            </select>
                        </div>
                        
                        <div class="form-controls">
                            <button class="btn" onclick="calculateFluid()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„</button>
                            <button class="btn ghost" onclick="clearFluidForm()">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div id="fluid-result" class="result-box">
                            <h3>Ù†ØªÙŠØ¬Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„</h3>
                            <p>Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù†Ù‚Ø± "Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„"</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Section -->
                <div style="margin-top: 24px;">
                    <h3>ğŸ’¬ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ù…</h3>
                    <div class="chatBox" id="fluid-chat"></div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input class="form-input" id="fluid-chat-input" placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ø¯Ù…..." style="flex: 1;">
                        <button class="btn" onclick="sendChatMessage('fluid')">Ø£Ø±Ø³Ù„</button>
                    </div>
                </div>
            </div>

            <!-- AIRWAY MANAGEMENT PANEL -->
            <div id="airway-panel" class="panel">
                <h2 class="panel-title">ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¦ÙŠ</h2>
                
                <div class="form-grid">
                    <div class="form-section">
                        <div class="form-group">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
                            <input type="text" class="form-input" id="airway-patient-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Ø§Ù„Ø¹Ù…Ø± (Ø³Ù†ÙˆØ§Øª)</label>
                                <input type="number" class="form-input" id="airway-age" placeholder="5">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</label>
                                <input type="number" class="form-input" id="airway-weight" placeholder="20">
                            </div>
                        </div>
                        
                        <div class="form-controls">
                            <button class="btn" onclick="calculateAirway()">Ø§Ø­Ø³Ø¨ Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨</button>
                            <button class="btn ghost" onclick="clearAirwayForm()">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div id="airway-result" class="result-box">
                            <h3>Ù†ØªÙŠØ¬Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¦ÙŠ</h3>
                            <p>Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø± ÙˆÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ Ù„Ø­Ø³Ø§Ø¨ Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Section -->
                <div style="margin-top: 24px;">
                    <h3>ğŸ’¬ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¦ÙŠ</h3>
                    <div class="chatBox" id="airway-chat"></div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input class="form-input" id="airway-chat-input" placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¦ÙŠ..." style="flex: 1;">
                        <button class="btn" onclick="sendChatMessage('airway')">Ø£Ø±Ø³Ù„</button>
                    </div>
                </div>
            </div>

            <!-- ADMIN PANEL -->
            <div id="admin-panel" class="panel">
                <h2 class="panel-title">âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</h2>
                
                <div id="admin-stats" class="form-grid" style="margin-bottom: 24px;">
                    <div class="result-box success">
                        <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                        <div style="display: flex; justify-content: space-between; margin-top: 12px;">
                            <div class="text-center">
                                <div class="result-value" id="total-users">0</div>
                                <div class="result-unit">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                            </div>
                            <div class="text-center">
                                <div class="result-value" id="total-calculations">0</div>
                                <div class="result-unit">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <h3>ğŸ”§ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
                        <div class="form-controls">
                            <button class="btn" onclick="refreshUsersList()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
                            <button class="btn ghost" onclick="exportAllData()">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                            <button class="btn danger" onclick="clearAllSystemData()">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>
                    </div>
                </div>
                
                <div class="result-box">
                    <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                    <div id="users-list-container">
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scanner-modal" class="hidden" style="position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;">
        <div style="background: var(--card); border-radius: 20px; padding: 24px; width: 90%; max-width: 500px; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: var(--text);">ğŸ“· Ù…Ø³Ø­ Ø¶ÙˆØ¦ÙŠ Ù„Ù„ÙˆØµÙØ©</h3>
                <button onclick="closeScanner()" style="background: none; border: none; color: var(--text); font-size: 20px; cursor: pointer;">âœ•</button>
            </div>
            
            <video id="scanner-video" autoplay style="width: 100%; border-radius: 12px; margin-bottom: 16px;"></video>
            
            <div class="form-controls">
                <button class="btn" onclick="captureImage()">Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</button>
                <button class="btn ghost" onclick="closeScanner()">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            
            <div id="scan-result" style="margin-top: 16px; display: none;" class="result-box">
                <h4>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ</h4>
                <div id="scan-text"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let userData = {};
        let isLoginMode = true;
        let currentPanel = 'dose';

        // Drug database with comprehensive information
        const drugDatabase = {
            propofol: {
                name: 'Propofol (Ø¨Ø±ÙˆØ¨ÙˆÙÙˆÙ„)',
                induction: { dose: '2-2.5', unit: 'mg/kg', range: '1.5-3' },
                maintenance: { dose: '4-12', unit: 'mg/kg/hr', range: '2-15' },
                pediatric: { dose: '2.5-3.5', unit: 'mg/kg', range: '2-4' },
                sideEffects: ['Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù…', 'Ù‡Ø¨ÙˆØ· ØªÙ†ÙØ³ÙŠ', 'Ø£Ù„Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ù‚Ù†', 'Ù…ØªÙ„Ø§Ø²Ù…Ø© Ø§Ù„Ø­Ù‚Ù†'],
                contraindications: ['Ø­Ø³Ø§Ø³ÙŠØ© Ù…Ù† ÙÙˆÙ„ Ø§Ù„ØµÙˆÙŠØ§', 'Ø­Ø³Ø§Ø³ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ¶'],
                onset: '15-45 Ø«Ø§Ù†ÙŠØ©',
                duration: '5-10 Ø¯Ù‚Ø§Ø¦Ù‚'
            },
            midazolam: {
                name: 'Midazolam (Ù…ÙŠØ¯Ø§Ø²ÙˆÙ„Ø§Ù…)',
                induction: { dose: '0.15-0.3', unit: 'mg/kg', range: '0.1-0.4' },
                maintenance: { dose: '0.02-0.1', unit: 'mg/kg/hr', range: '0.01-0.2' },
                pediatric: { dose: '0.1-0.15', unit: 'mg/kg', range: '0.05-0.2' },
                sideEffects: ['ØªÙ‡Ø¯Ø¦Ø© Ù…Ø·ÙˆÙ„Ø©', 'Ù‡Ø¨ÙˆØ· ØªÙ†ÙØ³ÙŠ', 'ÙÙ‚Ø¯Ø§Ù† Ø°Ø§ÙƒØ±Ø© Ù…Ø¤Ù‚Øª'],
                contraindications: ['Ø§Ù„ÙˆÙ‡Ù† Ø§Ù„Ø¹Ø¶Ù„ÙŠ Ø§Ù„Ø´Ø¯ÙŠØ¯', 'Ù…ØªÙ„Ø§Ø²Ù…Ø© ØªÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙØ³'],
                onset: '2-5 Ø¯Ù‚Ø§Ø¦Ù‚',
                duration: '1-6 Ø³Ø§Ø¹Ø§Øª'
            },
            fentanyl: {
                name: 'Fentanyl (ÙÙ†ØªØ§Ù†ÙŠÙ„)',
                induction: { dose: '1-3', unit: 'mcg/kg', range: '0.5-5' },
                maintenance: { dose: '0.5-2', unit: 'mcg/kg/hr', range: '0.2-5' },
                pediatric: { dose: '1-3', unit: 'mcg/kg', range: '0.5-5' },
                sideEffects: ['Ù‡Ø¨ÙˆØ· ØªÙ†ÙØ³ÙŠ', 'ØºØ«ÙŠØ§Ù† ÙˆÙ‚ÙŠØ¡', 'Ø­ÙƒØ©', 'ØªØµÙ„Ø¨ Ø¹Ø¶Ù„ÙŠ'],
                contraindications: ['Ø­Ø³Ø§Ø³ÙŠØ© Ù…Ù† Ø§Ù„Ø£ÙÙŠÙˆÙ†Ø§Øª', 'Ø¥ØµØ§Ø¨Ø© Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ø´Ø¯ÙŠØ¯Ø©'],
                onset: '1-2 Ø¯Ù‚ÙŠÙ‚Ø©',
                duration: '30-60 Ø¯Ù‚ÙŠÙ‚Ø©'
            },
            morphine: {
                name: 'Morphine (Ù…ÙˆØ±ÙÙŠÙ†)',
                induction: { dose: '0.1-0.2', unit: 'mg/kg', range: '0.05-0.3' },
                maintenance: { dose: '0.02-0.05', unit: 'mg/kg/hr', range: '0.01-0.1' },
                pediatric: { dose: '0.05-0.1', unit: 'mg/kg', range: '0.02-0.15' },
                sideEffects: ['Ù‡Ø¨ÙˆØ· ØªÙ†ÙØ³ÙŠ', 'Ø¥Ù…Ø³Ø§Ùƒ', 'ØºØ«ÙŠØ§Ù† ÙˆÙ‚ÙŠØ¡', 'Ø­ÙƒØ©'],
                contraindications: ['Ø­Ø³Ø§Ø³ÙŠØ© Ù…Ù† Ø§Ù„Ø£ÙÙŠÙˆÙ†Ø§Øª', 'Ø§Ù„Ø±Ø¨Ùˆ Ø§Ù„Ø­Ø§Ø¯'],
                onset: '5-10 Ø¯Ù‚Ø§Ø¦Ù‚',
                duration: '2-4 Ø³Ø§Ø¹Ø§Øª'
            },
            ketamine: {
                name: 'Ketamine (ÙƒÙŠØªØ§Ù…ÙŠÙ†)',
                induction: { dose: '1-2', unit: 'mg/kg IV', range: '0.5-3' },
                maintenance: { dose: '0.5-1', unit: 'mg/kg/hr', range: '0.2-2' },
                pediatric: { dose: '1-2', unit: 'mg/kg', range: '0.5-3' },
                sideEffects: ['Ù‡Ù„ÙˆØ³Ø©', 'Ø£Ø­Ù„Ø§Ù… Ù…Ø²Ø¹Ø¬Ø©', 'Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…', 'Ø²ÙŠØ§Ø¯Ø© Ø¥ÙØ±Ø§Ø² Ø§Ù„Ù„Ø¹Ø§Ø¨'],
                contraindications: ['Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù… ØºÙŠØ± Ø§Ù„Ù…Ø³ÙŠØ·Ø± Ø¹Ù„ÙŠÙ‡', 'Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„ØªØ§Ø¬ÙŠØ©'],
                onset: '30-60 Ø«Ø§Ù†ÙŠØ©',
                duration: '5-15 Ø¯Ù‚ÙŠÙ‚Ø©'
            },
            atracurium: {
                name: 'Atracurium (Ø£ØªØ±Ø§ÙƒÙˆØ±ÙŠÙˆÙ…)',
                induction: { dose: '0.4-0.5', unit: 'mg/kg', range: '0.3-0.6' },
                pediatric: { dose: '0.3-0.4', unit: 'mg/kg', range: '0.2-0.5' },
                sideEffects: ['ØªØ­Ø±Ø± Ø§Ù„Ù‡ÙŠØ³ØªØ§Ù…ÙŠÙ†', 'Ø§Ø­Ù…Ø±Ø§Ø± Ø§Ù„Ø¬Ù„Ø¯', 'Ù‡Ø¨ÙˆØ· Ø¶ØºØ· Ø®ÙÙŠÙ'],
                contraindications: ['Ø­Ø³Ø§Ø³ÙŠØ© Ù…Ù† Ø§Ù„Ø¨Ø§Ø±Ø§ÙƒÙˆØ§Øª', 'ÙˆÙ‡Ù† Ø§Ù„Ø¹Ø¶Ù„Ø§Øª Ø§Ù„Ø´Ø¯ÙŠØ¯'],
                onset: '2-3 Ø¯Ù‚Ø§Ø¦Ù‚',
                duration: '20-40 Ø¯Ù‚ÙŠÙ‚Ø©'
            }
        };

        // === INITIALIZATION ===
        window.onload = function() {
            console.log('App initializing...');
            
            // Hide splash and show login screen immediately
            setTimeout(() => {
                hideSplash();
                showLoginScreen();
            }, 3000);
            
            // Initialize drug dropdown
            initializeDrugDropdown();
            
            // Initialize Firebase when ready
            initializeFirebase();
        };

        async function initializeFirebase() {
            try {
                console.log('Initializing Firebase...');
                
                // Set timeout for Firebase initialization
                const firebaseTimeout = setTimeout(() => {
                    console.warn('Firebase timeout, switching to local mode');
                    initializeLocalMode();
                }, 5000);
                
                // Wait for Firebase to be available
                if (!window.firebaseAuth) {
                    console.error('Firebase Auth not available, using local mode');
                    clearTimeout(firebaseTimeout);
                    initializeLocalMode();
                    return;
                }
                
                // Check for redirect result first
                try {
                    const result = await window.firebaseAuthFunctions.getRedirectResult(window.firebaseAuth);
                    if (result && result.user) {
                        console.log('User signed in via redirect:', result.user);
                        clearTimeout(firebaseTimeout);
                        await handleUserLogin(result.user);
                        return;
                    }
                } catch (error) {
                    console.error('Redirect result error:', error);
                }
                
                // Check authentication state with timeout protection
                window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
                    console.log('Auth state changed:', user ? user.email : 'No user');
                    if (user) {
                        try {
                            await handleUserLogin(user);
                            clearTimeout(firebaseTimeout);
                        } catch (error) {
                            console.error('handleUserLogin failed, switching to local mode:', error);
                            clearTimeout(firebaseTimeout);
                            
                            // Auto-login for owner if Firebase fails
                            if (user.email === 'bama47686@gmail.com') {
                                loginAsLocalOwner();
                            } else {
                                initializeLocalMode();
                            }
                        }
                    } else {
                        clearTimeout(firebaseTimeout);
                        showLoginScreen();
                    }
                });
                
                console.log('Firebase initialized successfully');
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                initializeLocalMode();
            }
        }

        function initializeLocalMode() {
            console.log('Initializing local mode...');
            showLoginScreen();
            
            // Add local mode indicator to login screen
            const loginScreen = document.getElementById('login-screen');
            if (loginScreen && !document.getElementById('local-mode-banner')) {
                const banner = document.createElement('div');
                banner.id = 'local-mode-banner';
                banner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #f59e0b;
                    color: white;
                    text-align: center;
                    padding: 8px;
                    font-size: 14px;
                    z-index: 10001;
                `;
                banner.textContent = 'âš ï¸ ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ - Firebase ØºÙŠØ± Ù…ØªØ§Ø­';
                document.body.appendChild(banner);
            }
        }
        
        // Initialize owner account
        async function initializeOwnerAccount() {
            try {
                console.log('Owner account initialization completed');
            } catch (error) {
                console.log('Owner account will be created on first login');
            }
        }

        // Initialize drug dropdown
        function initializeDrugDropdown() {
            const select = document.getElementById('drug-select');
            if (select) {
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡</option>';
                Object.keys(drugDatabase).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = drugDatabase[key].name;
                    select.appendChild(option);
                });
            }
        }

        // === AUTHENTICATION FUNCTIONS ===
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
            document.getElementById('splash').style.display = 'none';
        }

        function hideLoginScreen() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            hideSplash();
        }

        function hideSplash() {
            const splash = document.getElementById('splash');
            if (splash && splash.style.display !== 'none') {
                splash.style.transition = 'opacity .25s, transform .25s';
                splash.style.opacity = '0';
                splash.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    splash.style.display = 'none';
                }, 300);
            }
        }

        function toggleLoginMode() {
            isLoginMode = !isLoginMode;
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (isLoginMode) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            }
            
            clearErrors();
        }

        function clearErrors() {
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('register-error').classList.add('hidden');
        }

        function showError(type, message) {
            const errorElement = document.getElementById(type + '-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        async function handleLogin() {
            console.log('Login button clicked');
            const email = document.getElementById('login-email').value?.trim();
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');
            
            if (!email || !password) {
                showError('login', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
            clearErrors();
            
            try {
                console.log('Attempting login for:', email);
                
                // Check if Firebase is available
                if (!window.firebaseAuth || !window.firebaseAuthFunctions) {
                    console.error('Firebase not initialized');
                    throw new Error('Firebase ØºÙŠØ± Ù…ØªØ§Ø­. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ.');
                }
                
                // Special handling for owner account
                if (email === 'bama47686@gmail.com' && password === 'mustafa@2006#2') {
                    console.log('Owner login detected');
                    try {
                        const userCredential = await window.firebaseAuthFunctions.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                        console.log('Owner login successful');
                    } catch (loginError) {
                        if (loginError.code === 'auth/user-not-found') {
                            console.log('Creating owner account...');
                            const userCredential = await window.firebaseAuthFunctions.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                            console.log('Owner account created successfully');
                        } else {
                            throw loginError;
                        }
                    }
                } else {
                    // Regular user login
                    const userCredential = await window.firebaseAuthFunctions.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    console.log('Regular login successful:', userCredential.user.email);
                }
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Fallback to local mode for owner
                if (email === 'bama47686@gmail.com' && password === 'mustafa@2006#2') {
                    console.log('Firebase failed, using local owner mode');
                    loginAsLocalOwner();
                    return;
                }
                
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                
                if (error.message && error.message.includes('Firebase ØºÙŠØ± Ù…ØªØ§Ø­')) {
                    errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ...';
                    
                    // Try local mode for demo
                    if (email === 'demo@ans.com' && password === 'demo123') {
                        setTimeout(() => {
                            loginAsDemo();
                        }, 1000);
                        return;
                    }
                } else if (error.code) {
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„. Ø¬Ø±Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
                            break;
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù„. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙƒØ«ÙŠØ±Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                            break;
                    }
                }
                
                showError('login', errorMessage);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            }
        }

        // Local fallback functions
        function loginAsLocalOwner() {
            currentUser = {
                uid: 'local-owner',
                email: 'bama47686@gmail.com',
                displayName: 'Ù…ØµØ·ÙÙ‰ Ø§Ù„Ù…Ø§Ù„Ùƒ'
            };
            
            userData = {
                uid: 'local-owner',
                email: 'bama47686@gmail.com',
                displayName: 'Ù…ØµØ·ÙÙ‰ Ø§Ù„Ù…Ø§Ù„Ùƒ',
                userId: 'ANS001',
                role: 'owner',
                isBlocked: false,
                createdAt: new Date(),
                lastLogin: new Date(),
                calculationsCount: 0,
                loginMethod: 'local'
            };
            
            console.log('Local owner login successful');
            hideLoginScreen();
            
            document.getElementById('user-name').textContent = 'Ù…ØµØ·ÙÙ‰ Ø§Ù„Ù…Ø§Ù„Ùƒ (ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ)';
            document.getElementById('user-id').textContent = '(ANS001)';
            document.getElementById('admin-btn').style.display = 'block';
        }

        function loginAsDemo() {
            currentUser = {
                uid: 'demo-user',
                email: 'demo@ans.com',
                displayName: 'Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ'
            };
            
            userData = {
                uid: 'demo-user',
                email: 'demo@ans.com',
                displayName: 'Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ',
                userId: 'ANS999',
                role: 'user',
                isBlocked: false,
                createdAt: new Date(),
                lastLogin: new Date(),
                calculationsCount: 0,
                loginMethod: 'local'
            };
            
            console.log('Demo login successful');
            hideLoginScreen();
            
            document.getElementById('user-name').textContent = 'Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ (ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ)';
            document.getElementById('user-id').textContent = '(ANS999)';
        }

        async function handleGoogleLogin() {
            console.log('Starting Google login...');
            const googleLoginBtn = document.getElementById('google-login-btn') || document.getElementById('google-register-btn');
            
            if (googleLoginBtn) {
                googleLoginBtn.disabled = true;
                googleLoginBtn.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
            }
            clearErrors();
            
            try {
                if (!window.firebaseAuth || !window.googleProvider) {
                    throw new Error('Firebase not properly initialized');
                }
                
                console.log('Firebase Auth initialized, attempting Google sign-in...');
                
                window.googleProvider = new window.firebaseAuthFunctions.GoogleAuthProvider();
                window.googleProvider.setCustomParameters({
                    prompt: 'select_account'
                });
                
                window.googleProvider.addScope('email');
                window.googleProvider.addScope('profile');
                
                console.log('Google provider configured, attempting popup...');
                
                let result;
                try {
                    result = await window.firebaseAuthFunctions.signInWithPopup(window.firebaseAuth, window.googleProvider);
                    console.log('Popup sign-in successful:', result.user.email);
                } catch (popupError) {
                    console.warn('Popup sign-in failed:', popupError.code, popupError.message);
                    
                    if (popupError.code === 'auth/popup-blocked' || 
                        popupError.code === 'auth/cancelled-popup-request' ||
                        popupError.code === 'auth/popup-closed-by-user') {
                        
                        console.log('Trying redirect method...');
                        await window.firebaseAuthFunctions.signInWithRedirect(window.firebaseAuth, window.googleProvider);
                        return;
                    } else {
                        throw popupError;
                    }
                }
                
                const user = result.user;
                console.log('Google login successful for user:', user.email);
                
            } catch (error) {
                console.error('Google login error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google';
                
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        errorMessage = 'ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                        break;
                    case 'auth/popup-blocked':
                        errorMessage = 'ØªÙ… Ø­Ø¬Ø¨ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø£Ùˆ Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                        break;
                    case 'auth/cancelled-popup-request':
                        errorMessage = 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                        break;
                    case 'auth/account-exists-with-different-credential':
                        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø±ØªØ¨Ø· Ø¨Ø·Ø±ÙŠÙ‚Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø£Ø®Ø±Ù‰. Ø¬Ø±Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù„. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google ØºÙŠØ± Ù…ÙØ¹Ù„ ÙÙŠ Firebase Console. ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„Ù‡ Ø£ÙˆÙ„Ø§Ù‹:\n\n1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Firebase Console\n2. Ø§Ø®ØªØ± Authentication\n3. ÙØ¹Ù‘Ù„ Google Sign-in method\n4. Ø§Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
                        break;
                    case 'auth/unauthorized-domain':
                        errorMessage = 'Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚ ØºÙŠØ± Ù…ÙØµØ±Ø­ Ù„Ù‡ ÙÙŠ Firebase. Ø£Ø¶Ù Ø§Ù„Ù†Ø·Ø§Ù‚:\n\n1. Firebase Console â†’ Authentication\n2. Settings â†’ Authorized domains\n3. Ø£Ø¶Ù Ù†Ø·Ø§Ù‚ Ù…ÙˆÙ‚Ø¹Ùƒ';
                        break;
                    default:
                        if (error.message.includes('Firebase not properly initialized')) {
                            errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©';
                        } else {
                            errorMessage = `Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google: ${error.message}`;
                        }
                }
                
                if (error.code !== 'auth/cancelled-popup-request') {
                    showError(isLoginMode ? 'login' : 'register', errorMessage);
                }
            } finally {
                if (googleLoginBtn) {
                    googleLoginBtn.disabled = false;
                    googleLoginBtn.textContent = isLoginMode ? 'ğŸ”— ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google' : 'ğŸ”— Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù€ Google';
                }
            }
        }

        async function handleRegister() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;
            const registerBtn = document.getElementById('register-btn');
            
            if (!name || !email || !password || !confirmPassword) {
                showError('register', 'ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('register', 'ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†');
                return;
            }
            
            if (password.length < 6) {
                showError('register', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            registerBtn.disabled = true;
            registerBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';
            clearErrors();
            
            try {
                const userCredential = await window.firebaseAuthFunctions.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                await createUserProfile(user, name);
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹';
                        break;
                }
                
                showError('register', errorMessage);
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
            }
        }

        async function createUserProfile(user, displayName) {
            try {
                console.log('Creating user profile for:', user.email);
                
                const usersSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'users')
                );
                const userCount = usersSnapshot.size;
                
                const isOwner = user.email === 'bama47686@gmail.com';
                const userId = isOwner ? 'ANS001' : `ANS${String(userCount + 2).padStart(3, '0')}`;
                
                const finalDisplayName = displayName || user.displayName || (isOwner ? 'Ù…ØµØ·ÙÙ‰ Ø§Ù„Ù…Ø§Ù„Ùƒ' : user.email.split('@')[0]);
                
                const userProfile = {
                    uid: user.uid,
                    email: user.email,
                    displayName: finalDisplayName,
                    userId: userId,
                    role: isOwner ? 'owner' : 'user',
                    isBlocked: false,
                    createdAt: new Date(),
                    lastLogin: new Date(),
                    calculationsCount: 0,
                    loginMethod: user.providerData && user.providerData.length > 0 ? 
                        (user.providerData[0].providerId === 'google.com' ? 'google' : 'email') : 'email'
                };
                
                console.log('User profile data:', userProfile);
                
                await window.firebaseDbFunctions.setDoc(
                    window.firebaseDbFunctions.doc(window.firebaseDb, 'users', user.uid),
                    userProfile
                );
                
                console.log('User profile created successfully:', finalDisplayName);
                return userProfile;
            } catch (error) {
                console.error('Error creating user profile:', error);
                throw error;
            }
        }

        async function handleUserLogin(user) {
            try {
                console.log('Handling user login for:', user.email);
                
                // Try to get user data from Firestore, but fallback to local mode if fails
                let userData = null;
                try {
                    if (window.firebaseDb && window.firebaseDbFunctions) {
                        const userDocRef = window.firebaseDbFunctions.doc(window.firebaseDb, 'users', user.uid);
                        let userDoc = await window.firebaseDbFunctions.getDoc(userDocRef);
                        
                        if (userDoc.exists()) {
                            userData = userDoc.data();
                            console.log('User data loaded from Firestore');
                            
                            // Check if user is blocked
                            if (userData.isBlocked && userData.role !== 'owner') {
                                alert('Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¹Ø·Ù„. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.');
                                await handleLogout();
                                return;
                            }
                            
                            // Update last login
                            const updateData = {
                                lastLogin: new Date(),
                            };
                            
                            if (user.providerData && user.providerData.length > 0) {
                                const provider = user.providerData[0].providerId;
                                if (provider === 'google.com') {
                                    updateData.loginMethod = 'google';
                                }
                            }
                            
                            await window.firebaseDbFunctions.updateDoc(userDocRef, updateData);
                            
                        } else {
                            console.log('Creating new user profile...');
                            userData = await createUserProfile(user);
                        }
                    }
                } catch (firestoreError) {
                    console.warn('Firestore failed, using local mode:', firestoreError.message);
                    userData = null; // Will fallback to local mode
                }
                
                // If Firestore failed, create local user data
                if (!userData) {
                    console.log('Creating local user data...');
                    const isOwner = user.email === 'bama47686@gmail.com';
                    userData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || (isOwner ? 'Ù…ØµØ·ÙÙ‰ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù…Ø­Ù„ÙŠ)' : user.email.split('@')[0]),
                        userId: isOwner ? 'ANS001' : 'ANS999',
                        role: isOwner ? 'owner' : 'user',
                        isBlocked: false,
                        createdAt: new Date(),
                        lastLogin: new Date(),
                        calculationsCount: 0,
                        loginMethod: 'local'
                    };
                    
                    // Add local mode banner
                    addLocalModeBanner();
                }
                
                currentUser = user;
                window.userData = userData; // Make it globally accessible
                
                const displayName = userData.displayName || user.displayName || user.email.split('@')[0];
                document.getElementById('user-name').textContent = displayName;
                document.getElementById('user-id').textContent = `(${userData.userId})`;
                
                if (userData.role === 'owner') {
                    document.getElementById('admin-btn').style.display = 'block';
                    console.log('Owner logged in, showing admin panel');
                }
                
                hideLoginScreen();
                console.log('User login handled successfully');
                
            } catch (error) {
                console.error('Error handling user login:', error);
                
                // Fallback for owner account
                if (user.email === 'bama47686@gmail.com') {
                    console.log('Critical fallback: Using owner local mode');
                    loginAsLocalOwner();
                    return;
                }
                
                showError('login', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ.');
                
                // Create minimal user data for fallback
                currentUser = user;
                window.userData = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0],
                    userId: 'ANS999',
                    role: 'user',
                    isBlocked: false,
                    loginMethod: 'local-fallback'
                };
                
                document.getElementById('user-name').textContent = window.userData.displayName;
                document.getElementById('user-id').textContent = `(${window.userData.userId})`;
                
                addLocalModeBanner();
                hideLoginScreen();
            }
        }

        function addLocalModeBanner() {
            if (!document.getElementById('local-mode-banner')) {
                const banner = document.createElement('div');
                banner.id = 'local-mode-banner';
                banner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #f59e0b;
                    color: white;
                    text-align: center;
                    padding: 8px;
                    font-size: 14px;
                    z-index: 10001;
                `;
                banner.textContent = 'âš ï¸ ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…';
                document.body.appendChild(banner);
            }
        }

        async function handleLogout() {
            try {
                await window.firebaseAuthFunctions.signOut(window.firebaseAuth);
                currentUser = null;
                userData = {};
                document.getElementById('admin-btn').style.display = 'none';
                showLoginScreen();
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
            }
        }

        // === PANEL MANAGEMENT ===
        function showPanel(panelId) {
            // Hide all panels
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.nav-buttons .btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('inactive');
            });
            
            // Show selected panel
            document.getElementById(panelId + '-panel').classList.add('active');
            
            // Add active class to selected button
            const activeBtn = document.getElementById(panelId + '-btn');
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.classList.remove('inactive');
            }
            
            currentPanel = panelId;
            
            // Load admin data if admin panel
            if (panelId === 'admin' && userData.role === 'owner') {
                loadAdminData();
            }
        }

        // === CALCULATION FUNCTIONS ===
        function calculateDose() {
            const patientName = document.getElementById('patient-name').value;
            const weight = parseFloat(document.getElementById('patient-weight').value);
            const age = parseFloat(document.getElementById('patient-age').value);
            const drugKey = document.getElementById('drug-select').value;
            const doseType = document.getElementById('dose-type').value;
            
            if (!weight || !age || !drugKey) {
                document.getElementById('dose-result').innerHTML = `
                    <h3>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    <p style="color: var(--danger);">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</p>
                `;
                return;
            }
            
            const drug = drugDatabase[drugKey];
            if (!drug) {
                document.getElementById('dose-result').innerHTML = `
                    <h3>Ø®Ø·Ø£</h3>
                    <p style="color: var(--danger);">Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</p>
                `;
                return;
            }
            
            let doseInfo = drug[doseType];
            if (!doseInfo) {
                document.getElementById('dose-result').innerHTML = `
                    <h3>Ø®Ø·Ø£</h3>
                    <p style="color: var(--danger);">Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ØªÙˆÙØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡</p>
                `;
                return;
            }
            
            const baseDose = parseFloat(doseInfo.dose.split('-')[0]);
            const calculatedDose = (baseDose * weight).toFixed(2);
            
            document.getElementById('dose-result').innerHTML = `
                <h3>Ù†ØªÙŠØ¬Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©</h3>
                <div class="result-value">${calculatedDose}</div>
                <div class="result-unit">${doseInfo.unit.replace('/kg', '')}</div>
                <div class="result-details">
                    <strong>Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
                    <strong>Ø§Ù„Ø¯ÙˆØ§Ø¡:</strong> ${drug.name}<br>
                    <strong>Ø§Ù„ÙˆØ²Ù†:</strong> ${weight} ÙƒØº<br>
                    <strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${doseType === 'induction' ? 'Ø¬Ø±Ø¹Ø© Ø§Ù„Ø­Ø«' : doseType === 'maintenance' ? 'Ø¬Ø±Ø¹Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©' : 'Ø¬Ø±Ø¹Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„'}<br>
                    <strong>Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong> ${doseInfo.range} ${doseInfo.unit}
                </div>
            `;
            
            document.getElementById('dose-result').className = 'result-box success';
            
            // Show drug information
            showDrugInfo(drug);
            
            // Save calculation to Firebase
            saveCalculation('dose', {
                patientName: patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                drug: drug.name,
                weight: weight,
                age: age,
                doseType: doseType,
                calculatedDose: calculatedDose,
                unit: doseInfo.unit
            });
        }

        function showDrugInfo(drug) {
            const drugInfoDiv = document.getElementById('drug-info');
            drugInfoDiv.innerHTML = `
                <h4>${drug.name}</h4>
                <div class="result-details">
                    <strong>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…ÙØ¹ÙˆÙ„:</strong> ${drug.onset}<br>
                    <strong>Ù…Ø¯Ø© Ø§Ù„Ù…ÙØ¹ÙˆÙ„:</strong> ${drug.duration}<br>
                    <strong>Ø§Ù„Ø¢Ø«Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©:</strong><br>
                    ${drug.sideEffects.map(effect => `<span class="pill">${effect}</span>`).join('')}<br>
                    <strong>Ù…ÙˆØ§Ù†Ø¹ Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„:</strong><br>
                    ${drug.contraindications.map(contra => `<span class="sideEffect">${contra}</span>`).join('')}
                </div>
            `;
            drugInfoDiv.style.display = 'block';
        }

        function calculateFluid() {
            const patientName = document.getElementById('fluid-patient-name').value;
            const weight = parseFloat(document.getElementById('fluid-weight').value);
            const age = parseFloat(document.getElementById('fluid-age').value);
            const fluidType = document.getElementById('fluid-type').value;
            
            if (!weight || !age) {
                document.getElementById('fluid-result').innerHTML = `
                    <h3>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    <p style="color: var(--danger);">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø¹Ù…Ø±</p>
                `;
                return;
            }
            
            let maintenanceFluid = 0;
            let additionalInfo = '';
            
            // Holliday-Segar method
            if (weight <= 10) {
                maintenanceFluid = weight * 100;
            } else if (weight <= 20) {
                maintenanceFluid = 1000 + (weight - 10) * 50;
            } else {
                maintenanceFluid = 1500 + (weight - 20) * 20;
            }
            
            const hourlyRate = (maintenanceFluid / 24).toFixed(1);
            
            if (fluidType === 'blood') {
                const bloodVolume = weight * 10; // 10-15 ml/kg typically
                additionalInfo = `
                    <div style="margin-top: 16px; padding: 12px; background: rgba(255,82,82,0.1); border-left: 4px solid var(--danger); border-radius: 6px;">
                        <strong>Ù†Ù‚Ù„ Ø§Ù„Ø¯Ù… (PRBC):</strong><br>
                        Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${bloodVolume} Ù…Ù„ (10 Ù…Ù„/ÙƒØº)<br>
                        Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ³Ø±ÙŠØ¨: 1-2 Ù…Ù„/ÙƒØº/Ø³Ø§Ø¹Ø©<br>
                        Ø§Ù„Ù…Ø¯Ø©: 2-4 Ø³Ø§Ø¹Ø§Øª ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
                    </div>
                `;
            } else if (fluidType === 'replacement') {
                additionalInfo = `
                    <div style="margin-top: 16px; padding: 12px; background: rgba(245,158,11,0.1); border-left: 4px solid var(--warning); border-radius: 6px;">
                        <strong>Ø³ÙˆØ§Ø¦Ù„ Ø§Ù„ØªØ¹ÙˆÙŠØ¶:</strong><br>
                        â€¢ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: 2-10 Ù…Ù„/ÙƒØº/Ø³Ø§Ø¹Ø©<br>
                        â€¢ ÙÙ‚Ø¯Ø§Ù† Ù…Ø¹ÙˆÙŠ: Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©<br>
                        â€¢ Ù†Ø²ÙŠÙ: 3:1 Ù†Ø³Ø¨Ø© Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ù„Ù„Ø¯Ù… Ø§Ù„Ù…ÙÙ‚ÙˆØ¯
                    </div>
                `;
            }
            
            document.getElementById('fluid-result').innerHTML = `
                <h3>Ù†ØªÙŠØ¬Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„</h3>
                <div class="result-value">${maintenanceFluid}</div>
                <div class="result-unit">Ù…Ù„/24 Ø³Ø§Ø¹Ø©</div>
                <div class="result-details">
                    <strong>Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
                    <strong>Ø§Ù„ÙˆØ²Ù†:</strong> ${weight} ÙƒØº<br>
                    <strong>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ³Ø±ÙŠØ¨:</strong> ${hourlyRate} Ù…Ù„/Ø³Ø§Ø¹Ø©<br>
                    <strong>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¦Ù„:</strong> ${fluidType === 'maintenance' ? 'Ø³ÙˆØ§Ø¦Ù„ Ø£Ø³Ø§Ø³ÙŠØ©' : fluidType === 'replacement' ? 'Ø³ÙˆØ§Ø¦Ù„ ØªØ¹ÙˆÙŠØ¶' : 'Ù†Ù‚Ù„ Ø¯Ù…'}
                </div>
                ${additionalInfo}
            `;
            
            document.getElementById('fluid-result').className = 'result-box success';
            
            // Save calculation
            saveCalculation('fluid', {
                patientName: patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                weight: weight,
                age: age,
                fluidType: fluidType,
                maintenanceFluid: maintenanceFluid,
                hourlyRate: hourlyRate
            });
        }

        function calculateAirway() {
            const patientName = document.getElementById('airway-patient-name').value;
            const age = parseFloat(document.getElementById('airway-age').value);
            const weight = parseFloat(document.getElementById('airway-weight').value);
            
            if (!age) {
                document.getElementById('airway-result').innerHTML = `
                    <h3>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    <p style="color: var(--danger);">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù…Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>
                `;
                return;
            }
            
            // ETT size calculation
            let ettSize;
            if (age < 1) {
                ettSize = 3.5;
            } else if (age < 2) {
                ettSize = 4.0;
            } else {
                ettSize = (age / 4) + 4;
            }
            
            // Laryngoscope blade
            let bladeSize;
            if (age < 1) {
                bladeSize = "0-1 (Miller)";
            } else if (age < 3) {
                bladeSize = "1-2 (Miller Ø£Ùˆ Mac)";
            } else if (age < 8) {
                bladeSize = "2-3 (Macintosh)";
            } else {
                bladeSize = "3-4 (Macintosh)";
            }
            
            const depth = ettSize * 3;
            const additionalInfo = age < 8 ? 
                '<div style="color: var(--warning); margin-top: 12px;">âš ï¸ Ù„Ù„Ø£Ø·ÙØ§Ù„ ØªØ­Øª 8 Ø³Ù†ÙˆØ§Øª: Ø§Ø³ØªØ®Ø¯Ù… uncuffed ETT Ø£Ùˆ low-pressure cuffed</div>' : '';
            
            document.getElementById('airway-result').innerHTML = `
                <h3>Ù†ØªÙŠØ¬Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¦ÙŠ</h3>
                <div class="result-value">${ettSize.toFixed(1)}</div>
                <div class="result-unit">Ù…Ù… (ETT)</div>
                <div class="result-details">
                    <strong>Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
                    <strong>Ø§Ù„Ø¹Ù…Ø±:</strong> ${age} Ø³Ù†Ø©<br>
                    ${weight ? `<strong>Ø§Ù„ÙˆØ²Ù†:</strong> ${weight} ÙƒØº<br>` : ''}
                    <strong>Ø­Ø¬Ù… ETT:</strong> ${ettSize.toFixed(1)} Ù…Ù…<br>
                    <strong>Ø¹Ù…Ù‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„:</strong> ${depth.toFixed(1)} Ø³Ù…<br>
                    <strong>Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨:</strong> ${bladeSize}
                </div>
                ${additionalInfo}
            `;
            
            document.getElementById('airway-result').className = 'result-box success';
            
            // Save calculation
            saveCalculation('airway', {
                patientName: patientName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                age: age,
                weight: weight || null,
                ettSize: ettSize,
                depth: depth,
                bladeSize: bladeSize
            });
        }

        // === CHAT FUNCTIONS ===
        async function sendChatMessage(section) {
            const inputId = section + '-chat-input';
            const chatId = section + '-chat';
            const input = document.getElementById(inputId);
            const chat = document.getElementById(chatId);
            
            const message = input.value.trim();
            if (!message) return;
            
            // Add user message
            chat.innerHTML += `
                <div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; text-align: right;">
                    <strong>Ø£Ù†Øª:</strong> ${message}
                </div>
            `;
            
            input.value = '';
            chat.scrollTop = chat.scrollHeight;
            
            // Add loading message
            chat.innerHTML += `
                <div style="margin: 8px 0; color: var(--text-muted);">
                    â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø¯...
                </div>
            `;
            chat.scrollTop = chat.scrollHeight;
            
            try {
                // Simulate AI response (replace with actual OpenAI API call)
                const response = await simulateAIResponse(message, section);
                
                // Remove loading message
                const loadingMsg = chat.lastElementChild;
                if (loadingMsg && loadingMsg.textContent.includes('â³')) {
                    loadingMsg.remove();
                }
                
                // Add AI response
                chat.innerHTML += `
                    <div style="margin: 8px 0; padding: 8px; background: rgba(10,155,214,0.1); border-radius: 6px; border-left: 3px solid var(--accent);">
                        <strong>AI Ø§Ù„Ø·Ø¨ÙŠ:</strong> ${response}
                    </div>
                `;
                
            } catch (error) {
                // Remove loading message
                const loadingMsg = chat.lastElementChild;
                if (loadingMsg && loadingMsg.textContent.includes('â³')) {
                    loadingMsg.remove();
                }
                
                chat.innerHTML += `
                    <div style="margin: 8px 0; color: var(--danger);">
                        âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                    </div>
                `;
            }
            
            chat.scrollTop = chat.scrollHeight;
        }

        async function simulateAIResponse(message, section) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Simple response simulation based on keywords
            const responses = {
                dose: {
                    'Ø¬Ø±Ø¹Ø©': 'Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ØªØ­Ø³Ø¨ Ø­Ø³Ø¨ ÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ¹Ù…Ø±Ù‡. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ±ÙŠØ©.',
                    'propofol': 'Ø§Ù„Ø¨Ø±ÙˆØ¨ÙˆÙÙˆÙ„: Ø¬Ø±Ø¹Ø© Ø§Ù„Ø­Ø« 2-2.5 Ù…Øº/ÙƒØºØŒ Ø§Ø­Ø°Ø± Ù…Ù† Ø§Ù†Ø®ÙØ§Ø¶ Ø¶ØºØ· Ø§Ù„Ø¯Ù….',
                    'ÙÙ†ØªØ§Ù†ÙŠÙ„': 'Ø§Ù„ÙÙ†ØªØ§Ù†ÙŠÙ„: Ù…Ø³ÙƒÙ† Ù‚ÙˆÙŠØŒ Ø¬Ø±Ø¹Ø© Ø§Ù„Ø­Ø« 1-3 Ù…ÙƒØº/ÙƒØºØŒ Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªÙ†ÙØ³ Ø¨Ø¹Ù†Ø§ÙŠØ©.',
                    'default': 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£ÙƒØ«Ø±. ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆØ§Ù„Ø£Ø¯ÙˆÙŠØ©.'
                },
                fluid: {
                    'Ø³ÙˆØ§Ø¦Ù„': 'Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØªØ­Ø³Ø¨ Ø¨Ø·Ø±ÙŠÙ‚Ø© Holliday-Segar: 100 Ù…Ù„/ÙƒØº Ù„Ù„Ø£ÙˆÙ„ 10 ÙƒØº.',
                    'Ø¯Ù…': 'Ù†Ù‚Ù„ Ø§Ù„Ø¯Ù…: 10-15 Ù…Ù„/ÙƒØº Ø¹Ø§Ø¯Ø©ØŒ Ø¨Ù…Ø¹Ø¯Ù„ 1-2 Ù…Ù„/ÙƒØº/Ø³Ø§Ø¹Ø©.',
                    'default': 'Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ù…Ù‡Ù…Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªÙˆØ§Ø²Ù† Ø§Ù„Ø¬Ø³Ù…. Ù…Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯ØŸ'
                },
                airway: {
                    'Ø£Ù†Ø¨ÙˆØ¨': 'Ø­Ø¬Ù… Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨ = (Ø§Ù„Ø¹Ù…Ø± Ã· 4) + 4 Ù„Ù„Ø£Ø·ÙØ§Ù„ ÙÙˆÙ‚ Ø§Ù„Ø³Ù†ØªÙŠÙ†.',
                    'Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨': 'Ø§Ø®ØªÙŠØ§Ø± Ø´ÙØ±Ø© Ø§Ù„Ù„Ø§Ø±Ù†ØºÙˆØ³ÙƒÙˆØ¨ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ­Ø¬Ù… Ø§Ù„ÙÙ….',
                    'default': 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¦ÙŠ ØªØªØ·Ù„Ø¨ Ø¯Ù‚Ø©. Ù…Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯ØŸ'
                }
            };
            
            const sectionResponses = responses[section] || responses.dose;
            
            for (const keyword in sectionResponses) {
                if (keyword !== 'default' && message.toLowerCase().includes(keyword)) {
                    return sectionResponses[keyword];
                }
            }
            
            return sectionResponses.default;
        }

        // === UTILITY FUNCTIONS ===
        function clearDoseForm() {
            document.getElementById('patient-name').value = '';
            document.getElementById('patient-weight').value = '';
            document.getElementById('patient-age').value = '';
            document.getElementById('drug-select').value = '';
            document.getElementById('dose-result').innerHTML = `
                <h3>Ø§Ù„Ù†ØªÙŠØ¬Ø©</h3>
                <p>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„Ø¯ÙˆØ§Ø¡ ÙˆØ§Ù†Ù‚Ø± "Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©"</p>
            `;
            document.getElementById('dose-result').className = 'result-box';
            document.getElementById('drug-info').style.display = 'none';
        }

        function clearFluidForm() {
            document.getElementById('fluid-patient-name').value = '';
            document.getElementById('fluid-weight').value = '';
            document.getElementById('fluid-age').value = '';
            document.getElementById('fluid-result').innerHTML = `
                <h3>Ù†ØªÙŠØ¬Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„</h3>
                <p>Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù†Ù‚Ø± "Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ§Ø¦Ù„"</p>
            `;
            document.getElementById('fluid-result').className = 'result-box';
        }

        function clearAirwayForm() {
            document.getElementById('airway-patient-name').value = '';
            document.getElementById('airway-age').value = '';
            document.getElementById('airway-weight').value = '';
            document.getElementById('airway-result').innerHTML = `
                <h3>Ù†ØªÙŠØ¬Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¦ÙŠ</h3>
                <p>Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø± ÙˆÙˆØ²Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ Ù„Ø­Ø³Ø§Ø¨ Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</p>
            `;
            document.getElementById('airway-result').className = 'result-box';
        }

        function toggleTheme() {
            document.body.classList.toggle('light');
            localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
        }

        // === SCANNER FUNCTIONS ===
        function openScanner() {
            document.getElementById('scanner-modal').classList.remove('hidden');
            document.getElementById('scanner-modal').style.display = 'flex';
            
            // Request camera access
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    document.getElementById('scanner-video').srcObject = stream;
                })
                .catch(error => {
                    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + error.message);
                });
        }

        function closeScanner() {
            const video = document.getElementById('scanner-video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('scanner-modal').classList.add('hidden');
            document.getElementById('scanner-modal').style.display = 'none';
        }

        function captureImage() {
            const video = document.getElementById('scanner-video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            // Simulate OCR result
            document.getElementById('scan-result').style.display = 'block';
            document.getElementById('scan-text').innerHTML = `
                <div style="color: var(--success);">âœ… ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­</div>
                <div style="margin-top: 8px;">
                    <strong>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©:</strong><br>
                    â€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ<br>
                    â€¢ Ø§Ù„ÙˆØ²Ù†: 75 ÙƒØº<br>
                    â€¢ Ø§Ù„Ø¹Ù…Ø±: 45 Ø³Ù†Ø©<br>
                    â€¢ Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠØ±: A-12
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                    Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ù†ØªÙŠØ¬Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©. ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙƒØªØ¨Ø© OCR Ù…Ø«Ù„ Tesseract.js
                </div>
            `;
        }

        // === ADMIN FUNCTIONS ===
        async function loadAdminData() {
            if (userData.role !== 'owner') return;
            
            try {
                // Load statistics
                const usersSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'users')
                );
                
                const calculationsSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'calculations')
                );
                
                document.getElementById('total-users').textContent = usersSnapshot.size;
                document.getElementById('total-calculations').textContent = calculationsSnapshot.size;
                
                // Load users list
                await refreshUsersList();
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        async function refreshUsersList() {
            if (userData.role !== 'owner') return;
            
            try {
                const snapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'users')
                );
                
                let html = `
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                <th>Ø§Ù„Ø¯ÙˆØ±</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const status = user.role === 'owner' ? 'owner' : (user.isBlocked ? 'blocked' : 'active');
                    const statusText = user.role === 'owner' ? 'Ù…Ø§Ù„Ùƒ' : (user.isBlocked ? 'Ù…Ø­Ø¸ÙˆØ±' : 'Ù†Ø´Ø·');
                    const lastLogin = user.lastLogin ? new Date(user.lastLogin.seconds * 1000).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    
                    html += `
                        <tr>
                            <td>${user.userId}</td>
                            <td>${user.displayName}</td>
                            <td>${user.email}</td>
                            <td>${user.role === 'owner' ? 'Ù…Ø§Ù„Ùƒ' : 'Ù…Ø³ØªØ®Ø¯Ù…'}</td>
                            <td><span class="user-status status-${status}">${statusText}</span></td>
                            <td>${lastLogin}</td>
                            <td>
                                ${user.role !== 'owner' ? `
                                    <button class="btn ${user.isBlocked ? 'ghost' : 'danger'}" onclick="${user.isBlocked ? 'unblockUser' : 'blockUser'}('${doc.id}')" style="padding: 4px 8px; font-size: 12px; min-width: 60px;">
                                        ${user.isBlocked ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'}
                                    </button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('users-list-container').innerHTML = html;
                
            } catch (error) {
                console.error('Error refreshing users list:', error);
                document.getElementById('users-list-container').innerHTML = '<p style="color: var(--danger);">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>';
            }
        }

        async function blockUser(userId) {
            if (userData.role !== 'owner') return;
            
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
            
            try {
                await window.firebaseDbFunctions.updateDoc(
                    window.firebaseDbFunctions.doc(window.firebaseDb, 'users', userId),
                    { isBlocked: true }
                );
                
                alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                refreshUsersList();
                
            } catch (error) {
                console.error('Error blocking user:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        }

        async function unblockUser(userId) {
            if (userData.role !== 'owner') return;
            
            try {
                await window.firebaseDbFunctions.updateDoc(
                    window.firebaseDbFunctions.doc(window.firebaseDb, 'users', userId),
                    { isBlocked: false }
                );
                
                alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                refreshUsersList();
                
            } catch (error) {
                console.error('Error unblocking user:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        }

        async function exportAllData() {
            if (userData.role !== 'owner') return;
            
            try {
                const usersSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'users')
                );
                const calculationsSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'calculations')
                );
                
                const users = [];
                const calculations = [];
                
                usersSnapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                calculationsSnapshot.forEach(doc => {
                    calculations.push({ id: doc.id, ...doc.data() });
                });
                
                const exportData = {
                    users,
                    calculations,
                    exportDate: new Date().toISOString(),
                    totalUsers: users.length,
                    totalCalculations: calculations.length
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                    type: 'application/json' 
                });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `ans-medical-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        async function clearAllSystemData() {
            if (userData.role !== 'owner') return;
            
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø¹Ø¯Ø§ Ø§Ù„Ù…Ø§Ù„Ùƒ)\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©')) return;
            
            const confirmText = prompt('Ø§ÙƒØªØ¨ "Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ù„Ù„ØªØ£ÙƒÙŠØ¯:');
            if (confirmText !== 'Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª') {
                alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
                return;
            }
            
            try {
                const calculationsSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'calculations')
                );
                
                for (const doc of calculationsSnapshot.docs) {
                    await window.firebaseDbFunctions.deleteDoc(doc.ref);
                }
                
                const usersSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'users')
                );
                
                for (const doc of usersSnapshot.docs) {
                    const user = doc.data();
                    if (user.role !== 'owner') {
                        await window.firebaseDbFunctions.deleteDoc(doc.ref);
                    }
                }
                
                alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!');
                refreshUsersList();
                loadAdminData();
                
            } catch (error) {
                console.error('Error clearing system data:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        // === SAVE CALCULATION TO FIREBASE ===
        async function saveCalculation(type, data) {
            if (!currentUser) return;
            
            try {
                await window.firebaseDbFunctions.addDoc(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'calculations'),
                    {
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        type: type,
                        data: data,
                        timestamp: new Date()
                    }
                );
                
                // Update user's calculation count
                if (userData.calculationsCount !== undefined) {
                    await window.firebaseDbFunctions.updateDoc(
                        window.firebaseDbFunctions.doc(window.firebaseDb, 'users', currentUser.uid),
                        { calculationsCount: userData.calculationsCount + 1 }
                    );
                    userData.calculationsCount += 1;
                }
                
            } catch (error) {
                console.error('Error saving calculation:', error);
            }
        }

        // === FIREBASE INSTRUCTIONS ===
        function showFirebaseInstructions() {
            document.getElementById('firebase-modal').style.display = 'flex';
            document.getElementById('firebase-modal').classList.remove('hidden');
        }

        function hideFirebaseInstructions() {
            document.getElementById('firebase-modal').style.display = 'none';
            document.getElementById('firebase-modal').classList.add('hidden');
        }

        // === KEYBOARD SHORTCUTS ===
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('login-screen').style.display !== 'none') {
                e.preventDefault();
                if (isLoginMode) {
                    handleLogin();
                } else {
                    handleRegister();
                }
            }
            
            if (e.key === 'Escape') {
                hideFirebaseInstructions();
                closeScanner();
            }
        });

        // Load theme from localStorage
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light');
        }

        // Auto-hide splash after 5 seconds
        setTimeout(() => {
            if (document.getElementById('splash').style.display !== 'none') {
                hideSplash();
            }
        }, 5000);

        console.log('ANS Medical Academy app loaded successfully! ğŸ¥');
    </script>
</body>
</html>