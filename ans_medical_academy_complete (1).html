<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أكاديمية ANS الطبية — حساب الجرعات المتطور</title>
    <meta name="description" content="تطبيق متقدم لحساب جرعات التخدير وإدارة السوائل والدم مع Firebase authentication">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&family=Noto+Sans+Arabic:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, updateDoc, deleteDoc, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration - إعدادات مشروع Firebase الخاص بك
        const firebaseConfig = {
            apiKey: "AIzaSyAZUYrFNedms77FWlksMJV3yCETywoJAZw",
            authDomain: "anesthesia-dose-262e3.firebaseapp.com",
            projectId: "anesthesia-dose-262e3",
            storageBucket: "anesthesia-dose-262e3.firebasestorage.app",
            messagingSenderId: "602244448093",
            appId: "1:602244448093:web:0a8d9905849126086ff2b4",
            measurementId: "G-SCHMQFCK3J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.googleProvider = new GoogleAuthProvider();
        window.firebaseAuthFunctions = {
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithPopup,
            signInWithRedirect,
            getRedirectResult,
            GoogleAuthProvider
        };
        window.firebaseDbFunctions = {
            doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, updateDoc, deleteDoc, orderBy
        };
    </script>
    
    <style>
        /* === CSS VARIABLES & BASE STYLES === */
        :root {
            --bg-dark: #071223;
            --bg-dark-2: #0b3045;
            --card: #0f2333;
            --accent: #0a9bd6;
            --accent-2: #11cdef;
            --glass: rgba(255,255,255,0.04);
            --success: #16a34a;
            --danger: #ff5252;
            --warning: #f59e0b;
            --text: #e6f6ff;
            --text-muted: #93c1d8;
            --border: rgba(255,255,255,0.06);
            --radius: 12px;
            --font-sans: 'Cairo', 'Noto Sans Arabic', Tahoma, Arial, sans-serif;
        }

        /* Light Theme */
        body.light {
            --bg-dark: #f5f8fb;
            --bg-dark-2: #ffffff;
            --card: #ffffff;
            --text: #052036;
            --text-muted: #475569;
            --border: #e6eef6;
            --glass: rgba(0,0,0,0.02);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: var(--font-sans);
            background: linear-gradient(180deg, var(--bg-dark), var(--bg-dark-2));
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.35s, color 0.35s;
            direction: rtl;
        }

        /* === SPLASH SCREEN === */
        #splash {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 14px;
            background: linear-gradient(135deg, #071024 0%, #06293a 70%);
            overflow: hidden;
        }

        .splash-top {
            width: 92%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: stretch;
            transform-origin: center;
        }

        .splash-bar {
            background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            padding: 18px;
            border-radius: 12px;
            color: #eaf6ff;
            display: flex;
            flex-direction: column;
            gap: 6px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        .splash-bar .role {
            opacity: .9;
            font-size: 13px;
            color: #cfefff;
        }

        .splash-bar.dev { animation: barOutDev 5s cubic-bezier(.2,.9,.3,1) forwards; }
        .splash-bar.mid { animation: barOutMid 5s cubic-bezier(.2,.9,.3,1) forwards; }
        .splash-bar.top { animation: barOutTop 5s cubic-bezier(.2,.9,.3,1) forwards; }

        @keyframes barOutTop { 0%{transform:translateX(0);opacity:1} 60%{opacity:1} 100%{transform:translateX(-150%);opacity:0} }
        @keyframes barOutMid { 0%{transform:translateX(0);opacity:1} 60%{opacity:1} 100%{transform:translateY(-120%);opacity:0} }
        @keyframes barOutDev { 0%{transform:translateX(0);opacity:1} 60%{opacity:1} 100%{transform:translateX(150%);opacity:0} }

        .splash-note { color: #cfefff; opacity: .95; }

        /* === DECORATIONS === */
        .decoration {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 5;
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.08), rgba(255,255,255,0.01));
            filter: blur(8px);
            opacity: .5;
            animation: float 9s ease-in-out infinite;
        }

        @keyframes float { 0%{transform:translateY(0)} 50%{transform:translateY(-50px)} 100%{transform:translateY(0)} }

        .glow {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            opacity: .7;
        }

        /* === LOGIN SCREEN === */
        #login-screen {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #071024 0%, #06293a 70%);
        }

        .login-container {
            background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .login-title {
            text-align: center;
            color: #eaf6ff;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-input {
            width: 100%;
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #eaf6ff;
            font-family: var(--font-sans);
            font-size: 16px;
            direction: rtl;
        }

        .login-input::placeholder {
            color: rgba(234, 246, 255, 0.7);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(10, 155, 214, 0.3);
        }

        .login-btn {
            padding: 15px 30px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            color: var(--bg-dark);
            cursor: pointer;
            font-weight: 700;
            font-family: var(--font-sans);
            font-size: 16px;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(10, 155, 214, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            color: var(--danger);
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-line;
            padding: 10px;
            background: rgba(255, 82, 82, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 82, 82, 0.3);
        }

        .login-toggle {
            text-align: center;
            margin-top: 20px;
            color: rgba(234, 246, 255, 0.8);
            font-size: 14px;
        }

        .login-toggle button {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
            font-family: var(--font-sans);
        }

        /* === MAIN APPLICATION === */
        .app-container {
            position: relative;
            z-index: 10;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: none;
        }

        .main-card {
            background: linear-gradient(180deg, var(--glass), rgba(255,255,255,0.01));
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* === HEADER === */
        .header {
            padding: 16px 24px;
            text-align: center;
            font-weight: 700;
            background: linear-gradient(90deg, #072a40, #0a5f86);
            color: white;
            box-shadow: 0 6px 20px rgba(2,6,23,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.3rem;
            flex: 1;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .logout-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 12px;
        }

        /* === NAVIGATION === */
        .nav-container {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        /* === BUTTONS === */
        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            color: var(--bg-dark);
            cursor: pointer;
            font-weight: 700;
            min-width: 160px;
            font-family: var(--font-sans);
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(10, 155, 214, 0.3);
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn.ghost:hover {
            background: var(--glass);
            border-color: var(--accent);
        }

        .btn.active {
            opacity: 1;
            background: linear-gradient(90deg, var(--accent-2), var(--accent));
        }

        .btn.inactive {
            opacity: 0.7;
        }

        .btn.danger {
            background: linear-gradient(90deg, var(--danger), #ff7676);
        }

        /* === PANELS === */
        .panel {
            padding: 24px;
            display: none;
        }

        .panel.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        .panel-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 24px;
            text-align: right;
        }

        /* === FORMS === */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        @media (min-width: 1024px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--glass);
            color: var(--text);
            font-family: var(--font-sans);
            font-size: 14px;
            transition: all 0.3s;
            direction: rtl;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(10, 155, 214, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        /* === RESULTS === */
        .result-box {
            background: linear-gradient(180deg, rgba(0,0,0,0.3), rgba(0,0,0,0.2));
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            min-height: 120px;
        }

        .result-box.success {
            border-color: var(--success);
            background: linear-gradient(180deg, rgba(22,163,74,0.1), rgba(22,163,74,0.05));
        }

        .result-box.warning {
            border-color: var(--warning);
            background: linear-gradient(180deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));
        }

        .result-box.error {
            border-color: var(--danger);
            background: linear-gradient(180deg, rgba(255,82,82,0.1), rgba(255,82,82,0.05));
        }

        .result-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }

        .result-unit {
            font-size: 1rem;
            margin-right: 8px;
            color: var(--text-muted);
        }

        .result-details {
            margin-top: 12px;
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* === USER MANAGEMENT TABLE === */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--glass);
            border-radius: 12px;
            overflow: hidden;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .users-table th {
            background: var(--accent);
            color: white;
            font-weight: 600;
        }

        .users-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .user-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(22,163,74,0.2);
            color: var(--success);
        }

        .status-blocked {
            background: rgba(255,82,82,0.2);
            color: var(--danger);
        }

        .status-owner {
            background: rgba(245,158,11,0.2);
            color: var(--warning);
        }

        /* Chat and additional styles */
        .chatBox {
            height: 140px;
            overflow: auto;
            padding: 10px;
            background: rgba(255,255,255,0.012);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .sideEffect {
            background: rgba(255,60,60,0.06);
            border-left: 4px solid rgba(255,80,80,0.9);
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
        }

        .pill {
            display: inline-block;
            padding: 6px 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 999px;
            margin: 6px 6px 0 0;
            color: #dff6ff;
        }

        /* === ANIMATIONS === */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === UTILITIES === */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--text-muted); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .flex-1 { flex: 1; }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                min-width: 0;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .users-table {
                font-size: 12px;
            }
            
            .users-table th,
            .users-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- FIREBASE INSTRUCTIONS MODAL -->
    <div id="firebase-modal" class="hidden" style="position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #eaf6ff;">🔧 تعليمات إعداد Google Authentication</h3>
                <button onclick="hideFirebaseInstructions()" style="background: none; border: none; color: #eaf6ff; font-size: 20px; cursor: pointer;">✕</button>
            </div>
            
            <div style="color: #eaf6ff; line-height: 1.6; font-size: 14px;">
                <p><strong>لحل مشكلة تسجيل الدخول بـ Google، اتبع هذه الخطوات:</strong></p>
                
                <ol style="text-align: right; margin-right: 20px;">
                    <li><strong>اذهب إلى Firebase Console:</strong><br>
                        <a href="https://console.firebase.google.com/" target="_blank" style="color: #11cdef;">https://console.firebase.google.com/</a>
                    </li>
                    
                    <li><strong>اختر مشروع "anesthesia-dose-262e3"</strong></li>
                    
                    <li><strong>فعّل Google Authentication:</strong><br>
                        • Authentication → Sign-in method<br>
                        • فعّل "Google" واضغط Save
                    </li>
                    
                    <li><strong>أضف النطاقات المُصرح بها:</strong><br>
                        • Authentication → Settings → Authorized domains<br>
                        • أضف نطاق موقعك (مثال: yoursite.com)
                    </li>
                    
                    <li><strong>تأكد من إعدادات OAuth:</strong><br>
                        • Project Settings → General<br>
                        • تحقق من صحة Support email
                    </li>
                </ol>
                
                <div style="background: rgba(255,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <strong>⚠️ ملاحظة مهمة:</strong><br>
                    قد تحتاج إلى انتظار 5-10 دقائق بعد حفظ الإعدادات حتى تصبح فعالة.
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button type="button" onclick="hideFirebaseInstructions()" class="login-btn" style="min-width: 120px;">فهمت</button>
            </div>
        </div>
    </div>

    <!-- SPLASH SCREEN -->
    <div id="splash">
        <div class="splash-top" style="width:86%">
            <div class="splash-bar top">
                <strong>شريط 1 — أكاديمية ANS الطبية</strong>
                <div class="role">حساب الجرعات المتطور</div>
            </div>

            <div class="splash-bar mid">
                <strong>شريط 2 — منظّم</strong>
                <div class="role">مصطفى احمد عبد شكير — @871c</div>
            </div>

            <div class="splash-bar dev">
                <strong>مصطفى مكي عبدالرضا</strong>
                <div class="role">منظم و مطور الموقع — @ku56t</div>
            </div>
        </div>

        <div class="splash-note">جاري التحميل — انتظر قليلاً لفتح الواجهة</div>

        <!-- decorative sparkles -->
        <div style="position:absolute;inset:0;pointer-events:none">
            <div style="position:absolute;left:6%;top:20%;width:14px;height:14px;background:rgba(255,255,255,0.12);border-radius:50%;filter:blur(6px);animation:float 7s infinite;"></div>
            <div style="position:absolute;right:12%;top:36%;width:18px;height:18px;background:rgba(255,255,255,0.08);border-radius:50%;filter:blur(9px);animation:float 9s infinite;"></div>
        </div>
    </div>

    <!-- decoration bubbles -->
    <div class="decoration" aria-hidden="true">
        <div class="bubble" style="left:3%;top:10%;width:140px;height:140px;animation-duration:10s"></div>
        <div class="bubble" style="left:82%;top:18%;width:100px;height:100px;animation-duration:12s"></div>
        <div class="bubble" style="left:22%;top:75%;width:90px;height:90px;animation-duration:8s"></div>
        <div class="bubble" style="left:68%;top:82%;width:120px;height:120px;animation-duration:11s"></div>
        <div class="glow" style="left:2%;top:72%;width:300px;height:300px;background:radial-gradient(circle,#11cdef44,transparent);"></div>
        <div class="glow" style="right:2%;top:60%;width:260px;height:260px;background:radial-gradient(circle,#0a9bd644,transparent);"></div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-title">🏥 أكاديمية ANS الطبية</div>
            
            <div id="login-form" class="login-form">
                <input type="email" class="login-input" id="login-email" placeholder="البريد الإلكتروني" required>
                <input type="password" class="login-input" id="login-password" placeholder="كلمة المرور" required>
                
                <button class="login-btn" id="login-btn" type="button" onclick="handleLogin()">تسجيل الدخول</button>
                <button class="login-btn" id="google-login-btn" type="button" onclick="handleGoogleLogin()" style="background: #4285f4; margin-top: 10px;">
                    🔗 تسجيل الدخول بـ Google
                </button>
                <div id="login-error" class="login-error hidden"></div>
                
                <div class="login-toggle">
                    ليس لديك حساب؟ <button onclick="toggleLoginMode()">إنشاء حساب جديد</button>
                </div>
                
                <div class="login-toggle">
                    مشكلة في تسجيل الدخول بـ Google؟ <button onclick="showFirebaseInstructions()">تعليمات الإعداد</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(10,155,214,0.1); border-radius: 8px; border: 1px solid rgba(10,155,214,0.3);">
                    <h4 style="margin: 0 0 10px; color: #11cdef;">🔑 حسابات تجريبية متاحة:</h4>
                    <div style="font-size: 13px; color: #eaf6ff; line-height: 1.4;">
                        <strong>المالك:</strong> bama47686@gmail.com / mustafa@2006#2<br>
                        <strong>تجريبي:</strong> demo@ans.com / demo123
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: rgba(234, 246, 255, 0.7);">
                        ⚠️ يعمل التطبيق في الوضع المحلي إذا فشل الاتصال بـ Firebase
                    </div>
                </div>
            </div>
            
            <div id="register-form" class="login-form hidden">
                <input type="text" class="login-input" id="register-name" placeholder="الاسم الكامل" required>
                <input type="email" class="login-input" id="register-email" placeholder="البريد الإلكتروني" required>
                <input type="password" class="login-input" id="register-password" placeholder="كلمة المرور (6 أحرف على الأقل)" required>
                <input type="password" class="login-input" id="register-confirm" placeholder="تأكيد كلمة المرور" required>
                <button class="login-btn" id="register-btn" type="button" onclick="handleRegister()">إنشاء حساب</button>
                <button class="login-btn" id="google-register-btn" type="button" onclick="handleGoogleLogin()" style="background: #4285f4; margin-top: 10px;">
                    🔗 التسجيل بـ Google
                </button>
                <div id="register-error" class="login-error hidden"></div>
                
                <div class="login-toggle">
                    لديك حساب بالفعل؟ <button onclick="toggleLoginMode()">تسجيل الدخول</button>
                </div>
                
                <div class="login-toggle">
                    مشكلة في التسجيل بـ Google؟ <button onclick="showFirebaseInstructions()">تعليمات الإعداد</button>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(10,155,214,0.1); border-radius: 8px; border: 1px solid rgba(10,155,214,0.3);">
                    <h4 style="margin: 0 0 10px; color: #11cdef;">ℹ️ معلومات التسجيل:</h4>
                    <div style="font-size: 13px; color: #eaf6ff; line-height: 1.4;">
                        • استخدم بريد إلكتروني صحيح<br>
                        • كلمة المرور 6 أحرف على الأقل<br>
                        • سيتم إنشاء حساب جديد تلقائياً
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div class="app-container" id="app">
        <div class="main-card">
            <!-- HEADER -->
            <div class="header">
                <h1>🏥 أكاديمية ANS الطبية — حساب الجرعات المتطور</h1>
                <div class="user-info">
                    <span id="user-name">المستخدم</span>
                    <span id="user-id" class="text-muted"></span>
                    <button class="logout-btn" onclick="handleLogout()">تسجيل خروج</button>
                </div>
            </div>

            <!-- NAVIGATION -->
            <div class="nav-container">
                <div class="nav-buttons">
                    <button class="btn" id="dose-btn" onclick="showPanel('dose')">💉 حساب الجرعات</button>
                    <button class="btn" id="fluid-btn" onclick="showPanel('fluid')">💧 السوائل والدم</button>
                    <button class="btn" id="airway-btn" onclick="showPanel('airway')">🫁 إدارة المجرى الهوائي</button>
                    <button class="btn" id="admin-btn" onclick="showPanel('admin')" style="display: none;">⚙️ لوحة التحكم</button>
                    <button class="btn ghost" onclick="toggleTheme()">🌙 تبديل الوضع</button>
                </div>
            </div>

            <!-- DOSE CALCULATION PANEL -->
            <div id="dose-panel" class="panel active">
                <h2 class="panel-title">💉 حساب جرعات التخدير</h2>
                
                <div class="form-grid">
                    <div class="form-section">
                        <div class="form-group">
                            <label class="form-label">اسم المريض</label>
                            <input type="text" class="form-input" id="patient-name" placeholder="اسم المريض">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">الوزن (كغ)</label>
                                <input type="number" class="form-input" id="patient-weight" placeholder="70">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">العمر</label>
                                <input type="number" class="form-input" id="patient-age" placeholder="40">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">الدواء</label>
                            <select class="form-select" id="drug-select">
                                <option value="">اختر الدواء</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">نوع الجرعة</label>
                            <select class="form-select" id="dose-type">
                                <option value="induction">جرعة الحث</option>
                                <option value="maintenance">جرعة الصيانة</option>
                                <option value="pediatric">جرعة الأطفال</option>
                            </select>
                        </div>
                        
                        <div class="form-controls">
                            <button class="btn" onclick="calculateDose()">احسب الجرعة</button>
                            <button class="btn ghost" onclick="clearDoseForm()">مسح البيانات</button>
                            <button class="btn ghost" onclick="openScanner()">📷 مسح ضوئي</button>
                        </div>
                        
                        <div style="margin-top: 12px; font-size: 13px; color: var(--text-muted);">
                            ⚠️ هذه النتائج للإرشاد الطبي فقط - راجع الإرشادات السريرية دائماً
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div id="dose-result" class="result-box">
                            <h3>النتيجة</h3>
                            <p>اختر المريض والدواء وانقر "احسب الجرعة"</p>
                        </div>
                        
                        <div id="drug-info" class="result-box" style="margin-top: 16px; display: none;">
                            <h4>معلومات الدواء</h4>
                            <div id="drug-details"></div>
                        </div>
                    </div>
                </div>

                <!-- Chat Section -->
                <div style="margin-top: 24px;">
                    <h3>💬 الاستشارة الطبية الذكية</h3>
                    <div class="chatBox" id="dose-chat"></div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input class="form-input" id="dose-chat-input" placeholder="اسأل عن الجرعات أو الأدوية..." style="flex: 1;">
                        <button class="btn" onclick="sendChatMessage('dose')">أرسل</button>
                    </div>
                </div>
            </div>

            <!-- FLUID CALCULATION PANEL -->
            <div id="fluid-panel" class="panel">
                <h2 class="panel-title">💧 حساب السوائل والدم</h2>
                
                <div class="form-grid">
                    <div class="form-section">
                        <div class="form-group">
                            <label class="form-label">اسم المريض</label>
                            <input type="text" class="form-input" id="fluid-patient-name" placeholder="اسم المريض">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">الوزن (كغ)</label>
                                <input type="number" class="form-input" id="fluid-weight" placeholder="70">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">العمر</label>
                                <input type="number" class="form-input" id="fluid-age" placeholder="40">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">نوع السائل</label>
                            <select class="form-select" id="fluid-type">
                                <option value="maintenance">السوائل الأساسية</option>
                                <option value="replacement">سوائل التعويض</option>
                                <option value="blood">نقل الدم</option>
                            </select>
                        </div>
                        
                        <div class="form-controls">
                            <button class="btn" onclick="calculateFluid()">احسب السوائل</button>
                            <button class="btn ghost" onclick="clearFluidForm()">مسح البيانات</button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div id="fluid-result" class="result-box">
                            <h3>نتيجة حساب السوائل</h3>
                            <p>أدخل بيانات المريض وانقر "احسب السوائل"</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Section -->
                <div style="margin-top: 24px;">
                    <h3>💬 استشارة السوائل والدم</h3>
                    <div class="chatBox" id="fluid-chat"></div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input class="form-input" id="fluid-chat-input" placeholder="اسأل عن السوائل أو نقل الدم..." style="flex: 1;">
                        <button class="btn" onclick="sendChatMessage('fluid')">أرسل</button>
                    </div>
                </div>
            </div>

            <!-- AIRWAY MANAGEMENT PANEL -->
            <div id="airway-panel" class="panel">
                <h2 class="panel-title">🫁 إدارة المجرى الهوائي</h2>
                
                <div class="form-grid">
                    <div class="form-section">
                        <div class="form-group">
                            <label class="form-label">اسم المريض</label>
                            <input type="text" class="form-input" id="airway-patient-name" placeholder="اسم المريض">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">العمر (سنوات)</label>
                                <input type="number" class="form-input" id="airway-age" placeholder="5">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">الوزن (كغ)</label>
                                <input type="number" class="form-input" id="airway-weight" placeholder="20">
                            </div>
                        </div>
                        
                        <div class="form-controls">
                            <button class="btn" onclick="calculateAirway()">احسب أحجام الأنابيب</button>
                            <button class="btn ghost" onclick="clearAirwayForm()">مسح البيانات</button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div id="airway-result" class="result-box">
                            <h3>نتيجة حساب المجرى الهوائي</h3>
                            <p>أدخل عمر ووزن المريض لحساب أحجام الأنابيب المناسبة</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Section -->
                <div style="margin-top: 24px;">
                    <h3>💬 استشارة المجرى الهوائي</h3>
                    <div class="chatBox" id="airway-chat"></div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <input class="form-input" id="airway-chat-input" placeholder="اسأل عن إدارة المجرى الهوائي..." style="flex: 1;">
                        <button class="btn" onclick="sendChatMessage('airway')">أرسل</button>
                    </div>
                </div>
            </div>

            <!-- ADMIN PANEL -->
            <div id="admin-panel" class="panel">
                <h2 class="panel-title">⚙️ لوحة تحكم المالك</h2>
                
                <div id="admin-stats" class="form-grid" style="margin-bottom: 24px;">
                    <div class="result-box success">
                        <h3>📊 إحصائيات النظام</h3>
                        <div style="display: flex; justify-content: space-between; margin-top: 12px;">
                            <div class="text-center">
                                <div class="result-value" id="total-users">0</div>
                                <div class="result-unit">المستخدمين</div>
                            </div>
                            <div class="text-center">
                                <div class="result-value" id="total-calculations">0</div>
                                <div class="result-unit">العمليات الحسابية</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <h3>🔧 أدوات الإدارة</h3>
                        <div class="form-controls">
                            <button class="btn" onclick="refreshUsersList()">تحديث المستخدمين</button>
                            <button class="btn ghost" onclick="exportAllData()">تصدير البيانات</button>
                            <button class="btn danger" onclick="clearAllSystemData()">مسح جميع البيانات</button>
                        </div>
                    </div>
                </div>
                
                <div class="result-box">
                    <h3>👥 إدارة المستخدمين</h3>
                    <div id="users-list-container">
                        <p>جاري تحميل قائمة المستخدمين...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scanner-modal" class="hidden" style="position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;">
        <div style="background: var(--card); border-radius: 20px; padding: 24px; width: 90%; max-width: 500px; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: var(--text);">📷 مسح ضوئي للوصفة</h3>
                <button onclick="closeScanner()" style="background: none; border: none; color: var(--text); font-size: 20px; cursor: pointer;">✕</button>
            </div>
            
            <video id="scanner-video" autoplay style="width: 100%; border-radius: 12px; margin-bottom: 16px;"></video>
            
            <div class="form-controls">
                <button class="btn" onclick="captureImage()">التقاط صورة</button>
                <button class="btn ghost" onclick="closeScanner()">إغلاق</button>
            </div>
            
            <div id="scan-result" style="margin-top: 16px; display: none;" class="result-box">
                <h4>نتيجة المسح الضوئي</h4>
                <div id="scan-text"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let userData = {};
        let isLoginMode = true;
        let currentPanel = 'dose';

        // Drug database with comprehensive information
        const drugDatabase = {
            propofol: {
                name: 'Propofol (بروبوفول)',
                induction: { dose: '2-2.5', unit: 'mg/kg', range: '1.5-3' },
                maintenance: { dose: '4-12', unit: 'mg/kg/hr', range: '2-15' },
                pediatric: { dose: '2.5-3.5', unit: 'mg/kg', range: '2-4' },
                sideEffects: ['انخفاض ضغط الدم', 'هبوط تنفسي', 'ألم عند الحقن', 'متلازمة الحقن'],
                contraindications: ['حساسية من فول الصويا', 'حساسية من البيض'],
                onset: '15-45 ثانية',
                duration: '5-10 دقائق'
            },
            midazolam: {
                name: 'Midazolam (ميدازولام)',
                induction: { dose: '0.15-0.3', unit: 'mg/kg', range: '0.1-0.4' },
                maintenance: { dose: '0.02-0.1', unit: 'mg/kg/hr', range: '0.01-0.2' },
                pediatric: { dose: '0.1-0.15', unit: 'mg/kg', range: '0.05-0.2' },
                sideEffects: ['تهدئة مطولة', 'هبوط تنفسي', 'فقدان ذاكرة مؤقت'],
                contraindications: ['الوهن العضلي الشديد', 'متلازمة توقف التنفس'],
                onset: '2-5 دقائق',
                duration: '1-6 ساعات'
            },
            fentanyl: {
                name: 'Fentanyl (فنتانيل)',
                induction: { dose: '1-3', unit: 'mcg/kg', range: '0.5-5' },
                maintenance: { dose: '0.5-2', unit: 'mcg/kg/hr', range: '0.2-5' },
                pediatric: { dose: '1-3', unit: 'mcg/kg', range: '0.5-5' },
                sideEffects: ['هبوط تنفسي', 'غثيان وقيء', 'حكة', 'تصلب عضلي'],
                contraindications: ['حساسية من الأفيونات', 'إصابة الرأس الشديدة'],
                onset: '1-2 دقيقة',
                duration: '30-60 دقيقة'
            },
            morphine: {
                name: 'Morphine (مورفين)',
                induction: { dose: '0.1-0.2', unit: 'mg/kg', range: '0.05-0.3' },
                maintenance: { dose: '0.02-0.05', unit: 'mg/kg/hr', range: '0.01-0.1' },
                pediatric: { dose: '0.05-0.1', unit: 'mg/kg', range: '0.02-0.15' },
                sideEffects: ['هبوط تنفسي', 'إمساك', 'غثيان وقيء', 'حكة'],
                contraindications: ['حساسية من الأفيونات', 'الربو الحاد'],
                onset: '5-10 دقائق',
                duration: '2-4 ساعات'
            },
            ketamine: {
                name: 'Ketamine (كيتامين)',
                induction: { dose: '1-2', unit: 'mg/kg IV', range: '0.5-3' },
                maintenance: { dose: '0.5-1', unit: 'mg/kg/hr', range: '0.2-2' },
                pediatric: { dose: '1-2', unit: 'mg/kg', range: '0.5-3' },
                sideEffects: ['هلوسة', 'أحلام مزعجة', 'ارتفاع ضغط الدم', 'زيادة إفراز اللعاب'],
                contraindications: ['ارتفاع ضغط الدم غير المسيطر عليه', 'أمراض القلب التاجية'],
                onset: '30-60 ثانية',
                duration: '5-15 دقيقة'
            },
            atracurium: {
                name: 'Atracurium (أتراكوريوم)',
                induction: { dose: '0.4-0.5', unit: 'mg/kg', range: '0.3-0.6' },
                pediatric: { dose: '0.3-0.4', unit: 'mg/kg', range: '0.2-0.5' },
                sideEffects: ['تحرر الهيستامين', 'احمرار الجلد', 'هبوط ضغط خفيف'],
                contraindications: ['حساسية من الباراكوات', 'وهن العضلات الشديد'],
                onset: '2-3 دقائق',
                duration: '20-40 دقيقة'
            }
        };

        // === INITIALIZATION ===
        window.onload = function() {
            console.log('App initializing...');
            
            // Hide splash and show login screen immediately
            setTimeout(() => {
                hideSplash();
                showLoginScreen();
            }, 3000);
            
            // Initialize drug dropdown
            initializeDrugDropdown();
            
            // Initialize Firebase when ready
            initializeFirebase();
        };

        async function initializeFirebase() {
            try {
                console.log('Initializing Firebase...');
                
                // Set timeout for Firebase initialization
                const firebaseTimeout = setTimeout(() => {
                    console.warn('Firebase timeout, switching to local mode');
                    initializeLocalMode();
                }, 5000);
                
                // Wait for Firebase to be available
                if (!window.firebaseAuth) {
                    console.error('Firebase Auth not available, using local mode');
                    clearTimeout(firebaseTimeout);
                    initializeLocalMode();
                    return;
                }
                
                // Check for redirect result first
                try {
                    const result = await window.firebaseAuthFunctions.getRedirectResult(window.firebaseAuth);
                    if (result && result.user) {
                        console.log('User signed in via redirect:', result.user);
                        clearTimeout(firebaseTimeout);
                        await handleUserLogin(result.user);
                        return;
                    }
                } catch (error) {
                    console.error('Redirect result error:', error);
                }
                
                // Check authentication state with timeout protection
                window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
                    console.log('Auth state changed:', user ? user.email : 'No user');
                    if (user) {
                        try {
                            await handleUserLogin(user);
                            clearTimeout(firebaseTimeout);
                        } catch (error) {
                            console.error('handleUserLogin failed, switching to local mode:', error);
                            clearTimeout(firebaseTimeout);
                            
                            // Auto-login for owner if Firebase fails
                            if (user.email === 'bama47686@gmail.com') {
                                loginAsLocalOwner();
                            } else {
                                initializeLocalMode();
                            }
                        }
                    } else {
                        clearTimeout(firebaseTimeout);
                        showLoginScreen();
                    }
                });
                
                console.log('Firebase initialized successfully');
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                initializeLocalMode();
            }
        }

        function initializeLocalMode() {
            console.log('Initializing local mode...');
            showLoginScreen();
            
            // Add local mode indicator to login screen
            const loginScreen = document.getElementById('login-screen');
            if (loginScreen && !document.getElementById('local-mode-banner')) {
                const banner = document.createElement('div');
                banner.id = 'local-mode-banner';
                banner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #f59e0b;
                    color: white;
                    text-align: center;
                    padding: 8px;
                    font-size: 14px;
                    z-index: 10001;
                `;
                banner.textContent = '⚠️ وضع محلي - Firebase غير متاح';
                document.body.appendChild(banner);
            }
        }
        
        // Initialize owner account
        async function initializeOwnerAccount() {
            try {
                console.log('Owner account initialization completed');
            } catch (error) {
                console.log('Owner account will be created on first login');
            }
        }

        // Initialize drug dropdown
        function initializeDrugDropdown() {
            const select = document.getElementById('drug-select');
            if (select) {
                select.innerHTML = '<option value="">اختر الدواء</option>';
                Object.keys(drugDatabase).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = drugDatabase[key].name;
                    select.appendChild(option);
                });
            }
        }

        // === AUTHENTICATION FUNCTIONS ===
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
            document.getElementById('splash').style.display = 'none';
        }

        function hideLoginScreen() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            hideSplash();
        }

        function hideSplash() {
            const splash = document.getElementById('splash');
            if (splash && splash.style.display !== 'none') {
                splash.style.transition = 'opacity .25s, transform .25s';
                splash.style.opacity = '0';
                splash.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    splash.style.display = 'none';
                }, 300);
            }
        }

        function toggleLoginMode() {
            isLoginMode = !isLoginMode;
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (isLoginMode) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            }
            
            clearErrors();
        }

        function clearErrors() {
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('register-error').classList.add('hidden');
        }

        function showError(type, message) {
            const errorElement = document.getElementById(type + '-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        async function handleLogin() {
            console.log('Login button clicked');
            const email = document.getElementById('login-email').value?.trim();
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');
            
            if (!email || !password) {
                showError('login', 'يرجى إدخال البريد الإلكتروني وكلمة المرور');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'جاري تسجيل الدخول...';
            clearErrors();
            
            try {
                console.log('Attempting login for:', email);
                
                // Check if Firebase is available
                if (!window.firebaseAuth || !window.firebaseAuthFunctions) {
                    console.error('Firebase not initialized');
                    throw new Error('Firebase غير متاح. استخدم الوضع المحلي.');
                }
                
                // Special handling for owner account
                if (email === 'bama47686@gmail.com' && password === 'mustafa@2006#2') {
                    console.log('Owner login detected');
                    try {
                        const userCredential = await window.firebaseAuthFunctions.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                        console.log('Owner login successful');
                    } catch (loginError) {
                        if (loginError.code === 'auth/user-not-found') {
                            console.log('Creating owner account...');
                            const userCredential = await window.firebaseAuthFunctions.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                            console.log('Owner account created successfully');
                        } else {
                            throw loginError;
                        }
                    }
                } else {
                    // Regular user login
                    const userCredential = await window.firebaseAuthFunctions.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    console.log('Regular login successful:', userCredential.user.email);
                }
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Fallback to local mode for owner
                if (email === 'bama47686@gmail.com' && password === 'mustafa@2006#2') {
                    console.log('Firebase failed, using local owner mode');
                    loginAsLocalOwner();
                    return;
                }
                
                let errorMessage = 'حدث خطأ في تسجيل الدخول';
                
                if (error.message && error.message.includes('Firebase غير متاح')) {
                    errorMessage = 'خطأ في الاتصال بالخادم. جاري المحاولة في الوضع المحلي...';
                    
                    // Try local mode for demo
                    if (email === 'demo@ans.com' && password === 'demo123') {
                        setTimeout(() => {
                            loginAsDemo();
                        }, 1000);
                        return;
                    }
                } else if (error.code) {
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'البريد الإلكتروني غير مسجل. جرب إنشاء حساب جديد';
                            break;
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            errorMessage = 'كلمة المرور غير صحيحة';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'البريد الإلكتروني غير صحيح';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'هذا الحساب معطل. تواصل مع الإدارة';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'محاولات تسجيل دخول كثيرة. حاول مرة أخرى لاحقاً';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'خطأ في الشبكة. تحقق من اتصال الإنترنت';
                            break;
                    }
                }
                
                showError('login', errorMessage);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'تسجيل الدخول';
            }
        }

        // Local fallback functions
        function loginAsLocalOwner() {
            currentUser = {
                uid: 'local-owner',
                email: 'bama47686@gmail.com',
                displayName: 'مصطفى المالك'
            };
            
            userData = {
                uid: 'local-owner',
                email: 'bama47686@gmail.com',
                displayName: 'مصطفى المالك',
                userId: 'ANS001',
                role: 'owner',
                isBlocked: false,
                createdAt: new Date(),
                lastLogin: new Date(),
                calculationsCount: 0,
                loginMethod: 'local'
            };
            
            console.log('Local owner login successful');
            hideLoginScreen();
            
            document.getElementById('user-name').textContent = 'مصطفى المالك (وضع محلي)';
            document.getElementById('user-id').textContent = '(ANS001)';
            document.getElementById('admin-btn').style.display = 'block';
        }

        function loginAsDemo() {
            currentUser = {
                uid: 'demo-user',
                email: 'demo@ans.com',
                displayName: 'مستخدم تجريبي'
            };
            
            userData = {
                uid: 'demo-user',
                email: 'demo@ans.com',
                displayName: 'مستخدم تجريبي',
                userId: 'ANS999',
                role: 'user',
                isBlocked: false,
                createdAt: new Date(),
                lastLogin: new Date(),
                calculationsCount: 0,
                loginMethod: 'local'
            };
            
            console.log('Demo login successful');
            hideLoginScreen();
            
            document.getElementById('user-name').textContent = 'مستخدم تجريبي (وضع محلي)';
            document.getElementById('user-id').textContent = '(ANS999)';
        }

        async function handleGoogleLogin() {
            console.log('Starting Google login...');
            const googleLoginBtn = document.getElementById('google-login-btn') || document.getElementById('google-register-btn');
            
            if (googleLoginBtn) {
                googleLoginBtn.disabled = true;
                googleLoginBtn.textContent = 'جاري تسجيل الدخول...';
            }
            clearErrors();
            
            try {
                if (!window.firebaseAuth || !window.googleProvider) {
                    throw new Error('Firebase not properly initialized');
                }
                
                console.log('Firebase Auth initialized, attempting Google sign-in...');
                
                window.googleProvider = new window.firebaseAuthFunctions.GoogleAuthProvider();
                window.googleProvider.setCustomParameters({
                    prompt: 'select_account'
                });
                
                window.googleProvider.addScope('email');
                window.googleProvider.addScope('profile');
                
                console.log('Google provider configured, attempting popup...');
                
                let result;
                try {
                    result = await window.firebaseAuthFunctions.signInWithPopup(window.firebaseAuth, window.googleProvider);
                    console.log('Popup sign-in successful:', result.user.email);
                } catch (popupError) {
                    console.warn('Popup sign-in failed:', popupError.code, popupError.message);
                    
                    if (popupError.code === 'auth/popup-blocked' || 
                        popupError.code === 'auth/cancelled-popup-request' ||
                        popupError.code === 'auth/popup-closed-by-user') {
                        
                        console.log('Trying redirect method...');
                        await window.firebaseAuthFunctions.signInWithRedirect(window.firebaseAuth, window.googleProvider);
                        return;
                    } else {
                        throw popupError;
                    }
                }
                
                const user = result.user;
                console.log('Google login successful for user:', user.email);
                
            } catch (error) {
                console.error('Google login error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                
                let errorMessage = 'حدث خطأ في تسجيل الدخول بـ Google';
                
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        errorMessage = 'تم إغلاق نافذة تسجيل الدخول';
                        break;
                    case 'auth/popup-blocked':
                        errorMessage = 'تم حجب نافذة تسجيل الدخول. يرجى السماح بالنوافذ المنبثقة أو جرب مرة أخرى';
                        break;
                    case 'auth/cancelled-popup-request':
                        errorMessage = 'تم إلغاء تسجيل الدخول';
                        break;
                    case 'auth/account-exists-with-different-credential':
                        errorMessage = 'البريد الإلكتروني مرتبط بطريقة تسجيل دخول أخرى. جرب تسجيل الدخول بالبريد الإلكتروني';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'هذا الحساب معطل. تواصل مع الإدارة';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'تسجيل الدخول بـ Google غير مفعل في Firebase Console. يجب تفعيله أولاً:\n\n1. اذهب إلى Firebase Console\n2. اختر Authentication\n3. فعّل Google Sign-in method\n4. احفظ التغييرات';
                        break;
                    case 'auth/unauthorized-domain':
                        errorMessage = 'هذا النطاق غير مُصرح له في Firebase. أضف النطاق:\n\n1. Firebase Console → Authentication\n2. Settings → Authorized domains\n3. أضف نطاق موقعك';
                        break;
                    default:
                        if (error.message.includes('Firebase not properly initialized')) {
                            errorMessage = 'خطأ في تهيئة النظام. يرجى إعادة تحميل الصفحة';
                        } else {
                            errorMessage = `خطأ في تسجيل الدخول بـ Google: ${error.message}`;
                        }
                }
                
                if (error.code !== 'auth/cancelled-popup-request') {
                    showError(isLoginMode ? 'login' : 'register', errorMessage);
                }
            } finally {
                if (googleLoginBtn) {
                    googleLoginBtn.disabled = false;
                    googleLoginBtn.textContent = isLoginMode ? '🔗 تسجيل الدخول بـ Google' : '🔗 التسجيل بـ Google';
                }
            }
        }

        async function handleRegister() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;
            const registerBtn = document.getElementById('register-btn');
            
            if (!name || !email || !password || !confirmPassword) {
                showError('register', 'يرجى إكمال جميع البيانات');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('register', 'كلمتا المرور غير متطابقتين');
                return;
            }
            
            if (password.length < 6) {
                showError('register', 'كلمة المرور يجب أن تكون 6 أحرف على الأقل');
                return;
            }
            
            registerBtn.disabled = true;
            registerBtn.textContent = 'جاري إنشاء الحساب...';
            clearErrors();
            
            try {
                const userCredential = await window.firebaseAuthFunctions.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                await createUserProfile(user, name);
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'حدث خطأ في إنشاء الحساب';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'البريد الإلكتروني مستخدم بالفعل';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'البريد الإلكتروني غير صحيح';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'كلمة المرور ضعيفة جداً';
                        break;
                }
                
                showError('register', errorMessage);
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'إنشاء حساب';
            }
        }

        async function createUserProfile(user, displayName) {
            try {
                console.log('Creating user profile for:', user.email);
                
                const usersSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'users')
                );
                const userCount = usersSnapshot.size;
                
                const isOwner = user.email === 'bama47686@gmail.com';
                const userId = isOwner ? 'ANS001' : `ANS${String(userCount + 2).padStart(3, '0')}`;
                
                const finalDisplayName = displayName || user.displayName || (isOwner ? 'مصطفى المالك' : user.email.split('@')[0]);
                
                const userProfile = {
                    uid: user.uid,
                    email: user.email,
                    displayName: finalDisplayName,
                    userId: userId,
                    role: isOwner ? 'owner' : 'user',
                    isBlocked: false,
                    createdAt: new Date(),
                    lastLogin: new Date(),
                    calculationsCount: 0,
                    loginMethod: user.providerData && user.providerData.length > 0 ? 
                        (user.providerData[0].providerId === 'google.com' ? 'google' : 'email') : 'email'
                };
                
                console.log('User profile data:', userProfile);
                
                await window.firebaseDbFunctions.setDoc(
                    window.firebaseDbFunctions.doc(window.firebaseDb, 'users', user.uid),
                    userProfile
                );
                
                console.log('User profile created successfully:', finalDisplayName);
                return userProfile;
            } catch (error) {
                console.error('Error creating user profile:', error);
                throw error;
            }
        }

        async function handleUserLogin(user) {
            try {
                console.log('Handling user login for:', user.email);
                
                // Try to get user data from Firestore, but fallback to local mode if fails
                let userData = null;
                try {
                    if (window.firebaseDb && window.firebaseDbFunctions) {
                        const userDocRef = window.firebaseDbFunctions.doc(window.firebaseDb, 'users', user.uid);
                        let userDoc = await window.firebaseDbFunctions.getDoc(userDocRef);
                        
                        if (userDoc.exists()) {
                            userData = userDoc.data();
                            console.log('User data loaded from Firestore');
                            
                            // Check if user is blocked
                            if (userData.isBlocked && userData.role !== 'owner') {
                                alert('حسابك معطل. تواصل مع الإدارة.');
                                await handleLogout();
                                return;
                            }
                            
                            // Update last login
                            const updateData = {
                                lastLogin: new Date(),
                            };
                            
                            if (user.providerData && user.providerData.length > 0) {
                                const provider = user.providerData[0].providerId;
                                if (provider === 'google.com') {
                                    updateData.loginMethod = 'google';
                                }
                            }
                            
                            await window.firebaseDbFunctions.updateDoc(userDocRef, updateData);
                            
                        } else {
                            console.log('Creating new user profile...');
                            userData = await createUserProfile(user);
                        }
                    }
                } catch (firestoreError) {
                    console.warn('Firestore failed, using local mode:', firestoreError.message);
                    userData = null; // Will fallback to local mode
                }
                
                // If Firestore failed, create local user data
                if (!userData) {
                    console.log('Creating local user data...');
                    const isOwner = user.email === 'bama47686@gmail.com';
                    userData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || (isOwner ? 'مصطفى المالك (محلي)' : user.email.split('@')[0]),
                        userId: isOwner ? 'ANS001' : 'ANS999',
                        role: isOwner ? 'owner' : 'user',
                        isBlocked: false,
                        createdAt: new Date(),
                        lastLogin: new Date(),
                        calculationsCount: 0,
                        loginMethod: 'local'
                    };
                    
                    // Add local mode banner
                    addLocalModeBanner();
                }
                
                currentUser = user;
                window.userData = userData; // Make it globally accessible
                
                const displayName = userData.displayName || user.displayName || user.email.split('@')[0];
                document.getElementById('user-name').textContent = displayName;
                document.getElementById('user-id').textContent = `(${userData.userId})`;
                
                if (userData.role === 'owner') {
                    document.getElementById('admin-btn').style.display = 'block';
                    console.log('Owner logged in, showing admin panel');
                }
                
                hideLoginScreen();
                console.log('User login handled successfully');
                
            } catch (error) {
                console.error('Error handling user login:', error);
                
                // Fallback for owner account
                if (user.email === 'bama47686@gmail.com') {
                    console.log('Critical fallback: Using owner local mode');
                    loginAsLocalOwner();
                    return;
                }
                
                showError('login', 'حدث خطأ في تحميل بيانات المستخدم. النظام يعمل في الوضع المحلي.');
                
                // Create minimal user data for fallback
                currentUser = user;
                window.userData = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0],
                    userId: 'ANS999',
                    role: 'user',
                    isBlocked: false,
                    loginMethod: 'local-fallback'
                };
                
                document.getElementById('user-name').textContent = window.userData.displayName;
                document.getElementById('user-id').textContent = `(${window.userData.userId})`;
                
                addLocalModeBanner();
                hideLoginScreen();
            }
        }

        function addLocalModeBanner() {
            if (!document.getElementById('local-mode-banner')) {
                const banner = document.createElement('div');
                banner.id = 'local-mode-banner';
                banner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #f59e0b;
                    color: white;
                    text-align: center;
                    padding: 8px;
                    font-size: 14px;
                    z-index: 10001;
                `;
                banner.textContent = '⚠️ وضع محلي - البيانات غير محفوظة على الخادم';
                document.body.appendChild(banner);
            }
        }

        async function handleLogout() {
            try {
                await window.firebaseAuthFunctions.signOut(window.firebaseAuth);
                currentUser = null;
                userData = {};
                document.getElementById('admin-btn').style.display = 'none';
                showLoginScreen();
            } catch (error) {
                console.error('Error signing out:', error);
                alert('حدث خطأ في تسجيل الخروج');
            }
        }

        // === PANEL MANAGEMENT ===
        function showPanel(panelId) {
            // Hide all panels
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.nav-buttons .btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('inactive');
            });
            
            // Show selected panel
            document.getElementById(panelId + '-panel').classList.add('active');
            
            // Add active class to selected button
            const activeBtn = document.getElementById(panelId + '-btn');
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.classList.remove('inactive');
            }
            
            currentPanel = panelId;
            
            // Load admin data if admin panel
            if (panelId === 'admin' && userData.role === 'owner') {
                loadAdminData();
            }
        }

        // === CALCULATION FUNCTIONS ===
        function calculateDose() {
            const patientName = document.getElementById('patient-name').value;
            const weight = parseFloat(document.getElementById('patient-weight').value);
            const age = parseFloat(document.getElementById('patient-age').value);
            const drugKey = document.getElementById('drug-select').value;
            const doseType = document.getElementById('dose-type').value;
            
            if (!weight || !age || !drugKey) {
                document.getElementById('dose-result').innerHTML = `
                    <h3>خطأ في البيانات</h3>
                    <p style="color: var(--danger);">يرجى إدخال جميع البيانات المطلوبة</p>
                `;
                return;
            }
            
            const drug = drugDatabase[drugKey];
            if (!drug) {
                document.getElementById('dose-result').innerHTML = `
                    <h3>خطأ</h3>
                    <p style="color: var(--danger);">الدواء المحدد غير موجود</p>
                `;
                return;
            }
            
            let doseInfo = drug[doseType];
            if (!doseInfo) {
                document.getElementById('dose-result').innerHTML = `
                    <h3>خطأ</h3>
                    <p style="color: var(--danger);">نوع الجرعة المحدد غير متوفر لهذا الدواء</p>
                `;
                return;
            }
            
            const baseDose = parseFloat(doseInfo.dose.split('-')[0]);
            const calculatedDose = (baseDose * weight).toFixed(2);
            
            document.getElementById('dose-result').innerHTML = `
                <h3>نتيجة حساب الجرعة</h3>
                <div class="result-value">${calculatedDose}</div>
                <div class="result-unit">${doseInfo.unit.replace('/kg', '')}</div>
                <div class="result-details">
                    <strong>المريض:</strong> ${patientName || 'غير محدد'}<br>
                    <strong>الدواء:</strong> ${drug.name}<br>
                    <strong>الوزن:</strong> ${weight} كغ<br>
                    <strong>النوع:</strong> ${doseType === 'induction' ? 'جرعة الحث' : doseType === 'maintenance' ? 'جرعة الصيانة' : 'جرعة الأطفال'}<br>
                    <strong>المدى المقترح:</strong> ${doseInfo.range} ${doseInfo.unit}
                </div>
            `;
            
            document.getElementById('dose-result').className = 'result-box success';
            
            // Show drug information
            showDrugInfo(drug);
            
            // Save calculation to Firebase
            saveCalculation('dose', {
                patientName: patientName || 'غير محدد',
                drug: drug.name,
                weight: weight,
                age: age,
                doseType: doseType,
                calculatedDose: calculatedDose,
                unit: doseInfo.unit
            });
        }

        function showDrugInfo(drug) {
            const drugInfoDiv = document.getElementById('drug-info');
            drugInfoDiv.innerHTML = `
                <h4>${drug.name}</h4>
                <div class="result-details">
                    <strong>بداية المفعول:</strong> ${drug.onset}<br>
                    <strong>مدة المفعول:</strong> ${drug.duration}<br>
                    <strong>الآثار الجانبية:</strong><br>
                    ${drug.sideEffects.map(effect => `<span class="pill">${effect}</span>`).join('')}<br>
                    <strong>موانع الاستعمال:</strong><br>
                    ${drug.contraindications.map(contra => `<span class="sideEffect">${contra}</span>`).join('')}
                </div>
            `;
            drugInfoDiv.style.display = 'block';
        }

        function calculateFluid() {
            const patientName = document.getElementById('fluid-patient-name').value;
            const weight = parseFloat(document.getElementById('fluid-weight').value);
            const age = parseFloat(document.getElementById('fluid-age').value);
            const fluidType = document.getElementById('fluid-type').value;
            
            if (!weight || !age) {
                document.getElementById('fluid-result').innerHTML = `
                    <h3>خطأ في البيانات</h3>
                    <p style="color: var(--danger);">يرجى إدخال الوزن والعمر</p>
                `;
                return;
            }
            
            let maintenanceFluid = 0;
            let additionalInfo = '';
            
            // Holliday-Segar method
            if (weight <= 10) {
                maintenanceFluid = weight * 100;
            } else if (weight <= 20) {
                maintenanceFluid = 1000 + (weight - 10) * 50;
            } else {
                maintenanceFluid = 1500 + (weight - 20) * 20;
            }
            
            const hourlyRate = (maintenanceFluid / 24).toFixed(1);
            
            if (fluidType === 'blood') {
                const bloodVolume = weight * 10; // 10-15 ml/kg typically
                additionalInfo = `
                    <div style="margin-top: 16px; padding: 12px; background: rgba(255,82,82,0.1); border-left: 4px solid var(--danger); border-radius: 6px;">
                        <strong>نقل الدم (PRBC):</strong><br>
                        الحجم المقترح: ${bloodVolume} مل (10 مل/كغ)<br>
                        معدل التسريب: 1-2 مل/كغ/ساعة<br>
                        المدة: 2-4 ساعات تقريباً
                    </div>
                `;
            } else if (fluidType === 'replacement') {
                additionalInfo = `
                    <div style="margin-top: 16px; padding: 12px; background: rgba(245,158,11,0.1); border-left: 4px solid var(--warning); border-radius: 6px;">
                        <strong>سوائل التعويض:</strong><br>
                        • فقدان العمليات: 2-10 مل/كغ/ساعة<br>
                        • فقدان معوي: حسب الكمية المفقودة<br>
                        • نزيف: 3:1 نسبة السوائل للدم المفقود
                    </div>
                `;
            }
            
            document.getElementById('fluid-result').innerHTML = `
                <h3>نتيجة حساب السوائل</h3>
                <div class="result-value">${maintenanceFluid}</div>
                <div class="result-unit">مل/24 ساعة</div>
                <div class="result-details">
                    <strong>المريض:</strong> ${patientName || 'غير محدد'}<br>
                    <strong>الوزن:</strong> ${weight} كغ<br>
                    <strong>معدل التسريب:</strong> ${hourlyRate} مل/ساعة<br>
                    <strong>نوع السائل:</strong> ${fluidType === 'maintenance' ? 'سوائل أساسية' : fluidType === 'replacement' ? 'سوائل تعويض' : 'نقل دم'}
                </div>
                ${additionalInfo}
            `;
            
            document.getElementById('fluid-result').className = 'result-box success';
            
            // Save calculation
            saveCalculation('fluid', {
                patientName: patientName || 'غير محدد',
                weight: weight,
                age: age,
                fluidType: fluidType,
                maintenanceFluid: maintenanceFluid,
                hourlyRate: hourlyRate
            });
        }

        function calculateAirway() {
            const patientName = document.getElementById('airway-patient-name').value;
            const age = parseFloat(document.getElementById('airway-age').value);
            const weight = parseFloat(document.getElementById('airway-weight').value);
            
            if (!age) {
                document.getElementById('airway-result').innerHTML = `
                    <h3>خطأ في البيانات</h3>
                    <p style="color: var(--danger);">يرجى إدخال العمر على الأقل</p>
                `;
                return;
            }
            
            // ETT size calculation
            let ettSize;
            if (age < 1) {
                ettSize = 3.5;
            } else if (age < 2) {
                ettSize = 4.0;
            } else {
                ettSize = (age / 4) + 4;
            }
            
            // Laryngoscope blade
            let bladeSize;
            if (age < 1) {
                bladeSize = "0-1 (Miller)";
            } else if (age < 3) {
                bladeSize = "1-2 (Miller أو Mac)";
            } else if (age < 8) {
                bladeSize = "2-3 (Macintosh)";
            } else {
                bladeSize = "3-4 (Macintosh)";
            }
            
            const depth = ettSize * 3;
            const additionalInfo = age < 8 ? 
                '<div style="color: var(--warning); margin-top: 12px;">⚠️ للأطفال تحت 8 سنوات: استخدم uncuffed ETT أو low-pressure cuffed</div>' : '';
            
            document.getElementById('airway-result').innerHTML = `
                <h3>نتيجة حساب المجرى الهوائي</h3>
                <div class="result-value">${ettSize.toFixed(1)}</div>
                <div class="result-unit">مم (ETT)</div>
                <div class="result-details">
                    <strong>المريض:</strong> ${patientName || 'غير محدد'}<br>
                    <strong>العمر:</strong> ${age} سنة<br>
                    ${weight ? `<strong>الوزن:</strong> ${weight} كغ<br>` : ''}
                    <strong>حجم ETT:</strong> ${ettSize.toFixed(1)} مم<br>
                    <strong>عمق الإدخال:</strong> ${depth.toFixed(1)} سم<br>
                    <strong>لارنغوسكوب:</strong> ${bladeSize}
                </div>
                ${additionalInfo}
            `;
            
            document.getElementById('airway-result').className = 'result-box success';
            
            // Save calculation
            saveCalculation('airway', {
                patientName: patientName || 'غير محدد',
                age: age,
                weight: weight || null,
                ettSize: ettSize,
                depth: depth,
                bladeSize: bladeSize
            });
        }

        // === CHAT FUNCTIONS ===
        async function sendChatMessage(section) {
            const inputId = section + '-chat-input';
            const chatId = section + '-chat';
            const input = document.getElementById(inputId);
            const chat = document.getElementById(chatId);
            
            const message = input.value.trim();
            if (!message) return;
            
            // Add user message
            chat.innerHTML += `
                <div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; text-align: right;">
                    <strong>أنت:</strong> ${message}
                </div>
            `;
            
            input.value = '';
            chat.scrollTop = chat.scrollHeight;
            
            // Add loading message
            chat.innerHTML += `
                <div style="margin: 8px 0; color: var(--text-muted);">
                    ⏳ جاري جلب الرد...
                </div>
            `;
            chat.scrollTop = chat.scrollHeight;
            
            try {
                // Simulate AI response (replace with actual OpenAI API call)
                const response = await simulateAIResponse(message, section);
                
                // Remove loading message
                const loadingMsg = chat.lastElementChild;
                if (loadingMsg && loadingMsg.textContent.includes('⏳')) {
                    loadingMsg.remove();
                }
                
                // Add AI response
                chat.innerHTML += `
                    <div style="margin: 8px 0; padding: 8px; background: rgba(10,155,214,0.1); border-radius: 6px; border-left: 3px solid var(--accent);">
                        <strong>AI الطبي:</strong> ${response}
                    </div>
                `;
                
            } catch (error) {
                // Remove loading message
                const loadingMsg = chat.lastElementChild;
                if (loadingMsg && loadingMsg.textContent.includes('⏳')) {
                    loadingMsg.remove();
                }
                
                chat.innerHTML += `
                    <div style="margin: 8px 0; color: var(--danger);">
                        ❌ خطأ في الاتصال بالذكاء الاصطناعي
                    </div>
                `;
            }
            
            chat.scrollTop = chat.scrollHeight;
        }

        async function simulateAIResponse(message, section) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Simple response simulation based on keywords
            const responses = {
                dose: {
                    'جرعة': 'الجرعات تحسب حسب وزن المريض وعمره. تأكد من مراجعة الإرشادات السريرية.',
                    'propofol': 'البروبوفول: جرعة الحث 2-2.5 مغ/كغ، احذر من انخفاض ضغط الدم.',
                    'فنتانيل': 'الفنتانيل: مسكن قوي، جرعة الحث 1-3 مكغ/كغ، راقب التنفس بعناية.',
                    'default': 'يرجى تحديد السؤال أكثر. يمكنني مساعدتك في حساب الجرعات والأدوية.'
                },
                fluid: {
                    'سوائل': 'السوائل الأساسية تحسب بطريقة Holliday-Segar: 100 مل/كغ للأول 10 كغ.',
                    'دم': 'نقل الدم: 10-15 مل/كغ عادة، بمعدل 1-2 مل/كغ/ساعة.',
                    'default': 'السوائل مهمة للحفاظ على توازن الجسم. ما السؤال المحدد؟'
                },
                airway: {
                    'أنبوب': 'حجم الأنبوب = (العمر ÷ 4) + 4 للأطفال فوق السنتين.',
                    'لارنغوسكوب': 'اختيار شفرة اللارنغوسكوب يعتمد على عمر المريض وحجم الفم.',
                    'default': 'إدارة المجرى الهوائي تتطلب دقة. ما السؤال المحدد؟'
                }
            };
            
            const sectionResponses = responses[section] || responses.dose;
            
            for (const keyword in sectionResponses) {
                if (keyword !== 'default' && message.toLowerCase().includes(keyword)) {
                    return sectionResponses[keyword];
                }
            }
            
            return sectionResponses.default;
        }

        // === UTILITY FUNCTIONS ===
        function clearDoseForm() {
            document.getElementById('patient-name').value = '';
            document.getElementById('patient-weight').value = '';
            document.getElementById('patient-age').value = '';
            document.getElementById('drug-select').value = '';
            document.getElementById('dose-result').innerHTML = `
                <h3>النتيجة</h3>
                <p>اختر المريض والدواء وانقر "احسب الجرعة"</p>
            `;
            document.getElementById('dose-result').className = 'result-box';
            document.getElementById('drug-info').style.display = 'none';
        }

        function clearFluidForm() {
            document.getElementById('fluid-patient-name').value = '';
            document.getElementById('fluid-weight').value = '';
            document.getElementById('fluid-age').value = '';
            document.getElementById('fluid-result').innerHTML = `
                <h3>نتيجة حساب السوائل</h3>
                <p>أدخل بيانات المريض وانقر "احسب السوائل"</p>
            `;
            document.getElementById('fluid-result').className = 'result-box';
        }

        function clearAirwayForm() {
            document.getElementById('airway-patient-name').value = '';
            document.getElementById('airway-age').value = '';
            document.getElementById('airway-weight').value = '';
            document.getElementById('airway-result').innerHTML = `
                <h3>نتيجة حساب المجرى الهوائي</h3>
                <p>أدخل عمر ووزن المريض لحساب أحجام الأنابيب المناسبة</p>
            `;
            document.getElementById('airway-result').className = 'result-box';
        }

        function toggleTheme() {
            document.body.classList.toggle('light');
            localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
        }

        // === SCANNER FUNCTIONS ===
        function openScanner() {
            document.getElementById('scanner-modal').classList.remove('hidden');
            document.getElementById('scanner-modal').style.display = 'flex';
            
            // Request camera access
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    document.getElementById('scanner-video').srcObject = stream;
                })
                .catch(error => {
                    alert('لا يمكن الوصول للكاميرا: ' + error.message);
                });
        }

        function closeScanner() {
            const video = document.getElementById('scanner-video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('scanner-modal').classList.add('hidden');
            document.getElementById('scanner-modal').style.display = 'none';
        }

        function captureImage() {
            const video = document.getElementById('scanner-video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            // Simulate OCR result
            document.getElementById('scan-result').style.display = 'block';
            document.getElementById('scan-text').innerHTML = `
                <div style="color: var(--success);">✅ تم التقاط الصورة بنجاح</div>
                <div style="margin-top: 8px;">
                    <strong>نتيجة المسح المحاكاة:</strong><br>
                    • اسم المريض: أحمد محمد علي<br>
                    • الوزن: 75 كغ<br>
                    • العمر: 45 سنة<br>
                    • رقم السرير: A-12
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                    ملاحظة: هذه نتيجة تجريبية. في التطبيق الحقيقي، استخدم مكتبة OCR مثل Tesseract.js
                </div>
            `;
        }

        // === ADMIN FUNCTIONS ===
        async function loadAdminData() {
            if (userData.role !== 'owner') return;
            
            try {
                // Load statistics
                const usersSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'users')
                );
                
                const calculationsSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'calculations')
                );
                
                document.getElementById('total-users').textContent = usersSnapshot.size;
                document.getElementById('total-calculations').textContent = calculationsSnapshot.size;
                
                // Load users list
                await refreshUsersList();
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        async function refreshUsersList() {
            if (userData.role !== 'owner') return;
            
            try {
                const snapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'users')
                );
                
                let html = `
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>معرف المستخدم</th>
                                <th>الاسم</th>
                                <th>البريد الإلكتروني</th>
                                <th>الدور</th>
                                <th>الحالة</th>
                                <th>آخر دخول</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const status = user.role === 'owner' ? 'owner' : (user.isBlocked ? 'blocked' : 'active');
                    const statusText = user.role === 'owner' ? 'مالك' : (user.isBlocked ? 'محظور' : 'نشط');
                    const lastLogin = user.lastLogin ? new Date(user.lastLogin.seconds * 1000).toLocaleDateString('ar-EG') : 'غير محدد';
                    
                    html += `
                        <tr>
                            <td>${user.userId}</td>
                            <td>${user.displayName}</td>
                            <td>${user.email}</td>
                            <td>${user.role === 'owner' ? 'مالك' : 'مستخدم'}</td>
                            <td><span class="user-status status-${status}">${statusText}</span></td>
                            <td>${lastLogin}</td>
                            <td>
                                ${user.role !== 'owner' ? `
                                    <button class="btn ${user.isBlocked ? 'ghost' : 'danger'}" onclick="${user.isBlocked ? 'unblockUser' : 'blockUser'}('${doc.id}')" style="padding: 4px 8px; font-size: 12px; min-width: 60px;">
                                        ${user.isBlocked ? 'إلغاء الحظر' : 'حظر'}
                                    </button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('users-list-container').innerHTML = html;
                
            } catch (error) {
                console.error('Error refreshing users list:', error);
                document.getElementById('users-list-container').innerHTML = '<p style="color: var(--danger);">خطأ في تحميل قائمة المستخدمين</p>';
            }
        }

        async function blockUser(userId) {
            if (userData.role !== 'owner') return;
            
            if (!confirm('هل أنت متأكد من حظر هذا المستخدم؟')) return;
            
            try {
                await window.firebaseDbFunctions.updateDoc(
                    window.firebaseDbFunctions.doc(window.firebaseDb, 'users', userId),
                    { isBlocked: true }
                );
                
                alert('تم حظر المستخدم بنجاح');
                refreshUsersList();
                
            } catch (error) {
                console.error('Error blocking user:', error);
                alert('حدث خطأ في حظر المستخدم');
            }
        }

        async function unblockUser(userId) {
            if (userData.role !== 'owner') return;
            
            try {
                await window.firebaseDbFunctions.updateDoc(
                    window.firebaseDbFunctions.doc(window.firebaseDb, 'users', userId),
                    { isBlocked: false }
                );
                
                alert('تم إلغاء حظر المستخدم بنجاح');
                refreshUsersList();
                
            } catch (error) {
                console.error('Error unblocking user:', error);
                alert('حدث خطأ في إلغاء حظر المستخدم');
            }
        }

        async function exportAllData() {
            if (userData.role !== 'owner') return;
            
            try {
                const usersSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'users')
                );
                const calculationsSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'calculations')
                );
                
                const users = [];
                const calculations = [];
                
                usersSnapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });
                
                calculationsSnapshot.forEach(doc => {
                    calculations.push({ id: doc.id, ...doc.data() });
                });
                
                const exportData = {
                    users,
                    calculations,
                    exportDate: new Date().toISOString(),
                    totalUsers: users.length,
                    totalCalculations: calculations.length
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                    type: 'application/json' 
                });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `ans-medical-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                alert('تم تصدير البيانات بنجاح!');
                
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('حدث خطأ في تصدير البيانات');
            }
        }

        async function clearAllSystemData() {
            if (userData.role !== 'owner') return;
            
            if (!confirm('هل أنت متأكد من حذف جميع بيانات النظام؟ هذا الإجراء لا يمكن التراجع عنه.\n\nسيتم حذف:\n- جميع المستخدمين (عدا المالك)\n- جميع الحسابات الطبية\n- جميع البيانات المحفوظة')) return;
            
            const confirmText = prompt('اكتب "حذف جميع البيانات" للتأكيد:');
            if (confirmText !== 'حذف جميع البيانات') {
                alert('تم إلغاء العملية');
                return;
            }
            
            try {
                const calculationsSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'calculations')
                );
                
                for (const doc of calculationsSnapshot.docs) {
                    await window.firebaseDbFunctions.deleteDoc(doc.ref);
                }
                
                const usersSnapshot = await window.firebaseDbFunctions.getDocs(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'users')
                );
                
                for (const doc of usersSnapshot.docs) {
                    const user = doc.data();
                    if (user.role !== 'owner') {
                        await window.firebaseDbFunctions.deleteDoc(doc.ref);
                    }
                }
                
                alert('تم حذف جميع بيانات النظام بنجاح!');
                refreshUsersList();
                loadAdminData();
                
            } catch (error) {
                console.error('Error clearing system data:', error);
                alert('حدث خطأ في حذف البيانات');
            }
        }

        // === SAVE CALCULATION TO FIREBASE ===
        async function saveCalculation(type, data) {
            if (!currentUser) return;
            
            try {
                await window.firebaseDbFunctions.addDoc(
                    window.firebaseDbFunctions.collection(window.firebaseDb, 'calculations'),
                    {
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        type: type,
                        data: data,
                        timestamp: new Date()
                    }
                );
                
                // Update user's calculation count
                if (userData.calculationsCount !== undefined) {
                    await window.firebaseDbFunctions.updateDoc(
                        window.firebaseDbFunctions.doc(window.firebaseDb, 'users', currentUser.uid),
                        { calculationsCount: userData.calculationsCount + 1 }
                    );
                    userData.calculationsCount += 1;
                }
                
            } catch (error) {
                console.error('Error saving calculation:', error);
            }
        }

        // === FIREBASE INSTRUCTIONS ===
        function showFirebaseInstructions() {
            document.getElementById('firebase-modal').style.display = 'flex';
            document.getElementById('firebase-modal').classList.remove('hidden');
        }

        function hideFirebaseInstructions() {
            document.getElementById('firebase-modal').style.display = 'none';
            document.getElementById('firebase-modal').classList.add('hidden');
        }

        // === KEYBOARD SHORTCUTS ===
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('login-screen').style.display !== 'none') {
                e.preventDefault();
                if (isLoginMode) {
                    handleLogin();
                } else {
                    handleRegister();
                }
            }
            
            if (e.key === 'Escape') {
                hideFirebaseInstructions();
                closeScanner();
            }
        });

        // Load theme from localStorage
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light');
        }

        // Auto-hide splash after 5 seconds
        setTimeout(() => {
            if (document.getElementById('splash').style.display !== 'none') {
                hideSplash();
            }
        }, 5000);

        console.log('ANS Medical Academy app loaded successfully! 🏥');
    </script>
</body>
</html>